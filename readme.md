- [åŸºäºå¾®æœåŠ¡çš„å¤´æ¡ç±»é¡¹ç›®](#åŸºäºå¾®æœåŠ¡çš„å¤´æ¡ç±»é¡¹ç›®)
  - [ä¸€ã€é¡¹ç›®èƒŒæ™¯ä»‹ç»](#ä¸€é¡¹ç›®èƒŒæ™¯ä»‹ç»)
    - [1. é¡¹ç›®æ¦‚è¿°](#1-é¡¹ç›®æ¦‚è¿°)
    - [2. åŠŸèƒ½æ¶æ„å›¾](#2-åŠŸèƒ½æ¶æ„å›¾)
    - [3. æŠ€æœ¯æ ˆè¯´æ˜](#3-æŠ€æœ¯æ ˆè¯´æ˜)
      - [3.1 åŸºç¡€å±‚](#31-åŸºç¡€å±‚)
      - [3.2 æœåŠ¡å±‚](#32-æœåŠ¡å±‚)
    - [4. é¡¹ç›®ä¸»ä½“ç»“æ„](#4-é¡¹ç›®ä¸»ä½“ç»“æ„)
  - [äºŒã€ç™»å½•åŠŸèƒ½å®ç°](#äºŒç™»å½•åŠŸèƒ½å®ç°)
    - [1. éœ€æ±‚è®¾è®¡](#1-éœ€æ±‚è®¾è®¡)
    - [2. è¡¨ç»“æ„åˆ†æ](#2-è¡¨ç»“æ„åˆ†æ)
    - [3. ap\_userè¡¨ç»“æ„å¦‚ä¸‹ï¼š](#3-ap_userè¡¨ç»“æ„å¦‚ä¸‹)
      - [3.1 ä½¿ç”¨mybais-plusé€†å‘ç”Ÿæˆå¯¹åº”çš„å®ä½“ç±»](#31-ä½¿ç”¨mybais-plusé€†å‘ç”Ÿæˆå¯¹åº”çš„å®ä½“ç±»)
    - [4. æ‰‹åŠ¨åŠ å¯†ï¼ˆmd5+éšæœºå­—ç¬¦ä¸²ï¼‰](#4-æ‰‹åŠ¨åŠ å¯†md5éšæœºå­—ç¬¦ä¸²)
    - [5. æ€è·¯åˆ†æ](#5-æ€è·¯åˆ†æ)
      - [5.1 æ ¸å¿ƒä»£ç ](#51-æ ¸å¿ƒä»£ç )
    - [6.  å…¨å±€è¿‡æ»¤å™¨å®ç°jwtæ ¡éªŒ](#6--å…¨å±€è¿‡æ»¤å™¨å®ç°jwtæ ¡éªŒ)
  - [ä¸‰ã€æ¥å£æµ‹è¯•å·¥å…·postmanã€swaggerã€knife4j](#ä¸‰æ¥å£æµ‹è¯•å·¥å…·postmanswaggerknife4j)
    - [1. postman](#1-postman)
    - [2.swagger](#2swagger)
      - [2.1 Swaggerå¸¸ç”¨æ³¨è§£](#21-swaggerå¸¸ç”¨æ³¨è§£)
      - [2.2 è®¿é—®æ¥å£æ–‡æ¡£](#22-è®¿é—®æ¥å£æ–‡æ¡£)
    - [3. knife4j](#3-knife4j)
      - [3.1 æ ¸å¿ƒåŠŸèƒ½](#31-æ ¸å¿ƒåŠŸèƒ½)
      - [3.2 è®¿é—®æ¥å£æ–‡æ¡£](#32-è®¿é—®æ¥å£æ–‡æ¡£)
  - [å››ã€Nginx](#å››nginx)
  - [äº”ã€æ–‡ç« åˆ—è¡¨åŠ è½½](#äº”æ–‡ç« åˆ—è¡¨åŠ è½½)
    - [1. éœ€æ±‚åˆ†æ](#1-éœ€æ±‚åˆ†æ)
    - [2. è¡¨ç»“æ„åˆ†æ](#2-è¡¨ç»“æ„åˆ†æ-1)
      - [2.1 è¡¨çš„æ‹†åˆ†-å‚ç›´åˆ†è¡¨](#21-è¡¨çš„æ‹†åˆ†-å‚ç›´åˆ†è¡¨)
    - [3. å®ç°æ€è·¯](#3-å®ç°æ€è·¯)
    - [4. æ•°æ®åº“æŸ¥è¯¢](#4-æ•°æ®åº“æŸ¥è¯¢)
    - [5. æ ¸å¿ƒä»£ç ](#5-æ ¸å¿ƒä»£ç )
  - [å…­ã€freemarker](#å…­freemarker)
    - [1. åŸºç¡€è¯­æ³•ç§ç±»](#1-åŸºç¡€è¯­æ³•ç§ç±»)
    - [2. é›†åˆæŒ‡ä»¤ï¼ˆListå’ŒMapï¼‰](#2-é›†åˆæŒ‡ä»¤listå’Œmap)
    - [3. ifæŒ‡ä»¤](#3-ifæŒ‡ä»¤)
    - [4. è¿ç®—ç¬¦](#4-è¿ç®—ç¬¦)
      - [4.1. ç®—æ•°è¿ç®—ç¬¦](#41-ç®—æ•°è¿ç®—ç¬¦)
      - [4.2. æ¯”è¾ƒè¿ç®—ç¬¦](#42-æ¯”è¾ƒè¿ç®—ç¬¦)
      - [4.3. é€»è¾‘è¿ç®—ç¬¦](#43-é€»è¾‘è¿ç®—ç¬¦)
    - [5. ç©ºå€¼å¤„ç†](#5-ç©ºå€¼å¤„ç†)
    - [6. å†…å»ºå‡½æ•°](#6-å†…å»ºå‡½æ•°)
    - [7. é™æ€åŒ–æµ‹è¯•](#7-é™æ€åŒ–æµ‹è¯•)
  - [ä¸ƒã€å¯¹è±¡å­˜å‚¨æœåŠ¡MinIO](#ä¸ƒå¯¹è±¡å­˜å‚¨æœåŠ¡minio)
    - [1. MinIOç®€ä»‹](#1-minioç®€ä»‹)
    - [2. MinIOç‰¹ç‚¹](#2-minioç‰¹ç‚¹)
    - [3. ä½¿ç”¨dockerè¿›è¡Œç¯å¢ƒéƒ¨ç½²å’Œå¯åŠ¨](#3-ä½¿ç”¨dockerè¿›è¡Œç¯å¢ƒéƒ¨ç½²å’Œå¯åŠ¨)
    - [4. æ ¸å¿ƒä»£ç ](#4-æ ¸å¿ƒä»£ç )
  - [å…«ã€æ–‡ç« è¯¦æƒ…](#å…«æ–‡ç« è¯¦æƒ…)
    - [1. éœ€æ±‚åˆ†æ](#1-éœ€æ±‚åˆ†æ-1)
    - [2. å®ç°æ–¹æ¡ˆ](#2-å®ç°æ–¹æ¡ˆ)
    - [3. æ ¸å¿ƒä»£ç ](#3-æ ¸å¿ƒä»£ç )
  - [ä¹ã€è‡ªåª’ä½“æ–‡ç« å‘å¸ƒ](#ä¹è‡ªåª’ä½“æ–‡ç« å‘å¸ƒ)
    - [1. åå°æ­å»º](#1-åå°æ­å»º)
    - [2. å‰å°æ­å»º](#2-å‰å°æ­å»º)
    - [3. è‡ªåª’ä½“ç´ æç®¡ç†](#3-è‡ªåª’ä½“ç´ æç®¡ç†)
      - [3.1 ç´ æä¸Šä¼ ](#31-ç´ æä¸Šä¼ )
        - [3.1.1 éœ€æ±‚åˆ†æ](#311-éœ€æ±‚åˆ†æ)
        - [3.1.2 è¡¨ç»“æ„](#312-è¡¨ç»“æ„)
        - [3.1.3 å®ç°æ€è·¯](#313-å®ç°æ€è·¯)
        - [3.1.4 æ¥å£å®šä¹‰](#314-æ¥å£å®šä¹‰)
        - [3.1.5 æ ¸å¿ƒä»£ç ](#315-æ ¸å¿ƒä»£ç )
      - [3.2 ç´ æåˆ—è¡¨æŸ¥è¯¢](#32-ç´ æåˆ—è¡¨æŸ¥è¯¢)
        - [3.2.1 æ ¸å¿ƒä»£ç ](#321-æ ¸å¿ƒä»£ç )
    - [4. è‡ªåª’ä½“æ–‡ç« ç®¡ç†](#4-è‡ªåª’ä½“æ–‡ç« ç®¡ç†)
      - [4.1 æŸ¥è¯¢æ‰€æœ‰é¢‘é“](#41-æŸ¥è¯¢æ‰€æœ‰é¢‘é“)
        - [4.1.1 éœ€æ±‚åˆ†æ](#411-éœ€æ±‚åˆ†æ)
        - [4.1.2 è¡¨ç»“æ„](#412-è¡¨ç»“æ„)
        - [4.1.3 æ¥å£å®šä¹‰](#413-æ¥å£å®šä¹‰)
        - [4.1.4 æ ¸å¿ƒä»£ç ](#414-æ ¸å¿ƒä»£ç )
      - [4.2 æŸ¥è¯¢è‡ªåª’ä½“æ–‡ç« ](#42-æŸ¥è¯¢è‡ªåª’ä½“æ–‡ç« )
        - [4.2.1 éœ€æ±‚è¯´æ˜](#421-éœ€æ±‚è¯´æ˜)
        - [4.2.2 è¡¨ç»“æ„åˆ†æ](#422-è¡¨ç»“æ„åˆ†æ)
        - [4.2.3 æšä¸¾ç±»](#423-æšä¸¾ç±»)
        - [4.2.4 æ¥å£å®šä¹‰](#424-æ¥å£å®šä¹‰)
        - [4.2.5 æ ¸å¿ƒä»£ç ](#425-æ ¸å¿ƒä»£ç )
      - [4.3 æ–‡ç« å‘å¸ƒ](#43-æ–‡ç« å‘å¸ƒ)
        - [4.3.1 éœ€æ±‚åˆ†æ](#431-éœ€æ±‚åˆ†æ)
        - [4.3.2 è¡¨ç»“æ„åˆ†æ](#432-è¡¨ç»“æ„åˆ†æ)
        - [4.3.3 å®ç°æ€è·¯](#433-å®ç°æ€è·¯)
        - [4.3.4 æ¥å£å®šä¹‰](#434-æ¥å£å®šä¹‰)
        - [4.3.5 æ ¸å¿ƒä»£ç ](#435-æ ¸å¿ƒä»£ç )


# åŸºäºå¾®æœåŠ¡çš„å¤´æ¡ç±»é¡¹ç›®

## ä¸€ã€é¡¹ç›®èƒŒæ™¯ä»‹ç»

### 1. é¡¹ç›®æ¦‚è¿°

&emsp;ç±»ä¼¼äºä»Šæ—¥å¤´æ¡/è…¾è®¯æ–°é—»ï¼Œæ˜¯ä¸€ä¸ªæ–°é—»èµ„è®¯ç±»é¡¹ç›®ã€‚éšç€æ™ºèƒ½æ‰‹æœºçš„æ™®åŠï¼Œäººä»¬æ›´åŠ ä¹ æƒ¯äºé€šè¿‡æ‰‹æœºæ¥çœ‹æ–°é—»ã€‚ç”±äºç”Ÿæ´»èŠ‚å¥çš„åŠ å¿«ï¼Œå¾ˆå¤šäººåªèƒ½åˆ©ç”¨ç¢ç‰‡æ—¶é—´æ¥è·å–ä¿¡æ¯ï¼Œå› æ­¤ï¼Œå¯¹äºç§»åŠ¨èµ„è®¯å®¢æˆ·ç«¯çš„éœ€æ±‚ä¹Ÿè¶Šæ¥è¶Šé«˜ã€‚å¤´æ¡é¡¹ç›®é‡‡ç”¨å½“ä¸‹ç«çƒ­çš„å¾®æœåŠ¡+å¤§æ•°æ®æŠ€æœ¯æ¶æ„å®ç°ã€‚æœ¬é¡¹ç›®ä¸»è¦ç€æ‰‹äºè·å–æœ€æ–°æœ€çƒ­æ–°é—»èµ„è®¯ï¼Œé€šè¿‡å¤§æ•°æ®åˆ†æç”¨æˆ·å–œå¥½ç²¾ç¡®æ¨é€å’¨è¯¢æ–°é—»ã€‚

&emsp;æœ¬ç³»ç»Ÿåˆ†ä¸ºæ™®é€šç”¨æˆ·ã€ä½œè€…ã€ç®¡ç†å‘˜ä¸‰ç§è§’è‰²

- æ™®é€šç”¨æˆ·ï¼šæ³¨å†Œç™»å½• æµè§ˆæ–‡ç«  å…³æ³¨ ç‚¹èµ å–œæ¬¢ è¯„è®º å›å¤è¯„è®º ç‚¹èµè¯„è®º æœç´¢æ–‡ç«  æœç´¢å†å²è®°å½•
- ä½œè€…ï¼šæ‹¥æœ‰æ™®é€šç”¨æˆ·æ‰€æœ‰åŠŸèƒ½ å›¾ç‰‡ç´ æç®¡ç† å‘å¸ƒæ–‡ç«  ä¸Šä¸‹æ¶æ–‡ç« 

- ç®¡ç†å‘˜ï¼šç”¨æˆ·åˆ—è¡¨ ç”¨æˆ·ç”³è¯·æˆä¸ºä½œè€…åˆ—è¡¨ å®¡æ ¸ é¢‘é“ç®¡ç†ï¼ˆæ–‡ç« ç±»å‹ç®¡ç†ï¼‰æ–‡ç« ç®¡ç†å®¡æ ¸ æ•æ„Ÿè¯ç®¡ç†

æ–‡ç« å‘å¸ƒè¿˜æ¥å…¥äº†é˜¿é‡Œäº‘æ–‡å­—å’Œå›¾ç‰‡è¯†åˆ«ï¼Œå†…å®¹å®‰å…¨æ¶‰é»„æ¶‰é»‘æ£€æµ‹

### 2. åŠŸèƒ½æ¶æ„å›¾

<div align="center">
    <img src="æˆªå›¾/é¡¹ç›®èƒŒæ™¯ä»‹ç»/åŠŸèƒ½æ¶æ„å›¾.png" alt="åŠŸèƒ½æ¶æ„å›¾" />
</div>

### 3. æŠ€æœ¯æ ˆè¯´æ˜

#### 3.1 åŸºç¡€å±‚

<div align="center">
    <img src="æˆªå›¾/é¡¹ç›®èƒŒæ™¯ä»‹ç»/åŸºç¡€å±‚.png" alt="åŸºç¡€å±‚" />
</div>

#### 3.2 æœåŠ¡å±‚

<div align="center">
    <img src="æˆªå›¾/é¡¹ç›®èƒŒæ™¯ä»‹ç»/æœåŠ¡å±‚.png" alt="æœåŠ¡å±‚" />
</div>

- Spring-Cloud-Gateway : å¾®æœåŠ¡ä¹‹å‰æ¶è®¾çš„ç½‘å…³æœåŠ¡ï¼Œå®ç°æœåŠ¡æ³¨å†Œä¸­çš„APIè¯·æ±‚è·¯ç”±ï¼Œä»¥åŠæ§åˆ¶æµé€Ÿæ§åˆ¶å’Œç†”æ–­å¤„ç†éƒ½æ˜¯å¸¸ç”¨çš„æ¶æ„æ‰‹æ®µï¼Œè€Œè¿™äº›åŠŸèƒ½Gatewayå¤©ç„¶æ”¯æŒ
- è¿ç”¨Spring Bootå¿«é€Ÿå¼€å‘æ¡†æ¶ï¼Œæ„å»ºé¡¹ç›®å·¥ç¨‹ï¼›å¹¶ç»“åˆSpring Cloudå…¨å®¶æ¡¶æŠ€æœ¯ï¼Œå®ç°åç«¯ä¸ªäººä¸­å¿ƒã€è‡ªåª’ä½“ã€ç®¡ç†ä¸­å¿ƒç­‰å¾®æœåŠ¡ã€‚
- è¿ç”¨Spring Cloud Alibaba Nacosä½œä¸ºé¡¹ç›®ä¸­çš„æ³¨å†Œä¸­å¿ƒå’Œé…ç½®ä¸­å¿ƒ
- è¿ç”¨mybatis-plusä½œä¸ºæŒä¹…å±‚æå‡å¼€å‘æ•ˆç‡
- è¿ç”¨Kafkaå®Œæˆå†…éƒ¨ç³»ç»Ÿæ¶ˆæ¯é€šçŸ¥ï¼›ä¸å®¢æˆ·ç«¯ç³»ç»Ÿæ¶ˆæ¯é€šçŸ¥ï¼›ä»¥åŠå®æ—¶æ•°æ®è®¡ç®—
- è¿ç”¨Redisç¼“å­˜æŠ€æœ¯ï¼Œå®ç°çƒ­æ•°æ®çš„è®¡ç®—ï¼Œæå‡ç³»ç»Ÿæ€§èƒ½æŒ‡æ ‡
- ä½¿ç”¨Mysqlå­˜å‚¨ç”¨æˆ·æ•°æ®ï¼Œä»¥ä¿è¯ä¸Šå±‚æ•°æ®æŸ¥è¯¢çš„é«˜æ€§èƒ½
- ä½¿ç”¨Mongoå­˜å‚¨ç”¨æˆ·çƒ­æ•°æ®ï¼Œä»¥ä¿è¯ç”¨æˆ·çƒ­æ•°æ®é«˜æ‰©å±•å’Œé«˜æ€§èƒ½æŒ‡æ ‡
- ä½¿ç”¨FastDFSä½œä¸ºé™æ€èµ„æºå­˜å‚¨å™¨ï¼Œåœ¨å…¶ä¸Šå®ç°çƒ­é™æ€èµ„æºç¼“å­˜ã€æ·˜æ±°ç­‰åŠŸèƒ½
- è¿ç”¨HbaseæŠ€æœ¯ï¼Œå­˜å‚¨ç³»ç»Ÿä¸­çš„å†·æ•°æ®ï¼Œä¿è¯ç³»ç»Ÿæ•°æ®çš„å¯é æ€§
- è¿ç”¨ESæœç´¢æŠ€æœ¯ï¼Œå¯¹å†·æ•°æ®ã€æ–‡ç« æ•°æ®å»ºç«‹ç´¢å¼•ï¼Œä»¥ä¿è¯å†·æ•°æ®ã€æ–‡ç« æŸ¥è¯¢æ€§èƒ½
- è¿ç”¨AIæŠ€æœ¯ï¼Œæ¥å®Œæˆç³»ç»Ÿè‡ªåŠ¨åŒ–åŠŸèƒ½ï¼Œä»¥æå‡æ•ˆç‡åŠèŠ‚çœæˆæœ¬ã€‚æ¯”å¦‚å®åè®¤è¯è‡ªåŠ¨åŒ–
- PMD&P3C : é™æ€ä»£ç æ‰«æå·¥å…·ï¼Œåœ¨é¡¹ç›®ä¸­æ‰«æé¡¹ç›®ä»£ç ï¼Œæ£€æŸ¥å¼‚å¸¸ç‚¹ã€ä¼˜åŒ–ç‚¹ã€ä»£ç è§„èŒƒç­‰ï¼Œä¸ºå¼€å‘å›¢é˜Ÿæä¾›è§„èŒƒç»Ÿä¸€ï¼Œæå‡é¡¹ç›®ä»£ç è´¨é‡

### 4. é¡¹ç›®ä¸»ä½“ç»“æ„

<div align="center">
    <img src="æˆªå›¾/é¡¹ç›®èƒŒæ™¯ä»‹ç»/å·¥ç¨‹ä¸»ä½“ç»“æ„.png" alt="å·¥ç¨‹ä¸»ä½“ç»“æ„" />
</div>



## äºŒã€ç™»å½•åŠŸèƒ½å®ç°

### 1. éœ€æ±‚è®¾è®¡

- ç”¨æˆ·ç‚¹å‡»**å¼€å§‹ä½¿ç”¨**

  ç™»å½•åçš„ç”¨æˆ·æƒé™è¾ƒå¤§ï¼Œå¯ä»¥æŸ¥çœ‹ï¼Œä¹Ÿå¯ä»¥æ“ä½œï¼ˆç‚¹èµï¼Œå…³æ³¨ï¼Œè¯„è®ºï¼‰

- ç”¨æˆ·ç‚¹å‡»**ä¸ç™»å½•ï¼Œå…ˆçœ‹çœ‹**

â€‹       æ¸¸å®¢åªæœ‰æŸ¥çœ‹çš„æƒé™

### 2. è¡¨ç»“æ„åˆ†æ

&emsp;å…³äºappç«¯ç”¨æˆ·ç›¸å…³çš„å†…å®¹è¾ƒå¤šï¼Œå¯ä»¥å•ç‹¬è®¾ç½®ä¸€ä¸ªåº“leadnews_user

| **è¡¨åç§°**       | **è¯´æ˜**          |
| ---------------- | :---------------- |
| ap_user          | APPç”¨æˆ·ä¿¡æ¯è¡¨     |
| ap_user_fan      | APPç”¨æˆ·ç²‰ä¸ä¿¡æ¯è¡¨ |
| ap_user_follow   | APPç”¨æˆ·å…³æ³¨ä¿¡æ¯è¡¨ |
| ap_user_realname | APPå®åè®¤è¯ä¿¡æ¯è¡¨ |

### 3. ap_userè¡¨ç»“æ„å¦‚ä¸‹ï¼š

```mysql
-- auto-generated definition
create table ap_user
(
    id                         int unsigned auto_increment comment 'ä¸»é”®'
        primary key,
    salt                       varchar(32)      null comment 'å¯†ç ã€é€šä¿¡ç­‰åŠ å¯†ç›',
    name                       varchar(20)      null comment 'ç”¨æˆ·å',
    password                   varchar(32)      null comment 'å¯†ç ,md5åŠ å¯†',
    phone                      varchar(11)      null comment 'æ‰‹æœºå·',
    image                      varchar(255)     null comment 'å¤´åƒ',
    sex                        tinyint unsigned null comment '0 ç”·
            1 å¥³
            2 æœªçŸ¥',
    is_certification           tinyint unsigned null comment '0 æœª
            1 æ˜¯',
    is_identity_authentication tinyint(1)       null comment 'æ˜¯å¦èº«ä»½è®¤è¯',
    status                     tinyint unsigned null comment '0æ­£å¸¸
            1é”å®š',
    flag                       tinyint unsigned null comment '0 æ™®é€šç”¨æˆ·
            1 è‡ªåª’ä½“äºº
            2 å¤§V',
    created_time               datetime         null comment 'æ³¨å†Œæ—¶é—´'
)
    comment 'APPç”¨æˆ·ä¿¡æ¯è¡¨' row_format = DYNAMIC;
```

<div align="center">
    <img src="æˆªå›¾/ç™»å½•åŠŸèƒ½å®ç°/tinyint.png" alt="tinyint" />
</div>


#### 3.1 ä½¿ç”¨mybais-plusé€†å‘ç”Ÿæˆå¯¹åº”çš„å®ä½“ç±»

&emsp;é¡¹ç›®ä¸­çš„æŒä¹…å±‚ä½¿ç”¨çš„mybatis-plusï¼Œä¸€èˆ¬éƒ½ä½¿ç”¨mybais-plusé€†å‘ç”Ÿæˆå¯¹åº”çš„å®ä½“ç±»

app_userè¡¨å¯¹åº”çš„å®ä½“ç±»å¦‚ä¸‹ï¼š

```java
package com.heima.model.user.pojos;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableField;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;

import java.io.Serializable;
import java.util.Date;

/**
 * <p>
 * APPç”¨æˆ·ä¿¡æ¯è¡¨
 * </p>
 *
 * @author itheima
 */
@Data
@TableName("ap_user")
public class ApUser implements Serializable {

    private static final long serialVersionUID = 1L;

    /**
     * ä¸»é”®
     */
    @TableId(value = "id", type = IdType.AUTO)
    private Integer id;

    /**
     * å¯†ç ã€é€šä¿¡ç­‰åŠ å¯†ç›
     */
    @TableField("salt")
    private String salt;

    /**
     * ç”¨æˆ·å
     */
    @TableField("name")
    private String name;

    /**
     * å¯†ç ,md5åŠ å¯†
     */
    @TableField("password")
    private String password;

    /**
     * æ‰‹æœºå·
     */
    @TableField("phone")
    private String phone;

    /**
     * å¤´åƒ
     */
    @TableField("image")
    private String image;

    /**
     * 0 ç”·
            1 å¥³
            2 æœªçŸ¥
     */
    @TableField("sex")
    private Boolean sex;

    /**
     * 0 æœª
            1 æ˜¯
     */
    @TableField("is_certification")
    private Boolean certification;

    /**
     * æ˜¯å¦èº«ä»½è®¤è¯
     */
    @TableField("is_identity_authentication")
    private Boolean identityAuthentication;

    /**
     * 0æ­£å¸¸
            1é”å®š
     */
    @TableField("status")
    private Boolean status;

    /**
     * 0 æ™®é€šç”¨æˆ·
            1 è‡ªåª’ä½“äºº
            2 å¤§V
     */
    @TableField("flag")
    private Short flag;

    /**
     * æ³¨å†Œæ—¶é—´
     */
    @TableField("created_time")
    private Date createdTime;

}
```

### 4. æ‰‹åŠ¨åŠ å¯†ï¼ˆmd5+éšæœºå­—ç¬¦ä¸²ï¼‰

&emsp;md5æ˜¯ä¸å¯é€†åŠ å¯†ï¼Œmd5ç›¸åŒçš„å¯†ç æ¯æ¬¡åŠ å¯†éƒ½ä¸€æ ·ï¼Œä¸å¤ªå®‰å…¨ã€‚åœ¨md5çš„åŸºç¡€ä¸Šæ‰‹åŠ¨åŠ ç›ï¼ˆsaltï¼‰å¤„ç†

æ³¨å†Œ->ç”Ÿæˆç›

<div align="center">
    <img src="æˆªå›¾/ç™»å½•åŠŸèƒ½å®ç°/æ³¨å†Œ.png" alt="æ³¨å†Œ" />
</div>


ç™»å½•->ä½¿ç”¨ç›æ¥é…åˆéªŒè¯

<div align="center">
    <img src="æˆªå›¾/ç™»å½•åŠŸèƒ½å®ç°/ç™»å½•.png" alt="ç™»å½•" />
</div>


### 5. æ€è·¯åˆ†æ

<div align="center">
    <img src="æˆªå›¾/ç™»å½•åŠŸèƒ½å®ç°/æ€è·¯åˆ†æ.png" alt="æ€è·¯åˆ†æ" />
</div>


1. ç”¨æˆ·è¾“å…¥äº†ç”¨æˆ·åå’Œå¯†ç è¿›è¡Œç™»å½•ï¼Œæ ¡éªŒæˆåŠŸåè¿”å›jwt**(åŸºäºå½“å‰ç”¨æˆ·çš„idç”Ÿæˆï¼Œæ•°æ®åº“idå¿…å¤§äº0)**

2. ç”¨æˆ·æ¸¸å®¢ç™»å½•ï¼Œç”Ÿæˆjwtè¿”å›**(åŸºäºé»˜è®¤å€¼0ç”Ÿæˆ)**

#### 5.1 æ ¸å¿ƒä»£ç 

```java
package com.heima.user.service.impl;

import com.baomidou.mybatisplus.core.toolkit.Wrappers;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.heima.model.common.dtos.ResponseResult;
import com.heima.model.common.enums.AppHttpCodeEnum;
import com.heima.model.user.dtos.LoginDto;
import com.heima.model.user.pojos.ApUser;
import com.heima.user.mapper.ApUserMapper;
import com.heima.user.service.ApUserService;
import com.heima.utils.common.AppJwtUtil;
import org.apache.commons.lang3.StringUtils;
import org.springframework.stereotype.Service;
import org.springframework.util.DigestUtils;

import java.util.HashMap;
import java.util.Map;


@Service
public class ApUserServiceImpl extends ServiceImpl<ApUserMapper, ApUser> implements ApUserService {

    @Override
    public ResponseResult login(LoginDto dto) {

        //1.æ­£å¸¸ç™»å½•ï¼ˆæ‰‹æœºå·+å¯†ç ç™»å½•ï¼‰
        if (!StringUtils.isBlank(dto.getPhone()) && !StringUtils.isBlank(dto.getPassword())) {
            //1.1æŸ¥è¯¢ç”¨æˆ·
            ApUser apUser = getOne(Wrappers.<ApUser>lambdaQuery().eq(ApUser::getPhone, dto.getPhone()));
            if (apUser == null) {
                return ResponseResult.errorResult(AppHttpCodeEnum.DATA_NOT_EXIST,"ç”¨æˆ·ä¸å­˜åœ¨");
            }

            //1.2 æ¯”å¯¹å¯†ç 
            String salt = apUser.getSalt();
            String pswd = dto.getPassword();
            pswd = DigestUtils.md5DigestAsHex((pswd + salt).getBytes());
            if (!pswd.equals(apUser.getPassword())) {
                return ResponseResult.errorResult(AppHttpCodeEnum.LOGIN_PASSWORD_ERROR);
            }
            //1.3 è¿”å›æ•°æ®  jwt
            Map<String, Object> map = new HashMap<>();
            map.put("token", AppJwtUtil.getToken(apUser.getId().longValue()));
            apUser.setSalt("");
            apUser.setPassword("");
            map.put("user", apUser);
            return ResponseResult.okResult(map);
        } else {
            //2.æ¸¸å®¢  åŒæ ·è¿”å›token  id = 0
            Map<String, Object> map = new HashMap<>();
            map.put("token", AppJwtUtil.getToken(0l));
            return ResponseResult.okResult(map);
        }
    }
}
```

### 6.  å…¨å±€è¿‡æ»¤å™¨å®ç°jwtæ ¡éªŒ

<div align="center">
    <img src="æˆªå›¾/ç™»å½•åŠŸèƒ½å®ç°/å…¨å±€è¿‡æ»¤å™¨å®ç°jwtæ ¡éªŒ.png" alt="å…¨å±€è¿‡æ»¤å™¨å®ç°jwtæ ¡éªŒ" />
</div>

æ€è·¯åˆ†æï¼š

1. ç”¨æˆ·è¿›å…¥ç½‘å…³å¼€å§‹ç™»é™†ï¼Œç½‘å…³è¿‡æ»¤å™¨è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœæ˜¯ç™»å½•ï¼Œåˆ™è·¯ç”±åˆ°åå°ç®¡ç†å¾®æœåŠ¡è¿›è¡Œç™»å½•
2. ç”¨æˆ·ç™»å½•æˆåŠŸï¼Œåå°ç®¡ç†å¾®æœåŠ¡ç­¾å‘JWT TOKENä¿¡æ¯è¿”å›ç»™ç”¨æˆ·
3. ç”¨æˆ·å†æ¬¡è¿›å…¥ç½‘å…³å¼€å§‹è®¿é—®ï¼Œç½‘å…³è¿‡æ»¤å™¨æ¥æ”¶ç”¨æˆ·æºå¸¦çš„TOKEN 
4. ç½‘å…³è¿‡æ»¤å™¨è§£æTOKEN ï¼Œåˆ¤æ–­æ˜¯å¦æœ‰æƒé™ï¼Œå¦‚æœæœ‰ï¼Œåˆ™æ”¾è¡Œï¼Œå¦‚æœæ²¡æœ‰åˆ™è¿”å›æœªè®¤è¯é”™è¯¯

å…·ä½“å®ç°ï¼š

1. åœ¨è®¤è¯è¿‡æ»¤å™¨ä¸­éœ€è¦ç”¨åˆ°jwtçš„è§£æï¼Œæ‰€ä»¥éœ€è¦æŠŠå·¥å…·ç±»æ‹·è´ä¸€ä»½åˆ°ç½‘å…³å¾®æœåŠ¡

2. åœ¨ç½‘å…³å¾®æœåŠ¡ä¸­æ–°å»ºå…¨å±€è¿‡æ»¤å™¨ï¼š

```java
package com.heima.app.gateway.filter;


import com.heima.app.gateway.util.AppJwtUtil;
import io.jsonwebtoken.Claims;
import lombok.extern.slf4j.Slf4j;
import org.apache.commons.lang.StringUtils;
import org.springframework.cloud.gateway.filter.GatewayFilterChain;
import org.springframework.cloud.gateway.filter.GlobalFilter;
import org.springframework.core.Ordered;
import org.springframework.http.HttpStatus;
import org.springframework.http.server.reactive.ServerHttpRequest;
import org.springframework.http.server.reactive.ServerHttpResponse;
import org.springframework.stereotype.Component;
import org.springframework.web.server.ServerWebExchange;
import reactor.core.publisher.Mono;

@Component
@Slf4j
public class AuthorizeFilter implements Ordered, GlobalFilter {
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        //1.è·å–requestå’Œresponseå¯¹è±¡
        ServerHttpRequest request = exchange.getRequest();
        ServerHttpResponse response = exchange.getResponse();

        //2.åˆ¤æ–­æ˜¯å¦æ˜¯ç™»å½•
        if(request.getURI().getPath().contains("/login")){
            //æ”¾è¡Œ
            return chain.filter(exchange);
        }


        //3.è·å–token
        String token = request.getHeaders().getFirst("token");

        //4.åˆ¤æ–­tokenæ˜¯å¦å­˜åœ¨
        if(StringUtils.isBlank(token)){
            response.setStatusCode(HttpStatus.UNAUTHORIZED);
            return response.setComplete();
        }

        //5.åˆ¤æ–­tokenæ˜¯å¦æœ‰æ•ˆ
        try {
            Claims claimsBody = AppJwtUtil.getClaimsBody(token);
            //æ˜¯å¦æ˜¯è¿‡æœŸ
            int result = AppJwtUtil.verifyToken(claimsBody);
            if(result == 1 || result  == 2){
                response.setStatusCode(HttpStatus.UNAUTHORIZED);
                return response.setComplete();
            }
        }catch (Exception e){
            e.printStackTrace();
            response.setStatusCode(HttpStatus.UNAUTHORIZED);
            return response.setComplete();
        }

        //6.æ”¾è¡Œ
        return chain.filter(exchange);
    }

    /**
     * ä¼˜å…ˆçº§è®¾ç½®  å€¼è¶Šå°  ä¼˜å…ˆçº§è¶Šé«˜
     * @return
     */
    @Override
    public int getOrder() {
        return 0;
    }
}
```



## ä¸‰ã€æ¥å£æµ‹è¯•å·¥å…·postmanã€swaggerã€knife4j

### 1. postman

&emsp;Postmanæ˜¯ä¸€æ¬¾åŠŸèƒ½å¼ºå¤§çš„ç½‘é¡µè°ƒè¯•ä¸å‘é€ç½‘é¡µHTTPè¯·æ±‚çš„Chromeæ’ä»¶ã€‚postmanè¢«500ä¸‡å¼€å‘è€…å’Œè¶…100,000å®¶å…¬å¸ç”¨äºæ¯æœˆè®¿é—®1.3äº¿ä¸ªAPIã€‚å®˜æ–¹ç½‘å€ï¼šhttps://www.postman.com/

### 2.swagger

&emsp;Swagger æ˜¯ä¸€ä¸ªè§„èŒƒå’Œå®Œæ•´çš„æ¡†æ¶ï¼Œç”¨äºç”Ÿæˆã€æè¿°ã€è°ƒç”¨å’Œå¯è§†åŒ– RESTful é£æ ¼çš„ Web æœåŠ¡(<https://swagger.io/>)ã€‚ å®ƒçš„ä¸»è¦ä½œç”¨æ˜¯ï¼š

1. ä½¿å¾—å‰åç«¯åˆ†ç¦»å¼€å‘æ›´åŠ æ–¹ä¾¿ï¼Œæœ‰åˆ©äºå›¢é˜Ÿåä½œ

2. æ¥å£çš„æ–‡æ¡£åœ¨çº¿è‡ªåŠ¨ç”Ÿæˆï¼Œé™ä½åç«¯å¼€å‘äººå‘˜ç¼–å†™æ¥å£æ–‡æ¡£çš„è´Ÿæ‹…

3. åŠŸèƒ½æµ‹è¯•ï¼šSpringå·²ç»å°†Swaggerçº³å…¥è‡ªèº«çš„æ ‡å‡†ï¼Œå»ºç«‹äº†Spring-swaggeré¡¹ç›®ï¼Œç°åœ¨å«Springfoxã€‚é€šè¿‡åœ¨é¡¹ç›®ä¸­å¼•å…¥Springfox ï¼Œå³å¯éå¸¸ç®€å•å¿«æ·çš„ä½¿ç”¨Swaggerã€‚


#### 2.1 Swaggerå¸¸ç”¨æ³¨è§£

åœ¨Javaç±»ä¸­æ·»åŠ Swaggerçš„æ³¨è§£å³å¯ç”ŸæˆSwaggeræ¥å£æ–‡æ¡£ï¼Œå¸¸ç”¨Swaggeræ³¨è§£å¦‚ä¸‹ï¼š

@Apiï¼šä¿®é¥°æ•´ä¸ªç±»ï¼Œæè¿°Controllerçš„ä½œç”¨  

@ApiOperationï¼šæè¿°ä¸€ä¸ªç±»çš„ä¸€ä¸ªæ–¹æ³•ï¼Œæˆ–è€…è¯´ä¸€ä¸ªæ¥å£  

@ApiParamï¼šå•ä¸ªå‚æ•°çš„æè¿°ä¿¡æ¯  

@ApiModelï¼šç”¨å¯¹è±¡æ¥æ¥æ”¶å‚æ•°  

@ApiModelPropertyï¼šç”¨å¯¹è±¡æ¥æ”¶å‚æ•°æ—¶ï¼Œæè¿°å¯¹è±¡çš„ä¸€ä¸ªå­—æ®µ  

@ApiResponseï¼šHTTPå“åº”å…¶ä¸­1ä¸ªæè¿°  

@ApiResponsesï¼šHTTPå“åº”æ•´ä½“æè¿°  

@ApiIgnoreï¼šä½¿ç”¨è¯¥æ³¨è§£å¿½ç•¥è¿™ä¸ªAPI  

@ApiError ï¼šå‘ç”Ÿé”™è¯¯è¿”å›çš„ä¿¡æ¯  

@ApiImplicitParamï¼šä¸€ä¸ªè¯·æ±‚å‚æ•°  

@ApiImplicitParamsï¼šå¤šä¸ªè¯·æ±‚å‚æ•°çš„æè¿°ä¿¡æ¯

#### 2.2 è®¿é—®æ¥å£æ–‡æ¡£

&emsp;å¯åŠ¨userå¾®æœåŠ¡ï¼Œè®¿é—®åœ°å€ï¼šhttp://localhost:port/swagger-ui.html

### 3. knife4j

&emsp;knife4jæ˜¯ä¸ºJava MVCæ¡†æ¶é›†æˆSwaggerç”ŸæˆApiæ–‡æ¡£çš„å¢å¼ºè§£å†³æ–¹æ¡ˆ,å‰èº«æ˜¯swagger-bootstrap-ui,å–åkni4jæ˜¯å¸Œæœ›å®ƒèƒ½åƒä¸€æŠŠåŒ•é¦–ä¸€æ ·å°å·§,è½»é‡,å¹¶ä¸”åŠŸèƒ½å¼ºæ‚!

giteeåœ°å€ï¼šhttps://gitee.com/xiaoym/knife4j

å®˜æ–¹æ–‡æ¡£ï¼šhttps://doc.xiaominfo.com/

æ•ˆæœæ¼”ç¤ºï¼šhttp://knife4j.xiaominfo.com/doc.html

#### 3.1 æ ¸å¿ƒåŠŸèƒ½

è¯¥UIå¢å¼ºåŒ…ä¸»è¦åŒ…æ‹¬ä¸¤å¤§æ ¸å¿ƒåŠŸèƒ½ï¼šæ–‡æ¡£è¯´æ˜ å’Œ åœ¨çº¿è°ƒè¯•

- æ–‡æ¡£è¯´æ˜ï¼šæ ¹æ®Swaggerçš„è§„èŒƒè¯´æ˜ï¼Œè¯¦ç»†åˆ—å‡ºæ¥å£æ–‡æ¡£çš„è¯´æ˜ï¼ŒåŒ…æ‹¬æ¥å£åœ°å€ã€ç±»å‹ã€è¯·æ±‚ç¤ºä¾‹ã€è¯·æ±‚å‚æ•°ã€å“åº”ç¤ºä¾‹ã€å“åº”å‚æ•°ã€å“åº”ç ç­‰ä¿¡æ¯ï¼Œä½¿ç”¨swagger-bootstrap-uièƒ½æ ¹æ®è¯¥æ–‡æ¡£è¯´æ˜ï¼Œå¯¹è¯¥æ¥å£çš„ä½¿ç”¨æƒ…å†µä¸€ç›®äº†ç„¶ã€‚
- åœ¨çº¿è°ƒè¯•ï¼šæä¾›åœ¨çº¿æ¥å£è”è°ƒçš„å¼ºå¤§åŠŸèƒ½ï¼Œè‡ªåŠ¨è§£æå½“å‰æ¥å£å‚æ•°,åŒæ—¶åŒ…å«è¡¨å•éªŒè¯ï¼Œè°ƒç”¨å‚æ•°å¯è¿”å›æ¥å£å“åº”å†…å®¹ã€headersã€Curlè¯·æ±‚å‘½ä»¤å®ä¾‹ã€å“åº”æ—¶é—´ã€å“åº”çŠ¶æ€ç ç­‰ä¿¡æ¯ï¼Œå¸®åŠ©å¼€å‘è€…åœ¨çº¿è°ƒè¯•ï¼Œè€Œä¸å¿…é€šè¿‡å…¶ä»–æµ‹è¯•å·¥å…·æµ‹è¯•æ¥å£æ˜¯å¦æ­£ç¡®ï¼Œç®€æ´ã€å¼ºå¤§ã€‚
- ä¸ªæ€§åŒ–é…ç½®ï¼šé€šè¿‡ä¸ªæ€§åŒ–uié…ç½®é¡¹ï¼Œå¯è‡ªå®šä¹‰UIçš„ç›¸å…³æ˜¾ç¤ºä¿¡æ¯
- ç¦»çº¿æ–‡æ¡£ï¼šæ ¹æ®æ ‡å‡†è§„èŒƒï¼Œç”Ÿæˆçš„åœ¨çº¿markdownç¦»çº¿æ–‡æ¡£ï¼Œå¼€å‘è€…å¯ä»¥è¿›è¡Œæ‹·è´ç”Ÿæˆmarkdownæ¥å£æ–‡æ¡£ï¼Œé€šè¿‡å…¶ä»–ç¬¬ä¸‰æ–¹markdownè½¬æ¢å·¥å…·è½¬æ¢æˆhtmlæˆ–pdfï¼Œè¿™æ ·ä¹Ÿå¯ä»¥æ”¾å¼ƒswagger2markdownç»„ä»¶
- æ¥å£æ’åºï¼šè‡ª1.8.5åï¼Œuiæ”¯æŒäº†æ¥å£æ’åºåŠŸèƒ½ï¼Œä¾‹å¦‚ä¸€ä¸ªæ³¨å†ŒåŠŸèƒ½ä¸»è¦åŒ…å«äº†å¤šä¸ªæ­¥éª¤,å¯ä»¥æ ¹æ®swagger-bootstrap-uiæä¾›çš„æ¥å£æ’åºè§„åˆ™å®ç°æ¥å£çš„æ’åºï¼ŒstepåŒ–æ¥å£æ“ä½œï¼Œæ–¹ä¾¿å…¶ä»–å¼€å‘è€…è¿›è¡Œæ¥å£å¯¹æ¥

#### 3.2 è®¿é—®æ¥å£æ–‡æ¡£

&emsp;åœ¨æµè§ˆå™¨è¾“å…¥åœ°å€ï¼š`http://host:port/doc.html`

## å››ã€Nginx

<div align="center">
    <img src="æˆªå›¾/ç™»å½•åŠŸèƒ½å®ç°/nginx.png" alt="nginx" />
</div>

é€šè¿‡nginxæ¥è¿›è¡Œé…ç½®ï¼ŒåŠŸèƒ½å¦‚ä¸‹

- é€šè¿‡nginxçš„**åå‘ä»£ç†**åŠŸèƒ½è®¿é—®åå°çš„ç½‘å…³èµ„æº
- é€šè¿‡nginxçš„**é™æ€æœåŠ¡å™¨**åŠŸèƒ½è®¿é—®å‰ç«¯é™æ€é¡µé¢

## äº”ã€æ–‡ç« åˆ—è¡¨åŠ è½½

### 1. éœ€æ±‚åˆ†æ

æ–‡ç« å¸ƒå±€å±•ç¤º

<div align="center">
    <img src="æˆªå›¾/æ–‡ç« åˆ—è¡¨åŠ è½½/æ–‡ç« å¸ƒå±€å±•ç¤º.png" alt="æ–‡ç« å¸ƒå±€å±•ç¤º" />
</div>

### 2. è¡¨ç»“æ„åˆ†æ

ap_article  æ–‡ç« åŸºæœ¬ä¿¡æ¯è¡¨

```mysql
-- auto-generated definition
create table ap_article
(
    id           bigint unsigned auto_increment
        primary key,
    title        varchar(50)                  null comment 'æ ‡é¢˜',
    author_id    int unsigned                 null comment 'æ–‡ç« ä½œè€…çš„ID',
    author_name  varchar(20)                  null comment 'ä½œè€…æ˜µç§°',
    channel_id   int unsigned                 null comment 'æ–‡ç« æ‰€å±é¢‘é“ID',
    channel_name varchar(10)                  null comment 'é¢‘é“åç§°',
    layout       tinyint unsigned             null comment 'æ–‡ç« å¸ƒå±€
            0 æ— å›¾æ–‡ç« 
            1 å•å›¾æ–‡ç« 
            2 å¤šå›¾æ–‡ç« ',
    flag         tinyint unsigned             null comment 'æ–‡ç« æ ‡è®°
            0 æ™®é€šæ–‡ç« 
            1 çƒ­ç‚¹æ–‡ç« 
            2 ç½®é¡¶æ–‡ç« 
            3 ç²¾å“æ–‡ç« 
            4 å¤§V æ–‡ç« ',
    images       varchar(1000)                null comment 'æ–‡ç« å›¾ç‰‡
            å¤šå¼ é€—å·åˆ†éš”',
    labels       varchar(500)                 null comment 'æ–‡ç« æ ‡ç­¾æœ€å¤š3ä¸ª é€—å·åˆ†éš”',
    likes        int unsigned                 null comment 'ç‚¹èµæ•°é‡',
    collection   int unsigned                 null comment 'æ”¶è—æ•°é‡',
    comment      int unsigned                 null comment 'è¯„è®ºæ•°é‡',
    views        int unsigned                 null comment 'é˜…è¯»æ•°é‡',
    province_id  int unsigned                 null comment 'çœå¸‚',
    city_id      int unsigned                 null comment 'å¸‚åŒº',
    county_id    int unsigned                 null comment 'åŒºå¿',
    created_time datetime                     null comment 'åˆ›å»ºæ—¶é—´',
    publish_time datetime                     null comment 'å‘å¸ƒæ—¶é—´',
    sync_status  tinyint(1)       default 0   null comment 'åŒæ­¥çŠ¶æ€',
    origin       tinyint unsigned default '0' null comment 'æ¥æº',
    static_url   varchar(150)                 null
)
    comment 'æ–‡ç« ä¿¡æ¯è¡¨ï¼Œå­˜å‚¨å·²å‘å¸ƒçš„æ–‡ç« ' row_format = DYNAMIC;
```

ap_article_config  æ–‡ç« é…ç½®è¡¨

```mysql
-- auto-generated definition
create table ap_article_config
(
    id         bigint unsigned auto_increment comment 'ä¸»é”®'
        primary key,
    article_id bigint unsigned  null comment 'æ–‡ç« ID',
    is_comment tinyint unsigned null comment 'æ˜¯å¦å¯è¯„è®º',
    is_forward tinyint unsigned null comment 'æ˜¯å¦è½¬å‘',
    is_down    tinyint unsigned null comment 'æ˜¯å¦ä¸‹æ¶',
    is_delete  tinyint unsigned null comment 'æ˜¯å¦å·²åˆ é™¤'
)
    comment 'APPå·²å‘å¸ƒæ–‡ç« é…ç½®è¡¨' row_format = DYNAMIC;

create index idx_article_id
    on ap_article_config (article_id);
```

ap_article_content æ–‡ç« å†…å®¹è¡¨

```mysql
-- auto-generated definition
create table ap_article_content
(
    id         bigint unsigned auto_increment comment 'ä¸»é”®'
        primary key,
    article_id bigint unsigned null comment 'æ–‡ç« ID',
    content    longtext        null comment 'æ–‡ç« å†…å®¹'
)
    comment 'APPå·²å‘å¸ƒæ–‡ç« å†…å®¹è¡¨' row_format = DYNAMIC;

create index idx_article_id
    on ap_article_content (article_id);
```

ä¸‰å¼ è¡¨å…³ç³»åˆ†æ

<div align="center">
    <img src="æˆªå›¾/æ–‡ç« åˆ—è¡¨åŠ è½½/ä¸‰è¡¨å…³ç³».png" alt="ä¸‰è¡¨å…³ç³»" />
</div>
#### 2.1 è¡¨çš„æ‹†åˆ†-å‚ç›´åˆ†è¡¨

&emsp;å‚ç›´åˆ†è¡¨ï¼šå°†ä¸€ä¸ªè¡¨çš„å­—æ®µåˆ†æ•£åˆ°å¤šä¸ªè¡¨ä¸­ï¼Œæ¯ä¸ªè¡¨å­˜å‚¨å…¶ä¸­ä¸€éƒ¨åˆ†å­—æ®µã€‚

ä¼˜åŠ¿ï¼š

1. å‡å°‘IOäº‰æŠ¢ï¼Œå‡å°‘é”è¡¨çš„å‡ ç‡ï¼ŒæŸ¥çœ‹æ–‡ç« æ¦‚è¿°ä¸æ–‡ç« è¯¦æƒ…äº’ä¸å½±å“
2. å……åˆ†å‘æŒ¥é«˜é¢‘æ•°æ®çš„æ“ä½œæ•ˆç‡ï¼Œå¯¹æ–‡ç« æ¦‚è¿°æ•°æ®æ“ä½œçš„é«˜æ•ˆç‡ä¸ä¼šè¢«æ“ä½œæ–‡ç« è¯¦æƒ…æ•°æ®çš„ä½æ•ˆç‡æ‰€æ‹–ç´¯

æ‹†åˆ†åŸåˆ™ï¼š

1. æŠŠä¸å¸¸ç”¨çš„å­—æ®µå•ç‹¬æ”¾åœ¨ä¸€å¼ è¡¨
2. æŠŠtextï¼Œblobç­‰å¤§å­—æ®µæ‹†åˆ†å‡ºæ¥å•ç‹¬æ”¾åœ¨ä¸€å¼ è¡¨
3. ç»å¸¸ç»„åˆæŸ¥è¯¢çš„å­—æ®µå•ç‹¬æ”¾åœ¨ä¸€å¼ è¡¨ä¸­

### 3. å®ç°æ€è·¯

<div align="center">
    <img src="æˆªå›¾/æ–‡ç« åˆ—è¡¨åŠ è½½/å®ç°æ€è·¯.png" alt="å®ç°æ€è·¯" />
</div>

1. åœ¨é»˜è®¤é¢‘é“å±•ç¤º10æ¡æ–‡ç« ä¿¡æ¯

2. å¯ä»¥åˆ‡æ¢é¢‘é“æŸ¥çœ‹ä¸åŒç§ç±»æ–‡ç« 

3. å½“ç”¨æˆ·ä¸‹æ‹‰å¯ä»¥åŠ è½½æœ€æ–°çš„æ–‡ç« ï¼ˆåˆ†é¡µï¼‰æœ¬é¡µæ–‡ç« åˆ—è¡¨ä¸­å‘å¸ƒæ—¶é—´ä¸ºæœ€å¤§çš„æ—¶é—´ä¸ºä¾æ®

4. å½“ç”¨æˆ·ä¸Šæ‹‰å¯ä»¥åŠ è½½æ›´å¤šçš„æ–‡ç« ä¿¡æ¯ï¼ˆæŒ‰ç…§å‘å¸ƒæ—¶é—´ï¼‰æœ¬é¡µæ–‡ç« åˆ—è¡¨ä¸­å‘å¸ƒæ—¶é—´æœ€å°çš„æ—¶é—´ä¸ºä¾æ®

5. å¦‚æœæ˜¯å½“å‰é¢‘é“çš„é¦–é¡µï¼Œå‰ç«¯ä¼ é€’é»˜è®¤å‚æ•°ï¼š

- maxBehotTimeï¼š0ï¼ˆæ¯«ç§’ï¼‰

- minBehotTimeï¼š20000000000000ï¼ˆæ¯«ç§’ï¼‰--->2063å¹´

### 4. æ•°æ®åº“æŸ¥è¯¢

Mapperæ¥å£å¯¹åº”çš„æ˜ å°„æ–‡ä»¶

åœ¨resourcesä¸­æ–°å»ºmapper/ApArticleMapper.xml     å¦‚ä¸‹é…ç½®ï¼š

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.heima.article.mapper.ApArticleMapper">

    <resultMap id="resultMap" type="com.heima.model.article.pojos.ApArticle">
        <id column="id" property="id"/>
        <result column="title" property="title"/>
        <result column="author_id" property="authorId"/>
        <result column="author_name" property="authorName"/>
        <result column="channel_id" property="channelId"/>
        <result column="channel_name" property="channelName"/>
        <result column="layout" property="layout"/>
        <result column="flag" property="flag"/>
        <result column="images" property="images"/>
        <result column="labels" property="labels"/>
        <result column="likes" property="likes"/>
        <result column="collection" property="collection"/>
        <result column="comment" property="comment"/>
        <result column="views" property="views"/>
        <result column="province_id" property="provinceId"/>
        <result column="city_id" property="cityId"/>
        <result column="county_id" property="countyId"/>
        <result column="created_time" property="createdTime"/>
        <result column="publish_time" property="publishTime"/>
        <result column="sync_status" property="syncStatus"/>
        <result column="static_url" property="staticUrl"/>
    </resultMap>
    <select id="loadArticleList" resultMap="resultMap">
        SELECT
        aa.*
        FROM
        `ap_article` aa
        LEFT JOIN ap_article_config aac ON aa.id = aac.article_id
        <where>
            and aac.is_delete != 1
            and aac.is_down != 1
            <!-- loadmore -->
            <if test="type != null and type == 1">
                and aa.publish_time <![CDATA[<]]> #{dto.minBehotTime}
            </if>
            <!-- loadnew -->
            <if test="type != null and type == 2">
                and aa.publish_time <![CDATA[>]]> #{dto.maxBehotTime}
            </if>
            <if test="dto.tag != '__all__'">
                and aa.channel_id = #{dto.tag}
            </if>
        </where>
        order by aa.publish_time desc
        limit #{dto.size}
    </select>

</mapper>
```

### 5. æ ¸å¿ƒä»£ç 

```java
package com.heima.article.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.heima.article.mapper.ApArticleMapper;
import com.heima.article.service.ApArticleService;
import com.heima.common.constants.ArticleConstants;
import com.heima.model.article.dtos.ArticleHomeDto;

import com.heima.model.article.pojos.ApArticle;
import com.heima.model.common.dtos.ResponseResult;
import lombok.extern.slf4j.Slf4j;
import org.apache.commons.lang3.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.Date;
import java.util.List;


@Service
@Transactional
@Slf4j
public class ApArticleServiceImpl  extends ServiceImpl<ApArticleMapper, ApArticle> implements ApArticleService {

    // å•é¡µæœ€å¤§åŠ è½½çš„æ•°å­—
    private final static short MAX_PAGE_SIZE = 50;

    @Autowired
    private ApArticleMapper apArticleMapper;

    /**
     * æ ¹æ®å‚æ•°åŠ è½½æ–‡ç« åˆ—è¡¨
     * @param loadtype 1ä¸ºåŠ è½½æ›´å¤š  2ä¸ºåŠ è½½æœ€æ–°
     * @param dto
     * @return
     */
    @Override
    public ResponseResult load(Short loadtype, ArticleHomeDto dto) {
        //1.æ ¡éªŒå‚æ•°
        Integer size = dto.getSize();
        if(size == null || size == 0){
            size = 10;
        }
        size = Math.min(size,MAX_PAGE_SIZE);
        dto.setSize(size);

        //ç±»å‹å‚æ•°æ£€éªŒ
        if(!loadtype.equals(ArticleConstants.LOADTYPE_LOAD_MORE)&&!loadtype.equals(ArticleConstants.LOADTYPE_LOAD_NEW)){
            loadtype = ArticleConstants.LOADTYPE_LOAD_MORE;
        }
        //æ–‡ç« é¢‘é“æ ¡éªŒ
        if(StringUtils.isEmpty(dto.getTag())){
            dto.setTag(ArticleConstants.DEFAULT_TAG);
        }

        //æ—¶é—´æ ¡éªŒ
        if(dto.getMaxBehotTime() == null) dto.setMaxBehotTime(new Date());
        if(dto.getMinBehotTime() == null) dto.setMinBehotTime(new Date());
        //2.æŸ¥è¯¢æ•°æ®
        List<ApArticle> apArticles = apArticleMapper.loadArticleList(dto, loadtype);

        //3.ç»“æœå°è£…
        ResponseResult responseResult = ResponseResult.okResult(apArticles);
        return responseResult;
    }
    
}
```

å®šä¹‰å¸¸é‡ç±»

```java
package com.heima.common.constants;

public class ArticleConstants {
    public static final Short LOADTYPE_LOAD_MORE = 1;
    public static final Short LOADTYPE_LOAD_NEW = 2;
    public static final String DEFAULT_TAG = "__all__";

}
```

## å…­ã€freemarker

&emsp;FreeMarker æ˜¯ä¸€æ¬¾**æ¨¡æ¿å¼•æ“**ï¼š å³ä¸€ç§åŸºäºæ¨¡æ¿å’Œè¦æ”¹å˜çš„æ•°æ®ï¼Œ å¹¶ç”¨æ¥ç”Ÿæˆè¾“å‡ºæ–‡æœ¬(HTMLç½‘é¡µï¼Œç”µå­é‚®ä»¶ï¼Œé…ç½®æ–‡ä»¶ï¼Œæºä»£ç ç­‰)çš„é€šç”¨å·¥å…·ã€‚ å®ƒä¸æ˜¯é¢å‘æœ€ç»ˆç”¨æˆ·çš„ï¼Œè€Œæ˜¯ä¸€ä¸ªJavaç±»åº“ï¼Œæ˜¯ä¸€æ¬¾ç¨‹åºå‘˜å¯ä»¥åµŒå…¥ä»–ä»¬æ‰€å¼€å‘äº§å“çš„ç»„ä»¶ã€‚

&emsp;æ¨¡æ¿ç¼–å†™ä¸ºFreeMarker Template Language (FTL)ã€‚å®ƒæ˜¯ç®€å•çš„ï¼Œä¸“ç”¨çš„è¯­è¨€ï¼Œ *ä¸æ˜¯* åƒPHPé‚£æ ·æˆç†Ÿçš„ç¼–ç¨‹è¯­è¨€ã€‚ é‚£å°±æ„å‘³ç€è¦å‡†å¤‡æ•°æ®åœ¨çœŸå®ç¼–ç¨‹è¯­è¨€ä¸­æ¥æ˜¾ç¤ºï¼Œæ¯”å¦‚æ•°æ®åº“æŸ¥è¯¢å’Œä¸šåŠ¡è¿ç®—ï¼Œ ä¹‹åæ¨¡æ¿æ˜¾ç¤ºå·²ç»å‡†å¤‡å¥½çš„æ•°æ®ã€‚åœ¨æ¨¡æ¿ä¸­ï¼Œä½ å¯ä»¥ä¸“æ³¨äºå¦‚ä½•å±•ç°æ•°æ®ï¼Œ è€Œåœ¨æ¨¡æ¿ä¹‹å¤–å¯ä»¥ä¸“æ³¨äºè¦å±•ç¤ºä»€ä¹ˆæ•°æ®ã€‚ 

<div align="center">
    <img src="æˆªå›¾/æ–‡ç« åˆ—è¡¨åŠ è½½/freemarker.png" alt="freemarker" />
</div>

å¸¸ç”¨çš„javaæ¨¡æ¿å¼•æ“è¿˜æœ‰å“ªäº›ï¼Ÿ

Jspã€Freemarkerã€Thymeleaf ã€Velocity ç­‰ã€‚

1. Jsp ä¸º Servlet ä¸“ç”¨ï¼Œä¸èƒ½å•ç‹¬è¿›è¡Œä½¿ç”¨ã€‚

2. Thymeleaf ä¸ºæ–°æŠ€æœ¯ï¼ŒåŠŸèƒ½è¾ƒä¸ºå¼ºå¤§ï¼Œä½†æ˜¯æ‰§è¡Œçš„æ•ˆç‡æ¯”è¾ƒä½ã€‚

3. Velocityä»2010å¹´æ›´æ–°å®Œ 2.0 ç‰ˆæœ¬åï¼Œä¾¿æ²¡æœ‰åœ¨æ›´æ–°ã€‚Spring Boot å®˜æ–¹åœ¨ 1.4 ç‰ˆæœ¬åå¯¹æ­¤ä¹Ÿä¸åœ¨æ”¯æŒï¼Œè™½ç„¶ Velocity åœ¨ 2017 å¹´ç‰ˆæœ¬å¾—åˆ°è¿­ä»£ï¼Œä½†ä¸ºæ—¶å·²æ™šã€‚ 

### 1. åŸºç¡€è¯­æ³•ç§ç±»

  1ã€æ³¨é‡Šï¼Œå³<#--  -->ï¼Œä»‹äºå…¶ä¹‹é—´çš„å†…å®¹ä¼šè¢«freemarkerå¿½ç•¥

```velocity
<#--æˆ‘æ˜¯ä¸€ä¸ªfreemarkeræ³¨é‡Š-->
```

  2ã€æ’å€¼ï¼ˆInterpolationï¼‰ï¼šå³ **`${..}`** éƒ¨åˆ†,freemarkerä¼šç”¨çœŸå®çš„å€¼ä»£æ›¿**`${..}`**

```velocity
Hello ${name}
```

  3ã€FTLæŒ‡ä»¤ï¼šå’ŒHTMLæ ‡è®°ç±»ä¼¼ï¼Œåå­—å‰åŠ #äºˆä»¥åŒºåˆ†ï¼ŒFreemarkerä¼šè§£ææ ‡ç­¾ä¸­çš„è¡¨è¾¾å¼æˆ–é€»è¾‘ã€‚

```velocity
<# >FTLæŒ‡ä»¤</#> 
```

  4ã€æ–‡æœ¬ï¼Œä»…æ–‡æœ¬ä¿¡æ¯ï¼Œè¿™äº›ä¸æ˜¯freemarkerçš„æ³¨é‡Šã€æ’å€¼ã€FTLæŒ‡ä»¤çš„å†…å®¹ä¼šè¢«freemarkerå¿½ç•¥è§£æï¼Œç›´æ¥è¾“å‡ºå†…å®¹ã€‚

```velocity
æˆ‘æ˜¯ä¸€ä¸ªæ™®é€šçš„æ–‡æœ¬
```

### 2. é›†åˆæŒ‡ä»¤ï¼ˆListå’ŒMapï¼‰

å®ä¾‹ä»£ç 

```velocity
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Hello World!</title>
</head>
<body>
    
<#-- list æ•°æ®çš„å±•ç¤º -->
<b>å±•ç¤ºlistä¸­çš„stuæ•°æ®:</b>
<br>
<br>
<table>
    <tr>
        <td>åºå·</td>
        <td>å§“å</td>
        <td>å¹´é¾„</td>
        <td>é’±åŒ…</td>
    </tr>
    <#list stus as stu>
        <tr>
            <td>${stu_index+1}</td>
            <td>${stu.name}</td>
            <td>${stu.age}</td>
            <td>${stu.money}</td>
        </tr>
    </#list>

</table>
<hr>
    
<#-- Map æ•°æ®çš„å±•ç¤º -->
<b>mapæ•°æ®çš„å±•ç¤ºï¼š</b>
<br/><br/>
<a href="###">æ–¹å¼ä¸€ï¼šé€šè¿‡map['keyname'].property</a><br/>
è¾“å‡ºstu1çš„å­¦ç”Ÿä¿¡æ¯ï¼š<br/>
å§“åï¼š${stuMap['stu1'].name}<br/>
å¹´é¾„ï¼š${stuMap['stu1'].age}<br/>
<br/>
<a href="###">æ–¹å¼äºŒï¼šé€šè¿‡map.keyname.property</a><br/>
è¾“å‡ºstu2çš„å­¦ç”Ÿä¿¡æ¯ï¼š<br/>
å§“åï¼š${stuMap.stu2.name}<br/>
å¹´é¾„ï¼š${stuMap.stu2.age}<br/>

<br/>
<a href="###">éå†mapä¸­ä¸¤ä¸ªå­¦ç”Ÿä¿¡æ¯ï¼š</a><br/>
<table>
    <tr>
        <td>åºå·</td>
        <td>å§“å</td>
        <td>å¹´é¾„</td>
        <td>é’±åŒ…</td>
    </tr>
    <#list stuMap?keys as key >
        <tr>
            <td>${key_index}</td>
            <td>${stuMap[key].name}</td>
            <td>${stuMap[key].age}</td>
            <td>${stuMap[key].money}</td>
        </tr>
    </#list>
</table>
<hr>
 
</body>
</html>
```

ğŸ‘†ä¸Šé¢ä»£ç è§£é‡Šï¼š

${k_index}ï¼š
	indexï¼šå¾—åˆ°å¾ªç¯çš„ä¸‹æ ‡ï¼Œä½¿ç”¨æ–¹æ³•æ˜¯åœ¨stuåè¾¹åŠ "_index"ï¼Œå®ƒçš„å€¼æ˜¯ä»0å¼€å§‹

### 3. ifæŒ‡ä»¤

â€‹	 if æŒ‡ä»¤å³åˆ¤æ–­æŒ‡ä»¤ï¼Œæ˜¯å¸¸ç”¨çš„FTLæŒ‡ä»¤ï¼Œfreemarkeråœ¨è§£ææ—¶é‡åˆ°ifä¼šè¿›è¡Œåˆ¤æ–­ï¼Œæ¡ä»¶ä¸ºçœŸåˆ™è¾“å‡ºifä¸­é—´çš„å†…å®¹ï¼Œå¦åˆ™è·³è¿‡å†…å®¹ä¸å†è¾“å‡ºã€‚

- æŒ‡ä»¤æ ¼å¼

```html
<#if ></if>
```

### 4. è¿ç®—ç¬¦

#### 4.1. ç®—æ•°è¿ç®—ç¬¦

FreeMarkerè¡¨è¾¾å¼ä¸­å®Œå…¨æ”¯æŒç®—æœ¯è¿ç®—,FreeMarkeræ”¯æŒçš„ç®—æœ¯è¿ç®—ç¬¦åŒ…æ‹¬:

- åŠ æ³•ï¼š `+`
- å‡æ³•ï¼š `-`
- ä¹˜æ³•ï¼š `*`
- é™¤æ³•ï¼š `/`
- æ±‚æ¨¡ (æ±‚ä½™)ï¼š `%`

#### 4.2. æ¯”è¾ƒè¿ç®—ç¬¦

- **`=`**æˆ–è€…**`==`**:åˆ¤æ–­ä¸¤ä¸ªå€¼æ˜¯å¦ç›¸ç­‰. 
- **`!=`**:åˆ¤æ–­ä¸¤ä¸ªå€¼æ˜¯å¦ä¸ç­‰. 
- **`>`**æˆ–è€…**`gt`**:åˆ¤æ–­å·¦è¾¹å€¼æ˜¯å¦å¤§äºå³è¾¹å€¼ 
- **`>=`**æˆ–è€…**`gte`**:åˆ¤æ–­å·¦è¾¹å€¼æ˜¯å¦å¤§äºç­‰äºå³è¾¹å€¼ 
- **`<`**æˆ–è€…**`lt`**:åˆ¤æ–­å·¦è¾¹å€¼æ˜¯å¦å°äºå³è¾¹å€¼ 
- **`<=`**æˆ–è€…**`lte`**:åˆ¤æ–­å·¦è¾¹å€¼æ˜¯å¦å°äºç­‰äºå³è¾¹å€¼ 

**æ¯”è¾ƒè¿ç®—ç¬¦æ³¨æ„**

- **`=`**å’Œ**`!=`**å¯ä»¥ç”¨äºå­—ç¬¦ä¸²ã€æ•°å€¼å’Œæ—¥æœŸæ¥æ¯”è¾ƒæ˜¯å¦ç›¸ç­‰
- **`=`**å’Œ**`!=`**ä¸¤è¾¹å¿…é¡»æ˜¯ç›¸åŒç±»å‹çš„å€¼,å¦åˆ™ä¼šäº§ç”Ÿé”™è¯¯
- å­—ç¬¦ä¸² **`"x"`** ã€**`"x "`** ã€**`"X"`**æ¯”è¾ƒæ˜¯ä¸ç­‰çš„.å› ä¸ºFreeMarkeræ˜¯ç²¾ç¡®æ¯”è¾ƒ
- å…¶å®ƒçš„è¿è¡Œç¬¦å¯ä»¥ä½œç”¨äºæ•°å­—å’Œæ—¥æœŸ,ä½†ä¸èƒ½ä½œç”¨äºå­—ç¬¦ä¸²
- ä½¿ç”¨**`gt`**ç­‰å­—æ¯è¿ç®—ç¬¦ä»£æ›¿**`>`**ä¼šæœ‰æ›´å¥½çš„æ•ˆæœ,å› ä¸º FreeMarkerä¼šæŠŠ**`>`**è§£é‡ŠæˆFTLæ ‡ç­¾çš„ç»“æŸå­—ç¬¦
- å¯ä»¥ä½¿ç”¨æ‹¬å·æ¥é¿å…è¿™ç§æƒ…å†µ,å¦‚:**`<#if (x>y)>`**

#### 4.3. é€»è¾‘è¿ç®—ç¬¦

- é€»è¾‘ä¸:&& 
- é€»è¾‘æˆ–:|| 
- é€»è¾‘é:! 

é€»è¾‘è¿ç®—ç¬¦åªèƒ½ä½œç”¨äºå¸ƒå°”å€¼,å¦åˆ™å°†äº§ç”Ÿé”™è¯¯ ã€‚

### 5. ç©ºå€¼å¤„ç†

**1ã€åˆ¤æ–­æŸå˜é‡æ˜¯å¦å­˜åœ¨ä½¿ç”¨ â€œ??â€**

ç”¨æ³•ä¸º:variable??,å¦‚æœè¯¥å˜é‡å­˜åœ¨,è¿”å›true,å¦åˆ™è¿”å›false 

ä¾‹ï¼šä¸ºé˜²æ­¢stusä¸ºç©ºæŠ¥é”™å¯ä»¥åŠ ä¸Šåˆ¤æ–­å¦‚ä¸‹ï¼š

**2ã€ç¼ºå¤±å˜é‡é»˜è®¤å€¼ä½¿ç”¨ â€œ!â€**

- ä½¿ç”¨!è¦ä»¥æŒ‡å®šä¸€ä¸ªé»˜è®¤å€¼ï¼Œå½“å˜é‡ä¸ºç©ºæ—¶æ˜¾ç¤ºé»˜è®¤å€¼

  ä¾‹ï¼š  ${name!''}è¡¨ç¤ºå¦‚æœnameä¸ºç©ºæ˜¾ç¤ºç©ºå­—ç¬¦ä¸²ã€‚

- å¦‚æœæ˜¯åµŒå¥—å¯¹è±¡åˆ™å»ºè®®ä½¿ç”¨ï¼ˆï¼‰æ‹¬èµ·æ¥

  ä¾‹ï¼š ${(stu.bestFriend.name)!''}è¡¨ç¤ºï¼Œå¦‚æœstuæˆ–bestFriendæˆ–nameä¸ºç©ºé»˜è®¤æ˜¾ç¤ºç©ºå­—ç¬¦ä¸²ã€‚

### 6. å†…å»ºå‡½æ•°

å†…å»ºå‡½æ•°è¯­æ³•æ ¼å¼ï¼š **`å˜é‡+?+å‡½æ•°åç§°`**  

**1ã€å’Œåˆ°æŸä¸ªé›†åˆçš„å¤§å°**

**`${é›†åˆå?size}`**

**2ã€æ—¥æœŸæ ¼å¼åŒ–**

æ˜¾ç¤ºå¹´æœˆæ—¥: **`${today?date}`** 
æ˜¾ç¤ºæ—¶åˆ†ç§’ï¼š**`${today?time}`**   
æ˜¾ç¤ºæ—¥æœŸ+æ—¶é—´ï¼š**`${today?datetime}`**   
è‡ªå®šä¹‰æ ¼å¼åŒ–ï¼š  **`${today?string("yyyyå¹´MMæœˆ")}`**

**3ã€å†…å»ºå‡½æ•°`c`**

model.addAttribute("point", 102920122);

pointæ˜¯æ•°å­—å‹ï¼Œä½¿ç”¨${point}ä¼šæ˜¾ç¤ºè¿™ä¸ªæ•°å­—çš„å€¼ï¼Œæ¯ä¸‰ä½ä½¿ç”¨é€—å·åˆ†éš”ã€‚

å¦‚æœä¸æƒ³æ˜¾ç¤ºä¸ºæ¯ä¸‰ä½åˆ†éš”çš„æ•°å­—ï¼Œå¯ä»¥ä½¿ç”¨cå‡½æ•°å°†æ•°å­—å‹è½¬æˆå­—ç¬¦ä¸²è¾“å‡º

**`${point?c}`**

**4ã€å°†jsonå­—ç¬¦ä¸²è½¬æˆå¯¹è±¡**

ä¸€ä¸ªä¾‹å­ï¼š

å…¶ä¸­ç”¨åˆ°äº† assignæ ‡ç­¾ï¼Œassignçš„ä½œç”¨æ˜¯å®šä¹‰ä¸€ä¸ªå˜é‡ã€‚

```velocity
<#assign text="{'bank':'å·¥å•†é“¶è¡Œ','account':'10101920201920212'}" />
<#assign data=text?eval />
å¼€æˆ·è¡Œï¼š${data.bank}  è´¦å·ï¼š${data.account}
```

### 7. é™æ€åŒ–æµ‹è¯•

&emsp;ä¹‹å‰çš„æµ‹è¯•éƒ½æ˜¯SpringMVCå°†Freemarkerä½œä¸ºè§†å›¾è§£æå™¨ï¼ˆViewReporterï¼‰æ¥é›†æˆåˆ°é¡¹ç›®ä¸­ï¼Œå·¥ä½œä¸­ï¼Œæœ‰çš„æ—¶å€™éœ€è¦ä½¿ç”¨FreemarkeråŸç”ŸApiæ¥ç”Ÿæˆé™æ€å†…å®¹ï¼Œä¸‹é¢ä¸€èµ·æ¥å­¦ä¹ ä¸‹åŸç”ŸApiç”Ÿæˆæ–‡æœ¬æ–‡ä»¶ã€‚

ä½¿ç”¨freemarkeråŸç”ŸApiå°†é¡µé¢ç”Ÿæˆhtmlæ–‡ä»¶ï¼Œæœ¬èŠ‚æµ‹è¯•htmlæ–‡ä»¶ç”Ÿæˆçš„æ–¹æ³•ï¼š

<div align="center">
    <img src="æˆªå›¾/æ–‡ç« åˆ—è¡¨åŠ è½½/é™æ€åŒ–æµ‹è¯•.png" alt="é™æ€åŒ–æµ‹è¯•" />
</div>

```java
package com.heima.freemarker.test;


import com.heima.freemarker.FreemarkerDemoApplication;
import com.heima.freemarker.entity.Student;
import freemarker.template.Configuration;
import freemarker.template.Template;
import freemarker.template.TemplateException;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.test.context.junit4.SpringRunner;

import java.io.FileWriter;
import java.io.IOException;
import java.util.*;

@SpringBootTest(classes = FreemarkerDemoApplication.class)
@RunWith(SpringRunner.class)
public class FreemarkerTest {

    @Autowired
    private Configuration configuration;

    @Test
    public void test() throws IOException, TemplateException {
        //freemarkerçš„æ¨¡æ¿å¯¹è±¡ï¼Œè·å–æ¨¡æ¿
        Template template = configuration.getTemplate("02-list.ftl");
        Map params = getData();
        //åˆæˆ
        //ç¬¬ä¸€ä¸ªå‚æ•° æ•°æ®æ¨¡å‹
        //ç¬¬äºŒä¸ªå‚æ•°  è¾“å‡ºæµ
        template.process(params, new FileWriter("d:/list.html"));
    }

    private Map getData() {
        Map<String, Object> map = new HashMap<>();

        //å°å¼ºå¯¹è±¡æ¨¡å‹æ•°æ®
        Student stu1 = new Student();
        stu1.setName("å°å¼º");
        stu1.setAge(18);
        stu1.setMoney(1000.86f);
        stu1.setBirthday(new Date());

        //å°çº¢å¯¹è±¡æ¨¡å‹æ•°æ®
        Student stu2 = new Student();
        stu2.setName("å°çº¢");
        stu2.setMoney(200.1f);
        stu2.setAge(19);

        //å°†ä¸¤ä¸ªå¯¹è±¡æ¨¡å‹æ•°æ®å­˜æ”¾åˆ°Listé›†åˆä¸­
        List<Student> stus = new ArrayList<>();
        stus.add(stu1);
        stus.add(stu2);

        //å‘mapä¸­å­˜æ”¾Listé›†åˆæ•°æ®
        map.put("stus", stus);


        //åˆ›å»ºMapæ•°æ®
        HashMap<String, Student> stuMap = new HashMap<>();
        stuMap.put("stu1", stu1);
        stuMap.put("stu2", stu2);
        //å‘mapä¸­å­˜æ”¾Mapæ•°æ®
        map.put("stuMap", stuMap);

        //è¿”å›Map
        return map;
    }
}
```

## ä¸ƒã€å¯¹è±¡å­˜å‚¨æœåŠ¡MinIO 

### 1. MinIOç®€ä»‹   

&emsp;MinIOåŸºäºApache License v2.0å¼€æºåè®®çš„å¯¹è±¡å­˜å‚¨æœåŠ¡ï¼Œå¯ä»¥åšä¸ºäº‘å­˜å‚¨çš„è§£å†³æ–¹æ¡ˆç”¨æ¥ä¿å­˜æµ·é‡çš„å›¾ç‰‡ï¼Œè§†é¢‘ï¼Œæ–‡æ¡£ã€‚ç”±äºé‡‡ç”¨Golangå®ç°ï¼ŒæœåŠ¡ç«¯å¯ä»¥å·¥ä½œåœ¨Windows,Linux, OS Xå’ŒFreeBSDä¸Šã€‚é…ç½®ç®€å•ï¼ŒåŸºæœ¬æ˜¯å¤åˆ¶å¯æ‰§è¡Œç¨‹åºï¼Œå•è¡Œå‘½ä»¤å¯ä»¥è¿è¡Œèµ·æ¥ã€‚

&emsp;MinIOå…¼å®¹äºšé©¬é€ŠS3äº‘å­˜å‚¨æœåŠ¡æ¥å£ï¼Œéå¸¸é€‚åˆäºå­˜å‚¨å¤§å®¹é‡éç»“æ„åŒ–çš„æ•°æ®ï¼Œä¾‹å¦‚å›¾ç‰‡ã€è§†é¢‘ã€æ—¥å¿—æ–‡ä»¶ã€å¤‡ä»½æ•°æ®å’Œå®¹å™¨/è™šæ‹Ÿæœºé•œåƒç­‰ï¼Œè€Œä¸€ä¸ªå¯¹è±¡æ–‡ä»¶å¯ä»¥æ˜¯ä»»æ„å¤§å°ï¼Œä»å‡ kbåˆ°æœ€å¤§5Tä¸ç­‰ã€‚

**S3 ï¼ˆ Simple Storage Serviceç®€å•å­˜å‚¨æœåŠ¡ï¼‰**

åŸºæœ¬æ¦‚å¿µ

- bucket â€“ ç±»æ¯”äºæ–‡ä»¶ç³»ç»Ÿçš„ç›®å½•
- Object â€“ ç±»æ¯”æ–‡ä»¶ç³»ç»Ÿçš„æ–‡ä»¶
- Keys â€“ ç±»æ¯”æ–‡ä»¶å

å®˜ç½‘æ–‡æ¡£ï¼šhttp://docs.minio.org.cn/docs/

### 2. MinIOç‰¹ç‚¹ 

- æ•°æ®ä¿æŠ¤

  Minioä½¿ç”¨Minio Erasure Codeï¼ˆçº åˆ ç ï¼‰æ¥é˜²æ­¢ç¡¬ä»¶æ•…éšœã€‚å³ä¾¿æŸåä¸€åŠä»¥ä¸Šçš„driverï¼Œä½†æ˜¯ä»ç„¶å¯ä»¥ä»ä¸­æ¢å¤ã€‚

- é«˜æ€§èƒ½

  ä½œä¸ºé«˜æ€§èƒ½å¯¹è±¡å­˜å‚¨ï¼Œåœ¨æ ‡å‡†ç¡¬ä»¶æ¡ä»¶ä¸‹å®ƒèƒ½è¾¾åˆ°55GB/sçš„è¯»ã€35GB/sçš„å†™é€Ÿç‡

- å¯æ‰©å®¹

  ä¸åŒMinIOé›†ç¾¤å¯ä»¥ç»„æˆè”é‚¦ï¼Œå¹¶å½¢æˆä¸€ä¸ªå…¨å±€çš„å‘½åç©ºé—´ï¼Œå¹¶è·¨è¶Šå¤šä¸ªæ•°æ®ä¸­å¿ƒ

- SDKæ”¯æŒ

  åŸºäºMinioè½»é‡çš„ç‰¹ç‚¹ï¼Œå®ƒå¾—åˆ°ç±»ä¼¼Javaã€Pythonæˆ–Goç­‰è¯­è¨€çš„sdkæ”¯æŒ

- æœ‰æ“ä½œé¡µé¢

  é¢å‘ç”¨æˆ·å‹å¥½çš„ç®€å•æ“ä½œç•Œé¢ï¼Œéå¸¸æ–¹ä¾¿çš„ç®¡ç†BucketåŠé‡Œé¢çš„æ–‡ä»¶èµ„æº

- åŠŸèƒ½ç®€å•

  è¿™ä¸€è®¾è®¡åŸåˆ™è®©MinIOä¸å®¹æ˜“å‡ºé”™ã€æ›´å¿«å¯åŠ¨

- ä¸°å¯Œçš„API

  æ”¯æŒæ–‡ä»¶èµ„æºçš„åˆ†äº«è¿æ¥åŠåˆ†äº«é“¾æ¥çš„è¿‡æœŸç­–ç•¥ã€å­˜å‚¨æ¡¶æ“ä½œã€æ–‡ä»¶åˆ—è¡¨è®¿é—®åŠæ–‡ä»¶ä¸Šä¼ ä¸‹è½½çš„åŸºæœ¬åŠŸèƒ½ç­‰ã€‚

- æ–‡ä»¶å˜åŒ–ä¸»åŠ¨é€šçŸ¥

  å­˜å‚¨æ¡¶ï¼ˆBucketï¼‰å¦‚æœå‘ç”Ÿæ”¹å˜,æ¯”å¦‚ä¸Šä¼ å¯¹è±¡å’Œåˆ é™¤å¯¹è±¡ï¼Œå¯ä»¥ä½¿ç”¨å­˜å‚¨æ¡¶äº‹ä»¶é€šçŸ¥æœºåˆ¶è¿›è¡Œç›‘æ§ï¼Œå¹¶é€šè¿‡ä»¥ä¸‹æ–¹å¼å‘å¸ƒå‡ºå»:AMQPã€MQTTã€Elasticsearchã€Redisã€NATSã€MySQLã€Kafkaã€Webhooksç­‰ã€‚

### 3. ä½¿ç”¨dockerè¿›è¡Œç¯å¢ƒéƒ¨ç½²å’Œå¯åŠ¨

```bash
docker run -p 9000:9000 --name minio -d --restart=always -e "MINIO_ACCESS_KEY=minio" -e "MINIO_SECRET_KEY=minio123" -v /home/data:/data -v /home/config:/root/.minio minio/minio server /data
```

### 4. æ ¸å¿ƒä»£ç 

```java
package com.heima.file.service.impl;


import com.heima.file.config.MinIOConfig;
import com.heima.file.config.MinIOConfigProperties;
import com.heima.file.service.FileStorageService;
import io.minio.GetObjectArgs;
import io.minio.MinioClient;
import io.minio.PutObjectArgs;
import io.minio.RemoveObjectArgs;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.context.properties.EnableConfigurationProperties;
import org.springframework.context.annotation.Import;
import org.springframework.util.StringUtils;

import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.text.SimpleDateFormat;
import java.util.Date;

@Slf4j
@EnableConfigurationProperties(MinIOConfigProperties.class)
@Import(MinIOConfig.class)
public class MinIOFileStorageService implements FileStorageService {

    @Autowired
    private MinioClient minioClient;

    @Autowired
    private MinIOConfigProperties minIOConfigProperties;

    private final static String separator = "/";

    /**
     * @param dirPath
     * @param filename  yyyy/mm/dd/file.jpg
     * @return
     */
    public String builderFilePath(String dirPath,String filename) {
        StringBuilder stringBuilder = new StringBuilder(50);
        if(!StringUtils.isEmpty(dirPath)){
            stringBuilder.append(dirPath).append(separator);
        }
        SimpleDateFormat sdf = new SimpleDateFormat("yyyy/MM/dd");
        String todayStr = sdf.format(new Date());
        stringBuilder.append(todayStr).append(separator);
        stringBuilder.append(filename);
        return stringBuilder.toString();
    }

    /**
     *  ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶
     * @param prefix  æ–‡ä»¶å‰ç¼€
     * @param filename  æ–‡ä»¶å
     * @param inputStream æ–‡ä»¶æµ
     * @return  æ–‡ä»¶å…¨è·¯å¾„
     */
    @Override
    public String uploadImgFile(String prefix, String filename,InputStream inputStream) {
        String filePath = builderFilePath(prefix, filename);
        try {
            PutObjectArgs putObjectArgs = PutObjectArgs.builder()
                    .object(filePath)
                    .contentType("image/jpg")
                    .bucket(minIOConfigProperties.getBucket()).stream(inputStream,inputStream.available(),-1)
                    .build();
            minioClient.putObject(putObjectArgs);
            StringBuilder urlPath = new StringBuilder(minIOConfigProperties.getReadPath());
            urlPath.append(separator+minIOConfigProperties.getBucket());
            urlPath.append(separator);
            urlPath.append(filePath);
            return urlPath.toString();
        }catch (Exception ex){
            log.error("minio put file error.",ex);
            throw new RuntimeException("ä¸Šä¼ æ–‡ä»¶å¤±è´¥");
        }
    }

    /**
     *  ä¸Šä¼ htmlæ–‡ä»¶
     * @param prefix  æ–‡ä»¶å‰ç¼€
     * @param filename   æ–‡ä»¶å
     * @param inputStream  æ–‡ä»¶æµ
     * @return  æ–‡ä»¶å…¨è·¯å¾„
     */
    @Override
    public String uploadHtmlFile(String prefix, String filename,InputStream inputStream) {
        String filePath = builderFilePath(prefix, filename);
        try {
            PutObjectArgs putObjectArgs = PutObjectArgs.builder()
                    .object(filePath)
                    .contentType("text/html")
                    .bucket(minIOConfigProperties.getBucket()).stream(inputStream,inputStream.available(),-1)
                    .build();
            minioClient.putObject(putObjectArgs);
            StringBuilder urlPath = new StringBuilder(minIOConfigProperties.getReadPath());
            urlPath.append(separator+minIOConfigProperties.getBucket());
            urlPath.append(separator);
            urlPath.append(filePath);
            return urlPath.toString();
        }catch (Exception ex){
            log.error("minio put file error.",ex);
            ex.printStackTrace();
            throw new RuntimeException("ä¸Šä¼ æ–‡ä»¶å¤±è´¥");
        }
    }

    /**
     * åˆ é™¤æ–‡ä»¶
     * @param pathUrl  æ–‡ä»¶å…¨è·¯å¾„
     */
    @Override
    public void delete(String pathUrl) {
        String key = pathUrl.replace(minIOConfigProperties.getEndpoint()+"/","");
        int index = key.indexOf(separator);
        String bucket = key.substring(0,index);
        String filePath = key.substring(index+1);
        // åˆ é™¤Objects
        RemoveObjectArgs removeObjectArgs = RemoveObjectArgs.builder().bucket(bucket).object(filePath).build();
        try {
            minioClient.removeObject(removeObjectArgs);
        } catch (Exception e) {
            log.error("minio remove file error.  pathUrl:{}",pathUrl);
            e.printStackTrace();
        }
    }


    /**
     * ä¸‹è½½æ–‡ä»¶
     * @param pathUrl  æ–‡ä»¶å…¨è·¯å¾„
     * @return  æ–‡ä»¶æµ
     *
     */
    @Override
    public byte[] downLoadFile(String pathUrl)  {
        String key = pathUrl.replace(minIOConfigProperties.getEndpoint()+"/","");
        int index = key.indexOf(separator);
        String bucket = key.substring(0,index);
        String filePath = key.substring(index+1);
        InputStream inputStream = null;
        try {
            inputStream = minioClient.getObject(GetObjectArgs.builder().bucket(minIOConfigProperties.getBucket()).object(filePath).build());
        } catch (Exception e) {
            log.error("minio down file error.  pathUrl:{}",pathUrl);
            e.printStackTrace();
        }

        ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream();
        byte[] buff = new byte[100];
        int rc = 0;
        while (true) {
            try {
                if (!((rc = inputStream.read(buff, 0, 100)) > 0)) break;
            } catch (IOException e) {
                e.printStackTrace();
            }
            byteArrayOutputStream.write(buff, 0, rc);
        }
        return byteArrayOutputStream.toByteArray();
    }
}
```

## å…«ã€æ–‡ç« è¯¦æƒ…

### 1. éœ€æ±‚åˆ†æ

<div align="center">
    <img src="æˆªå›¾/æ–‡ç« åˆ—è¡¨åŠ è½½/æ–‡ç« è¯¦æƒ….png" alt="æ–‡ç« è¯¦æƒ…" />
</div>

### 2. å®ç°æ–¹æ¡ˆ

æ–¹æ¡ˆä¸€

ç”¨æˆ·æŸä¸€æ¡æ–‡ç« ï¼Œæ ¹æ®æ–‡ç« çš„idå»æŸ¥è¯¢æ–‡ç« å†…å®¹è¡¨ï¼Œè¿”å›æ¸²æŸ“é¡µé¢

<div align="center">
    <img src="æˆªå›¾/æ–‡ç« åˆ—è¡¨åŠ è½½/idæŸ¥æ–‡ç« .png" alt="idæŸ¥æ–‡ç« " />
</div>

æ–¹æ¡ˆäºŒ

<div align="center">
    <img src="æˆªå›¾/æ–‡ç« åˆ—è¡¨åŠ è½½/æ–¹æ¡ˆ2.png" alt="æ–¹æ¡ˆ2" />
</div>

### 3. æ ¸å¿ƒä»£ç 

```java
package com.heima.article.test;


import com.alibaba.fastjson.JSONArray;
import com.baomidou.mybatisplus.core.toolkit.Wrappers;
import com.heima.article.ArticleApplication;
import com.heima.article.mapper.ApArticleContentMapper;
import com.heima.article.mapper.ApArticleMapper;
import com.heima.file.service.FileStorageService;
import com.heima.model.article.pojos.ApArticle;
import com.heima.model.article.pojos.ApArticleContent;
import freemarker.template.Configuration;
import freemarker.template.Template;
import org.apache.commons.lang3.StringUtils;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.test.context.junit4.SpringRunner;

import java.io.ByteArrayInputStream;
import java.io.InputStream;
import java.io.StringWriter;
import java.util.HashMap;
import java.util.Map;

@SpringBootTest(classes = ArticleApplication.class)
@RunWith(SpringRunner.class)
public class ArticleFreemarkerTest {

    @Autowired
    private Configuration configuration;

    @Autowired
    private FileStorageService fileStorageService;


    @Autowired
    private ApArticleMapper apArticleMapper;

    @Autowired
    private ApArticleContentMapper apArticleContentMapper;

    @Test
    public void createStaticUrlTest() throws Exception {
        //1.è·å–æ–‡ç« å†…å®¹
        ApArticleContent apArticleContent = apArticleContentMapper.selectOne(Wrappers.<ApArticleContent>lambdaQuery().eq(ApArticleContent::getArticleId, 1390536764510310401L));
        if(apArticleContent != null && StringUtils.isNotBlank(apArticleContent.getContent())){
            //2.æ–‡ç« å†…å®¹é€šè¿‡freemarkerç”Ÿæˆhtmlæ–‡ä»¶
            StringWriter out = new StringWriter();
            Template template = configuration.getTemplate("article.ftl");

            Map<String, Object> params = new HashMap<>();
            params.put("content", JSONArray.parseArray(apArticleContent.getContent()));

            template.process(params, out);
            InputStream is = new ByteArrayInputStream(out.toString().getBytes());

            //3.æŠŠhtmlæ–‡ä»¶ä¸Šä¼ åˆ°minioä¸­
            String path = fileStorageService.uploadHtmlFile("", apArticleContent.getArticleId() + ".html", is);

            //4.ä¿®æ”¹ap_articleè¡¨ï¼Œä¿å­˜static_urlå­—æ®µ
            ApArticle article = new ApArticle();
            article.setId(apArticleContent.getArticleId());
            article.setStaticUrl(path);
            apArticleMapper.updateById(article);

        }
    }
}
```

## ä¹ã€è‡ªåª’ä½“æ–‡ç« å‘å¸ƒ

### 1. åå°æ­å»º

<div align="center">
    <img src="æˆªå›¾/è‡ªåª’ä½“æ–‡ç« å‘å¸ƒ/åå°æ­å»º.png" alt="åå°æ­å»º" />
</div>

### 2. å‰å°æ­å»º

<div align="center">
    <img src="æˆªå›¾/è‡ªåª’ä½“æ–‡ç« å‘å¸ƒ/å‰å°æ­å»º.png" alt="å‰å°æ­å»º" />
</div>

### 3. è‡ªåª’ä½“ç´ æç®¡ç†

#### 3.1 ç´ æä¸Šä¼ 

##### 3.1.1 éœ€æ±‚åˆ†æ

<div align="center">
    <img src="æˆªå›¾/è‡ªåª’ä½“æ–‡ç« å‘å¸ƒ/ç´ æä¸Šä¼ -éœ€æ±‚åˆ†æ.png" alt="ç´ æä¸Šä¼ -éœ€æ±‚åˆ†æ" />
</div>

å›¾ç‰‡ä¸Šä¼ çš„é¡µé¢ï¼Œé¦–å…ˆæ˜¯å±•ç¤ºç´ æä¿¡æ¯ï¼Œå¯ä»¥ç‚¹å‡»å›¾ç‰‡ä¸Šä¼ ï¼Œå¼¹çª—åå¯ä»¥ä¸Šä¼ å›¾ç‰‡

##### 3.1.2 è¡¨ç»“æ„

```mysql
-- auto-generated definition
create table wm_material
(
    id            int unsigned auto_increment comment 'ä¸»é”®'
        primary key,
    user_id       int unsigned     null comment 'è‡ªåª’ä½“ç”¨æˆ·ID',
    url           varchar(255)     null comment 'å›¾ç‰‡åœ°å€',
    type          tinyint unsigned null comment 'ç´ æç±»å‹
            0 å›¾ç‰‡
            1 è§†é¢‘',
    is_collection tinyint(1)       null comment 'æ˜¯å¦æ”¶è—',
    created_time  datetime         null comment 'åˆ›å»ºæ—¶é—´'
)
    comment 'è‡ªåª’ä½“å›¾æ–‡ç´ æä¿¡æ¯è¡¨' collate = utf8mb4_unicode_ci
                                   row_format = DYNAMIC;
```

##### 3.1.3 å®ç°æ€è·¯

<div align="center">
    <img src="æˆªå›¾/è‡ªåª’ä½“æ–‡ç« å‘å¸ƒ/ç´ æä¸Šä¼ -å®ç°æ€è·¯.png" alt="ç´ æä¸Šä¼ -å®ç°æ€è·¯" />
</div>

â‘ ï¼šå‰ç«¯å‘é€ä¸Šä¼ å›¾ç‰‡è¯·æ±‚ï¼Œç±»å‹ä¸ºMultipartFile

â‘¡ï¼šç½‘å…³è¿›è¡Œtokenè§£æåï¼ŒæŠŠè§£æåçš„ç”¨æˆ·ä¿¡æ¯å­˜å‚¨åˆ°headerä¸­

```java
//è·å¾—tokenè§£æåä¸­çš„ç”¨æˆ·ä¿¡æ¯
Object userId = claimsBody.get("id");
//åœ¨headerä¸­æ·»åŠ æ–°çš„ä¿¡æ¯
ServerHttpRequest serverHttpRequest = request.mutate().headers(httpHeaders -> {
    httpHeaders.add("userId", userId + "");
}).build();
//é‡ç½®header
exchange.mutate().request(serverHttpRequest).build();
```

â‘¢ï¼šè‡ªåª’ä½“å¾®æœåŠ¡ä½¿ç”¨æ‹¦æˆªå™¨è·å–åˆ°headerä¸­çš„çš„ç”¨æˆ·ä¿¡æ¯ï¼Œå¹¶æ”¾å…¥åˆ°threadlocalä¸­

åœ¨heima-leadnews-utilsä¸­æ–°å¢å·¥å…·ç±»

```java
package com.heima.utils.thread;

import com.heima.model.wemedia.pojos.WmUser;

public class WmThreadLocalUtil {

    private final static ThreadLocal<WmUser> WM_USER_THREAD_LOCAL = new ThreadLocal<>();

    /**
     * æ·»åŠ ç”¨æˆ·
     * @param wmUser
     */
    public static void  setUser(WmUser wmUser){
        WM_USER_THREAD_LOCAL.set(wmUser);
    }

    /**
     * è·å–ç”¨æˆ·
     */
    public static WmUser getUser(){
        return WM_USER_THREAD_LOCAL.get();
    }

    /**
     * æ¸…ç†ç”¨æˆ·
     */
    public static void clear(){
        WM_USER_THREAD_LOCAL.remove();
    }
}
```

æ–°å¢æ‹¦æˆªå™¨

```java
package com.heima.wemedia.interceptor;

import com.heima.model.wemedia.pojos.WmUser;
import com.heima.utils.thread.WmThreadLocalUtils;
import lombok.extern.slf4j.Slf4j;
import org.springframework.web.servlet.HandlerInterceptor;
import org.springframework.web.servlet.ModelAndView;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.util.Optional;

@Slf4j
public class WmTokenInterceptor implements HandlerInterceptor {
    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {
        //å¾—åˆ°headerä¸­çš„ä¿¡æ¯
        String userId = request.getHeader("userId");
        Optional<String> optional = Optional.ofNullable(userId);
        if(optional.isPresent()){
            //æŠŠç”¨æˆ·idå­˜å…¥threadloaclä¸­
            WmUser wmUser = new WmUser();
            wmUser.setId(Integer.valueOf(userId));
            WmThreadLocalUtils.setUser(wmUser);
            log.info("wmTokenFilterè®¾ç½®ç”¨æˆ·ä¿¡æ¯åˆ°threadlocalä¸­...");
        }

        return true;
    }

    @Override
    public void postHandle(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView) throws Exception {
        log.info("æ¸…ç†threadlocal...");
        WmThreadLocalUtils.clear();
    }
}
```

é…ç½®ä½¿æ‹¦æˆªå™¨ç”Ÿæ•ˆï¼Œæ‹¦æˆªæ‰€æœ‰çš„è¯·æ±‚

```java
package com.heima.wemedia.config;

import com.heima.wemedia.interceptor.WmTokenInterceptor;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.InterceptorRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

@Configuration
public class WebMvcConfig implements WebMvcConfigurer {

    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(new WmTokenInterceptor()).addPathPatterns("/**");
    }
}
```

â‘£ï¼šå…ˆæŠŠå›¾ç‰‡ä¸Šä¼ åˆ°minIOä¸­ï¼Œè·å–åˆ°å›¾ç‰‡è¯·æ±‚çš„è·¯å¾„

â‘¤ï¼šæŠŠç”¨æˆ·idå’Œå›¾ç‰‡ä¸Šçš„è·¯å¾„ä¿å­˜åˆ°ç´ æè¡¨ä¸­

##### 3.1.4 æ¥å£å®šä¹‰

|          | **è¯´æ˜**                        |
| -------- | ------------------------------- |
| æ¥å£è·¯å¾„ | /api/v1/material/upload_picture |
| è¯·æ±‚æ–¹å¼ | POST                            |
| å‚æ•°     | MultipartFile                   |
| å“åº”ç»“æœ | ResponseResult                  |

MultipartFile  ï¼šSpringmvcæŒ‡å®šçš„æ–‡ä»¶æ¥æ”¶ç±»å‹

ResponseResult  ï¼šæˆåŠŸéœ€è¦**å›æ˜¾å›¾ç‰‡**ï¼Œè¿”å›ç´ æå¯¹è±¡

```json
{
  "host":null,
  "code":200,
  "errorMessage":"æ“ä½œæˆåŠŸ",
  "data":{
    "id":52,
    "userId":1102,
    "url":"http://192.168.200.130:9000/leadnews/2021/04/26/a73f5b60c0d84c32bfe175055aaaac40.jpg",
    "type":0,
    "isCollection":0,
    "createdTime":"2021-01-20T16:49:48.443+0000"
  }
}
```

å¤±è´¥ï¼š

- å‚æ•°å¤±æ•ˆ
- æ–‡ç« ä¸Šä¼ å¤±è´¥

##### 3.1.5 æ ¸å¿ƒä»£ç 

```java
package com.heima.wemedia.service.impl;


import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.heima.file.service.FileStorageService;
import com.heima.model.common.dtos.ResponseResult;
import com.heima.model.common.enums.AppHttpCodeEnum;
import com.heima.model.wemedia.pojos.WmMaterial;
import com.heima.utils.thread.WmThreadLocalUtil;
import com.heima.wemedia.mapper.WmMaterialMapper;
import com.heima.wemedia.service.WmMaterialService;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.web.multipart.MultipartFile;

import java.io.IOException;
import java.util.Date;
import java.util.UUID;

@Slf4j
@Service
@Transactional
public class WmMaterialServiceImpl extends ServiceImpl<WmMaterialMapper, WmMaterial> implements WmMaterialService {

    @Autowired
    private FileStorageService fileStorageService;


    /**
     * å›¾ç‰‡ä¸Šä¼ 
     * @param multipartFile
     * @return
     */
    @Override
    public ResponseResult uploadPicture(MultipartFile multipartFile) {

        //1.æ£€æŸ¥å‚æ•°
        if(multipartFile == null || multipartFile.getSize() == 0){
            return ResponseResult.errorResult(AppHttpCodeEnum.PARAM_INVALID);
        }

        //2.ä¸Šä¼ å›¾ç‰‡åˆ°minIOä¸­
        String fileName = UUID.randomUUID().toString().replace("-", "");
        //aa.jpg
        String originalFilename = multipartFile.getOriginalFilename();
        String postfix = originalFilename.substring(originalFilename.lastIndexOf("."));
        String fileId = null;
        try {
            fileId = fileStorageService.uploadImgFile("", fileName + postfix, multipartFile.getInputStream());
            log.info("ä¸Šä¼ å›¾ç‰‡åˆ°MinIOä¸­ï¼ŒfileId:{}",fileId);
        } catch (IOException e) {
            e.printStackTrace();
            log.error("WmMaterialServiceImpl-ä¸Šä¼ æ–‡ä»¶å¤±è´¥");
        }

        //3.ä¿å­˜åˆ°æ•°æ®åº“ä¸­
        WmMaterial wmMaterial = new WmMaterial();
        wmMaterial.setUserId(WmThreadLocalUtil.getUser().getId());
        wmMaterial.setUrl(fileId);
        wmMaterial.setIsCollection((short)0);
        wmMaterial.setType((short)0);
        wmMaterial.setCreatedTime(new Date());
        save(wmMaterial);

        //4.è¿”å›ç»“æœ

        return ResponseResult.okResult(wmMaterial);
    }

}
```

#### 3.2 ç´ æåˆ—è¡¨æŸ¥è¯¢

##### 3.2.1 æ ¸å¿ƒä»£ç 

```java
/**
     * ç´ æåˆ—è¡¨æŸ¥è¯¢
     * @param dto
     * @return
     */
@Override
public ResponseResult findList(WmMaterialDto dto) {

    //1.æ£€æŸ¥å‚æ•°
    dto.checkParam();

    //2.åˆ†é¡µæŸ¥è¯¢
    IPage page = new Page(dto.getPage(),dto.getSize());
    LambdaQueryWrapper<WmMaterial> lambdaQueryWrapper = new LambdaQueryWrapper<>();
    //æ˜¯å¦æ”¶è—
    if(dto.getIsCollection() != null && dto.getIsCollection() == 1){
        lambdaQueryWrapper.eq(WmMaterial::getIsCollection,dto.getIsCollection());
    }

    //æŒ‰ç…§ç”¨æˆ·æŸ¥è¯¢
    lambdaQueryWrapper.eq(WmMaterial::getUserId,WmThreadLocalUtil.getUser().getId());

    //æŒ‰ç…§æ—¶é—´å€’åº
    lambdaQueryWrapper.orderByDesc(WmMaterial::getCreatedTime);


    page = page(page,lambdaQueryWrapper);

    //3.ç»“æœè¿”å›
    ResponseResult responseResult = new PageResponseResult(dto.getPage(),dto.getSize(),(int)page.getTotal());
    responseResult.setData(page.getRecords());
    return responseResult;
}
```

### 4. è‡ªåª’ä½“æ–‡ç« ç®¡ç†

#### 4.1 æŸ¥è¯¢æ‰€æœ‰é¢‘é“

##### 4.1.1 éœ€æ±‚åˆ†æ

<div align="center">
    <img src="æˆªå›¾/è‡ªåª’ä½“æ–‡ç« å‘å¸ƒ/è‡ªåª’ä½“æ–‡ç« ç®¡ç†-éœ€æ±‚åˆ†æ.png" alt="è‡ªåª’ä½“æ–‡ç« ç®¡ç†-éœ€æ±‚åˆ†æ" />
</div>

##### 4.1.2 è¡¨ç»“æ„

wm_channel é¢‘é“ä¿¡æ¯è¡¨

```mysql
-- auto-generated definition
create table wm_channel
(
    id           int unsigned auto_increment
        primary key,
    name         varchar(10)      null comment 'é¢‘é“åç§°',
    description  varchar(255)     null comment 'é¢‘é“æè¿°',
    is_default   tinyint unsigned null comment 'æ˜¯å¦é»˜è®¤é¢‘é“',
    status       tinyint unsigned null,
    ord          tinyint unsigned null comment 'é»˜è®¤æ’åº',
    created_time datetime         null comment 'åˆ›å»ºæ—¶é—´'
)
    comment 'é¢‘é“ä¿¡æ¯è¡¨' collate = utf8mb4_unicode_ci
                         row_format = DYNAMIC;
```

##### 4.1.3 æ¥å£å®šä¹‰

|          | **è¯´æ˜**                 |
| -------- | ------------------------ |
| æ¥å£è·¯å¾„ | /api/v1/channel/channels |
| è¯·æ±‚æ–¹å¼ | POST                     |
| å‚æ•°     | æ—                        |
| å“åº”ç»“æœ | ResponseResult           |

ResponseResult  ï¼š

```json
{
  "host": "null",
  "code": 0,
  "errorMessage": "æ“ä½œæˆåŠŸ",
  "data": [
    {
      "id": 4,
      "name": "java",
      "description": "java",
      "isDefault": true,
      "status": false,
      "ord": 3,
      "createdTime": "2019-08-16T10:55:41.000+0000"
    },
    Object {  ... },
    Object {  ... }
  ]
}
```

##### 4.1.4 æ ¸å¿ƒä»£ç 

```java
package com.heima.wemedia.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.heima.model.common.dtos.ResponseResult;
import com.heima.model.wemedia.pojos.WmChannel;
import com.heima.wemedia.mapper.WmChannelMapper;
import com.heima.wemedia.service.WmChannelService;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

@Service
@Transactional
@Slf4j
public class WmChannelServiceImpl extends ServiceImpl<WmChannelMapper, WmChannel> implements WmChannelService {

    /**
     * æŸ¥è¯¢æ‰€æœ‰é¢‘é“
     * @return
     */
    @Override
    public ResponseResult findAll() {
        return ResponseResult.okResult(list());
    }
}
```

#### 4.2 æŸ¥è¯¢è‡ªåª’ä½“æ–‡ç« 

##### 4.2.1 éœ€æ±‚è¯´æ˜

<div align="center">
    <img src="æˆªå›¾/è‡ªåª’ä½“æ–‡ç« å‘å¸ƒ/æŸ¥è¯¢è‡ªåª’ä½“æ–‡ç« -éœ€æ±‚è¯´æ˜.png" alt="æŸ¥è¯¢è‡ªåª’ä½“æ–‡ç« -éœ€æ±‚è¯´æ˜" />
</div>

##### 4.2.2 è¡¨ç»“æ„åˆ†æ

wm_news è‡ªåª’ä½“æ–‡ç« è¡¨

```mysql
-- auto-generated definition
create table wm_news
(
    id            int auto_increment comment 'ä¸»é”®'
        primary key,
    user_id       int unsigned                 null comment 'è‡ªåª’ä½“ç”¨æˆ·ID',
    title         varchar(36)                  null comment 'æ ‡é¢˜',
    content       longtext                     null comment 'å›¾æ–‡å†…å®¹',
    type          tinyint unsigned             null comment 'æ–‡ç« å¸ƒå±€
            0 æ— å›¾æ–‡ç« 
            1 å•å›¾æ–‡ç« 
            3 å¤šå›¾æ–‡ç« ',
    channel_id    int unsigned                 null comment 'å›¾æ–‡é¢‘é“ID',
    labels        varchar(20)                  null,
    created_time  datetime                     null comment 'åˆ›å»ºæ—¶é—´',
    submited_time datetime                     null comment 'æäº¤æ—¶é—´',
    status        tinyint unsigned             null comment 'å½“å‰çŠ¶æ€
            0 è‰ç¨¿
            1 æäº¤ï¼ˆå¾…å®¡æ ¸ï¼‰
            2 å®¡æ ¸å¤±è´¥
            3 äººå·¥å®¡æ ¸
            4 äººå·¥å®¡æ ¸é€šè¿‡
            8 å®¡æ ¸é€šè¿‡ï¼ˆå¾…å‘å¸ƒï¼‰
            9 å·²å‘å¸ƒ',
    publish_time  datetime                     null comment 'å®šæ—¶å‘å¸ƒæ—¶é—´ï¼Œä¸å®šæ—¶åˆ™ä¸ºç©º',
    reason        varchar(50)                  null comment 'æ‹’ç»ç†ç”±',
    article_id    bigint unsigned              null comment 'å‘å¸ƒåº“æ–‡ç« ID',
    images        longtext                     null comment '//å›¾ç‰‡ç”¨é€—å·åˆ†éš”',
    enable        tinyint unsigned default '1' null
)
    comment 'è‡ªåª’ä½“å›¾æ–‡å†…å®¹ä¿¡æ¯è¡¨' collate = utf8mb4_unicode_ci
                                   row_format = DYNAMIC;
```

##### 4.2.3 æšä¸¾ç±»

```java
//çŠ¶æ€æšä¸¾ç±»
    @Alias("WmNewsStatus")
    public enum Status{
        NORMAL((short)0),SUBMIT((short)1),FAIL((short)2),ADMIN_AUTH((short)3),ADMIN_SUCCESS((short)4),SUCCESS((short)8),PUBLISHED((short)9);
        short code;
        Status(short code){
            this.code = code;
        }
        public short getCode(){
            return this.code;
        }
    }
```

##### 4.2.4 æ¥å£å®šä¹‰

|          | **è¯´æ˜**          |
| -------- | ----------------- |
| æ¥å£è·¯å¾„ | /api/v1/news/list |
| è¯·æ±‚æ–¹å¼ | POST              |
| å‚æ•°     | WmNewsPageReqDto  |
| å“åº”ç»“æœ | ResponseResult    |

WmNewsPageReqDto  :

```java
package com.heima.model.wemedia.dtos;

import com.heima.model.common.dtos.PageRequestDto;
import lombok.Data;

import java.util.Date;

@Data
public class WmNewsPageReqDto extends PageRequestDto {

    /**
     * çŠ¶æ€
     */
    private Short status;
    /**
     * å¼€å§‹æ—¶é—´
     */
    private Date beginPubDate;
    /**
     * ç»“æŸæ—¶é—´
     */
    private Date endPubDate;
    /**
     * æ‰€å±é¢‘é“ID
     */
    private Integer channelId;
    /**
     * å…³é”®å­—
     */
    private String keyword;
}
```

ResponseResult  :

```json
{
  "host": "null",
  "code": 0,
  "errorMessage": "æ“ä½œæˆåŠŸ",
  "data": [
    Object { ... },
    Object { ... },
    Object { ... }
    
  ],
  "currentPage":1,
  "size":10,
  "total":21
}
```

##### 4.2.5 æ ¸å¿ƒä»£ç 

```java
package com.heima.wemedia.service.impl;

import com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.heima.model.common.dtos.PageResponseResult;
import com.heima.model.common.dtos.ResponseResult;
import com.heima.model.common.enums.AppHttpCodeEnum;
import com.heima.model.wemedia.dtos.WmNewsPageReqDto;
import com.heima.model.wemedia.pojos.WmNews;
import com.heima.model.wemedia.pojos.WmUser;
import com.heima.utils.thread.WmThreadLocalUtil;
import com.heima.wemedia.mapper.WmNewsMapper;
import com.heima.wemedia.service.WmNewsService;
import lombok.extern.slf4j.Slf4j;
import org.apache.commons.lang3.StringUtils;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

@Service
@Slf4j
@Transactional
public class WmNewsServiceImpl  extends ServiceImpl<WmNewsMapper, WmNews> implements WmNewsService {

    /**
     * æŸ¥è¯¢æ–‡ç« 
     * @param dto
     * @return
     */
    @Override
    public ResponseResult findAll(WmNewsPageReqDto dto) {

        //1.æ£€æŸ¥å‚æ•°
        if(dto == null){
            return ResponseResult.errorResult(AppHttpCodeEnum.PARAM_INVALID);
        }
        //åˆ†é¡µå‚æ•°æ£€æŸ¥
        dto.checkParam();
        //è·å–å½“å‰ç™»å½•äººçš„ä¿¡æ¯
        WmUser user = WmThreadLocalUtil.getUser();
        if(user == null){
            return ResponseResult.errorResult(AppHttpCodeEnum.NEED_LOGIN);
        }

        //2.åˆ†é¡µæ¡ä»¶æŸ¥è¯¢
        IPage page = new Page(dto.getPage(),dto.getSize());
        LambdaQueryWrapper<WmNews> lambdaQueryWrapper = new LambdaQueryWrapper<>();
        //çŠ¶æ€ç²¾ç¡®æŸ¥è¯¢
        if(dto.getStatus() != null){
            lambdaQueryWrapper.eq(WmNews::getStatus,dto.getStatus());
        }

        //é¢‘é“ç²¾ç¡®æŸ¥è¯¢
        if(dto.getChannelId() != null){
            lambdaQueryWrapper.eq(WmNews::getChannelId,dto.getChannelId());
        }

        //æ—¶é—´èŒƒå›´æŸ¥è¯¢
        if(dto.getBeginPubDate()!=null && dto.getEndPubDate()!=null){
            lambdaQueryWrapper.between(WmNews::getPublishTime,dto.getBeginPubDate(),dto.getEndPubDate());
        }

        //å…³é”®å­—æ¨¡ç³ŠæŸ¥è¯¢
        if(StringUtils.isNotBlank(dto.getKeyword())){
            lambdaQueryWrapper.like(WmNews::getTitle,dto.getKeyword());
        }

        //æŸ¥è¯¢å½“å‰ç™»å½•ç”¨æˆ·çš„æ–‡ç« 
        lambdaQueryWrapper.eq(WmNews::getUserId,user.getId());

        //å‘å¸ƒæ—¶é—´å€’åºæŸ¥è¯¢
        lambdaQueryWrapper.orderByDesc(WmNews::getCreatedTime);

        page = page(page,lambdaQueryWrapper);

        //3.ç»“æœè¿”å›
        ResponseResult responseResult = new PageResponseResult(dto.getPage(),dto.getSize(),(int)page.getTotal());
        responseResult.setData(page.getRecords());

        return responseResult;
    }
   
}
```

#### 4.3 æ–‡ç« å‘å¸ƒ

##### 4.3.1 éœ€æ±‚åˆ†æ

<div align="center">
    <img src="æˆªå›¾/è‡ªåª’ä½“æ–‡ç« å‘å¸ƒ/æ–‡ç« å‘å¸ƒ-éœ€æ±‚åˆ†æ.png" alt="æ–‡ç« å‘å¸ƒ-éœ€æ±‚åˆ†æ" />
</div>


##### 4.3.2 è¡¨ç»“æ„åˆ†æ

ä¿å­˜æ–‡ç« ï¼Œé™¤äº†éœ€è¦wm_newsè¡¨ä»¥å¤–ï¼Œè¿˜éœ€è¦å¦å¤–ä¸¤å¼ è¡¨

wm_material ç´ æè¡¨

```mysql
-- auto-generated definition
create table wm_material
(
    id            int unsigned auto_increment comment 'ä¸»é”®'
        primary key,
    user_id       int unsigned     null comment 'è‡ªåª’ä½“ç”¨æˆ·ID',
    url           varchar(255)     null comment 'å›¾ç‰‡åœ°å€',
    type          tinyint unsigned null comment 'ç´ æç±»å‹
            0 å›¾ç‰‡
            1 è§†é¢‘',
    is_collection tinyint(1)       null comment 'æ˜¯å¦æ”¶è—',
    created_time  datetime         null comment 'åˆ›å»ºæ—¶é—´'
)
    comment 'è‡ªåª’ä½“å›¾æ–‡ç´ æä¿¡æ¯è¡¨' collate = utf8mb4_unicode_ci
                                   row_format = DYNAMIC;
```

wm_news_material æ–‡ç« ç´ æå…³ç³»è¡¨

```mysql
-- auto-generated definition
create table wm_news_material
(
    id          int unsigned auto_increment comment 'ä¸»é”®'
        primary key,
    material_id int unsigned     null comment 'ç´ æID',
    news_id     int unsigned     null comment 'å›¾æ–‡ID',
    type        tinyint unsigned null comment 'å¼•ç”¨ç±»å‹
            0 å†…å®¹å¼•ç”¨
            1 ä¸»å›¾å¼•ç”¨',
    ord         tinyint unsigned null comment 'å¼•ç”¨æ’åº'
)
    comment 'è‡ªåª’ä½“å›¾æ–‡å¼•ç”¨ç´ æä¿¡æ¯è¡¨' collate = utf8mb4_unicode_ci
                                       row_format = DYNAMIC;
```

å› ä¸ºä¸€ç¯‡æ–‡ç« å¯ä»¥å¼•ç”¨å¤šå¼ ç´ æï¼Œä¸€å¼ ç´ æä¹Ÿå¯ä»¥è¢«å¤šç¯‡æ–‡ç« å¼•ç”¨ï¼Œå³wm_newsè¡¨ä¸wm_materialè¡¨æ˜¯**å¤šå¯¹å¤š**çš„å…³ç³»ï¼Œéœ€è¦wm_news_material ä¸­é—´è¡¨æ¥ç»´æŠ¤ä¸¤è€…å…³ç³»

<div align="center">
    <img src="æˆªå›¾/è‡ªåª’ä½“æ–‡ç« å‘å¸ƒ/ä¸‰è¡¨å…³ç³».png" alt="ä¸‰è¡¨å…³ç³»" />
</div>

##### 4.3.3 å®ç°æ€è·¯

<div align="center">
    <img src="æˆªå›¾/è‡ªåª’ä½“æ–‡ç« å‘å¸ƒ/æ–‡ç« å‘å¸ƒ-å®ç°æ€è·¯.png" alt="æ–‡ç« å‘å¸ƒ-å®ç°æ€è·¯" />
</div>
1.å‰ç«¯æäº¤å‘å¸ƒæˆ–ä¿å­˜ä¸ºè‰ç¨¿

2.åå°åˆ¤æ–­è¯·æ±‚ä¸­æ˜¯å¦åŒ…å«äº†æ–‡ç« id

3.å¦‚æœä¸åŒ…å«id,åˆ™ä¸ºæ–°å¢

â€‹	3.1 æ‰§è¡Œæ–°å¢æ–‡ç« çš„æ“ä½œ

â€‹	3.2 å…³è”æ–‡ç« å†…å®¹å›¾ç‰‡ä¸ç´ æçš„å…³ç³»

â€‹	3.3 å…³è”æ–‡ç« å°é¢å›¾ç‰‡ä¸ç´ æçš„å…³ç³»

4.å¦‚æœåŒ…å«äº†idï¼Œåˆ™ä¸ºä¿®æ”¹è¯·æ±‚

â€‹	4.1 åˆ é™¤è¯¥æ–‡ç« ä¸ç´ æçš„æ‰€æœ‰å…³ç³»

â€‹	4.2 æ‰§è¡Œä¿®æ”¹æ“ä½œ

â€‹	4.3 å…³è”æ–‡ç« å†…å®¹å›¾ç‰‡ä¸ç´ æçš„å…³ç³»

â€‹	4.4 å…³è”æ–‡ç« å°é¢å›¾ç‰‡ä¸ç´ æçš„å…³ç³»

##### 4.3.4 æ¥å£å®šä¹‰

|          | **è¯´æ˜**               |
| -------- | ---------------------- |
| æ¥å£è·¯å¾„ | /api/v1/channel/submit |
| è¯·æ±‚æ–¹å¼ | POST                   |
| å‚æ•°     | WmNewsDto              |
| å“åº”ç»“æœ | ResponseResult         |

WmNewsDto  

```java
package com.heima.model.wemedia.dtos;

import lombok.Data;

import java.util.Date;
import java.util.List;

@Data
public class WmNewsDto {
    
    private Integer id;
     /**
     * æ ‡é¢˜
     */
    private String title;
     /**
     * é¢‘é“id
     */
    private Integer channelId;
     /**
     * æ ‡ç­¾
     */
    private String labels;
     /**
     * å‘å¸ƒæ—¶é—´
     */
    private Date publishTime;
     /**
     * æ–‡ç« å†…å®¹
     */
    private String content;
     /**
     * æ–‡ç« å°é¢ç±»å‹  0 æ— å›¾ 1 å•å›¾ 3 å¤šå›¾ -1 è‡ªåŠ¨
     */
    private Short type;
     /**
     * æäº¤æ—¶é—´
     */
    private Date submitedTime; 
     /**
     * çŠ¶æ€ æäº¤ä¸º1  è‰ç¨¿ä¸º0
     */
    private Short status;
     
     /**
     * å°é¢å›¾ç‰‡åˆ—è¡¨ å¤šå¼ å›¾ä»¥é€—å·éš”å¼€
     */
    private List<String> images;
}
```

å‰ç«¯ç»™ä¼ é€’è¿‡æ¥çš„jsonæ•°æ®æ ¼å¼ä¸ºï¼š

```json
{
    "title":"é»‘é©¬å¤´æ¡é¡¹ç›®èƒŒæ™¯",
    "type":"1",//è¿™ä¸ª 0 æ˜¯æ— å›¾  1 æ˜¯å•å›¾  3 æ˜¯å¤šå›¾  -1 æ˜¯è‡ªåŠ¨
    "labels":"é»‘é©¬å¤´æ¡",
    "publishTime":"2020-03-14T11:35:49.000Z",
    "channelId":1,
    "images":[
        "http://192.168.200.130/group1/M00/00/00/wKjIgl5swbGATaSAAAEPfZfx6Iw790.png"
    ],
    "status":1,
    "content":"[
    {
        "type":"text",
        "value":"éšç€æ™ºèƒ½æ‰‹æœºçš„æ™®åŠï¼Œäººä»¬æ›´åŠ ä¹ æƒ¯äºé€šè¿‡æ‰‹æœºæ¥çœ‹æ–°é—»ã€‚ç”±äºç”Ÿæ´»èŠ‚å¥çš„åŠ å¿«ï¼Œå¾ˆå¤šäººåªèƒ½åˆ©ç”¨ç¢ç‰‡æ—¶é—´æ¥è·å–ä¿¡æ¯ï¼Œå› æ­¤ï¼Œå¯¹äºç§»åŠ¨èµ„è®¯å®¢æˆ·ç«¯çš„éœ€æ±‚ä¹Ÿè¶Šæ¥è¶Šé«˜ã€‚é»‘é©¬å¤´æ¡é¡¹ç›®æ­£æ˜¯åœ¨è¿™æ ·èƒŒæ™¯ä¸‹å¼€å‘å‡ºæ¥ã€‚é»‘é©¬å¤´æ¡é¡¹ç›®é‡‡ç”¨å½“ä¸‹ç«çƒ­çš„å¾®æœåŠ¡+å¤§æ•°æ®æŠ€æœ¯æ¶æ„å®ç°ã€‚æœ¬é¡¹ç›®ä¸»è¦ç€æ‰‹äºè·å–æœ€æ–°æœ€çƒ­æ–°é—»èµ„è®¯ï¼Œé€šè¿‡å¤§æ•°æ®åˆ†æç”¨æˆ·å–œå¥½ç²¾ç¡®æ¨é€å’¨è¯¢æ–°é—»"
    },
    {
        "type":"image",
        "value":"http://192.168.200.130/group1/M00/00/00/wKjIgl5swbGATaSAAAEPfZfx6Iw790.png"
    }
]"
}
```

ResponseResult:

```json
{
    â€œcodeâ€:501,
    â€œerrorMessageâ€:â€œå‚æ•°å¤±æ•ˆ"
}

{
    â€œcodeâ€:200,
    â€œerrorMessageâ€:â€œæ“ä½œæˆåŠŸ"
}

{
    â€œcodeâ€:501,
    â€œerrorMessageâ€:â€œç´ æå¼•ç”¨å¤±æ•ˆ"
}
```

##### 4.3.5 æ ¸å¿ƒä»£ç 

æ–°å¢WmNewsMaterialMapperç±»ï¼Œæ–‡ç« ä¸ç´ æçš„å…³è”å…³ç³»éœ€è¦æ‰¹é‡ä¿å­˜ï¼Œç´¢å¼•éœ€è¦å®šä¹‰mapperæ–‡ä»¶å’Œå¯¹åº”çš„æ˜ å°„æ–‡ä»¶

```java
package com.heima.wemedia.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.heima.model.wemedia.pojos.WmNewsMaterial;
import org.apache.ibatis.annotations.Mapper;
import org.apache.ibatis.annotations.Param;

import java.util.List;

@Mapper
public interface WmNewsMaterialMapper extends BaseMapper<WmNewsMaterial> {

     void saveRelations(@Param("materialIds") List<Integer> materialIds,@Param("newsId") Integer newsId, @Param("type")Short type);
}
```

WmNewsMaterialMapper.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.heima.wemedia.mapper.WmNewsMaterialMapper">

    <insert id="saveRelations">
        insert into wm_news_material (material_id,news_id,type,ord)
        values
        <foreach collection="materialIds" index="ord" item="mid" separator=",">
            (#{mid},#{newsId},#{type},#{ord})
        </foreach>
    </insert>

</mapper>
```

å®ç°æ–¹æ³•ï¼š

```java
/**
     * å‘å¸ƒä¿®æ”¹æ–‡ç« æˆ–ä¿å­˜ä¸ºè‰ç¨¿
     * @param dto
     * @return
     */
@Override
public ResponseResult submitNews(WmNewsDto dto) {

    //0.æ¡ä»¶åˆ¤æ–­
    if(dto == null || dto.getContent() == null){
        return ResponseResult.errorResult(AppHttpCodeEnum.PARAM_INVALID);
    }

    //1.ä¿å­˜æˆ–ä¿®æ”¹æ–‡ç« 

    WmNews wmNews = new WmNews();
    //å±æ€§æ‹·è´ å±æ€§åè¯å’Œç±»å‹ç›¸åŒæ‰èƒ½æ‹·è´
    BeanUtils.copyProperties(dto,wmNews);
    //å°é¢å›¾ç‰‡  list---> string
    if(dto.getImages() != null && dto.getImages().size() > 0){
        //[1dddfsd.jpg,sdlfjldk.jpg]-->   1dddfsd.jpg,sdlfjldk.jpg
        String imageStr = StringUtils.join(dto.getImages(), ",");
        wmNews.setImages(imageStr);
    }
    //å¦‚æœå½“å‰å°é¢ç±»å‹ä¸ºè‡ªåŠ¨ -1
    if(dto.getType().equals(WemediaConstants.WM_NEWS_TYPE_AUTO)){
        wmNews.setType(null);
    }

    saveOrUpdateWmNews(wmNews);

    //2.åˆ¤æ–­æ˜¯å¦ä¸ºè‰ç¨¿  å¦‚æœä¸ºè‰ç¨¿ç»“æŸå½“å‰æ–¹æ³•
    if(dto.getStatus().equals(WmNews.Status.NORMAL.getCode())){
        return ResponseResult.okResult(AppHttpCodeEnum.SUCCESS);
    }

    //3.ä¸æ˜¯è‰ç¨¿ï¼Œä¿å­˜æ–‡ç« å†…å®¹å›¾ç‰‡ä¸ç´ æçš„å…³ç³»
    //è·å–åˆ°æ–‡ç« å†…å®¹ä¸­çš„å›¾ç‰‡ä¿¡æ¯
    List<String> materials =  ectractUrlInfo(dto.getContent());
    saveRelativeInfoForContent(materials,wmNews.getId());

    //4.ä¸æ˜¯è‰ç¨¿ï¼Œä¿å­˜æ–‡ç« å°é¢å›¾ç‰‡ä¸ç´ æçš„å…³ç³»ï¼Œå¦‚æœå½“å‰å¸ƒå±€æ˜¯è‡ªåŠ¨ï¼Œéœ€è¦åŒ¹é…å°é¢å›¾ç‰‡
    saveRelativeInfoForCover(dto,wmNews,materials);

    return ResponseResult.okResult(AppHttpCodeEnum.SUCCESS);

}

/**
     * ç¬¬ä¸€ä¸ªåŠŸèƒ½ï¼šå¦‚æœå½“å‰å°é¢ç±»å‹ä¸ºè‡ªåŠ¨ï¼Œåˆ™è®¾ç½®å°é¢ç±»å‹çš„æ•°æ®
     * åŒ¹é…è§„åˆ™ï¼š
     * 1ï¼Œå¦‚æœå†…å®¹å›¾ç‰‡å¤§äºç­‰äº1ï¼Œå°äº3  å•å›¾  type 1
     * 2ï¼Œå¦‚æœå†…å®¹å›¾ç‰‡å¤§äºç­‰äº3  å¤šå›¾  type 3
     * 3ï¼Œå¦‚æœå†…å®¹æ²¡æœ‰å›¾ç‰‡ï¼Œæ— å›¾  type 0
     *
     * ç¬¬äºŒä¸ªåŠŸèƒ½ï¼šä¿å­˜å°é¢å›¾ç‰‡ä¸ç´ æçš„å…³ç³»
     * @param dto
     * @param wmNews
     * @param materials
     */
private void saveRelativeInfoForCover(WmNewsDto dto, WmNews wmNews, List<String> materials) {

    List<String> images = dto.getImages();

    //å¦‚æœå½“å‰å°é¢ç±»å‹ä¸ºè‡ªåŠ¨ï¼Œåˆ™è®¾ç½®å°é¢ç±»å‹çš„æ•°æ®
    if(dto.getType().equals(WemediaConstants.WM_NEWS_TYPE_AUTO)){
        //å¤šå›¾
        if(materials.size() >= 3){
            wmNews.setType(WemediaConstants.WM_NEWS_MANY_IMAGE);
            images = materials.stream().limit(3).collect(Collectors.toList());
        }else if(materials.size() >= 1 && materials.size() < 3){
            //å•å›¾
            wmNews.setType(WemediaConstants.WM_NEWS_SINGLE_IMAGE);
            images = materials.stream().limit(1).collect(Collectors.toList());
        }else {
            //æ— å›¾
            wmNews.setType(WemediaConstants.WM_NEWS_NONE_IMAGE);
        }

        //ä¿®æ”¹æ–‡ç« 
        if(images != null && images.size() > 0){
            wmNews.setImages(StringUtils.join(images,","));
        }
        updateById(wmNews);
    }
    if(images != null && images.size() > 0){
        saveRelativeInfo(images,wmNews.getId(),WemediaConstants.WM_COVER_REFERENCE);
    }

}


/**
     * å¤„ç†æ–‡ç« å†…å®¹å›¾ç‰‡ä¸ç´ æçš„å…³ç³»
     * @param materials
     * @param newsId
     */
private void saveRelativeInfoForContent(List<String> materials, Integer newsId) {
    saveRelativeInfo(materials,newsId,WemediaConstants.WM_CONTENT_REFERENCE);
}

@Autowired
private WmMaterialMapper wmMaterialMapper;

/**
     * ä¿å­˜æ–‡ç« å›¾ç‰‡ä¸ç´ æçš„å…³ç³»åˆ°æ•°æ®åº“ä¸­
     * @param materials
     * @param newsId
     * @param type
     */
private void saveRelativeInfo(List<String> materials, Integer newsId, Short type) {
    if(materials!=null && !materials.isEmpty()){
        //é€šè¿‡å›¾ç‰‡çš„urlæŸ¥è¯¢ç´ æçš„id
        List<WmMaterial> dbMaterials = wmMaterialMapper.selectList(Wrappers.<WmMaterial>lambdaQuery().in(WmMaterial::getUrl, materials));

        //åˆ¤æ–­ç´ ææ˜¯å¦æœ‰æ•ˆ
        if(dbMaterials==null || dbMaterials.size() == 0){
            //æ‰‹åŠ¨æŠ›å‡ºå¼‚å¸¸   ç¬¬ä¸€ä¸ªåŠŸèƒ½ï¼šèƒ½å¤Ÿæç¤ºè°ƒç”¨è€…ç´ æå¤±æ•ˆäº†ï¼Œç¬¬äºŒä¸ªåŠŸèƒ½ï¼Œè¿›è¡Œæ•°æ®çš„å›æ»š
            throw new CustomException(AppHttpCodeEnum.MATERIASL_REFERENCE_FAIL);
        }

        if(materials.size() != dbMaterials.size()){
            throw new CustomException(AppHttpCodeEnum.MATERIASL_REFERENCE_FAIL);
        }

        List<Integer> idList = dbMaterials.stream().map(WmMaterial::getId).collect(Collectors.toList());

        //æ‰¹é‡ä¿å­˜
        wmNewsMaterialMapper.saveRelations(idList,newsId,type);
    }

}


/**
     * æå–æ–‡ç« å†…å®¹ä¸­çš„å›¾ç‰‡ä¿¡æ¯
     * @param content
     * @return
     */
private List<String> ectractUrlInfo(String content) {
    List<String> materials = new ArrayList<>();

    List<Map> maps = JSON.parseArray(content, Map.class);
    for (Map map : maps) {
        if(map.get("type").equals("image")){
            String imgUrl = (String) map.get("value");
            materials.add(imgUrl);
        }
    }

    return materials;
}

@Autowired
private WmNewsMaterialMapper wmNewsMaterialMapper;

/**
     * ä¿å­˜æˆ–ä¿®æ”¹æ–‡ç« 
     * @param wmNews
     */
private void saveOrUpdateWmNews(WmNews wmNews) {
    //è¡¥å…¨å±æ€§
    wmNews.setUserId(WmThreadLocalUtil.getUser().getId());
    wmNews.setCreatedTime(new Date());
    wmNews.setSubmitedTime(new Date());
    wmNews.setEnable((short)1);//é»˜è®¤ä¸Šæ¶

    if(wmNews.getId() == null){
        //ä¿å­˜
        save(wmNews);
    }else {
        //ä¿®æ”¹
        //åˆ é™¤æ–‡ç« å›¾ç‰‡ä¸ç´ æçš„å…³ç³»
        wmNewsMaterialMapper.delete(Wrappers.<WmNewsMaterial>lambdaQuery().eq(WmNewsMaterial::getNewsId,wmNews.getId()));
        updateById(wmNews);
    }

}
```

## åã€è‡ªåª’ä½“æ–‡ç« -è‡ªåŠ¨å®¡æ ¸

### 1. è‡ªåª’ä½“æ–‡ç« è‡ªåŠ¨å®¡æ ¸æµç¨‹

<div align="center">
    <img src="æˆªå›¾/è‡ªåŠ¨å®¡æ ¸/è‡ªåŠ¨å®¡æ ¸æµç¨‹.png" alt="åå°æ­å»º" />
</div>

1. è‡ªåª’ä½“ç«¯å‘å¸ƒæ–‡ç« åï¼Œå¼€å§‹å®¡æ ¸æ–‡ç« 

2. å®¡æ ¸çš„ä¸»è¦æ˜¯å®¡æ ¸æ–‡ç« çš„å†…å®¹ï¼ˆæ–‡æœ¬å†…å®¹å’Œå›¾ç‰‡ï¼‰

3. å€ŸåŠ©ç¬¬ä¸‰æ–¹æä¾›çš„æ¥å£å®¡æ ¸æ–‡æœ¬

4. å€ŸåŠ©ç¬¬ä¸‰æ–¹æä¾›çš„æ¥å£å®¡æ ¸å›¾ç‰‡ï¼Œç”±äºå›¾ç‰‡å­˜å‚¨åˆ°minIOä¸­ï¼Œéœ€è¦å…ˆä¸‹è½½æ‰èƒ½å®¡æ ¸

5. å¦‚æœå®¡æ ¸å¤±è´¥ï¼Œåˆ™éœ€è¦ä¿®æ”¹è‡ªåª’ä½“æ–‡ç« çš„çŠ¶æ€ï¼Œstatus:2  å®¡æ ¸å¤±è´¥    status:3  è½¬åˆ°äººå·¥å®¡æ ¸

6. å¦‚æœå®¡æ ¸æˆåŠŸï¼Œåˆ™éœ€è¦åœ¨æ–‡ç« å¾®æœåŠ¡ä¸­åˆ›å»ºappç«¯éœ€è¦çš„æ–‡ç« 

### 2. å†…å®¹å®‰å…¨ç¬¬ä¸‰æ–¹æ¥å£

&emsp;å†…å®¹å®‰å…¨æ˜¯è¯†åˆ«æœåŠ¡ï¼Œæ”¯æŒå¯¹å›¾ç‰‡ã€è§†é¢‘ã€æ–‡æœ¬ã€è¯­éŸ³ç­‰å¯¹è±¡è¿›è¡Œå¤šæ ·åŒ–åœºæ™¯æ£€æµ‹ï¼Œæœ‰æ•ˆé™ä½å†…å®¹è¿è§„é£é™©ã€‚ç›®å‰å¾ˆå¤šå¹³å°éƒ½æ”¯æŒå†…å®¹æ£€æµ‹ï¼Œå¦‚é˜¿é‡Œäº‘ã€è…¾è®¯äº‘ã€ç™¾åº¦AIã€ç½‘æ˜“äº‘ç­‰å›½å†…å¤§å‹äº’è”ç½‘å…¬å¸éƒ½å¯¹å¤–æä¾›äº†APIã€‚

- æ–‡æœ¬åƒåœ¾å†…å®¹æ£€æµ‹ï¼šhttps://help.aliyun.com/document_detail/70439.html?spm=a2c4g.11186623.6.659.35ac3db3l0wV5k 
- æ–‡æœ¬åƒåœ¾å†…å®¹Java SDK: https://help.aliyun.com/document_detail/53427.html?spm=a2c4g.11186623.6.717.466d7544QbU8Lr 
- å›¾ç‰‡åƒåœ¾å†…å®¹æ£€æµ‹ï¼šhttps://help.aliyun.com/document_detail/70292.html?spm=a2c4g.11186623.6.616.5d7d1e7f9vDRz4 
- å›¾ç‰‡åƒåœ¾å†…å®¹Java SDK: https://help.aliyun.com/document_detail/53424.html?spm=a2c4g.11186623.6.715.c8f69b12ey35j4 

### 3. appç«¯æ–‡ç« ä¿å­˜æ¥å£

#### 3.1 è¡¨ç»“æ„è¯´æ˜

ap_article  æ–‡ç« åŸºæœ¬ä¿¡æ¯è¡¨

```mysql
-- auto-generated definition
create table ap_article
(
    id           bigint unsigned auto_increment
        primary key,
    title        varchar(50)                  null comment 'æ ‡é¢˜',
    author_id    int unsigned                 null comment 'æ–‡ç« ä½œè€…çš„ID',
    author_name  varchar(20)                  null comment 'ä½œè€…æ˜µç§°',
    channel_id   int unsigned                 null comment 'æ–‡ç« æ‰€å±é¢‘é“ID',
    channel_name varchar(10)                  null comment 'é¢‘é“åç§°',
    layout       tinyint unsigned             null comment 'æ–‡ç« å¸ƒå±€
            0 æ— å›¾æ–‡ç« 
            1 å•å›¾æ–‡ç« 
            2 å¤šå›¾æ–‡ç« ',
    flag         tinyint unsigned             null comment 'æ–‡ç« æ ‡è®°
            0 æ™®é€šæ–‡ç« 
            1 çƒ­ç‚¹æ–‡ç« 
            2 ç½®é¡¶æ–‡ç« 
            3 ç²¾å“æ–‡ç« 
            4 å¤§V æ–‡ç« ',
    images       varchar(1000)                null comment 'æ–‡ç« å›¾ç‰‡
            å¤šå¼ é€—å·åˆ†éš”',
    labels       varchar(500)                 null comment 'æ–‡ç« æ ‡ç­¾æœ€å¤š3ä¸ª é€—å·åˆ†éš”',
    likes        int unsigned                 null comment 'ç‚¹èµæ•°é‡',
    collection   int unsigned                 null comment 'æ”¶è—æ•°é‡',
    comment      int unsigned                 null comment 'è¯„è®ºæ•°é‡',
    views        int unsigned                 null comment 'é˜…è¯»æ•°é‡',
    province_id  int unsigned                 null comment 'çœå¸‚',
    city_id      int unsigned                 null comment 'å¸‚åŒº',
    county_id    int unsigned                 null comment 'åŒºå¿',
    created_time datetime                     null comment 'åˆ›å»ºæ—¶é—´',
    publish_time datetime                     null comment 'å‘å¸ƒæ—¶é—´',
    sync_status  tinyint(1)       default 0   null comment 'åŒæ­¥çŠ¶æ€',
    origin       tinyint unsigned default '0' null comment 'æ¥æº',
    static_url   varchar(150)                 null
)
    comment 'æ–‡ç« ä¿¡æ¯è¡¨ï¼Œå­˜å‚¨å·²å‘å¸ƒçš„æ–‡ç« ' row_format = DYNAMIC;
```

ap_article_config  æ–‡ç« é…ç½®è¡¨

```mysql
-- auto-generated definition
create table ap_article_config
(
    id         bigint unsigned auto_increment comment 'ä¸»é”®'
        primary key,
    article_id bigint unsigned  null comment 'æ–‡ç« ID',
    is_comment tinyint unsigned null comment 'æ˜¯å¦å¯è¯„è®º',
    is_forward tinyint unsigned null comment 'æ˜¯å¦è½¬å‘',
    is_down    tinyint unsigned null comment 'æ˜¯å¦ä¸‹æ¶',
    is_delete  tinyint unsigned null comment 'æ˜¯å¦å·²åˆ é™¤'
)
    comment 'APPå·²å‘å¸ƒæ–‡ç« é…ç½®è¡¨' row_format = DYNAMIC;

create index idx_article_id
    on ap_article_config (article_id);
```

ap_article_content æ–‡ç« å†…å®¹è¡¨

```mysql
-- auto-generated definition
create table ap_article_content
(
    id         bigint unsigned auto_increment comment 'ä¸»é”®'
        primary key,
    article_id bigint unsigned null comment 'æ–‡ç« ID',
    content    longtext        null comment 'æ–‡ç« å†…å®¹'
)
    comment 'APPå·²å‘å¸ƒæ–‡ç« å†…å®¹è¡¨' row_format = DYNAMIC;

create index idx_article_id
    on ap_article_content (article_id);
```

ä¸‰å¼ è¡¨å…³ç³»åˆ†æ

<div align="center">
    <img src="æˆªå›¾/æ–‡ç« åˆ—è¡¨åŠ è½½/ä¸‰è¡¨å…³ç³».png" alt="ä¸‰è¡¨å…³ç³»" />
</div>

#### 3.2 åˆ†å¸ƒå¼id

&emsp;éšç€ä¸šåŠ¡çš„å¢é•¿ï¼Œæ–‡ç« è¡¨å¯èƒ½è¦å ç”¨å¾ˆå¤§çš„ç‰©ç†å­˜å‚¨ç©ºé—´ï¼Œä¸ºäº†è§£å†³è¯¥é—®é¢˜ï¼ŒåæœŸä½¿ç”¨æ•°æ®åº“åˆ†ç‰‡æŠ€æœ¯ã€‚å°†ä¸€ä¸ªæ•°æ®åº“è¿›è¡Œæ‹†åˆ†ï¼Œé€šè¿‡æ•°æ®åº“ä¸­é—´ä»¶è¿æ¥ã€‚å¦‚æœæ•°æ®åº“ä¸­è¯¥è¡¨é€‰ç”¨IDè‡ªå¢ç­–ç•¥ï¼Œåˆ™å¯èƒ½äº§ç”Ÿé‡å¤çš„IDï¼Œæ­¤æ—¶åº”è¯¥ä½¿ç”¨åˆ†å¸ƒå¼IDç”Ÿæˆç­–ç•¥æ¥ç”ŸæˆIDã€‚

<div align="center">
    <img src="æˆªå›¾/è‡ªåŠ¨å®¡æ ¸/åˆ†å¸ƒå¼id.png" alt="åˆ†å¸ƒå¼id" />
</div>

&emsp;snowflakeæ˜¯Twitterå¼€æºçš„åˆ†å¸ƒå¼IDç”Ÿæˆç®—æ³•ï¼Œç»“æœæ˜¯ä¸€ä¸ªlongå‹çš„IDã€‚å…¶æ ¸å¿ƒæ€æƒ³æ˜¯ï¼šä½¿ç”¨41bitä½œä¸ºæ¯«ç§’æ•°ï¼Œ10bitä½œä¸ºæœºå™¨çš„IDï¼ˆ5ä¸ªbitæ˜¯æ•°æ®ä¸­å¿ƒï¼Œ5ä¸ªbitçš„æœºå™¨IDï¼‰ï¼Œ12bitä½œä¸ºæ¯«ç§’å†…çš„æµæ°´å·ï¼ˆæ„å‘³ç€æ¯ä¸ªèŠ‚ç‚¹åœ¨æ¯æ¯«ç§’å¯ä»¥äº§ç”Ÿ 4096 ä¸ª IDï¼‰ï¼Œæœ€åè¿˜æœ‰ä¸€ä¸ªç¬¦å·ä½ï¼Œæ°¸è¿œæ˜¯0

<div align="center">
    <img src="æˆªå›¾/è‡ªåŠ¨å®¡æ ¸/é›ªèŠ±ç®—æ³•.png" alt="åå°æ­å»º" />
</div>

æ–‡ç« ç«¯ç›¸å…³çš„è¡¨éƒ½ä½¿ç”¨é›ªèŠ±ç®—æ³•ç”Ÿæˆid,åŒ…æ‹¬ap_articleã€ ap_article_configã€ ap_article_content

#### 3.3 æ€è·¯åˆ†æ

åœ¨æ–‡ç« å®¡æ ¸æˆåŠŸä»¥åéœ€è¦åœ¨appçš„articleåº“ä¸­æ–°å¢æ–‡ç« æ•°æ®

1.ä¿å­˜æ–‡ç« ä¿¡æ¯ ap_article

2.ä¿å­˜æ–‡ç« é…ç½®ä¿¡æ¯ ap_article_config

3.ä¿å­˜æ–‡ç« å†…å®¹ ap_article_content

å®ç°æ€è·¯ï¼š

<div align="center">
    <img src="æˆªå›¾/è‡ªåŠ¨å®¡æ ¸/æ–‡ç« ä¿å­˜æ¥å£.png" alt="åå°æ­å»º" />
</div>

#### 3.4 feignæ¥å£

|          | **è¯´æ˜**             |
| -------- | -------------------- |
| æ¥å£è·¯å¾„ | /api/v1/article/save |
| è¯·æ±‚æ–¹å¼ | POST                 |
| å‚æ•°     | ArticleDto           |
| å“åº”ç»“æœ | ResponseResult       |

ArticleDto

```java
package com.heima.model.article.dtos;

import com.heima.model.article.pojos.ApArticle;
import lombok.Data;

@Data
public class ArticleDto  extends ApArticle {
    /**
     * æ–‡ç« å†…å®¹
     */
    private String content;
}
```

æˆåŠŸï¼š

```json
{
  "code": 200,
  "errorMessage" : "æ“ä½œæˆåŠŸ",
  "data":"1302864436297442242"
 }
```

å¤±è´¥ï¼š

```json
{
  "code":501,
  "errorMessage":"å‚æ•°å¤±æ•ˆ",
 }
```

```json
{
  "code":501,
  "errorMessage":"æ–‡ç« æ²¡æœ‰æ‰¾åˆ°",
 }
```

#### 3.5 æ ¸å¿ƒä»£ç 

```java
@Autowired
private ApArticleConfigMapper apArticleConfigMapper;

@Autowired
private ApArticleContentMapper apArticleContentMapper;

/**
     * ä¿å­˜appç«¯ç›¸å…³æ–‡ç« 
     * @param dto
     * @return
     */
@Override
public ResponseResult saveArticle(ArticleDto dto) {
    //1.æ£€æŸ¥å‚æ•°
    if(dto == null){
        return ResponseResult.errorResult(AppHttpCodeEnum.PARAM_INVALID);
    }

    ApArticle apArticle = new ApArticle();
    BeanUtils.copyProperties(dto,apArticle);

    //2.åˆ¤æ–­æ˜¯å¦å­˜åœ¨id
    if(dto.getId() == null){
        //2.1 ä¸å­˜åœ¨id  ä¿å­˜  æ–‡ç«   æ–‡ç« é…ç½®  æ–‡ç« å†…å®¹

        //ä¿å­˜æ–‡ç« 
        save(apArticle);

        //ä¿å­˜é…ç½®
        ApArticleConfig apArticleConfig = new ApArticleConfig(apArticle.getId());
        apArticleConfigMapper.insert(apArticleConfig);

        //ä¿å­˜ æ–‡ç« å†…å®¹
        ApArticleContent apArticleContent = new ApArticleContent();
        apArticleContent.setArticleId(apArticle.getId());
        apArticleContent.setContent(dto.getContent());
        apArticleContentMapper.insert(apArticleContent);

    }else {
        //2.2 å­˜åœ¨id   ä¿®æ”¹  æ–‡ç«   æ–‡ç« å†…å®¹

        //ä¿®æ”¹  æ–‡ç« 
        updateById(apArticle);

        //ä¿®æ”¹æ–‡ç« å†…å®¹
        ApArticleContent apArticleContent = apArticleContentMapper.selectOne(Wrappers.<ApArticleContent>lambdaQuery().eq(ApArticleContent::getArticleId, dto.getId()));
        apArticleContent.setContent(dto.getContent());
        apArticleContentMapper.updateById(apArticleContent);
    }


    //3.ç»“æœè¿”å›  æ–‡ç« çš„id
    return ResponseResult.okResult(apArticle.getId());
}
```

### 4. è‡ªåª’ä½“æ–‡ç« è‡ªåŠ¨å®¡æ ¸åŠŸèƒ½å®ç°

#### 4.1 è¡¨ç»“æ„è¯´æ˜

wm_news è‡ªåª’ä½“æ–‡ç« è¡¨

```mysql
-- auto-generated definition
create table wm_news
(
    id            int auto_increment comment 'ä¸»é”®'
        primary key,
    user_id       int unsigned                 null comment 'è‡ªåª’ä½“ç”¨æˆ·ID',
    title         varchar(36)                  null comment 'æ ‡é¢˜',
    content       longtext                     null comment 'å›¾æ–‡å†…å®¹',
    type          tinyint unsigned             null comment 'æ–‡ç« å¸ƒå±€
            0 æ— å›¾æ–‡ç« 
            1 å•å›¾æ–‡ç« 
            3 å¤šå›¾æ–‡ç« ',
    channel_id    int unsigned                 null comment 'å›¾æ–‡é¢‘é“ID',
    labels        varchar(20)                  null,
    created_time  datetime                     null comment 'åˆ›å»ºæ—¶é—´',
    submited_time datetime                     null comment 'æäº¤æ—¶é—´',
    status        tinyint unsigned             null comment 'å½“å‰çŠ¶æ€
            0 è‰ç¨¿
            1 æäº¤ï¼ˆå¾…å®¡æ ¸ï¼‰
            2 å®¡æ ¸å¤±è´¥
            3 äººå·¥å®¡æ ¸
            4 äººå·¥å®¡æ ¸é€šè¿‡
            8 å®¡æ ¸é€šè¿‡ï¼ˆå¾…å‘å¸ƒï¼‰
            9 å·²å‘å¸ƒ',
    publish_time  datetime                     null comment 'å®šæ—¶å‘å¸ƒæ—¶é—´ï¼Œä¸å®šæ—¶åˆ™ä¸ºç©º',
    reason        varchar(50)                  null comment 'æ‹’ç»ç†ç”±',
    article_id    bigint unsigned              null comment 'å‘å¸ƒåº“æ–‡ç« ID',
    images        longtext                     null comment '//å›¾ç‰‡ç”¨é€—å·åˆ†éš”',
    enable        tinyint unsigned default '1' null
)
    comment 'è‡ªåª’ä½“å›¾æ–‡å†…å®¹ä¿¡æ¯è¡¨' collate = utf8mb4_unicode_ci
                                   row_format = DYNAMIC;
```

statuså­—æ®µï¼š0 è‰ç¨¿  1 å¾…å®¡æ ¸  2 å®¡æ ¸å¤±è´¥  3 äººå·¥å®¡æ ¸  4 äººå·¥å®¡æ ¸é€šè¿‡  8 å®¡æ ¸é€šè¿‡ï¼ˆå¾…å‘å¸ƒï¼‰ 9 å·²å‘å¸ƒ

#### 4.2 æ ¸å¿ƒä»£ç 

```java
@Service
@Slf4j
@Transactional
public class WmNewsAutoScanServiceImpl implements WmNewsAutoScanService {

    @Autowired
    private WmNewsMapper wmNewsMapper;

    /**
     * è‡ªåª’ä½“æ–‡ç« å®¡æ ¸
     *
     * @param id è‡ªåª’ä½“æ–‡ç« id
     */
    @Override
    public void autoScanWmNews(Integer id) {
        //1.æŸ¥è¯¢è‡ªåª’ä½“æ–‡ç« 
        WmNews wmNews = wmNewsMapper.selectById(id);
        if(wmNews == null){
            throw new RuntimeException("WmNewsAutoScanServiceImpl-æ–‡ç« ä¸å­˜åœ¨");
        }

        if(wmNews.getStatus().equals(WmNews.Status.SUBMIT.getCode())){
            //ä»å†…å®¹ä¸­æå–çº¯æ–‡æœ¬å†…å®¹å’Œå›¾ç‰‡
            Map<String,Object> textAndImages = handleTextAndImages(wmNews);

            //2.å®¡æ ¸æ–‡æœ¬å†…å®¹  é˜¿é‡Œäº‘æ¥å£
            boolean isTextScan = handleTextScan((String) textAndImages.get("content"),wmNews);
            if(!isTextScan)return;

            //3.å®¡æ ¸å›¾ç‰‡  é˜¿é‡Œäº‘æ¥å£
            boolean isImageScan =  handleImageScan((List<String>) textAndImages.get("images"),wmNews);
            if(!isImageScan)return;

            //4.å®¡æ ¸æˆåŠŸï¼Œä¿å­˜appç«¯çš„ç›¸å…³çš„æ–‡ç« æ•°æ®
            ResponseResult responseResult = saveAppArticle(wmNews);
            if(!responseResult.getCode().equals(200)){
                throw new RuntimeException("WmNewsAutoScanServiceImpl-æ–‡ç« å®¡æ ¸ï¼Œä¿å­˜appç«¯ç›¸å…³æ–‡ç« æ•°æ®å¤±è´¥");
            }
            //å›å¡«article_id
            wmNews.setArticleId((Long) responseResult.getData());
            updateWmNews(wmNews,(short) 9,"å®¡æ ¸æˆåŠŸ");

        }
    }

    @Autowired
    private IArticleClient articleClient;

    @Autowired
    private WmChannelMapper wmChannelMapper;

    @Autowired
    private WmUserMapper wmUserMapper;

    /**
     * ä¿å­˜appç«¯ç›¸å…³çš„æ–‡ç« æ•°æ®
     * @param wmNews
     */
    private ResponseResult saveAppArticle(WmNews wmNews) {

        ArticleDto dto = new ArticleDto();
        //å±æ€§çš„æ‹·è´
        BeanUtils.copyProperties(wmNews,dto);
        //æ–‡ç« çš„å¸ƒå±€
        dto.setLayout(wmNews.getType());
        //é¢‘é“
        WmChannel wmChannel = wmChannelMapper.selectById(wmNews.getChannelId());
        if(wmChannel != null){
            dto.setChannelName(wmChannel.getName());
        }

        //ä½œè€…
        dto.setAuthorId(wmNews.getUserId().longValue());
        WmUser wmUser = wmUserMapper.selectById(wmNews.getUserId());
        if(wmUser != null){
            dto.setAuthorName(wmUser.getName());
        }

        //è®¾ç½®æ–‡ç« id
        if(wmNews.getArticleId() != null){
            dto.setId(wmNews.getArticleId());
        }
        dto.setCreatedTime(new Date());

        ResponseResult responseResult = articleClient.saveArticle(dto);
        return responseResult;

    }


    @Autowired
    private FileStorageService fileStorageService;

    @Autowired
    private GreenImageScan greenImageScan;

    /**
     * å®¡æ ¸å›¾ç‰‡
     * @param images
     * @param wmNews
     * @return
     */
    private boolean handleImageScan(List<String> images, WmNews wmNews) {

        boolean flag = true;

        if(images == null || images.size() == 0){
            return flag;
        }

        //ä¸‹è½½å›¾ç‰‡ minIO
        //å›¾ç‰‡å»é‡
        images = images.stream().distinct().collect(Collectors.toList());

        List<byte[]> imageList = new ArrayList<>();

        for (String image : images) {
            byte[] bytes = fileStorageService.downLoadFile(image);
            imageList.add(bytes);
        }


        //å®¡æ ¸å›¾ç‰‡
        try {
            Map map = greenImageScan.imageScan(imageList);
            if(map != null){
                //å®¡æ ¸å¤±è´¥
                if(map.get("suggestion").equals("block")){
                    flag = false;
                    updateWmNews(wmNews, (short) 2, "å½“å‰æ–‡ç« ä¸­å­˜åœ¨è¿è§„å†…å®¹");
                }

                //ä¸ç¡®å®šä¿¡æ¯  éœ€è¦äººå·¥å®¡æ ¸
                if(map.get("suggestion").equals("review")){
                    flag = false;
                    updateWmNews(wmNews, (short) 3, "å½“å‰æ–‡ç« ä¸­å­˜åœ¨ä¸ç¡®å®šå†…å®¹");
                }
            }

        } catch (Exception e) {
            flag = false;
            e.printStackTrace();
        }
        return flag;
    }

    @Autowired
    private GreenTextScan greenTextScan;

    /**
     * å®¡æ ¸çº¯æ–‡æœ¬å†…å®¹
     * @param content
     * @param wmNews
     * @return
     */
    private boolean handleTextScan(String content, WmNews wmNews) {

        boolean flag = true;

        if((wmNews.getTitle()+"-"+content).length() == 0){
            return flag;
        }

        try {
            Map map = greenTextScan.greeTextScan((wmNews.getTitle()+"-"+content));
            if(map != null){
                //å®¡æ ¸å¤±è´¥
                if(map.get("suggestion").equals("block")){
                    flag = false;
                    updateWmNews(wmNews, (short) 2, "å½“å‰æ–‡ç« ä¸­å­˜åœ¨è¿è§„å†…å®¹");
                }

                //ä¸ç¡®å®šä¿¡æ¯  éœ€è¦äººå·¥å®¡æ ¸
                if(map.get("suggestion").equals("review")){
                    flag = false;
                    updateWmNews(wmNews, (short) 3, "å½“å‰æ–‡ç« ä¸­å­˜åœ¨ä¸ç¡®å®šå†…å®¹");
                }
            }
        } catch (Exception e) {
            flag = false;
            e.printStackTrace();
        }

        return flag;

    }

    /**
     * ä¿®æ”¹æ–‡ç« å†…å®¹
     * @param wmNews
     * @param status
     * @param reason
     */
    private void updateWmNews(WmNews wmNews, short status, String reason) {
        wmNews.setStatus(status);
        wmNews.setReason(reason);
        wmNewsMapper.updateById(wmNews);
    }

    /**
     * 1ã€‚ä»è‡ªåª’ä½“æ–‡ç« çš„å†…å®¹ä¸­æå–æ–‡æœ¬å’Œå›¾ç‰‡
     * 2.æå–æ–‡ç« çš„å°é¢å›¾ç‰‡
     * @param wmNews
     * @return
     */
    private Map<String, Object> handleTextAndImages(WmNews wmNews) {

        //å­˜å‚¨çº¯æ–‡æœ¬å†…å®¹
        StringBuilder stringBuilder = new StringBuilder();

        List<String> images = new ArrayList<>();

        //1ã€‚ä»è‡ªåª’ä½“æ–‡ç« çš„å†…å®¹ä¸­æå–æ–‡æœ¬å’Œå›¾ç‰‡
        if(StringUtils.isNotBlank(wmNews.getContent())){
            List<Map> maps = JSONArray.parseArray(wmNews.getContent(), Map.class);
            for (Map map : maps) {
                if (map.get("type").equals("text")){
                    stringBuilder.append(map.get("value"));
                }

                if (map.get("type").equals("image")){
                    images.add((String) map.get("value"));
                }
            }
        }
        //2.æå–æ–‡ç« çš„å°é¢å›¾ç‰‡
        if(StringUtils.isNotBlank(wmNews.getImages())){
            String[] split = wmNews.getImages().split(",");
            images.addAll(Arrays.asList(split));
        }

        Map<String, Object> resultMap = new HashMap<>();
        resultMap.put("content",stringBuilder.toString());
        resultMap.put("images",images);
        return resultMap;

    }
}
```

#### 4.3 feignè¿œç¨‹æ¥å£è°ƒç”¨æ–¹å¼

<div align="center">
    <img src="æˆªå›¾/è‡ªåŠ¨å®¡æ ¸/Feignè¿œç¨‹æ¥å£è°ƒç”¨.png" alt="Feignè¿œç¨‹æ¥å£è°ƒç”¨" />
</div>

åœ¨heima-leadnews-wemediaæœåŠ¡ä¸­å·²ç»ä¾èµ–äº†heima-leadnews-feign-apiså·¥ç¨‹ï¼Œåªéœ€è¦åœ¨è‡ªåª’ä½“çš„å¼•å¯¼ç±»ä¸­å¼€å¯feignçš„è¿œç¨‹è°ƒç”¨å³å¯

æ³¨è§£ä¸ºï¼š`@EnableFeignClients(basePackages = "com.heima.apis")` éœ€è¦æŒ‡å‘apisè¿™ä¸ªåŒ…

#### 4.4 æœåŠ¡é™çº§å¤„ç†

- æœåŠ¡é™çº§æ˜¯æœåŠ¡è‡ªæˆ‘ä¿æŠ¤çš„ä¸€ç§æ–¹å¼ï¼Œæˆ–è€…ä¿æŠ¤ä¸‹æ¸¸æœåŠ¡çš„ä¸€ç§æ–¹å¼ï¼Œç”¨äºç¡®ä¿æœåŠ¡ä¸ä¼šå—è¯·æ±‚çªå¢å½±å“å˜å¾—ä¸å¯ç”¨ï¼Œç¡®ä¿æœåŠ¡ä¸ä¼šå´©æºƒ

- æœåŠ¡é™çº§è™½ç„¶ä¼šå¯¼è‡´è¯·æ±‚å¤±è´¥ï¼Œä½†æ˜¯ä¸ä¼šå¯¼è‡´é˜»å¡ã€‚

##### 4.4.1 é™çº§é€»è¾‘

â‘ ï¼šåœ¨è‡ªåª’ä½“å¾®æœåŠ¡ä¸­æ·»åŠ ç±»ï¼Œæ‰«æé™çº§ä»£ç ç±»çš„åŒ…	

```java
@Component
public class IArticleClientFallback implements IArticleClient {
    @Override
    public ResponseResult saveArticle(ArticleDto dto)  {
        return ResponseResult.errorResult(AppHttpCodeEnum.SERVER_ERROR,"è·å–æ•°æ®å¤±è´¥");
    }
}
```

åœ¨è‡ªåª’ä½“å¾®æœåŠ¡ä¸­æ·»åŠ ç±»ï¼Œæ‰«æé™çº§ä»£ç ç±»çš„åŒ…

```java
@Configuration
@ComponentScan("com.heima.apis.article.fallback")
public class InitConfig {
}
```

â‘¡ï¼šè¿œç¨‹æ¥å£ä¸­æŒ‡å‘é™çº§ä»£ç 

```java
@FeignClient(value = "leadnews-article",fallback = IArticleClientFallback.class)
public interface IArticleClient {

    @PostMapping("/api/v1/article/save")
    public ResponseResult saveArticle(@RequestBody ArticleDto dto);
}
```

â‘¢ï¼šå®¢æˆ·ç«¯å¼€å¯é™çº§heima-leadnews-wemedia

åœ¨wemediaçš„nacosé…ç½®ä¸­å¿ƒé‡Œæ·»åŠ å¦‚ä¸‹å†…å®¹ï¼Œå¼€å¯æœåŠ¡é™çº§ï¼Œä¹Ÿå¯ä»¥æŒ‡å®šæœåŠ¡å“åº”çš„è¶…æ—¶çš„æ—¶é—´

```yaml
feign:
  # å¼€å¯feignå¯¹hystrixç†”æ–­é™çº§çš„æ”¯æŒ
  hystrix:
    enabled: true
  # ä¿®æ”¹è°ƒç”¨è¶…æ—¶æ—¶é—´
  client:
    config:
      default:
        connectTimeout: 2000
        readTimeout: 2000
        
# å¢åŠ Hystrixè¶…æ—¶æ—¶é—´é…ç½®
hystrix:
  command:
    default:
      execution:
        isolation:
          thread:
            timeoutInMilliseconds: 20000   # å°†Hystrixè¶…æ—¶è®¾ç½®ä¸º20ç§’
```

### 5. å‘å¸ƒæ–‡ç« æäº¤å®¡æ ¸é›†æˆ

#### 5.1 åŒæ­¥è°ƒç”¨ä¸å¼‚æ­¥è°ƒç”¨

åŒæ­¥ï¼šå°±æ˜¯åœ¨å‘å‡ºä¸€ä¸ªè°ƒç”¨æ—¶ï¼Œåœ¨æ²¡æœ‰å¾—åˆ°ç»“æœä¹‹å‰ï¼Œ è¯¥è°ƒç”¨å°±ä¸è¿”å›ï¼ˆå®æ—¶å¤„ç†ï¼‰

å¼‚æ­¥ï¼šè°ƒç”¨åœ¨å‘å‡ºä¹‹åï¼Œè¿™ä¸ªè°ƒç”¨å°±ç›´æ¥è¿”å›äº†ï¼Œæ²¡æœ‰è¿”å›ç»“æœï¼ˆåˆ†æ—¶å¤„ç†ï¼‰

<div align="center">
    <img src="æˆªå›¾/è‡ªåŠ¨å®¡æ ¸/å¼‚æ­¥å®¡æ ¸.png" alt="å¼‚æ­¥å®¡æ ¸" />
</div>

å¼‚æ­¥çº¿ç¨‹çš„æ–¹å¼å®¡æ ¸æ–‡ç« 

#### 5.2 Springbooté›†æˆå¼‚æ­¥çº¿ç¨‹è°ƒç”¨

â‘ ï¼šåœ¨è‡ªåŠ¨å®¡æ ¸çš„æ–¹æ³•ä¸ŠåŠ ä¸Š@Asyncæ³¨è§£ï¼ˆæ ‡æ˜è¦å¼‚æ­¥è°ƒç”¨ï¼‰

```java
@Override
@Async  //æ ‡æ˜å½“å‰æ–¹æ³•æ˜¯ä¸€ä¸ªå¼‚æ­¥æ–¹æ³•
public void autoScanWmNews(Integer id) {
	//ä»£ç ç•¥
}
```

â‘¡ï¼šåœ¨æ–‡ç« å‘å¸ƒæˆåŠŸåè°ƒç”¨å®¡æ ¸çš„æ–¹æ³•

```java
@Autowired
private WmNewsAutoScanService wmNewsAutoScanService;

/**
 * å‘å¸ƒä¿®æ”¹æ–‡ç« æˆ–ä¿å­˜ä¸ºè‰ç¨¿
 * @param dto
 * @return
 */
@Override
public ResponseResult submitNews(WmNewsDto dto) {

    //ä»£ç ç•¥

    //å®¡æ ¸æ–‡ç« 
    wmNewsAutoScanService.autoScanWmNews(wmNews.getId());

    return ResponseResult.okResult(AppHttpCodeEnum.SUCCESS);

}
```

â‘¢ï¼šåœ¨è‡ªåª’ä½“å¼•å¯¼ç±»ä¸­ä½¿ç”¨@EnableAsyncæ³¨è§£å¼€å¯å¼‚æ­¥è°ƒç”¨

```java
@SpringBootApplication
@EnableDiscoveryClient
@MapperScan("com.heima.wemedia.mapper")
@EnableFeignClients(basePackages = "com.heima.apis")
@EnableAsync  //å¼€å¯å¼‚æ­¥è°ƒç”¨
public class WemediaApplication {

    public static void main(String[] args) {
        SpringApplication.run(WemediaApplication.class,args);
    }

    @Bean
    public MybatisPlusInterceptor mybatisPlusInterceptor() {
        MybatisPlusInterceptor interceptor = new MybatisPlusInterceptor();
        interceptor.addInnerInterceptor(new PaginationInnerInterceptor(DbType.MYSQL));
        return interceptor;
    }
}
```

### 6. æ–°éœ€æ±‚-è‡ªç®¡ç†æ•æ„Ÿè¯

#### 6.1 éœ€æ±‚åˆ†æ

- æ–‡ç« å®¡æ ¸ä¸èƒ½è¿‡æ»¤ä¸€äº›æ•æ„Ÿè¯ï¼š

  ç§äººä¾¦æ¢ã€é’ˆå­”æ‘„è±¡ã€ä¿¡ç”¨å¡æç°ã€å¹¿å‘Šä»£ç†ã€ä»£å¼€å‘ç¥¨ã€åˆ»ç« åŠã€å‡ºå”®ç­”æ¡ˆã€å°é¢è´·æ¬¾â€¦

éœ€è¦å®Œæˆçš„åŠŸèƒ½ï¼š

éœ€è¦è‡ªå·±ç»´æŠ¤ä¸€å¥—æ•æ„Ÿè¯ï¼Œåœ¨æ–‡ç« å®¡æ ¸çš„æ—¶å€™ï¼Œéœ€è¦éªŒè¯æ–‡ç« æ˜¯å¦åŒ…å«è¿™äº›æ•æ„Ÿè¯

#### 6.2 æ•æ„Ÿè¯-è¿‡æ»¤

æŠ€æœ¯é€‰å‹

| **æ–¹æ¡ˆ**               | **è¯´æ˜**                     |
| ---------------------- | ---------------------------- |
| æ•°æ®åº“æ¨¡ç³ŠæŸ¥è¯¢         | æ•ˆç‡å¤ªä½                     |
| String.indexOf("")æŸ¥æ‰¾ | æ•°æ®åº“é‡å¤§çš„è¯ä¹Ÿæ˜¯æ¯”è¾ƒæ…¢     |
| å…¨æ–‡æ£€ç´¢               | åˆ†è¯å†åŒ¹é…                   |
| DFAç®—æ³•                | ç¡®å®šæœ‰ç©·è‡ªåŠ¨æœº(ä¸€ç§æ•°æ®ç»“æ„) |

#### 6.3 DFAå®ç°åŸç†

DFAå…¨ç§°ä¸ºï¼šDeterministic Finite Automaton,å³ç¡®å®šæœ‰ç©·è‡ªåŠ¨æœºã€‚

å­˜å‚¨ï¼šä¸€æ¬¡æ€§çš„æŠŠæ‰€æœ‰çš„æ•æ„Ÿè¯å­˜å‚¨åˆ°äº†å¤šä¸ªmapä¸­ï¼Œå°±æ˜¯ä¸‹å›¾è¡¨ç¤ºè¿™ç§ç»“æ„

æ•æ„Ÿè¯ï¼šå†°æ¯’ã€å¤§éº»ã€å¤§åè›‹

<div align="center">
    <img src="æˆªå›¾/è‡ªåŠ¨å®¡æ ¸/DFA.png" alt="DFA" />
</div>

æ£€ç´¢çš„è¿‡ç¨‹

<div align="center">
    <img src="æˆªå›¾/è‡ªåŠ¨å®¡æ ¸/æ£€ç´¢è¿‡ç¨‹.png" alt="æ£€ç´¢è¿‡ç¨‹" />
</div>

#### 6.4 è‡ªç®¡ç†æ•æ„Ÿè¯é›†æˆåˆ°æ–‡ç« å®¡æ ¸ä¸­

åˆ›å»ºæ•æ„Ÿè¯è¡¨ï¼Œwm_sensitive

```mysql
-- auto-generated definition
create table wm_sensitive
(
    id           int unsigned auto_increment comment 'ä¸»é”®'
        primary key,
    sensitives   varchar(10) null comment 'æ•æ„Ÿè¯',
    created_time datetime    null comment 'åˆ›å»ºæ—¶é—´'
)
    comment 'æ•æ„Ÿè¯ä¿¡æ¯è¡¨' collate = utf8mb4_unicode_ci
                           row_format = DYNAMIC;
```

##### 6.4.1 æ ¸å¿ƒä»£ç 

```java
@Autowired
private WmSensitiveMapper wmSensitiveMapper;

/**
     * è‡ªç®¡ç†çš„æ•æ„Ÿè¯å®¡æ ¸
     * @param content
     * @param wmNews
     * @return
     */
private boolean handleSensitiveScan(String content, WmNews wmNews) {

    boolean flag = true;

    //è·å–æ‰€æœ‰çš„æ•æ„Ÿè¯
    List<WmSensitive> wmSensitives = wmSensitiveMapper.selectList(Wrappers.<WmSensitive>lambdaQuery().select(WmSensitive::getSensitives));
    List<String> sensitiveList = wmSensitives.stream().map(WmSensitive::getSensitives).collect(Collectors.toList());

    //åˆå§‹åŒ–æ•æ„Ÿè¯åº“
    SensitiveWordUtil.initMap(sensitiveList);

    //æŸ¥çœ‹æ–‡ç« ä¸­æ˜¯å¦åŒ…å«æ•æ„Ÿè¯
    Map<String, Integer> map = SensitiveWordUtil.matchWords(content);
    if(map.size() >0){
        updateWmNews(wmNews,(short) 2,"å½“å‰æ–‡ç« ä¸­å­˜åœ¨è¿è§„å†…å®¹"+map);
        flag = false;
    }

    return flag;
}
```



SensitiveWordUtil

```java
public class SensitiveWordUtil {

    public static Map<String, Object> dictionaryMap = new HashMap<>();

    /**
     * ç”Ÿæˆå…³é”®è¯å­—å…¸åº“
     * @param words
     * @return
     */
    public static void initMap(Collection<String> words) {
        if (words == null) {
            System.out.println("æ•æ„Ÿè¯åˆ—è¡¨ä¸èƒ½ä¸ºç©º");
            return ;
        }

        // mapåˆå§‹é•¿åº¦words.size()ï¼Œæ•´ä¸ªå­—å…¸åº“çš„å…¥å£å­—æ•°(å°äºwords.size()ï¼Œå› ä¸ºä¸åŒçš„è¯å¯èƒ½ä¼šæœ‰ç›¸åŒçš„é¦–å­—)
        Map<String, Object> map = new HashMap<>(words.size());
        // éå†è¿‡ç¨‹ä¸­å½“å‰å±‚æ¬¡çš„æ•°æ®
        Map<String, Object> curMap = null;
        Iterator<String> iterator = words.iterator();

        while (iterator.hasNext()) {
            String word = iterator.next();
            curMap = map;
            int len = word.length();
            for (int i =0; i < len; i++) {
                // éå†æ¯ä¸ªè¯çš„å­—
                String key = String.valueOf(word.charAt(i));
                // å½“å‰å­—åœ¨å½“å‰å±‚æ˜¯å¦å­˜åœ¨, ä¸å­˜åœ¨åˆ™æ–°å»º, å½“å‰å±‚æ•°æ®æŒ‡å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹, ç»§ç»­åˆ¤æ–­æ˜¯å¦å­˜åœ¨æ•°æ®
                Map<String, Object> wordMap = (Map<String, Object>) curMap.get(key);
                if (wordMap == null) {
                    // æ¯ä¸ªèŠ‚ç‚¹å­˜åœ¨ä¸¤ä¸ªæ•°æ®: ä¸‹ä¸€ä¸ªèŠ‚ç‚¹å’ŒisEnd(æ˜¯å¦ç»“æŸæ ‡å¿—)
                    wordMap = new HashMap<>(2);
                    wordMap.put("isEnd", "0");
                    curMap.put(key, wordMap);
                }
                curMap = wordMap;
                // å¦‚æœå½“å‰å­—æ˜¯è¯çš„æœ€åä¸€ä¸ªå­—ï¼Œåˆ™å°†isEndæ ‡å¿—ç½®1
                if (i == len -1) {
                    curMap.put("isEnd", "1");
                }
            }
        }

        dictionaryMap = map;
    }

    /**
     * æœç´¢æ–‡æœ¬ä¸­æŸä¸ªæ–‡å­—æ˜¯å¦åŒ¹é…å…³é”®è¯
     * @param text
     * @param beginIndex
     * @return
     */
    private static int checkWord(String text, int beginIndex) {
        if (dictionaryMap == null) {
            throw new RuntimeException("å­—å…¸ä¸èƒ½ä¸ºç©º");
        }
        boolean isEnd = false;
        int wordLength = 0;
        Map<String, Object> curMap = dictionaryMap;
        int len = text.length();
        // ä»æ–‡æœ¬çš„ç¬¬beginIndexå¼€å§‹åŒ¹é…
        for (int i = beginIndex; i < len; i++) {
            String key = String.valueOf(text.charAt(i));
            // è·å–å½“å‰keyçš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹
            curMap = (Map<String, Object>) curMap.get(key);
            if (curMap == null) {
                break;
            } else {
                wordLength ++;
                if ("1".equals(curMap.get("isEnd"))) {
                    isEnd = true;
                }
            }
        }
        if (!isEnd) {
            wordLength = 0;
        }
        return wordLength;
    }

    /**
     * è·å–åŒ¹é…çš„å…³é”®è¯å’Œå‘½ä¸­æ¬¡æ•°
     * @param text
     * @return
     */
    public static Map<String, Integer> matchWords(String text) {
        Map<String, Integer> wordMap = new HashMap<>();
        int len = text.length();
        for (int i = 0; i < len; i++) {
            int wordLength = checkWord(text, i);
            if (wordLength > 0) {
                String word = text.substring(i, i + wordLength);
                // æ·»åŠ å…³é”®è¯åŒ¹é…æ¬¡æ•°
                if (wordMap.containsKey(word)) {
                    wordMap.put(word, wordMap.get(word) + 1);
                } else {
                    wordMap.put(word, 1);
                }

                i += wordLength - 1;
            }
        }
        return wordMap;
    }
}
```

### 7. æ–°éœ€æ±‚-å›¾ç‰‡è¯†åˆ«æ–‡å­—å®¡æ ¸æ•æ„Ÿè¯

#### 7.1 éœ€æ±‚åˆ†æ

æ–‡ç« ä¸­åŒ…å«çš„å›¾ç‰‡è¦è¯†åˆ«æ–‡å­—ï¼Œè¿‡æ»¤æ‰å›¾ç‰‡æ–‡å­—çš„æ•æ„Ÿè¯

<div align="center">
    <img src="æˆªå›¾/è‡ªåŠ¨å®¡æ ¸/å›¾ç‰‡è¯†åˆ«æ–‡å­—.png" alt="å›¾ç‰‡è¯†åˆ«æ–‡å­—" />
</div>

#### 7.2 å›¾ç‰‡æ–‡å­—è¯†åˆ«

&emsp;OCR ï¼ˆOptical Character Recognitionï¼Œå…‰å­¦å­—ç¬¦è¯†åˆ«ï¼‰æ˜¯æŒ‡ç”µå­è®¾å¤‡ï¼ˆä¾‹å¦‚æ‰«æä»ªæˆ–æ•°ç ç›¸æœºï¼‰æ£€æŸ¥çº¸ä¸Šæ‰“å°çš„å­—ç¬¦ï¼Œé€šè¿‡æ£€æµ‹æš—ã€äº®çš„æ¨¡å¼ç¡®å®šå…¶å½¢çŠ¶ï¼Œç„¶åç”¨å­—ç¬¦è¯†åˆ«æ–¹æ³•å°†å½¢çŠ¶ç¿»è¯‘æˆè®¡ç®—æœºæ–‡å­—çš„è¿‡ç¨‹

| **æ–¹æ¡ˆ**      | **è¯´æ˜**                                            |
| ------------- | --------------------------------------------------- |
| ç™¾åº¦OCR       | æ”¶è´¹                                                |
| Tesseract-OCR | Googleç»´æŠ¤çš„å¼€æºOCRå¼•æ“ï¼Œæ”¯æŒJavaï¼ŒPythonç­‰è¯­è¨€è°ƒç”¨ |
| Tess4J        | å°è£…äº†Tesseract-OCR  ï¼Œæ”¯æŒJavaè°ƒç”¨                 |

#### 7.3 Tess4jæ¡ˆä¾‹

```java
@Getter
@Setter
@Component
@ConfigurationProperties(prefix = "tess4j")
public class Tess4jClient {

    private String dataPath;
    private String language;

    public String doOCR(BufferedImage image) throws TesseractException {
        //åˆ›å»ºTesseractå¯¹è±¡
        ITesseract tesseract = new Tesseract();
        //è®¾ç½®å­—ä½“åº“è·¯å¾„
        tesseract.setDatapath(dataPath);
        //ä¸­æ–‡è¯†åˆ«
        tesseract.setLanguage(language);
        //æ‰§è¡Œocrè¯†åˆ«
        String result = tesseract.doOCR(image);
        //æ›¿æ¢å›è½¦å’Œtalé”®  ä½¿ç»“æœä¸ºä¸€è¡Œ
        result = result.replaceAll("\\r|\\n", "-").replaceAll(" ", "");
        return result;
    }

}
```

é…ç½®ä¸­æ·»åŠ å±æ€§

```yaml
tess4j:
  data-path: D:\workspace\tessdata
  language: chi_sim	
```

åœ¨WmNewsAutoScanServiceImplä¸­çš„handleImageScanæ–¹æ³•ä¸Šæ·»åŠ å¦‚ä¸‹ä»£ç 

```java
try {
    for (String image : images) {
        byte[] bytes = fileStorageService.downLoadFile(image);

        //å›¾ç‰‡è¯†åˆ«æ–‡å­—å®¡æ ¸---begin-----

        //ä»byte[]è½¬æ¢ä¸ºbutteredImage
        ByteArrayInputStream in = new ByteArrayInputStream(bytes);
        BufferedImage imageFile = ImageIO.read(in);
        //è¯†åˆ«å›¾ç‰‡çš„æ–‡å­—
        String result = tess4jClient.doOCR(imageFile);

        //å®¡æ ¸æ˜¯å¦åŒ…å«è‡ªç®¡ç†çš„æ•æ„Ÿè¯
        boolean isSensitive = handleSensitiveScan(result, wmNews);
        if(!isSensitive){
            return isSensitive;
        }

        //å›¾ç‰‡è¯†åˆ«æ–‡å­—å®¡æ ¸---end-----

        imageList.add(bytes);
    } 
}catch (Exception e){
    e.printStackTrace();
}
```

### 8. æ–‡ç« è¯¦æƒ…-é™æ€æ–‡ä»¶ç”Ÿæˆ

#### 8.1 æ€è·¯åˆ†æ

æ–‡ç« ç«¯åˆ›å»ºappç›¸å…³æ–‡ç« æ—¶ï¼Œç”Ÿæˆæ–‡ç« è¯¦æƒ…é™æ€é¡µä¸Šä¼ åˆ°MinIOä¸­

<div align="center">
    <img src="æˆªå›¾/è‡ªåŠ¨å®¡æ ¸/é™æ€æ–‡ä»¶ç”Ÿæˆ.png" alt="é™æ€æ–‡ä»¶ç”Ÿæˆ" />
</div>

æ ¸å¿ƒä»£ç 

```java
@Service
@Slf4j
@Transactional
public class ArticleFreemarkerServiceImpl implements ArticleFreemarkerService {

    @Autowired
    private ApArticleContentMapper apArticleContentMapper;

    @Autowired
    private Configuration configuration;

    @Autowired
    private FileStorageService fileStorageService;

    @Autowired
    private ApArticleService apArticleService;

    /**
     * ç”Ÿæˆé™æ€æ–‡ä»¶ä¸Šä¼ åˆ°minIOä¸­
     * @param apArticle
     * @param content
     */
    @Async
    @Override
    public void buildArticleToMinIO(ApArticle apArticle, String content) {
        //å·²çŸ¥æ–‡ç« çš„id
        //4.1 è·å–æ–‡ç« å†…å®¹
        if(StringUtils.isNotBlank(content)){
            //4.2 æ–‡ç« å†…å®¹é€šè¿‡freemarkerç”Ÿæˆhtmlæ–‡ä»¶
            Template template = null;
            StringWriter out = new StringWriter();
            try {
                template = configuration.getTemplate("article.ftl");
                //æ•°æ®æ¨¡å‹
                Map<String,Object> contentDataModel = new HashMap<>();
                contentDataModel.put("content", JSONArray.parseArray(content));
                //åˆæˆ
                template.process(contentDataModel,out);
            } catch (Exception e) {
                e.printStackTrace();
            }

            //4.3 æŠŠhtmlæ–‡ä»¶ä¸Šä¼ åˆ°minioä¸­
            InputStream in = new ByteArrayInputStream(out.toString().getBytes());
            String path = fileStorageService.uploadHtmlFile("", apArticle.getId() + ".html", in);

            //4.4 ä¿®æ”¹ap_articleè¡¨ï¼Œä¿å­˜static_urlå­—æ®µ
            apArticleService.update(Wrappers.<ApArticle>lambdaUpdate().eq(ApArticle::getId,apArticle.getId())
                    .set(ApArticle::getStaticUrl,path));

        }
    }
}
```

åœ¨ApArticleServiceçš„saveArticleå®ç°æ–¹æ³•ä¸­æ·»åŠ å¼‚æ­¥è°ƒç”¨ç”Ÿæˆæ–‡ä»¶çš„æ–¹æ³•

æ–‡ç« å¾®æœåŠ¡å¯åŠ¨ç±»ä¸Šå¼€å¯å¼‚æ­¥è°ƒç”¨`@EnableAsync`

## åä¸€ã€å»¶è¿Ÿä»»åŠ¡ç²¾å‡†å‘å¸ƒæ–‡ç« 

### 1. æ¦‚è¿°

#### 1.1 ä»€ä¹ˆæ˜¯å»¶è¿Ÿä»»åŠ¡

- å®šæ—¶ä»»åŠ¡ï¼šæœ‰å›ºå®šå‘¨æœŸçš„ï¼Œæœ‰æ˜ç¡®çš„è§¦å‘æ—¶é—´
- å»¶è¿Ÿé˜Ÿåˆ—ï¼šæ²¡æœ‰å›ºå®šçš„å¼€å§‹æ—¶é—´ï¼Œå®ƒå¸¸å¸¸æ˜¯ç”±ä¸€ä¸ªäº‹ä»¶è§¦å‘çš„ï¼Œè€Œåœ¨è¿™ä¸ªäº‹ä»¶è§¦å‘ä¹‹åçš„ä¸€æ®µæ—¶é—´å†…è§¦å‘å¦ä¸€ä¸ªäº‹ä»¶ï¼Œä»»åŠ¡å¯ä»¥ç«‹å³æ‰§è¡Œï¼Œä¹Ÿå¯ä»¥å»¶è¿Ÿ

<div align="center">
    <img src="æˆªå›¾/å»¶è¿Ÿä»»åŠ¡/æ¦‚è¿°.png" alt="æ¦‚è¿°" />
</div>

åº”ç”¨åœºæ™¯ï¼š

åœºæ™¯ä¸€ï¼šè®¢å•ä¸‹å•ä¹‹å30åˆ†é’Ÿåï¼Œå¦‚æœç”¨æˆ·æ²¡æœ‰ä»˜é’±ï¼Œåˆ™ç³»ç»Ÿè‡ªåŠ¨å–æ¶ˆè®¢å•ï¼›å¦‚æœæœŸé—´ä¸‹å•æˆåŠŸï¼Œä»»åŠ¡å–æ¶ˆ

åœºæ™¯äºŒï¼šæ¥å£å¯¹æ¥å‡ºç°ç½‘ç»œé—®é¢˜ï¼Œ1åˆ†é’Ÿåé‡è¯•ï¼Œå¦‚æœå¤±è´¥ï¼Œ2åˆ†é’Ÿé‡è¯•ï¼Œç›´åˆ°å‡ºç°é˜ˆå€¼ç»ˆæ­¢

#### 2.2 æŠ€æœ¯å¯¹æ¯”

##### 2.2.1 DelayQueue

JDKè‡ªå¸¦DelayQueue æ˜¯ä¸€ä¸ªæ”¯æŒå»¶æ—¶è·å–å…ƒç´ çš„é˜»å¡é˜Ÿåˆ—ï¼Œ å†…éƒ¨é‡‡ç”¨ä¼˜å…ˆé˜Ÿåˆ— PriorityQueue å­˜å‚¨å…ƒç´ ï¼ŒåŒæ—¶å…ƒç´ å¿…é¡»å®ç° Delayed æ¥å£ï¼›åœ¨åˆ›å»ºå…ƒç´ æ—¶å¯ä»¥æŒ‡å®šå¤šä¹…æ‰å¯ä»¥ä»é˜Ÿåˆ—ä¸­è·å–å½“å‰å…ƒç´ ï¼Œåªæœ‰åœ¨å»¶è¿ŸæœŸæ»¡æ—¶æ‰èƒ½ä»é˜Ÿåˆ—ä¸­æå–å…ƒç´ 

<div align="center">
    <img src="æˆªå›¾/å»¶è¿Ÿä»»åŠ¡/DelayQueue.png" alt="DelayQueue" />
</div>

DelayQueueå±äºæ’åºé˜Ÿåˆ—ï¼Œå®ƒçš„ç‰¹æ®Šä¹‹å¤„åœ¨äºé˜Ÿåˆ—çš„å…ƒç´ å¿…é¡»å®ç°Delayedæ¥å£ï¼Œè¯¥æ¥å£éœ€è¦å®ç°compareToå’ŒgetDelayæ–¹æ³•

getDelayæ–¹æ³•ï¼šè·å–å…ƒç´ åœ¨é˜Ÿåˆ—ä¸­çš„å‰©ä½™æ—¶é—´ï¼Œåªæœ‰å½“å‰©ä½™æ—¶é—´ä¸º0æ—¶å…ƒç´ æ‰å¯ä»¥å‡ºé˜Ÿåˆ—ã€‚

compareToæ–¹æ³•ï¼šç”¨äºæ’åºï¼Œç¡®å®šå…ƒç´ å‡ºé˜Ÿåˆ—çš„é¡ºåºã€‚

###### DelayQueueé—®é¢˜-æœªæŒä¹…åŒ–

ä½¿ç”¨çº¿ç¨‹æ± æˆ–è€…åŸç”ŸDelayQueueç¨‹åºæŒ‚æ‰ä¹‹åï¼Œ**ä»»åŠ¡éƒ½æ˜¯æ”¾åœ¨å†…å­˜**ï¼Œéœ€è¦è€ƒè™‘æœªå¤„ç†æ¶ˆæ¯çš„ä¸¢å¤±å¸¦æ¥çš„å½±å“ï¼Œå¦‚ä½•ä¿è¯æ•°æ®ä¸ä¸¢å¤±ï¼Œéœ€è¦**æŒä¹…åŒ–ï¼ˆç£ç›˜ï¼‰**ã€‚

##### 2.2.2 RabbitMQå®ç°å»¶è¿Ÿä»»åŠ¡

- TTLï¼šTime To Live (æ¶ˆæ¯å­˜æ´»æ—¶é—´)

- æ­»ä¿¡é˜Ÿåˆ—ï¼šDead Letter Exchange(æ­»ä¿¡äº¤æ¢æœº)ï¼Œå½“æ¶ˆæ¯æˆä¸ºDead messageåï¼Œå¯ä»¥é‡æ–°å‘é€å¦ä¸€ä¸ªäº¤æ¢æœºï¼ˆæ­»ä¿¡äº¤æ¢æœºï¼‰

<div align="center">
    <img src="æˆªå›¾/å»¶è¿Ÿä»»åŠ¡/RabbitMQ.png" alt="RabbitMQ" />
</div>

##### 2.2.3 rediså®ç°

zsetæ•°æ®ç±»å‹çš„å»é‡æœ‰åºï¼ˆåˆ†æ•°æ’åºï¼‰ç‰¹ç‚¹è¿›è¡Œå»¶è¿Ÿã€‚ä¾‹å¦‚ï¼šæ—¶é—´æˆ³ä½œä¸ºscoreè¿›è¡Œæ’åº

<div align="center">
    <img src="æˆªå›¾/å»¶è¿Ÿä»»åŠ¡/redis.png" alt="redis" />
</div>

### 2. rediså®ç°å»¶è¿Ÿä»»åŠ¡

<div align="center">
    <img src="æˆªå›¾/å»¶è¿Ÿä»»åŠ¡/å®ç°æ€è·¯.png" alt="å®ç°æ€è·¯" />
</div>

é—®é¢˜æ€è·¯

1.ä¸ºä»€ä¹ˆä»»åŠ¡éœ€è¦å­˜å‚¨åœ¨æ•°æ®åº“ä¸­ï¼Ÿ

å»¶è¿Ÿä»»åŠ¡æ˜¯ä¸€ä¸ªé€šç”¨çš„æœåŠ¡ï¼Œä»»ä½•éœ€è¦å»¶è¿Ÿå¾—ä»»åŠ¡éƒ½å¯ä»¥è°ƒç”¨è¯¥æœåŠ¡ï¼Œéœ€è¦è€ƒè™‘æ•°æ®æŒä¹…åŒ–çš„é—®é¢˜ï¼Œå­˜å‚¨æ•°æ®åº“ä¸­æ˜¯ä¸€ç§æ•°æ®å®‰å…¨çš„è€ƒè™‘ã€‚

2.ä¸ºä»€ä¹ˆredisä¸­ä½¿ç”¨ä¸¤ç§æ•°æ®ç±»å‹ï¼Œlistå’Œzsetï¼Ÿ

æ•ˆç‡é—®é¢˜ï¼Œç®—æ³•çš„æ—¶é—´å¤æ‚åº¦

3.åœ¨æ·»åŠ zsetæ•°æ®çš„æ—¶å€™ï¼Œä¸ºä»€ä¹ˆä¸éœ€è¦é¢„åŠ è½½ï¼Ÿ

ä»»åŠ¡æ¨¡å—æ˜¯ä¸€ä¸ªé€šç”¨çš„æ¨¡å—ï¼Œé¡¹ç›®ä¸­ä»»ä½•éœ€è¦å»¶è¿Ÿé˜Ÿåˆ—çš„åœ°æ–¹ï¼Œéƒ½å¯ä»¥è°ƒç”¨è¿™ä¸ªæ¥å£ï¼Œè¦è€ƒè™‘åˆ°æ•°æ®é‡çš„é—®é¢˜ï¼Œå¦‚æœæ•°æ®é‡ç‰¹åˆ«å¤§ï¼Œä¸ºäº†é˜²æ­¢é˜»å¡ï¼Œåªéœ€è¦æŠŠæœªæ¥å‡ åˆ†é’Ÿè¦æ‰§è¡Œçš„æ•°æ®å­˜å…¥ç¼“å­˜å³å¯ã€‚

### 3. å»¶è¿Ÿä»»åŠ¡æœåŠ¡å®ç°

#### 3.1 è¡¨ç»“æ„

taskinfo ä»»åŠ¡è¡¨

```mysql
-- auto-generated definition
create table taskinfo
(
    task_id      bigint      not null comment 'ä»»åŠ¡id'
        primary key,
    execute_time datetime(3) not null comment 'æ‰§è¡Œæ—¶é—´',
    parameters   longblob    null comment 'å‚æ•°',
    priority     int         not null comment 'ä¼˜å…ˆçº§',
    task_type    int         not null comment 'ä»»åŠ¡ç±»å‹'
)
    charset = utf8mb3;

create index index_taskinfo_time
    on taskinfo (task_type, priority, execute_time);
```

taskinfo_logs ä»»åŠ¡æ—¥å¿—è¡¨

```mysql
-- auto-generated definition
create table taskinfo_logs
(
    task_id      bigint        not null comment 'ä»»åŠ¡id'
        primary key,
    execute_time datetime(3)   not null comment 'æ‰§è¡Œæ—¶é—´',
    parameters   longblob      null comment 'å‚æ•°',
    priority     int           not null comment 'ä¼˜å…ˆçº§',
    task_type    int           not null comment 'ä»»åŠ¡ç±»å‹',
    version      int           not null comment 'ç‰ˆæœ¬å·,ç”¨ä¹è§‚é”',
    status       int default 0 null comment 'çŠ¶æ€ 0=åˆå§‹åŒ–çŠ¶æ€ 1=EXECUTED 2=CANCELLED'
)
    charset = utf8mb3;
```

ä¹è§‚é”æ”¯æŒï¼š

```java
/**
     * mybatis-plusä¹è§‚é”æ”¯æŒ
     * @return
     */
@Bean
public MybatisPlusInterceptor optimisticLockerInterceptor(){
    MybatisPlusInterceptor interceptor = new MybatisPlusInterceptor();
    interceptor.addInnerInterceptor(new OptimisticLockerInnerInterceptor());
    return interceptor;
}
```

#### 3.2 æ·»åŠ ä»»åŠ¡

ScheduleConstantså¸¸é‡ç±»

```java
public class ScheduleConstants {
    
    //taskçŠ¶æ€
    public static final int SCHEDULED=0;   //åˆå§‹åŒ–çŠ¶æ€

    public static final int EXECUTED=1;       //å·²æ‰§è¡ŒçŠ¶æ€

    public static final int CANCELLED=2;   //å·²å–æ¶ˆçŠ¶æ€

    public static String FUTURE="future_";   //æœªæ¥æ•°æ®keyå‰ç¼€

    public static String TOPIC="topic_";     //å½“å‰æ•°æ®keyå‰ç¼€
}
```

##### 3.2.1 æ ¸å¿ƒä»£ç 

```java
@Service
@Transactional
@Slf4j
public class TaskServiceImpl implements TaskService {
    /**
     * æ·»åŠ å»¶è¿Ÿä»»åŠ¡
     *
     * @param task
     * @return
     */
    @Override
    public long addTask(Task task) {
        //1.æ·»åŠ ä»»åŠ¡åˆ°æ•°æ®åº“ä¸­

        boolean success = addTaskToDb(task);

        if (success) {
            //2.æ·»åŠ ä»»åŠ¡åˆ°redis
            addTaskToCache(task);
        }

        return task.getTaskId();
    }

    @Autowired
    private CacheService cacheService;

    /**
     * æŠŠä»»åŠ¡æ·»åŠ åˆ°redisä¸­
     *
     * @param task
     */
    private void addTaskToCache(Task task) {

        String key = task.getTaskType() + "_" + task.getPriority();

        //è·å–5åˆ†é’Ÿä¹‹åçš„æ—¶é—´  æ¯«ç§’å€¼
        Calendar calendar = Calendar.getInstance();
        calendar.add(Calendar.MINUTE, 5);
        long nextScheduleTime = calendar.getTimeInMillis();

        //2.1 å¦‚æœä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´å°äºç­‰äºå½“å‰æ—¶é—´ï¼Œå­˜å…¥list
        if (task.getExecuteTime() <= System.currentTimeMillis()) {
            cacheService.lLeftPush(ScheduleConstants.TOPIC + key, JSON.toJSONString(task));
        } else if (task.getExecuteTime() <= nextScheduleTime) {
            //2.2 å¦‚æœä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´å¤§äºå½“å‰æ—¶é—´ && å°äºç­‰äºé¢„è®¾æ—¶é—´ï¼ˆæœªæ¥5åˆ†é’Ÿï¼‰ å­˜å…¥zsetä¸­
            cacheService.zAdd(ScheduleConstants.FUTURE + key, JSON.toJSONString(task), task.getExecuteTime());
        }

    }

    @Autowired
    private TaskinfoMapper taskinfoMapper;

    @Autowired
    private TaskinfoLogsMapper taskinfoLogsMapper;

    /**
     * æ·»åŠ ä»»åŠ¡åˆ°æ•°æ®åº“ä¸­
     *
     * @param task
     * @return
     */
    private boolean addTaskToDb(Task task) {

        boolean flag = false;

        try {
            //ä¿å­˜ä»»åŠ¡è¡¨
            Taskinfo taskinfo = new Taskinfo();
            BeanUtils.copyProperties(task, taskinfo);
            taskinfo.setExecuteTime(new Date(task.getExecuteTime()));
            taskinfoMapper.insert(taskinfo);

            //è®¾ç½®taskID
            task.setTaskId(taskinfo.getTaskId());

            //ä¿å­˜ä»»åŠ¡æ—¥å¿—æ•°æ®
            TaskinfoLogs taskinfoLogs = new TaskinfoLogs();
            BeanUtils.copyProperties(taskinfo, taskinfoLogs);
            taskinfoLogs.setVersion(1);
            taskinfoLogs.setStatus(ScheduleConstants.SCHEDULED);
            taskinfoLogsMapper.insert(taskinfoLogs);

            flag = true;
        } catch (Exception e) {
            e.printStackTrace();
        }

        return flag;
    }
}
```

#### 3.3 å–æ¶ˆä»»åŠ¡

##### 3.3.1 æ ¸å¿ƒä»£ç 

```java
/**
     * å–æ¶ˆä»»åŠ¡
     * @param taskId
     * @return
     */
@Override
public boolean cancelTask(long taskId) {

    boolean flag = false;

    //åˆ é™¤ä»»åŠ¡ï¼Œæ›´æ–°æ—¥å¿—
    Task task = updateDb(taskId,ScheduleConstants.EXECUTED);

    //åˆ é™¤redisçš„æ•°æ®
    if(task != null){
        removeTaskFromCache(task);
        flag = true;
    }

    return false;
}

/**
     * åˆ é™¤redisä¸­çš„ä»»åŠ¡æ•°æ®
     * @param task
     */
private void removeTaskFromCache(Task task) {

    String key = task.getTaskType()+"_"+task.getPriority();

    if(task.getExecuteTime()<=System.currentTimeMillis()){
        cacheService.lRemove(ScheduleConstants.TOPIC+key,0,JSON.toJSONString(task));
    }else {
        cacheService.zRemove(ScheduleConstants.FUTURE+key, JSON.toJSONString(task));
    }
}

/**
     * åˆ é™¤ä»»åŠ¡ï¼Œæ›´æ–°ä»»åŠ¡æ—¥å¿—çŠ¶æ€
     * @param taskId
     * @param status
     * @return
     */
private Task updateDb(long taskId, int status) {
    Task task = null;
    try {
        //åˆ é™¤ä»»åŠ¡
        taskinfoMapper.deleteById(taskId);

        TaskinfoLogs taskinfoLogs = taskinfoLogsMapper.selectById(taskId);
        taskinfoLogs.setStatus(status);
        taskinfoLogsMapper.updateById(taskinfoLogs);

        task = new Task();
        BeanUtils.copyProperties(taskinfoLogs,task);
        task.setExecuteTime(taskinfoLogs.getExecuteTime().getTime());
    }catch (Exception e){
        log.error("task cancel exception taskid={}",taskId);
    }

    return task;

}
```

#### 3.4 æ¶ˆè´¹ä»»åŠ¡

##### 3.4.1 æ ¸å¿ƒä»£ç 

```java
/**
     * æŒ‰ç…§ç±»å‹å’Œä¼˜å…ˆçº§æ‹‰å–ä»»åŠ¡
     * @return
     */
@Override
public Task poll(int type,int priority) {
    Task task = null;
    try {
        String key = type+"_"+priority;
        String task_json = cacheService.lRightPop(ScheduleConstants.TOPIC + key);
        if(StringUtils.isNotBlank(task_json)){
            task = JSON.parseObject(task_json, Task.class);
            //æ›´æ–°æ•°æ®åº“ä¿¡æ¯
            updateDb(task.getTaskId(),ScheduleConstants.EXECUTED);
        }
    }catch (Exception e){
        e.printStackTrace();
        log.error("poll task exception");
    }

    return task;
}
```

#### 3.5 æœªæ¥æ•°æ®å®šæ—¶åˆ·æ–°

##### 3.5.1 reids keyå€¼åŒ¹é…

æ–¹æ¡ˆ1ï¼škeys æ¨¡ç³ŠåŒ¹é…

keysçš„æ¨¡ç³ŠåŒ¹é…åŠŸèƒ½å¾ˆæ–¹ä¾¿ä¹Ÿå¾ˆå¼ºå¤§ï¼Œä½†æ˜¯åœ¨ç”Ÿäº§ç¯å¢ƒéœ€è¦æ…ç”¨ï¼å¼€å‘ä¸­ä½¿ç”¨keysçš„æ¨¡ç³ŠåŒ¹é…å´å‘ç°redisçš„**CPUä½¿ç”¨ç‡æé«˜**ï¼Œæ‰€ä»¥å…¬å¸çš„redisç”Ÿäº§ç¯å¢ƒå°†**keyså‘½ä»¤ç¦ç”¨**äº†ï¼**redisæ˜¯å•çº¿ç¨‹ï¼Œä¼šè¢«å µå¡**ã€‚

<div align="center">
    <img src="æˆªå›¾/å»¶è¿Ÿä»»åŠ¡/key.png" alt="key" />
</div>

æ–¹æ¡ˆ2ï¼šscan 

SCAN å‘½ä»¤æ˜¯ä¸€ä¸ª**åŸºäºæ¸¸æ ‡çš„è¿­ä»£å™¨**ï¼ŒSCANå‘½ä»¤æ¯æ¬¡è¢«è°ƒç”¨ä¹‹åï¼Œ éƒ½ä¼šå‘ç”¨æˆ·**è¿”å›ä¸€ä¸ªæ–°çš„æ¸¸æ ‡**ï¼Œ ç”¨æˆ·åœ¨ä¸‹æ¬¡è¿­ä»£æ—¶éœ€è¦ä½¿ç”¨è¿™ä¸ªæ–°æ¸¸æ ‡ä½œä¸ºSCANå‘½ä»¤çš„**æ¸¸æ ‡å‚æ•°**ï¼Œ ä»¥æ­¤æ¥å»¶ç»­ä¹‹å‰çš„è¿­ä»£è¿‡ç¨‹ã€‚

<div align="center">
    <img src="æˆªå›¾/å»¶è¿Ÿä»»åŠ¡/scan.png" alt="scan" />
</div>

##### 3.5.2 reidsç®¡é“

æ™®é€šrediså®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨äº¤äº’æ¨¡å¼

<div align="center">
    <img src="æˆªå›¾/å»¶è¿Ÿä»»åŠ¡/æ™®é€šäº¤äº’.png" alt="æ™®é€šäº¤äº’" />
</div>

Pipelineè¯·æ±‚æ¨¡å‹

<div align="center">
    <img src="æˆªå›¾/å»¶è¿Ÿä»»åŠ¡/Pipeline.png" alt="Pipeline" />
</div>

å®˜æ–¹æµ‹è¯•ç»“æœæ•°æ®å¯¹æ¯”

<div align="center">
    <img src="æˆªå›¾/å»¶è¿Ÿä»»åŠ¡/å®˜æ–¹æµ‹è¯•ç»“æœå¯¹æ¯”.png" alt="å®˜æ–¹æµ‹è¯•ç»“æœå¯¹æ¯”" />
</div>

##### 3.5.3 æ ¸å¿ƒä»£ç 

```java
@Scheduled(cron = "0 */1 * * * ?")
public void refresh() {
    System.out.println(System.currentTimeMillis() / 1000 + "æ‰§è¡Œäº†å®šæ—¶ä»»åŠ¡");

    // è·å–æ‰€æœ‰æœªæ¥æ•°æ®é›†åˆçš„keyå€¼
    Set<String> futureKeys = cacheService.scan(ScheduleConstants.FUTURE + "*");// future_*
    for (String futureKey : futureKeys) { // future_250_250

        String topicKey = ScheduleConstants.TOPIC + futureKey.split(ScheduleConstants.FUTURE)[1];
        //è·å–è¯¥ç»„keyä¸‹å½“å‰éœ€è¦æ¶ˆè´¹çš„ä»»åŠ¡æ•°æ®
        Set<String> tasks = cacheService.zRangeByScore(futureKey, 0, System.currentTimeMillis());
        if (!tasks.isEmpty()) {
            //å°†è¿™äº›ä»»åŠ¡æ•°æ®æ·»åŠ åˆ°æ¶ˆè´¹è€…é˜Ÿåˆ—ä¸­
            cacheService.refreshWithPipeline(futureKey, topicKey, tasks);
            System.out.println("æˆåŠŸçš„å°†" + futureKey + "ä¸‹çš„å½“å‰éœ€è¦æ‰§è¡Œçš„ä»»åŠ¡æ•°æ®åˆ·æ–°åˆ°" + topicKey + "ä¸‹");
        }
    }
}
```

åœ¨å¼•å¯¼ç±»ä¸­æ·»åŠ å¼€å¯ä»»åŠ¡è°ƒåº¦æ³¨è§£ï¼š`@EnableScheduling`

#### 3.6 åˆ†å¸ƒå¼é”è§£å†³é›†ç¾¤ä¸‹çš„æ–¹æ³•æŠ¢å æ‰§è¡Œ

##### 3.6.1 é—®é¢˜æè¿°

å¯åŠ¨ä¸¤å°heima-leadnews-scheduleæœåŠ¡ï¼Œæ¯å°æœåŠ¡éƒ½ä¼šå»æ‰§è¡Œrefreshå®šæ—¶ä»»åŠ¡æ–¹æ³•

<div align="center">
    <img src="æˆªå›¾/å»¶è¿Ÿä»»åŠ¡/é›†ç¾¤æŠ¢å .png" alt="é›†ç¾¤æŠ¢å " />
</div>

##### 3.6.2 åˆ†å¸ƒå¼é”

åˆ†å¸ƒå¼é”ï¼šæ§åˆ¶åˆ†å¸ƒå¼ç³»ç»Ÿæœ‰åºçš„å»å¯¹å…±äº«èµ„æºè¿›è¡Œæ“ä½œï¼Œé€šè¿‡äº’æ–¥æ¥ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ã€‚

è§£å†³æ–¹æ¡ˆï¼š

<div align="center">
    <img src="æˆªå›¾/å»¶è¿Ÿä»»åŠ¡/åˆ†å¸ƒå¼é”.png" alt="åˆ†å¸ƒå¼é”" />
</div>

##### 3.6.3 redisåˆ†å¸ƒå¼é”

sexnx ï¼ˆSET if Not eXistsï¼‰ å‘½ä»¤åœ¨æŒ‡å®šçš„ key ä¸å­˜åœ¨æ—¶ï¼Œä¸º key è®¾ç½®æŒ‡å®šçš„å€¼ã€‚

<div align="center">
    <img src="æˆªå›¾/å»¶è¿Ÿä»»åŠ¡/redisåˆ†å¸ƒå¼é”.png" alt="redisåˆ†å¸ƒå¼é”" />
</div>

è¿™ç§åŠ é”çš„æ€è·¯æ˜¯ï¼Œå¦‚æœ key ä¸å­˜åœ¨åˆ™ä¸º key è®¾ç½® valueï¼Œå¦‚æœ key å·²å­˜åœ¨åˆ™ SETNX å‘½ä»¤ä¸åšä»»ä½•æ“ä½œ

- å®¢æˆ·ç«¯Aè¯·æ±‚æœåŠ¡å™¨è®¾ç½®keyçš„å€¼ï¼Œå¦‚æœè®¾ç½®æˆåŠŸå°±è¡¨ç¤ºåŠ é”æˆåŠŸ
- å®¢æˆ·ç«¯Bä¹Ÿå»è¯·æ±‚æœåŠ¡å™¨è®¾ç½®keyçš„å€¼ï¼Œå¦‚æœè¿”å›å¤±è´¥ï¼Œé‚£ä¹ˆå°±ä»£è¡¨åŠ é”å¤±è´¥
- å®¢æˆ·ç«¯Aæ‰§è¡Œä»£ç å®Œæˆï¼Œåˆ é™¤é”
- å®¢æˆ·ç«¯Båœ¨ç­‰å¾…ä¸€æ®µæ—¶é—´åå†å»è¯·æ±‚è®¾ç½®keyçš„å€¼ï¼Œè®¾ç½®æˆåŠŸ
- å®¢æˆ·ç«¯Bæ‰§è¡Œä»£ç å®Œæˆï¼Œåˆ é™¤é”

##### 3.6.4 åœ¨å·¥å…·ç±»CacheServiceä¸­æ·»åŠ æ–¹æ³•

```java
/**
 * åŠ é”
 *
 * @param name
 * @param expire
 * @return
 */
public String tryLock(String name, long expire) {
    name = name + "_lock";
    String token = UUID.randomUUID().toString();
    RedisConnectionFactory factory = stringRedisTemplate.getConnectionFactory();
    RedisConnection conn = factory.getConnection();
    try {

        //å‚è€ƒrediså‘½ä»¤ï¼š
        //set key value [EX seconds] [PX milliseconds] [NX|XX]
        Boolean result = conn.set(
                name.getBytes(),
                token.getBytes(),
                Expiration.from(expire, TimeUnit.MILLISECONDS),
                RedisStringCommands.SetOption.SET_IF_ABSENT //NX
        );
        if (result != null && result)
            return token;
    } finally {
        RedisConnectionUtils.releaseConnection(conn, factory,false);
    }
    return null;
}
```

ä¿®æ”¹æœªæ¥æ•°æ®å®šæ—¶åˆ·æ–°çš„æ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š

```java
/**
 * æœªæ¥æ•°æ®å®šæ—¶åˆ·æ–°
 */
@Scheduled(cron = "0 */1 * * * ?")
public void refresh(){

    String token = cacheService.tryLock("FUTURE_TASK_SYNC", 1000 * 30);
    if(StringUtils.isNotBlank(token)){
        log.info("æœªæ¥æ•°æ®å®šæ—¶åˆ·æ–°---å®šæ—¶ä»»åŠ¡");

        //è·å–æ‰€æœ‰æœªæ¥æ•°æ®çš„é›†åˆkey
        Set<String> futureKeys = cacheService.scan(ScheduleConstants.FUTURE + "*");
        for (String futureKey : futureKeys) {//future_100_50

            //è·å–å½“å‰æ•°æ®çš„key  topic
            String topicKey = ScheduleConstants.TOPIC+futureKey.split(ScheduleConstants.FUTURE)[1];

            //æŒ‰ç…§keyå’Œåˆ†å€¼æŸ¥è¯¢ç¬¦åˆæ¡ä»¶çš„æ•°æ®
            Set<String> tasks = cacheService.zRangeByScore(futureKey, 0, System.currentTimeMillis());

            //åŒæ­¥æ•°æ®
            if(!tasks.isEmpty()){
                cacheService.refreshWithPipeline(futureKey,topicKey,tasks);
                log.info("æˆåŠŸçš„å°†"+futureKey+"åˆ·æ–°åˆ°äº†"+topicKey);
            }
        }
    }
}
```

#### 3.7 æ•°æ®åº“åŒæ­¥åˆ°redis

<div align="center">
    <img src="æˆªå›¾/å»¶è¿Ÿä»»åŠ¡/æ•°æ®åº“åŒæ­¥åˆ°redis.png" alt="æ•°æ®åº“åŒæ­¥åˆ°redis" />
</div>



```java
@Scheduled(cron = "0 */5 * * * ?")
@PostConstruct //æœºå™¨å®•æœºäº†ï¼Œå¸Œæœ›åœ¨æ¢å¤ä¹‹åç¬¬ä¸€æ—¶é—´åšæ•°æ®çš„åŒæ­¥
public void reloadData() {
    clearCache();
    log.info("æ•°æ®åº“æ•°æ®åŒæ­¥åˆ°ç¼“å­˜");
    Calendar calendar = Calendar.getInstance();
    calendar.add(Calendar.MINUTE, 5);

    //æŸ¥çœ‹å°äºæœªæ¥5åˆ†é’Ÿçš„æ‰€æœ‰ä»»åŠ¡
    List<Taskinfo> allTasks = taskinfoMapper.selectList(Wrappers.<Taskinfo>lambdaQuery().lt(Taskinfo::getExecuteTime,calendar.getTime()));
    if(allTasks != null && allTasks.size() > 0){
        for (Taskinfo taskinfo : allTasks) {
            Task task = new Task();
            BeanUtils.copyProperties(taskinfo,task);
            task.setExecuteTime(taskinfo.getExecuteTime().getTime());
            addTaskToCache(task);
        }
    }
}

private void clearCache(){
    // åˆ é™¤ç¼“å­˜ä¸­æœªæ¥æ•°æ®é›†åˆå’Œå½“å‰æ¶ˆè´¹è€…é˜Ÿåˆ—çš„æ‰€æœ‰key
    Set<String> futurekeys = cacheService.scan(ScheduleConstants.FUTURE + "*");// future_
    Set<String> topickeys = cacheService.scan(ScheduleConstants.TOPIC + "*");// topic_
    cacheService.delete(futurekeys);
    cacheService.delete(topickeys);
}
```

### 4. å»¶è¿Ÿé˜Ÿåˆ—è§£å†³ç²¾å‡†æ—¶é—´å‘å¸ƒæ–‡ç« 

##### 4.1 å»¶è¿Ÿé˜Ÿåˆ—æœåŠ¡æä¾›å¯¹å¤–æ¥å£

æä¾›è¿œç¨‹çš„feignæ¥å£ï¼Œåœ¨heima-leadnews-feign-apiç¼–å†™ç±»å¦‚ä¸‹ï¼š

```java
@FeignClient("leadnews-schedule")
public interface IScheduleClient {

    /**
     * æ·»åŠ ä»»åŠ¡
     * @param task   ä»»åŠ¡å¯¹è±¡
     * @return       ä»»åŠ¡id
     */
    @PostMapping("/api/v1/task/add")
    public ResponseResult  addTask(@RequestBody Task task);

    /**
     * å–æ¶ˆä»»åŠ¡
     * @param taskId        ä»»åŠ¡id
     * @return              å–æ¶ˆç»“æœ
     */
    @GetMapping("/api/v1/task/cancel/{taskId}")
    public ResponseResult cancelTask(@PathVariable("taskId") long taskId);

    /**
     * æŒ‰ç…§ç±»å‹å’Œä¼˜å…ˆçº§æ¥æ‹‰å–ä»»åŠ¡
     * @param type
     * @param priority
     * @return
     */
    @GetMapping("/api/v1/task/poll/{type}/{priority}")
    public ResponseResult poll(@PathVariable("type") int type,@PathVariable("priority")  int priority);
}
```

åœ¨heima-leadnews-scheduleå¾®æœåŠ¡ä¸‹æä¾›å¯¹åº”çš„å®ç°

```java
@RestController
public class ScheduleClient implements IScheduleClient {

    @Autowired
    private TaskService taskService;

    /**
     * æ·»åŠ ä»»åŠ¡
     * @param task ä»»åŠ¡å¯¹è±¡
     * @return ä»»åŠ¡id
     */
    @PostMapping("/api/v1/task/add")
    @Override
    public ResponseResult addTask(@RequestBody Task task) {
        return ResponseResult.okResult(taskService.addTask(task));
    }

    /**
     * å–æ¶ˆä»»åŠ¡
     * @param taskId ä»»åŠ¡id
     * @return å–æ¶ˆç»“æœ
     */
    @GetMapping("/api/v1/task/cancel/{taskId}")
    @Override
    public ResponseResult cancelTask(@PathVariable("taskId") long taskId) {
        return ResponseResult.okResult(taskService.cancelTask(taskId));
    }

    /**
     * æŒ‰ç…§ç±»å‹å’Œä¼˜å…ˆçº§æ¥æ‹‰å–ä»»åŠ¡
     * @param type
     * @param priority
     * @return
     */
    @GetMapping("/api/v1/task/poll/{type}/{priority}")
    @Override
    public ResponseResult poll(@PathVariable("type") int type, @PathVariable("priority") int priority) {
        return ResponseResult.okResult(taskService.poll(type,priority));
    }
}
```

##### 4.2 å‘å¸ƒæ–‡ç« é›†æˆæ·»åŠ å»¶è¿Ÿé˜Ÿåˆ—æ¥å£

æšä¸¾ç±»ï¼š

```java
@Getter
@AllArgsConstructor
public enum TaskTypeEnum {

    NEWS_SCAN_TIME(1001, 1,"æ–‡ç« å®šæ—¶å®¡æ ¸"),
    REMOTEERROR(1002, 2,"ç¬¬ä¸‰æ–¹æ¥å£è°ƒç”¨å¤±è´¥ï¼Œé‡è¯•");
    private final int taskType; //å¯¹åº”å…·ä½“ä¸šåŠ¡
    private final int priority; //ä¸šåŠ¡ä¸åŒçº§åˆ«
    private final String desc; //æè¿°ä¿¡æ¯
}
```

###### 4.2.1 åºåˆ—åŒ–å·¥å…·å¯¹æ¯”

- JdkSerializeï¼šjavaå†…ç½®çš„åºåˆ—åŒ–èƒ½å°†å®ç°äº†Serilazableæ¥å£çš„å¯¹è±¡è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Œ ObjectOutputStreamçš„writeObject()æ–¹æ³•å¯åºåˆ—åŒ–å¯¹è±¡ç”Ÿæˆå­—èŠ‚æ•°ç»„
- Protostuffï¼šgoogleå¼€æºçš„protostuffé‡‡ç”¨æ›´ä¸ºç´§å‡‘çš„äºŒè¿›åˆ¶æ•°ç»„ï¼Œè¡¨ç°æ›´åŠ ä¼˜å¼‚ï¼Œç„¶åä½¿ç”¨protostuffçš„ç¼–è¯‘å·¥å…·ç”Ÿæˆpojoç±»

###### 4.2.2 æ ¸å¿ƒä»£ç 

```java
@Service
@Slf4j
public class WmNewsTaskServiceImpl  implements WmNewsTaskService {

    @Autowired
    private IScheduleClient scheduleClient;

    /**
     * æ·»åŠ ä»»åŠ¡åˆ°å»¶è¿Ÿé˜Ÿåˆ—ä¸­
     * @param id          æ–‡ç« çš„id
     * @param publishTime å‘å¸ƒçš„æ—¶é—´  å¯ä»¥åšä¸ºä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´
     */
    @Override
    @Async //å¼‚æ­¥æ–¹æ³•
    public void addNewsToTask(Integer id, Date publishTime) {

        log.info("æ·»åŠ ä»»åŠ¡åˆ°å»¶è¿ŸæœåŠ¡ä¸­----begin");

        Task task = new Task();
        task.setExecuteTime(publishTime.getTime());
        task.setTaskType(TaskTypeEnum.NEWS_SCAN_TIME.getTaskType());
        task.setPriority(TaskTypeEnum.NEWS_SCAN_TIME.getPriority());
        WmNews wmNews = new WmNews();
        wmNews.setId(id);
        task.setParameters(ProtostuffUtil.serialize(wmNews));

        scheduleClient.addTask(task);

        log.info("æ·»åŠ ä»»åŠ¡åˆ°å»¶è¿ŸæœåŠ¡ä¸­----end");
    }
    
}
```

ä¿®æ”¹å‘å¸ƒæ–‡ç« ä»£ç ï¼š

æŠŠä¹‹å‰çš„å¼‚æ­¥è°ƒç”¨ä¿®æ”¹ä¸ºè°ƒç”¨å»¶è¿Ÿä»»åŠ¡

```java
    //å®¡æ ¸æ–‡ç« 
    //        wmNewsAutoScanService.autoScanWmNews(wmNews.getId());
    wmNewsTaskService.addNewsToTask(wmNews.getId(),wmNews.getPublishTime());
```

##### 4.3 æ¶ˆè´¹ä»»åŠ¡è¿›è¡Œå®¡æ ¸æ–‡ç« 

å®ç°

```java
@Autowired
private WmNewsAutoScanServiceImpl wmNewsAutoScanService;

/**
     * æ¶ˆè´¹å»¶è¿Ÿé˜Ÿåˆ—æ•°æ®
     */
@Scheduled(fixedRate = 1000)
@Override
@SneakyThrows
public void scanNewsByTask() {

    log.info("æ–‡ç« å®¡æ ¸---æ¶ˆè´¹ä»»åŠ¡æ‰§è¡Œ---begin---");

    ResponseResult responseResult = scheduleClient.poll(TaskTypeEnum.NEWS_SCAN_TIME.getTaskType(), TaskTypeEnum.NEWS_SCAN_TIME.getPriority());
    if(responseResult.getCode().equals(200) && responseResult.getData() != null){
        String json_str = JSON.toJSONString(responseResult.getData());
        Task task = JSON.parseObject(json_str, Task.class);
        byte[] parameters = task.getParameters();
        WmNews wmNews = ProtostuffUtil.deserialize(parameters, WmNews.class);
        System.out.println(wmNews.getId()+"-----------");
        wmNewsAutoScanService.autoScanWmNews(wmNews.getId());
    }
    log.info("æ–‡ç« å®¡æ ¸---æ¶ˆè´¹ä»»åŠ¡æ‰§è¡Œ---end---");
}
```

åœ¨WemediaApplicationè‡ªåª’ä½“çš„å¼•å¯¼ç±»ä¸­æ·»åŠ å¼€å¯ä»»åŠ¡è°ƒåº¦æ³¨è§£`@EnableScheduling`

## åäºŒã€kafkaåŠå¼‚æ­¥é€šçŸ¥æ–‡ç« ä¸Šä¸‹æ¶

### 1. è‡ªåª’ä½“æ–‡ç« ä¸Šä¸‹æ¶

éœ€æ±‚åˆ†æ

<div align="center">
    <img src="æˆªå›¾/æ–‡ç« ä¸Šä¸‹æ¶/éœ€æ±‚åˆ†æ.png" alt="éœ€æ±‚åˆ†æ" />
</div>

<div align="center">
    <img src="æˆªå›¾/æ–‡ç« ä¸Šä¸‹æ¶/ç³»ç»Ÿè§£è€¦.png" alt="ç³»ç»Ÿè§£è€¦" />
</div>

### 2. kafkaæ¦‚è¿°

æ¶ˆæ¯ä¸­é—´ä»¶å¯¹æ¯”                              

| ç‰¹æ€§       | ActiveMQ                               | RabbitMQ                   | RocketMQ                 | Kafka                                    |
| ---------- | -------------------------------------- | -------------------------- | ------------------------ | ---------------------------------------- |
| å¼€å‘è¯­è¨€   | java                                   | erlang                     | java                     | scala                                    |
| å•æœºååé‡ | ä¸‡çº§                                   | ä¸‡çº§                       | 10ä¸‡çº§                   | 100ä¸‡çº§                                  |
| æ—¶æ•ˆæ€§     | ms                                     | us                         | ms                       | msçº§ä»¥å†…                                 |
| å¯ç”¨æ€§     | é«˜ï¼ˆä¸»ä»ï¼‰                             | é«˜ï¼ˆä¸»ä»ï¼‰                 | éå¸¸é«˜ï¼ˆåˆ†å¸ƒå¼ï¼‰         | éå¸¸é«˜ï¼ˆåˆ†å¸ƒå¼ï¼‰                         |
| åŠŸèƒ½ç‰¹æ€§   | æˆç†Ÿçš„äº§å“ã€è¾ƒå…¨çš„æ–‡æ¡£ã€å„ç§åè®®æ”¯æŒå¥½ | å¹¶å‘èƒ½åŠ›å¼ºã€æ€§èƒ½å¥½ã€å»¶è¿Ÿä½ | MQåŠŸèƒ½æ¯”è¾ƒå®Œå–„ï¼Œæ‰©å±•æ€§ä½³ | åªæ”¯æŒä¸»è¦çš„MQåŠŸèƒ½ï¼Œä¸»è¦åº”ç”¨äºå¤§æ•°æ®é¢†åŸŸ |

æ¶ˆæ¯ä¸­é—´ä»¶å¯¹æ¯”-é€‰æ‹©å»ºè®®

| **æ¶ˆæ¯ä¸­é—´ä»¶** | **å»ºè®®**                                                     |
| -------------- | ------------------------------------------------------------ |
| Kafka          | è¿½æ±‚é«˜ååé‡ï¼Œé€‚åˆäº§ç”Ÿå¤§é‡æ•°æ®çš„äº’è”ç½‘æœåŠ¡çš„æ•°æ®æ”¶é›†ä¸šåŠ¡     |
| RocketMQ       | å¯é æ€§è¦æ±‚å¾ˆé«˜çš„é‡‘èäº’è”ç½‘é¢†åŸŸ,ç¨³å®šæ€§é«˜ï¼Œç»å†äº†å¤šæ¬¡é˜¿é‡ŒåŒ11è€ƒéªŒ |
| RabbitMQ       | æ€§èƒ½è¾ƒå¥½ï¼Œç¤¾åŒºæ´»è·ƒåº¦é«˜ï¼Œæ•°æ®é‡æ²¡æœ‰é‚£ä¹ˆå¤§ï¼Œä¼˜å…ˆé€‰æ‹©åŠŸèƒ½æ¯”è¾ƒå®Œå¤‡çš„RabbitMQ |

kafkaä»‹ç»

Kafka æ˜¯ä¸€ä¸ª**åˆ†å¸ƒå¼æµåª’ä½“å¹³å°**,ç±»ä¼¼äºæ¶ˆæ¯é˜Ÿåˆ—æˆ–ä¼ä¸šæ¶ˆæ¯ä¼ é€’ç³»ç»Ÿã€‚kafkaå®˜ç½‘ï¼šhttp://kafka.apache.org/  

<div align="center">
    <img src="æˆªå›¾/æ–‡ç« ä¸Šä¸‹æ¶/kafka.png" alt="kafka" />
</div>

kafkaä»‹ç»-åè¯è§£é‡Š

<div align="center">
    <img src="æˆªå›¾/æ–‡ç« ä¸Šä¸‹æ¶/åè¯è§£é‡Š.png" alt="åè¯è§£é‡Š" />
</div>

- producerï¼šå‘å¸ƒæ¶ˆæ¯çš„å¯¹è±¡ç§°ä¹‹ä¸ºä¸»é¢˜ç”Ÿäº§è€…ï¼ˆKafka topic producerï¼‰

- topicï¼šKafkaå°†æ¶ˆæ¯åˆ†é—¨åˆ«ç±»ï¼Œæ¯ä¸€ç±»çš„æ¶ˆæ¯ç§°ä¹‹ä¸ºä¸€ä¸ªä¸»é¢˜ï¼ˆTopicï¼‰

- consumerï¼šè®¢é˜…æ¶ˆæ¯å¹¶å¤„ç†å‘å¸ƒçš„æ¶ˆæ¯çš„å¯¹è±¡ç§°ä¹‹ä¸ºä¸»é¢˜æ¶ˆè´¹è€…ï¼ˆconsumersï¼‰

- brokerï¼šå·²å‘å¸ƒçš„æ¶ˆæ¯ä¿å­˜åœ¨ä¸€ç»„æœåŠ¡å™¨ä¸­ï¼Œç§°ä¹‹ä¸ºKafkaé›†ç¾¤ã€‚é›†ç¾¤ä¸­çš„**æ¯ä¸€ä¸ªæœåŠ¡å™¨**éƒ½æ˜¯ä¸€ä¸ª**ä»£ç†ï¼ˆBrokerï¼‰**ã€‚ æ¶ˆè´¹è€…å¯ä»¥è®¢é˜…ä¸€ä¸ªæˆ–å¤šä¸ªä¸»é¢˜ï¼ˆtopicï¼‰ï¼Œå¹¶ä»Brokeræ‹‰æ•°æ®ï¼Œä»è€Œæ¶ˆè´¹è¿™äº›å·²å‘å¸ƒçš„æ¶ˆæ¯ã€‚

### 3. kafkaå®‰è£…é…ç½®

Kafkaå¯¹äºzookeeperæ˜¯å¼ºä¾èµ–ï¼Œä¿å­˜kafkaç›¸å…³çš„èŠ‚ç‚¹æ•°æ®ï¼Œæ‰€ä»¥å®‰è£…Kafkaä¹‹å‰å¿…é¡»å…ˆå®‰è£…zookeeper

- Dockerå®‰è£…zookeeper

ä¸‹è½½é•œåƒï¼š

```shell
docker pull zookeeper:3.4.14
```

åˆ›å»ºå®¹å™¨

```shell
docker run -d --name zookeeper -p 2181:2181 zookeeper:3.4.14
```

- Dockerå®‰è£…kafka

ä¸‹è½½é•œåƒï¼š

```shell
docker pull wurstmeister/kafka:2.12-2.3.1
```

åˆ›å»ºå®¹å™¨

```shell
docker run -d --name kafka \
--env KAFKA_ADVERTISED_HOST_NAME=192.168.200.130 \
--env KAFKA_ZOOKEEPER_CONNECT=192.168.200.130:2181 \
--env KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://192.168.200.130:9092 \
--env KAFKA_LISTENERS=PLAINTEXT://0.0.0.0:9092 \
--env KAFKA_HEAP_OPTS="-Xmx256M -Xms256M" \
--net=host wurstmeister/kafka:2.12-2.3.1
```

### 4. kafkaé«˜å¯ç”¨è®¾è®¡

#### 4.1 é›†ç¾¤

<div align="center">
    <img src="æˆªå›¾/æ–‡ç« ä¸Šä¸‹æ¶/é›†ç¾¤.png" alt="é›†ç¾¤" />
</div>

- Kafka çš„æœåŠ¡å™¨ç«¯ç”±è¢«ç§°ä¸º Broker çš„**æœåŠ¡è¿›ç¨‹**æ„æˆï¼Œå³ä¸€ä¸ª Kafka é›†ç¾¤ç”±å¤šä¸ª Broker ç»„æˆ

- è¿™æ ·å¦‚æœé›†ç¾¤ä¸­æŸä¸€å°æœºå™¨å®•æœºï¼Œå…¶ä»–æœºå™¨ä¸Šçš„ Broker ä¹Ÿä¾ç„¶èƒ½å¤Ÿå¯¹å¤–æä¾›æœåŠ¡ã€‚è¿™å…¶å®å°±æ˜¯ Kafka æä¾›é«˜å¯ç”¨çš„æ‰‹æ®µä¹‹ä¸€

#### 4.2 å¤‡ä»½æœºåˆ¶(Replicationï¼‰

<div align="center">
    <img src="æˆªå›¾/æ–‡ç« ä¸Šä¸‹æ¶/å¤‡ä»½æœºåˆ¶.png" alt="å¤‡ä»½æœºåˆ¶" />
</div>

Kafka ä¸­æ¶ˆæ¯çš„å¤‡ä»½åˆå«åš **å‰¯æœ¬ï¼ˆReplicaï¼‰**

Kafka å®šä¹‰äº†ä¸¤ç±»å‰¯æœ¬ï¼š

- é¢†å¯¼è€…å‰¯æœ¬ï¼ˆLeader Replicaï¼‰

- è¿½éšè€…å‰¯æœ¬ï¼ˆFollower Replicaï¼‰

##### åŒæ­¥æ–¹å¼

<div align="center">
    <img src="æˆªå›¾/æ–‡ç« ä¸Šä¸‹æ¶/åŒæ­¥æ–¹å¼.png" alt="åŒæ­¥æ–¹å¼" />
</div>

ISRï¼ˆin-**sync** replicaï¼‰éœ€è¦**åŒæ­¥å¤åˆ¶**ä¿å­˜çš„follower



å¦‚æœleaderå¤±æ•ˆåï¼Œéœ€è¦é€‰å‡ºæ–°çš„leaderï¼Œé€‰ä¸¾çš„åŸåˆ™å¦‚ä¸‹ï¼š

ç¬¬ä¸€ï¼šé€‰ä¸¾æ—¶**ä¼˜å…ˆä»ISR**ä¸­é€‰å®šï¼Œå› ä¸ºè¿™ä¸ªåˆ—è¡¨ä¸­followerçš„æ•°æ®æ˜¯ä¸leader**åŒæ­¥**çš„

ç¬¬äºŒï¼šå¦‚æœISRåˆ—è¡¨ä¸­çš„follower**éƒ½ä¸è¡Œäº†**ï¼Œå°±**åªèƒ½ä»å…¶ä»–followerä¸­é€‰å–**



æç«¯æƒ…å†µï¼Œå°±æ˜¯æ‰€æœ‰å‰¯æœ¬éƒ½å¤±æ•ˆäº†ï¼Œè¿™æ—¶æœ‰ä¸¤ç§æ–¹æ¡ˆ

ç¬¬ä¸€ï¼š**ç­‰å¾…ISRä¸­çš„ä¸€ä¸ªæ´»è¿‡æ¥ï¼Œ**é€‰ä¸ºLeaderï¼Œ**æ•°æ®å¯é **ï¼Œä½†æ´»è¿‡æ¥çš„**æ—¶é—´ä¸ç¡®å®š**

ç¬¬äºŒï¼š**é€‰æ‹©ç¬¬ä¸€ä¸ªæ´»**è¿‡æ¥çš„Replicationï¼Œä¸ä¸€å®šæ˜¯ISRä¸­çš„ï¼Œé€‰ä¸ºleaderï¼Œä»¥**æœ€å¿«é€Ÿåº¦æ¢å¤å¯ç”¨æ€§**ï¼Œ**ä½†æ•°æ®ä¸ä¸€å®šå®Œæ•´**

### 5. ç”Ÿäº§è€…è¯¦è§£

#### 5.1 å‚æ•°è¯¦è§£

- ack

ä»£ç çš„é…ç½®æ–¹å¼ï¼š

```java
//acké…ç½®  æ¶ˆæ¯ç¡®è®¤æœºåˆ¶
prop.put(ProducerConfig.ACKS_CONFIG,"all");
```

å‚æ•°çš„é€‰æ‹©è¯´æ˜

| **ç¡®è®¤æœºåˆ¶**     | **è¯´æ˜**                                                     |
| ---------------- | ------------------------------------------------------------ |
| acks=0           | ç”Ÿäº§è€…åœ¨æˆåŠŸå†™å…¥æ¶ˆæ¯ä¹‹å‰ä¸ä¼šç­‰å¾…ä»»ä½•æ¥è‡ªæœåŠ¡å™¨çš„å“åº”,æ¶ˆæ¯æœ‰ä¸¢å¤±çš„é£é™©ï¼Œä½†æ˜¯é€Ÿåº¦æœ€å¿« |
| acks=1ï¼ˆé»˜è®¤å€¼ï¼‰ | åªè¦é›†ç¾¤**é¦–é¢†èŠ‚ç‚¹**æ”¶åˆ°æ¶ˆæ¯ï¼Œç”Ÿäº§è€…å°±ä¼šæ”¶åˆ°ä¸€ä¸ªæ¥è‡ªæœåŠ¡å™¨çš„æˆåŠŸå“åº” |
| acks=all         | åªæœ‰å½“æ‰€æœ‰å‚ä¸èµ‹å€¼çš„èŠ‚ç‚¹å…¨éƒ¨æ”¶åˆ°æ¶ˆæ¯æ—¶ï¼Œç”Ÿäº§è€…æ‰ä¼šæ”¶åˆ°ä¸€ä¸ªæ¥è‡ªæœåŠ¡å™¨çš„æˆåŠŸå“åº” |

- retries

ç”Ÿäº§è€…ä»æœåŠ¡å™¨æ”¶åˆ°çš„é”™è¯¯æœ‰å¯èƒ½æ˜¯ä¸´æ—¶æ€§é”™è¯¯ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œretrieså‚æ•°çš„å€¼å†³å®šäº†ç”Ÿäº§è€…å¯ä»¥é‡å‘æ¶ˆæ¯çš„æ¬¡æ•°ï¼Œå¦‚æœè¾¾åˆ°è¿™ä¸ªæ¬¡æ•°ï¼Œç”Ÿäº§è€…ä¼šæ”¾å¼ƒé‡è¯•è¿”å›é”™è¯¯ï¼Œ**é»˜è®¤æƒ…å†µ**ä¸‹ï¼Œç”Ÿäº§è€…ä¼šåœ¨æ¯æ¬¡é‡è¯•ä¹‹é—´ç­‰å¾…**100ms**

ä»£ç ä¸­é…ç½®æ–¹å¼ï¼š

```java
//é‡è¯•æ¬¡æ•°
prop.put(ProducerConfig.RETRIES_CONFIG,10);
```

- æ¶ˆæ¯å‹ç¼©

é»˜è®¤æƒ…å†µä¸‹ï¼Œ æ¶ˆæ¯å‘é€æ—¶ä¸ä¼šè¢«å‹ç¼©ã€‚

ä»£ç ä¸­é…ç½®æ–¹å¼ï¼š

```java
//æ•°æ®å‹ç¼©
prop.put(ProducerConfig.COMPRESSION_TYPE_CONFIG,"lz4");
```

| **å‹ç¼©ç®—æ³•** | **è¯´æ˜**                                                     |
| ------------ | ------------------------------------------------------------ |
| snappy       | å ç”¨è¾ƒå°‘çš„  CPUï¼Œ  å´èƒ½æä¾›è¾ƒå¥½çš„æ€§èƒ½å’Œç›¸å½“å¯è§‚çš„å‹ç¼©æ¯”ï¼Œ å¦‚æœçœ‹é‡æ€§èƒ½å’Œç½‘ç»œå¸¦å®½ï¼Œå»ºè®®é‡‡ç”¨ |
| lz4          | å ç”¨è¾ƒå°‘çš„ CPUï¼Œ å‹ç¼©å’Œè§£å‹ç¼©é€Ÿåº¦è¾ƒå¿«ï¼Œå‹ç¼©æ¯”ä¹Ÿå¾ˆå®¢è§‚        |
| gzip         | å ç”¨è¾ƒå¤šçš„  CPUï¼Œä½†ä¼šæä¾›æ›´é«˜çš„å‹ç¼©æ¯”ï¼Œç½‘ç»œå¸¦å®½æœ‰é™ï¼Œå¯ä»¥ä½¿ç”¨è¿™ç§ç®—æ³• |

**ä½¿ç”¨å‹ç¼©å¯ä»¥é™ä½ç½‘ç»œä¼ è¾“å¼€é”€å’Œå­˜å‚¨å¼€é”€ï¼Œè€Œè¿™å¾€å¾€æ˜¯å‘ Kafka å‘é€æ¶ˆæ¯çš„ç“¶é¢ˆæ‰€åœ¨**ã€‚

### 6.æ¶ˆè´¹è€…è¯¦è§£

#### 6.1 æ¶ˆè´¹è€…ç»„

<div align="center">
    <img src="æˆªå›¾/æ–‡ç« ä¸Šä¸‹æ¶/æ¶ˆè´¹è€….png" alt="æ¶ˆè´¹è€…" />
</div>

- æ¶ˆè´¹è€…ç»„ï¼ˆConsumer Groupï¼‰ ï¼šæŒ‡çš„å°±æ˜¯ç”±**ä¸€ä¸ªæˆ–å¤šä¸ªæ¶ˆè´¹è€…**ç»„æˆçš„ç¾¤ä½“

- ä¸€ä¸ªå‘å¸ƒåœ¨Topicä¸Šæ¶ˆæ¯è¢«åˆ†å‘ç»™**æ­¤æ¶ˆè´¹è€…ç»„ä¸­çš„ä¸€ä¸ªæ¶ˆè´¹è€…**

  - æ‰€æœ‰çš„æ¶ˆè´¹è€…éƒ½åœ¨ä¸€ä¸ªç»„ä¸­ï¼Œé‚£ä¹ˆè¿™å°±å˜æˆäº†queueæ¨¡å‹

  - æ‰€æœ‰çš„æ¶ˆè´¹è€…éƒ½åœ¨ä¸åŒçš„ç»„ä¸­ï¼Œé‚£ä¹ˆå°±å®Œå…¨å˜æˆäº†å‘å¸ƒ-è®¢é˜…æ¨¡å‹

#### 6.2 æ¶ˆæ¯æœ‰åºæ€§

åº”ç”¨åœºæ™¯ï¼š

- å³æ—¶æ¶ˆæ¯ä¸­çš„å•å¯¹å•èŠå¤©å’Œç¾¤èŠï¼Œä¿è¯å‘é€æ–¹æ¶ˆæ¯å‘é€é¡ºåºä¸æ¥æ”¶æ–¹çš„é¡ºåºä¸€è‡´

- å……å€¼è½¬è´¦ä¸¤ä¸ªæ¸ é“åœ¨åŒä¸€ä¸ªæ—¶é—´è¿›è¡Œä½™é¢å˜æ›´ï¼ŒçŸ­ä¿¡é€šçŸ¥å¿…é¡»è¦æœ‰é¡ºåº

<div align="center">
    <img src="æˆªå›¾/æ–‡ç« ä¸Šä¸‹æ¶/æœ‰åºæ€§.png" alt="æœ‰åºæ€§" />
</div>

**topicåˆ†åŒº**ä¸­æ¶ˆæ¯åªèƒ½ç”±**æ¶ˆè´¹è€…ç»„ä¸­çš„å”¯ä¸€ä¸€ä¸ªæ¶ˆè´¹è€…**å¤„ç†ï¼Œæ‰€ä»¥æ¶ˆæ¯è‚¯å®šæ˜¯**æŒ‰ç…§å…ˆåé¡ºåº**è¿›è¡Œå¤„ç†çš„ã€‚ä½†æ˜¯å®ƒä¹Ÿä»…ä»…æ˜¯ä¿è¯Topicçš„ä¸€ä¸ªåˆ†åŒºé¡ºåºå¤„ç†ï¼Œ**ä¸èƒ½ä¿è¯è·¨åˆ†åŒºçš„æ¶ˆæ¯å…ˆåå¤„ç†é¡ºåº**ã€‚ æ‰€ä»¥ï¼Œå¦‚æœä½ **æƒ³è¦é¡ºåºçš„å¤„ç†**Topicçš„æ‰€æœ‰æ¶ˆæ¯ï¼Œé‚£å°±**åªæä¾›ä¸€ä¸ªåˆ†åŒº**ã€‚

#### 6.3 æäº¤å’Œåç§»é‡

kafka**ä¸ä¼š**åƒå…¶ä»–JMSé˜Ÿåˆ—é‚£æ ·**éœ€è¦å¾—åˆ°æ¶ˆè´¹è€…çš„ç¡®è®¤**ï¼Œæ¶ˆè´¹è€…å¯ä»¥ä½¿ç”¨kafkaæ¥è¿½è¸ªæ¶ˆæ¯åœ¨åˆ†åŒºçš„ä½ç½®ï¼ˆåç§»é‡ï¼‰

æ¶ˆè´¹è€…ä¼šå¾€ä¸€ä¸ªå«åš**_consumer_offset**çš„ç‰¹æ®Šä¸»é¢˜å‘é€æ¶ˆæ¯ï¼Œæ¶ˆæ¯é‡ŒåŒ…å«äº†æ¯ä¸ªåˆ†åŒºçš„åç§»é‡ã€‚å¦‚æœæ¶ˆè´¹è€…å‘ç”Ÿ**å´©æºƒ**æˆ–æœ‰æ–°çš„æ¶ˆè´¹è€…**åŠ å…¥**ç¾¤ç»„ï¼Œå°±ä¼š**è§¦å‘å†å‡è¡¡**

<div align="center">
    <img src="æˆªå›¾/æ–‡ç« ä¸Šä¸‹æ¶/æ­£å¸¸æƒ…å†µ.png" alt="æ­£å¸¸æƒ…å†µ" />
</div>

æ­£å¸¸çš„æƒ…å†µ

<div align="center">
    <img src="æˆªå›¾/æ–‡ç« ä¸Šä¸‹æ¶/æŒ‚æ‰æƒ…å†µ.png" alt="æŒ‚æ‰æƒ…å†µ" />
</div>

å¦‚æœæ¶ˆè´¹è€…2æŒ‚æ‰ä»¥åï¼Œä¼šå‘ç”Ÿå†å‡è¡¡ï¼Œæ¶ˆè´¹è€…2**è´Ÿè´£çš„åˆ†åŒº**ä¼šè¢«**å…¶ä»–æ¶ˆè´¹è€…**è¿›è¡Œæ¶ˆè´¹

å†å‡è¡¡åä¸å¯é¿å…ä¼šå‡ºç°ä¸€äº›é—®é¢˜

é—®é¢˜ä¸€ï¼š

<div align="center">
    <img src="æˆªå›¾/æ–‡ç« ä¸Šä¸‹æ¶/é—®é¢˜1.png" alt="é—®é¢˜1" />
</div>

å¦‚æœ**æäº¤åç§»é‡**å°äºå®¢æˆ·ç«¯**å¤„ç†çš„æœ€åä¸€ä¸ªæ¶ˆæ¯çš„åç§»é‡**ï¼Œé‚£ä¹ˆå¤„äºä¸¤ä¸ªåç§»é‡ä¹‹é—´çš„æ¶ˆæ¯å°±ä¼šè¢«**é‡å¤å¤„ç†**ã€‚



é—®é¢˜äºŒï¼š

<div align="center">
    <img src="æˆªå›¾/æ–‡ç« ä¸Šä¸‹æ¶/é—®é¢˜2.png" alt="é—®é¢˜2" />
</div>

å¦‚æœæäº¤çš„åç§»é‡**å¤§äº**å®¢æˆ·ç«¯çš„æœ€åä¸€ä¸ªæ¶ˆæ¯çš„åç§»é‡ï¼Œé‚£ä¹ˆå¤„äºä¸¤ä¸ªåç§»é‡ä¹‹é—´çš„æ¶ˆæ¯å°†ä¼š**ä¸¢å¤±**ã€‚

å¦‚æœæƒ³è¦è§£å†³è¿™äº›é—®é¢˜ï¼Œè¿˜è¦çŸ¥é“ç›®å‰kafkaæäº¤åç§»é‡çš„æ–¹å¼ï¼š

æäº¤åç§»é‡çš„æ–¹å¼æœ‰ä¸¤ç§ï¼Œåˆ†åˆ«æ˜¯è‡ªåŠ¨æäº¤åç§»é‡å’Œæ‰‹åŠ¨æäº¤

- è‡ªåŠ¨æäº¤åç§»é‡

å½“enable.auto.commitè¢«è®¾ç½®ä¸ºtrueï¼Œæäº¤æ–¹å¼å°±æ˜¯è®©æ¶ˆè´¹è€…è‡ªåŠ¨æäº¤åç§»é‡ï¼Œ**æ¯éš”5ç§’**æ¶ˆè´¹è€…ä¼šè‡ªåŠ¨æŠŠä»**poll()**æ–¹æ³•æ¥æ”¶çš„**æœ€å¤§åç§»é‡**æäº¤ä¸Šå»

- æ‰‹åŠ¨æäº¤ ï¼Œå½“enable.auto.commitè¢«è®¾ç½®ä¸ºfalseå¯ä»¥æœ‰ä»¥ä¸‹ä¸‰ç§æäº¤æ–¹å¼

  - æäº¤å½“å‰åç§»é‡ï¼ˆåŒæ­¥æäº¤ï¼‰

  - å¼‚æ­¥æäº¤

  - åŒæ­¥å’Œå¼‚æ­¥ç»„åˆæäº¤

1.æäº¤å½“å‰åç§»é‡ï¼ˆåŒæ­¥æäº¤ï¼‰

æŠŠ`enable.auto.commit`è®¾ç½®ä¸ºfalse,è®©åº”ç”¨ç¨‹åºå†³å®šä½•æ—¶æäº¤åç§»é‡ã€‚ä½¿ç”¨**commitSync()**æäº¤åç§»é‡ï¼ŒcommitSync()å°†ä¼š**æäº¤pollè¿”å›çš„æœ€æ–°çš„åç§»é‡**ï¼Œæ‰€ä»¥åœ¨å¤„ç†å®Œæ‰€æœ‰è®°å½•åè¦ç¡®ä¿è°ƒç”¨äº†commitSync()æ–¹æ³•ã€‚å¦åˆ™è¿˜æ˜¯ä¼šæœ‰æ¶ˆæ¯ä¸¢å¤±çš„é£é™©ã€‚

åªè¦æ²¡æœ‰å‘ç”Ÿä¸å¯æ¢å¤çš„é”™è¯¯ï¼ŒcommitSync()æ–¹æ³•ä¼šä¸€ç›´å°è¯•ç›´è‡³æäº¤æˆåŠŸï¼Œå¦‚æœæäº¤å¤±è´¥ä¹Ÿå¯ä»¥è®°å½•åˆ°é”™è¯¯æ—¥å¿—é‡Œã€‚

2.å¼‚æ­¥æäº¤

æ‰‹åŠ¨æäº¤æœ‰ä¸€ä¸ªç¼ºç‚¹ï¼Œé‚£å°±æ˜¯å½“å‘èµ·æäº¤è°ƒç”¨æ—¶åº”ç”¨ä¼š**é˜»å¡**ã€‚å½“ç„¶æˆ‘ä»¬å¯ä»¥å‡å°‘æ‰‹åŠ¨æäº¤çš„é¢‘ç‡ï¼Œä½†è¿™ä¸ªä¼šå¢åŠ æ¶ˆæ¯é‡å¤çš„æ¦‚ç‡ï¼ˆå’Œè‡ªåŠ¨æäº¤ä¸€æ ·ï¼‰ã€‚å¦å¤–ä¸€ä¸ªè§£å†³åŠæ³•æ˜¯ï¼Œä½¿ç”¨å¼‚æ­¥æäº¤çš„APIã€‚

3.åŒæ­¥å’Œå¼‚æ­¥ç»„åˆæäº¤

**å¼‚æ­¥**æäº¤ä¹Ÿæœ‰ä¸ª**ç¼ºç‚¹**ï¼Œé‚£å°±æ˜¯å¦‚æœæœåŠ¡å™¨è¿”å›æäº¤å¤±è´¥ï¼Œ**å¼‚æ­¥æäº¤ä¸ä¼šè¿›è¡Œé‡è¯•**ã€‚ç›¸æ¯”è¾ƒèµ·æ¥ï¼ŒåŒæ­¥æäº¤ä¼šè¿›è¡Œé‡è¯•ç›´åˆ°æˆåŠŸæˆ–è€…æœ€åæŠ›å‡ºå¼‚å¸¸ç»™åº”ç”¨ã€‚**å¼‚æ­¥æäº¤æ²¡æœ‰å®ç°é‡è¯•æ˜¯å› ä¸ºï¼Œå¦‚æœåŒæ—¶å­˜åœ¨å¤šä¸ªå¼‚æ­¥æäº¤ï¼Œè¿›è¡Œé‡è¯•å¯èƒ½ä¼šå¯¼è‡´ä½ç§»è¦†ç›–ã€‚**

ä¸¾ä¸ªä¾‹å­ï¼Œå‡å¦‚æˆ‘ä»¬å‘èµ·äº†ä¸€ä¸ªå¼‚æ­¥æäº¤**commitA**ï¼Œæ­¤æ—¶çš„æäº¤ä½ç§»ä¸º**2000**ï¼Œéšååˆå‘èµ·äº†ä¸€ä¸ªå¼‚æ­¥æäº¤**commitB**ä¸”ä½ç§»ä¸º**3000**ï¼›**commitAæäº¤å¤±è´¥ä½†commitBæäº¤æˆåŠŸ**ï¼Œæ­¤æ—¶commitAè¿›è¡Œ**é‡è¯•å¹¶æˆåŠŸ**çš„è¯ï¼Œä¼šå°†å®é™…ä¸Šå°†å·²ç»æäº¤çš„ä½ç§»ä»**3000å›æ»šåˆ°2000**ï¼Œå¯¼è‡´æ¶ˆæ¯**é‡å¤æ¶ˆè´¹**ã€‚

### 7. è‡ªåª’ä½“æ–‡ç« ä¸Šä¸‹æ¶åŠŸèƒ½å®Œæˆ

#### 7.1 éœ€æ±‚åˆ†æ

- å·²å‘è¡¨ä¸”å·²ä¸Šæ¶çš„æ–‡ç« å¯ä»¥ä¸‹æ¶

- å·²å‘è¡¨ä¸”å·²ä¸‹æ¶çš„æ–‡ç« å¯ä»¥ä¸Šæ¶

#### 7.2 æµç¨‹è¯´æ˜

<div align="center">
    <img src="æˆªå›¾/æ–‡ç« ä¸Šä¸‹æ¶/ä¸Šä¸‹æ¶æµç¨‹.png" alt="ä¸Šä¸‹æ¶æµç¨‹" />
</div>

#### 7.3 æ¥å£å®šä¹‰

|          | **è¯´æ˜**                |
| -------- | ----------------------- |
| æ¥å£è·¯å¾„ | /api/v1/news/down_or_up |
| è¯·æ±‚æ–¹å¼ | POST                    |
| å‚æ•°     | DTO                     |
| å“åº”ç»“æœ | ResponseResult          |

 DTO  

```java
@Data
public class WmNewsDto {
    
    private Integer id;
    /**
    * æ˜¯å¦ä¸Šæ¶  0 ä¸‹æ¶  1 ä¸Šæ¶
    */
    private Short enable;
                       
}
```

#### 7.4 æ ¸å¿ƒä»£ç 

```java
/**
 * æ–‡ç« çš„ä¸Šä¸‹æ¶
 * @param dto
 * @return
 */
@Override
public ResponseResult downOrUp(WmNewsDto dto) {
    //1.æ£€æŸ¥å‚æ•°
    if(dto.getId() == null){
        return ResponseResult.errorResult(AppHttpCodeEnum.PARAM_INVALID);
    }

    //2.æŸ¥è¯¢æ–‡ç« 
    WmNews wmNews = getById(dto.getId());
    if(wmNews == null){
        return ResponseResult.errorResult(AppHttpCodeEnum.DATA_NOT_EXIST,"æ–‡ç« ä¸å­˜åœ¨");
    }

    //3.åˆ¤æ–­æ–‡ç« æ˜¯å¦å·²å‘å¸ƒ
    if(!wmNews.getStatus().equals(WmNews.Status.PUBLISHED.getCode())){
        return ResponseResult.errorResult(AppHttpCodeEnum.PARAM_INVALID,"å½“å‰æ–‡ç« ä¸æ˜¯å‘å¸ƒçŠ¶æ€ï¼Œä¸èƒ½ä¸Šä¸‹æ¶");
    }

    //4.ä¿®æ”¹æ–‡ç« enable
    if(dto.getEnable() != null && dto.getEnable() > -1 && dto.getEnable() < 2){
        update(Wrappers.<WmNews>lambdaUpdate().set(WmNews::getEnable,dto.getEnable())
                .eq(WmNews::getId,wmNews.getId()));
    }
    return ResponseResult.okResult(AppHttpCodeEnum.SUCCESS);
}
```

#### 7.5 æ¶ˆæ¯é€šçŸ¥articleç«¯æ–‡ç« ä¸Šä¸‹æ¶

åœ¨è‡ªåª’ä½“ç«¯æ–‡ç« ä¸Šä¸‹æ¶åå‘é€æ¶ˆæ¯

```java
//å‘é€æ¶ˆæ¯ï¼Œé€šçŸ¥articleç«¯ä¿®æ”¹æ–‡ç« é…ç½®
if(wmNews.getArticleId() != null){
    Map<String,Object> map = new HashMap<>();
    map.put("articleId",wmNews.getArticleId());
    map.put("enable",dto.getEnable());
    kafkaTemplate.send(WmNewsMessageConstants.WM_NEWS_UP_OR_DOWN_TOPIC,JSON.toJSONString(map));
}
```

å¸¸é‡ç±»ï¼š

```java
public class WmNewsMessageConstants {

    public static final String WM_NEWS_UP_OR_DOWN_TOPIC="wm.news.up.or.down.topic";
}
```

åœ¨**articleç«¯**ç¼–å†™ç›‘å¬ï¼Œæ¥æ”¶æ•°æ®

```java
@Component
@Slf4j
public class ArtilceIsDownListener {

    @Autowired
    private ApArticleConfigService apArticleConfigService;

    @KafkaListener(topics = WmNewsMessageConstants.WM_NEWS_UP_OR_DOWN_TOPIC)
    public void onMessage(String message){
        if(StringUtils.isNotBlank(message)){
            Map map = JSON.parseObject(message, Map.class);
            apArticleConfigService.updateByMap(map);
            log.info("articleç«¯æ–‡ç« é…ç½®ä¿®æ”¹ï¼ŒarticleId={}",map.get("articleId"));
        }
    }
}
```

```java
@Service
@Slf4j
@Transactional
public class ApArticleConfigServiceImpl extends ServiceImpl<ApArticleConfigMapper, ApArticleConfig> implements ApArticleConfigService {
    /**
     * ä¿®æ”¹æ–‡ç« é…ç½®
     * @param map
     */
    @Override
    public void updateByMap(Map map) {
        //0 ä¸‹æ¶ 1 ä¸Šæ¶
        Object enable = map.get("enable");
        boolean isDown = true;
        if(enable.equals(1)){
            isDown = false;
        }
        //ä¿®æ”¹æ–‡ç« é…ç½®
        update(Wrappers.<ApArticleConfig>lambdaUpdate().eq(ApArticleConfig::getArticleId,map.get("articleId")).set(ApArticleConfig::getIsDown,isDown));
    }
}
```

## åä¸‰ã€appç«¯æ–‡ç« æœç´¢

### 1. Appç«¯æœç´¢-æ•ˆæœå›¾

<div align="center">
    <img src="æˆªå›¾/æ–‡ç« æœç´¢/Appç«¯æœç´¢æ•ˆæœå›¾.png" alt="Appç«¯æœç´¢æ•ˆæœå›¾" />
</div>

### 2. æ­å»ºElasticSearchç¯å¢ƒ

#### 2.1 æ‹‰å–é•œåƒ

```shell
docker pull elasticsearch:7.4.0
```

#### 2.2 åˆ›å»ºå®¹å™¨

```shell
docker run -id --name elasticsearch -d --restart=always -p 9200:9200 -p 9300:9300 -v /usr/share/elasticsearch/plugins:/usr/share/elasticsearch/plugins -e "discovery.type=single-node" elasticsearch:7.4.0
```

#### 2.3 é…ç½®ä¸­æ–‡åˆ†è¯å™¨ ik

å› ä¸ºåœ¨åˆ›å»ºelasticsearchå®¹å™¨çš„æ—¶å€™ï¼Œæ˜ å°„äº†ç›®å½•ï¼Œæ‰€ä»¥å¯ä»¥åœ¨å®¿ä¸»æœºä¸Šè¿›è¡Œé…ç½®ikä¸­æ–‡åˆ†è¯å™¨

åœ¨å»é€‰æ‹©ikåˆ†è¯å™¨çš„æ—¶å€™ï¼Œéœ€è¦ä¸elasticsearchçš„ç‰ˆæœ¬å¯¹åº”ä¸Š

æŠŠ`elasticsearch-analysis-ik-7.4.0.zip`ä¸Šä¼ åˆ°æœåŠ¡å™¨ä¸Š,æ”¾åˆ°å¯¹åº”ç›®å½•ï¼ˆpluginsï¼‰è§£å‹

```shell
#åˆ‡æ¢ç›®å½•
cd /usr/share/elasticsearch/plugins
#æ–°å»ºç›®å½•
mkdir analysis-ik
cd analysis-ik
#rootæ ¹ç›®å½•ä¸­æ‹·è´æ–‡ä»¶
mv elasticsearch-analysis-ik-7.4.0.zip /usr/share/elasticsearch/plugins/analysis-ik
#è§£å‹æ–‡ä»¶
cd /usr/share/elasticsearch/plugins/analysis-ik
unzip elasticsearch-analysis-ik-7.4.0.zip
```

### 3. appç«¯æ–‡ç« æœç´¢

#### 3.1 éœ€æ±‚åˆ†æ

- ç”¨æˆ·è¾“å…¥å…³é”®å¯æœç´¢æ–‡ç« åˆ—è¡¨

- å…³é”®è¯é«˜äº®æ˜¾ç¤º

- æ–‡ç« åˆ—è¡¨å±•ç¤ºä¸homeå±•ç¤ºä¸€æ ·ï¼Œå½“ç”¨æˆ·ç‚¹å‡»æŸä¸€ç¯‡æ–‡ç« ï¼Œå¯æŸ¥çœ‹æ–‡ç« è¯¦æƒ…

#### 3.2 æ€è·¯åˆ†æ

ä¸ºäº†åŠ å¿«æ£€ç´¢çš„æ•ˆç‡ï¼Œåœ¨æŸ¥è¯¢çš„æ—¶å€™ä¸ä¼šç›´æ¥ä»æ•°æ®åº“ä¸­æŸ¥è¯¢æ–‡ç« ï¼Œéœ€è¦åœ¨elasticsearchä¸­è¿›è¡Œé«˜é€Ÿæ£€ç´¢ã€‚

<div align="center">
    <img src="æˆªå›¾/æ–‡ç« æœç´¢/æœç´¢æ€è·¯åˆ†æ.png" alt="æœç´¢æ€è·¯åˆ†æ" />
</div>

#### 3.3 åˆ›å»ºç´¢å¼•å’Œæ˜ å°„

ä½¿ç”¨postmanæ·»åŠ æ˜ å°„

putè¯·æ±‚ ï¼š http://192.168.200.130:9200/app_info_article

```json
{
    "mappings":{
        "properties":{
            "id":{
                "type":"long"
            },
            "publishTime":{
                "type":"date"
            },
            "layout":{
                "type":"integer"
            },
            "images":{
                "type":"keyword",
                "index": false
            },
            "staticUrl":{
                "type":"keyword",
                "index": false
            },
            "authorId": {
                "type": "long"
            },
            "authorName": {
                "type": "text"
            },
            "title":{
                "type":"text",
                "analyzer":"ik_smart"
            },
            "content":{
                "type":"text",
                "analyzer":"ik_smart"
            }
        }
    }
}
```

GETè¯·æ±‚æŸ¥è¯¢æ˜ å°„ï¼šhttp://192.168.200.130:9200/app_info_article

DELETEè¯·æ±‚ï¼Œåˆ é™¤ç´¢å¼•åŠæ˜ å°„ï¼šhttp://192.168.200.130:9200/app_info_article

GETè¯·æ±‚ï¼ŒæŸ¥è¯¢æ‰€æœ‰æ–‡æ¡£ï¼šhttp://192.168.200.130:9200/app_info_article/_search

### 4. æ•°æ®åˆå§‹åŒ–åˆ°ç´¢å¼•åº“

#### 4.1 æ ¸å¿ƒä»£ç 

```java
@SpringBootTest
@RunWith(SpringRunner.class)
public class ApArticleTest {
    
    @Autowired
    private ApArticleMapper apArticleMapper;
    @Autowired
    private RestHighLevelClient restHighLevelClient;
    
    /**
     * æ³¨æ„ï¼šæ•°æ®é‡çš„å¯¼å…¥ï¼Œå¦‚æœæ•°æ®é‡è¿‡å¤§ï¼Œéœ€è¦åˆ†é¡µå¯¼å…¥
     * @throws Exception
     */
    @Test
    public void init() throws Exception {

        //1.æŸ¥è¯¢æ‰€æœ‰ç¬¦åˆæ¡ä»¶çš„æ–‡ç« æ•°æ®
        List<SearchArticleVo> searchArticleVos = apArticleMapper.loadArticleList();

        //2.æ‰¹é‡å¯¼å…¥åˆ°esç´¢å¼•åº“
        BulkRequest bulkRequest = new BulkRequest("app_info_article");

        for (SearchArticleVo searchArticleVo : searchArticleVos) {

            IndexRequest indexRequest = new IndexRequest().id(searchArticleVo.getId().toString())
                    .source(JSON.toJSONString(searchArticleVo), XContentType.JSON);

            //æ‰¹é‡æ·»åŠ æ•°æ®
            bulkRequest.add(indexRequest);

        }
        restHighLevelClient.bulk(bulkRequest, RequestOptions.DEFAULT);
    }
}
```

### 5. æ–‡ç« æœç´¢åŠŸèƒ½å®ç°

#### 5.1 æ­å»ºæœç´¢å¾®æœåŠ¡

```xml
<!--elasticsearch-->
<dependency>
    <groupId>org.elasticsearch.client</groupId>
    <artifactId>elasticsearch-rest-high-level-client</artifactId>
    <version>7.4.0</version>
</dependency>
<dependency>
    <groupId>org.elasticsearch.client</groupId>
    <artifactId>elasticsearch-rest-client</artifactId>
    <version>7.4.0</version>
</dependency>
<dependency>
    <groupId>org.elasticsearch</groupId>
    <artifactId>elasticsearch</artifactId>
    <version>7.4.0</version>
</dependency>
```

nacosé…ç½®ä¸­å¿ƒleadnews-search

```yaml
spring:
  autoconfigure:
    exclude: org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration
elasticsearch:
  host: 192.168.200.130
  port: 9200
```

UserSearchDto

```java
@Data
public class UserSearchDto {
    /**
    * æœç´¢å…³é”®å­—
    */
    String searchWords;
    /**
    * å½“å‰é¡µ
    */
    int pageNum;
    /**
    * åˆ†é¡µæ¡æ•°
    */
    int pageSize;
    /**
    * æœ€å°æ—¶é—´
    */
    Date minBehotTime;

    public int getFromIndex(){
        if(this.pageNum<1)return 0;
        if(this.pageSize<1) this.pageSize = 10;
        return this.pageSize * (pageNum-1);
    }
}
```

#### 5.2 æ ¸å¿ƒä»£ç 

```java
@Service
@Slf4j
public class ArticleSearchServiceImpl implements ArticleSearchService {
    @Autowired
    private RestHighLevelClient restHighLevelClient;
    /**
     * esæ–‡ç« åˆ†é¡µæ£€ç´¢
     * @param dto
     * @return
     */
    @Override
    public ResponseResult search(UserSearchDto dto) throws IOException {

        //1.æ£€æŸ¥å‚æ•°
        if(dto == null || StringUtils.isBlank(dto.getSearchWords())){
            return ResponseResult.errorResult(AppHttpCodeEnum.PARAM_INVALID);
        }

        //2.è®¾ç½®æŸ¥è¯¢æ¡ä»¶
        SearchRequest searchRequest = new SearchRequest("app_info_article");
        SearchSourceBuilder searchSourceBuilder = new SearchSourceBuilder();

        //å¸ƒå°”æŸ¥è¯¢
        BoolQueryBuilder boolQueryBuilder = QueryBuilders.boolQuery();

        //å…³é”®å­—çš„åˆ†è¯ä¹‹åæŸ¥è¯¢
        QueryStringQueryBuilder queryStringQueryBuilder = QueryBuilders.queryStringQuery(dto.getSearchWords()).field("title").field("content").defaultOperator(Operator.OR);
        boolQueryBuilder.must(queryStringQueryBuilder);//mustå‚ä¸ç®—åˆ†

        //æŸ¥è¯¢å°äºmindateçš„æ•°æ®
        RangeQueryBuilder rangeQueryBuilder = QueryBuilders.rangeQuery("publishTime").lt(dto.getMinBehotTime().getTime());
        boolQueryBuilder.filter(rangeQueryBuilder);//ä¸å‚ä¸ç®—åˆ†

        //åˆ†é¡µæŸ¥è¯¢(æŸ¥å‡ºæ¥çš„æ–‡ç« éƒ½æ˜¯æ¯”å½“å‰ç”¨æˆ·æ˜¾ç¤ºæ–‡ç« çš„å‘å¸ƒæ—¶é—´æ—©çš„ï¼Œç›´æ¥å–å‰PageSizeæ¡)
        searchSourceBuilder.from(0);
        searchSourceBuilder.size(dto.getPageSize());

        //æŒ‰ç…§å‘å¸ƒæ—¶é—´å€’åºæŸ¥è¯¢
        searchSourceBuilder.sort("publishTime", SortOrder.DESC);

        //è®¾ç½®é«˜äº®  title
        HighlightBuilder highlightBuilder = new HighlightBuilder();
        highlightBuilder.field("title");
        highlightBuilder.preTags("<font style='color: red; font-size: inherit;'>");
        highlightBuilder.postTags("</font>");
        searchSourceBuilder.highlighter(highlightBuilder);


        searchSourceBuilder.query(boolQueryBuilder);
        searchRequest.source(searchSourceBuilder);
        SearchResponse searchResponse = restHighLevelClient.search(searchRequest, RequestOptions.DEFAULT);

        //3.ç»“æœå°è£…è¿”å›
        List<Map> list = new ArrayList<>();

        SearchHit[] hits = searchResponse.getHits().getHits();
        for (SearchHit hit : hits) {
            String json = hit.getSourceAsString();
            Map map = JSON.parseObject(json, Map.class);
            //å¤„ç†é«˜äº®
            if(hit.getHighlightFields() != null && hit.getHighlightFields().size() > 0){
                Text[] titles = hit.getHighlightFields().get("title").getFragments();
                String title = StringUtils.join(titles);
                //é«˜äº®æ ‡é¢˜
                map.put("h_title",title);
            }else {
                //åŸå§‹æ ‡é¢˜
                map.put("h_title",map.get("title"));
            }
            list.add(map);
        }
        return ResponseResult.okResult(list);
    }
}
```

éœ€è¦åœ¨appçš„ç½‘å…³ä¸­æ·»åŠ æœç´¢å¾®æœåŠ¡çš„è·¯ç”±é…ç½®

```yaml
#æœç´¢å¾®æœåŠ¡
- id: leadnews-search
 uri: lb://leadnews-search
 predicates:
   - Path=/search/**
 filters:
   - StripPrefix= 1
```

### 6. æ–‡ç« è‡ªåŠ¨å®¡æ ¸æ„å»ºç´¢å¼•

#### 6.1 æ€è·¯åˆ†æ

<div align="center">
    <img src="æˆªå›¾/æ–‡ç« æœç´¢/æ–‡ç« è‡ªåŠ¨å®¡æ ¸æ„å»ºç´¢å¼•.png" alt="æ–‡ç« è‡ªåŠ¨å®¡æ ¸æ„å»ºç´¢å¼•" />
</div>

#### 6.2 æ–‡ç« å¾®æœåŠ¡å‘é€æ¶ˆæ¯

SearchArticleVo

```java
package com.heima.model.search.vos;

import lombok.Data;

import java.util.Date;

@Data
public class SearchArticleVo {

    // æ–‡ç« id
    private Long id;
    // æ–‡ç« æ ‡é¢˜
    private String title;
    // æ–‡ç« å‘å¸ƒæ—¶é—´
    private Date publishTime;
    // æ–‡ç« å¸ƒå±€
    private Integer layout;
    // å°é¢
    private String images;
    // ä½œè€…id
    private Long authorId;
    // ä½œè€…åè¯
    private String authorName;
    //é™æ€url
    private String staticUrl;
    //æ–‡ç« å†…å®¹
    private String content;

}
```

2.æ–‡ç« å¾®æœåŠ¡çš„ArticleFreemarkerServiceä¸­çš„buildArticleToMinIOæ–¹æ³•ä¸­æ”¶é›†æ•°æ®å¹¶å‘é€æ¶ˆæ¯

```java
@Service
@Slf4j
@Transactional
public class ArticleFreemarkerServiceImpl implements ArticleFreemarkerService {

    @Autowired
    private ApArticleContentMapper apArticleContentMapper;
    @Autowired
    private Configuration configuration;
    @Autowired
    private FileStorageService fileStorageService;
    @Autowired
    private ApArticleService apArticleService;

    /**
     * ç”Ÿæˆé™æ€æ–‡ä»¶ä¸Šä¼ åˆ°minIOä¸­
     * @param apArticle
     * @param content
     */
    @Async
    @Override
    public void buildArticleToMinIO(ApArticle apArticle, String content) {
        //å·²çŸ¥æ–‡ç« çš„id
        //4.1 è·å–æ–‡ç« å†…å®¹
        if(StringUtils.isNotBlank(content)){
            //4.2 æ–‡ç« å†…å®¹é€šè¿‡freemarkerç”Ÿæˆhtmlæ–‡ä»¶
            Template template = null;
            StringWriter out = new StringWriter();
            try {
                template = configuration.getTemplate("article.ftl");
                //æ•°æ®æ¨¡å‹
                Map<String,Object> contentDataModel = new HashMap<>();
                contentDataModel.put("content", JSONArray.parseArray(content));
                //åˆæˆ
                template.process(contentDataModel,out);
            } catch (Exception e) {
                e.printStackTrace();
            }
            
            //4.3 æŠŠhtmlæ–‡ä»¶ä¸Šä¼ åˆ°minioä¸­
            InputStream in = new ByteArrayInputStream(out.toString().getBytes());
            String path = fileStorageService.uploadHtmlFile("", apArticle.getId() + ".html", in);
            
            //4.4 ä¿®æ”¹ap_articleè¡¨ï¼Œä¿å­˜static_urlå­—æ®µ
            apArticleService.update(Wrappers.<ApArticle>lambdaUpdate().eq(ApArticle::getId,apArticle.getId())
                    .set(ApArticle::getStaticUrl,path));

            //å‘é€æ¶ˆæ¯ï¼Œåˆ›å»ºç´¢å¼•
            createArticleESIndex(apArticle,content,path);
        }
    }

    @Autowired
    private KafkaTemplate<String,String> kafkaTemplate;

    /**
     * é€æ¶ˆæ¯ï¼Œåˆ›å»ºç´¢å¼•
     * @param apArticle
     * @param content
     * @param path
     */
    private void createArticleESIndex(ApArticle apArticle, String content, String path) {
        SearchArticleVo vo = new SearchArticleVo();
        BeanUtils.copyProperties(apArticle,vo);
        vo.setContent(content);
        vo.setStaticUrl(path);

        kafkaTemplate.send(ArticleConstants.ARTICLE_ES_SYNC_TOPIC, JSON.toJSONString(vo));
    }
}
```

åœ¨ArticleConstantsç±»ä¸­æ·»åŠ æ–°çš„å¸¸é‡ï¼Œå®Œæ•´ä»£ç å¦‚ä¸‹

```java
public class ArticleConstants {
    public static final Short LOADTYPE_LOAD_MORE = 1;
    public static final Short LOADTYPE_LOAD_NEW = 2;
    public static final String DEFAULT_TAG = "__all__";

    public static final String ARTICLE_ES_SYNC_TOPIC = "article.es.sync.topic";

    public static final Integer HOT_ARTICLE_LIKE_WEIGHT = 3;
    public static final Integer HOT_ARTICLE_COMMENT_WEIGHT = 5;
    public static final Integer HOT_ARTICLE_COLLECTION_WEIGHT = 8;

    public static final String HOT_ARTICLE_FIRST_PAGE = "hot_article_first_page_";
}
```

#### 6.4 æœç´¢å¾®æœåŠ¡æ¥æ”¶æ¶ˆæ¯å¹¶åˆ›å»ºç´¢å¼•

##### 6.4.1 æ ¸å¿ƒä»£ç 

```java
@Component
@Slf4j
public class SyncArticleListener {

    @Autowired
    private RestHighLevelClient restHighLevelClient;

    @KafkaListener(topics = ArticleConstants.ARTICLE_ES_SYNC_TOPIC)
    public void onMessage(String message){
        if(StringUtils.isNotBlank(message)){

            log.info("SyncArticleListener,message={}",message);

            SearchArticleVo searchArticleVo = JSON.parseObject(message, SearchArticleVo.class);
            IndexRequest indexRequest = new IndexRequest("app_info_article");
            indexRequest.id(searchArticleVo.getId().toString());
            indexRequest.source(message, XContentType.JSON);
            try {
                restHighLevelClient.index(indexRequest, RequestOptions.DEFAULT);
            } catch (IOException e) {
                e.printStackTrace();
                log.error("sync es error={}",e);
            }
        }
    }
}
```

### 7. appç«¯æœç´¢-æœç´¢è®°å½•

#### 7.1 éœ€æ±‚åˆ†æ

<div align="center">
    <img src="æˆªå›¾/æ–‡ç« æœç´¢/æœç´¢è®°å½•.png" alt="æœç´¢è®°å½•" />
</div>

- å±•ç¤ºç”¨æˆ·çš„æœç´¢è®°å½•10æ¡ï¼ŒæŒ‰ç…§æœç´¢å…³é”®è¯çš„æ—¶é—´å€’åº
- å¯ä»¥åˆ é™¤æœç´¢è®°å½•
- ä¿å­˜å†å²è®°å½•ï¼Œä¿å­˜10æ¡ï¼Œå¤šä½™çš„åˆ™åˆ é™¤æœ€ä¹…çš„å†å²è®°å½•

#### 7.2 æ•°æ®å­˜å‚¨è¯´æ˜

ç”¨æˆ·çš„æœç´¢è®°å½•ï¼Œéœ€è¦ç»™æ¯ä¸€ä¸ªç”¨æˆ·éƒ½ä¿å­˜ä¸€ä»½ï¼Œæ•°æ®é‡è¾ƒå¤§ï¼Œè¦æ±‚åŠ è½½é€Ÿåº¦å¿«ï¼Œé€šå¸¸è¿™æ ·çš„æ•°æ®å­˜å‚¨åˆ°mongodbæ›´åˆé€‚ï¼Œä¸å»ºè®®ç›´æ¥å­˜å‚¨åˆ°å…³ç³»å‹æ•°æ®åº“ä¸­

<div align="center">
    <img src="æˆªå›¾/æ–‡ç« æœç´¢/MongoDB.png" alt="MongoDB" />
</div>

#### 7.3MongoDBå®‰è£…åŠé›†æˆ

##### 3.1 å®‰è£…MongoDB

æ‹‰å–é•œåƒ

```
docker pull mongo
```

åˆ›å»ºå®¹å™¨

```
docker run -di --name mongo-service --restart=always -p 27017:27017 -v ~/data/mongodata:/data mongo
```

æ˜ å°„

```java
/**
 * <p>
 * è”æƒ³è¯è¡¨
 * </p>
 */
@Data
@Document("ap_associate_words")
public class ApAssociateWords implements Serializable {

    private static final long serialVersionUID = 1L;

    private String id;

    /**
     * è”æƒ³è¯
     */
    private String associateWords;

    /**
     * åˆ›å»ºæ—¶é—´
     */
    private Date createdTime;
}
```

#### 7.3 æ ¸å¿ƒæ–¹æ³•

```java
@SpringBootTest(classes = MongoApplication.class)
@RunWith(SpringRunner.class)
public class MongoTest {

    @Autowired
    private MongoTemplate mongoTemplate;

    //ä¿å­˜
    @Test
    public void saveTest(){
        /*for (int i = 0; i < 10; i++) {
            ApAssociateWords apAssociateWords = new ApAssociateWords();
            apAssociateWords.setAssociateWords("é»‘é©¬å¤´æ¡");
            apAssociateWords.setCreatedTime(new Date());
            mongoTemplate.save(apAssociateWords);
        }*/
        ApAssociateWords apAssociateWords = new ApAssociateWords();
        apAssociateWords.setAssociateWords("é»‘é©¬ç›´æ’­");
        apAssociateWords.setCreatedTime(new Date());
        mongoTemplate.save(apAssociateWords);
    }

    //æŸ¥è¯¢ä¸€ä¸ª
    @Test
    public void saveFindOne(){
        ApAssociateWords apAssociateWords = mongoTemplate.findById("60bd973eb0c1d430a71a7928", ApAssociateWords.class);
        System.out.println(apAssociateWords);
    }

    //æ¡ä»¶æŸ¥è¯¢
    @Test
    public void testQuery(){
        Query query = Query.query(Criteria.where("associateWords").is("é»‘é©¬å¤´æ¡"))
                .with(Sort.by(Sort.Direction.DESC,"createdTime"));
        List<ApAssociateWords> apAssociateWordsList = mongoTemplate.find(query, ApAssociateWords.class);
        System.out.println(apAssociateWordsList);
    }

    @Test
    public void testDel(){
        mongoTemplate.remove(Query.query(Criteria.where("associateWords").is("é»‘é©¬å¤´æ¡")),ApAssociateWords.class);
    }
}
```

#### 7.4 ä¿å­˜æœç´¢è®°å½•

##### 7.4.1 å®ç°æ€è·¯

<div align="center">
    <img src="æˆªå›¾/æ–‡ç« æœç´¢/ä¿å­˜æœç´¢è®°å½•.png" alt="ä¿å­˜æœç´¢è®°å½•" />
</div>

ç”¨æˆ·è¾“å…¥å…³é”®å­—è¿›è¡Œæœç´¢çš„å¼‚æ­¥è®°å½•å…³é”®å­—

<div align="center">
    <img src="æˆªå›¾/æ–‡ç« æœç´¢/å…³é”®è¯ä¿å­˜æ€è·¯.png" alt="å…³é”®è¯ä¿å­˜æ€è·¯" />
</div>

ç”¨æˆ·æœç´¢è®°å½•å¯¹åº”çš„é›†åˆï¼Œå¯¹åº”å®ä½“ç±»ï¼š

```java
/**
 * <p>
 * APPç”¨æˆ·æœç´¢ä¿¡æ¯è¡¨
 * </p>
 */
@Data
@Document("ap_user_search")
public class ApUserSearch implements Serializable {

    private static final long serialVersionUID = 1L;

    /**
     * ä¸»é”®
     */
    private String id;

    /**
     * ç”¨æˆ·ID
     */
    private Integer userId;

    /**
     * æœç´¢è¯
     */
    private String keyword;

    /**
     * åˆ›å»ºæ—¶é—´
     */
    private Date createdTime;

}
```

æœç´¢å¾®æœåŠ¡é›†æˆmongodb

â‘ ï¼špomä¾èµ–

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-mongodb</artifactId>
</dependency>
```

â‘¡ï¼šnacosé…ç½®

```yaml
spring:
  data:
   mongodb:
    host: 192.168.200.130
    port: 27017
    database: leadnews-history
```

##### 7.4.2 æ ¸å¿ƒä»£ç 

```java
@Service
@Slf4j
public class ApUserSearchServiceImpl implements ApUserSearchService {

    @Autowired
    private MongoTemplate mongoTemplate;
    /**
     * ä¿å­˜ç”¨æˆ·æœç´¢å†å²è®°å½•
     * @param keyword
     * @param userId
     */
    @Override
    @Async //---------------ï¼ï¼ï¼å¼‚æ­¥æ–¹æ³•ï¼Œä¸èƒ½ä»ThreadLocalè·å–userIdäº†ï¼Œè¦ä½œä¸ºå‚æ•°ä¼ å…¥ï¼ï¼ï¼---------------
    public void insert(String keyword, Integer userId) {
        //1.æŸ¥è¯¢å½“å‰ç”¨æˆ·çš„æœç´¢å…³é”®è¯
        Query query = Query.query(Criteria.where("userId").is(userId).and("keyword").is(keyword));
        ApUserSearch apUserSearch = mongoTemplate.findOne(query, ApUserSearch.class);

        //2.å­˜åœ¨ æ›´æ–°åˆ›å»ºæ—¶é—´
        if(apUserSearch != null){
            apUserSearch.setCreatedTime(new Date());
            mongoTemplate.save(apUserSearch);
            return;
        }

        //3.ä¸å­˜åœ¨ï¼Œåˆ¤æ–­å½“å‰å†å²è®°å½•æ€»æ•°é‡æ˜¯å¦è¶…è¿‡10
        apUserSearch = new ApUserSearch();
        apUserSearch.setUserId(userId);
        apUserSearch.setKeyword(keyword);
        apUserSearch.setCreatedTime(new Date());

        Query query1 = Query.query(Criteria.where("userId").is(userId));
        query1.with(Sort.by(Sort.Direction.DESC,"createdTime"));
        List<ApUserSearch> apUserSearchList = mongoTemplate.find(query1, ApUserSearch.class);

        if(apUserSearchList == null || apUserSearchList.size() < 10){
            mongoTemplate.save(apUserSearch);
        }else {
            ApUserSearch lastUserSearch = apUserSearchList.get(apUserSearchList.size() - 1);
            mongoTemplate.findAndReplace(Query.query(Criteria.where("id").is(lastUserSearch.getId())),apUserSearch);
        }
    }
}
```

3.å‚è€ƒè‡ªåª’ä½“ç›¸å…³å¾®æœåŠ¡ï¼Œåœ¨æœç´¢å¾®æœåŠ¡ä¸­è·å–å½“å‰ç™»å½•çš„ç”¨æˆ·

4.åœ¨ArticleSearchServiceçš„searchæ–¹æ³•ä¸­è°ƒç”¨ä¿å­˜å†å²è®°å½•

```java
@Service
@Slf4j
public class ArticleSearchServiceImpl implements ArticleSearchService {

    @Autowired
    private RestHighLevelClient restHighLevelClient;

    @Autowired
    private ApUserSearchService apUserSearchService;

    /**
     * esæ–‡ç« åˆ†é¡µæ£€ç´¢
     *
     * @param dto
     * @return
     */
    @Override
    public ResponseResult search(UserSearchDto dto) throws IOException {

        //1.æ£€æŸ¥å‚æ•°
        if(dto == null || StringUtils.isBlank(dto.getSearchWords())){
            return ResponseResult.errorResult(AppHttpCodeEnum.PARAM_INVALID);
        }

        ApUser user = AppThreadLocalUtil.getUser();

        //å¼‚æ­¥è°ƒç”¨ ä¿å­˜æœç´¢è®°å½•  åªæœ‰é¦–æ¬¡æœç´¢éœ€è¦ä¿å­˜è®°å½•ï¼Œåç»­ä¸‹æ‹‰åŠ è½½æ›´å¤šæœç´¢å†…å®¹ä¸éœ€è¦
        if(user != null && dto.getFromIndex() == 0){
            apUserSearchService.insert(dto.getSearchWords(), user.getId());
        }


        //2.è®¾ç½®æŸ¥è¯¢æ¡ä»¶
        SearchRequest searchRequest = new SearchRequest("app_info_article");
        SearchSourceBuilder searchSourceBuilder = new SearchSourceBuilder();

        //å¸ƒå°”æŸ¥è¯¢
        BoolQueryBuilder boolQueryBuilder = QueryBuilders.boolQuery();

        //å…³é”®å­—çš„åˆ†è¯ä¹‹åæŸ¥è¯¢
        QueryStringQueryBuilder queryStringQueryBuilder = QueryBuilders.queryStringQuery(dto.getSearchWords()).field("title").field("content").defaultOperator(Operator.OR);
        boolQueryBuilder.must(queryStringQueryBuilder);

        //æŸ¥è¯¢å°äºmindateçš„æ•°æ®
        RangeQueryBuilder rangeQueryBuilder = QueryBuilders.rangeQuery("publishTime").lt(dto.getMinBehotTime().getTime());
        boolQueryBuilder.filter(rangeQueryBuilder);

        //åˆ†é¡µæŸ¥è¯¢
        searchSourceBuilder.from(0);
        searchSourceBuilder.size(dto.getPageSize());

        //æŒ‰ç…§å‘å¸ƒæ—¶é—´å€’åºæŸ¥è¯¢
        searchSourceBuilder.sort("publishTime", SortOrder.DESC);

        //è®¾ç½®é«˜äº®  title
        HighlightBuilder highlightBuilder = new HighlightBuilder();
        highlightBuilder.field("title");
        highlightBuilder.preTags("<font style='color: red; font-size: inherit;'>");
        highlightBuilder.postTags("</font>");
        searchSourceBuilder.highlighter(highlightBuilder);


        searchSourceBuilder.query(boolQueryBuilder);
        searchRequest.source(searchSourceBuilder);
        SearchResponse searchResponse = restHighLevelClient.search(searchRequest, RequestOptions.DEFAULT);


        //3.ç»“æœå°è£…è¿”å›

        List<Map> list = new ArrayList<>();

        SearchHit[] hits = searchResponse.getHits().getHits();
        for (SearchHit hit : hits) {
            String json = hit.getSourceAsString();
            Map map = JSON.parseObject(json, Map.class);
            //å¤„ç†é«˜äº®
            if(hit.getHighlightFields() != null && hit.getHighlightFields().size() > 0){
                Text[] titles = hit.getHighlightFields().get("title").getFragments();
                String title = StringUtils.join(titles);
                //é«˜äº®æ ‡é¢˜
                map.put("h_title",title);
            }else {
                //åŸå§‹æ ‡é¢˜
                map.put("h_title",map.get("title"));
            }
            list.add(map);
        }

        return ResponseResult.okResult(list);

    }
}
```

5.ä¿å­˜å†å²è®°å½•ä¸­å¼€å¯å¼‚æ­¥è°ƒç”¨ï¼Œæ·»åŠ æ³¨è§£@Async

6.åœ¨æœç´¢å¾®æœåŠ¡å¼•å¯¼ç±»ä¸Šå¼€å¯å¼‚æ­¥è°ƒç”¨

<div align="center">
    <img src="æˆªå›¾/æ–‡ç« æœç´¢/å¼€å¯å¼‚æ­¥è°ƒç”¨.png" alt="å¼€å¯å¼‚æ­¥è°ƒç”¨" />
</div>

7.æµ‹è¯•ï¼Œæœç´¢åæŸ¥çœ‹ç»“æœ

#### 7.5 åŠ è½½æœç´¢è®°å½•åˆ—è¡¨

##### 7.5.1 æ€è·¯åˆ†æ

æŒ‰ç…§å½“å‰ç”¨æˆ·ï¼ŒæŒ‰ç…§æ—¶é—´å€’åºæŸ¥è¯¢

|          | **è¯´æ˜**             |
| -------- | -------------------- |
| æ¥å£è·¯å¾„ | /api/v1/history/load |
| è¯·æ±‚æ–¹å¼ | POST                 |
| å‚æ•°     | æ—                    |
| å“åº”ç»“æœ | ResponseResult       |

##### 7.5.2æ ¸å¿ƒä»£ç 

```java
 /**
     * æŸ¥è¯¢æœç´¢å†å²
     *
     * @return
     */
@Override
public ResponseResult findUserSearch() {
    //è·å–å½“å‰ç”¨æˆ·
    ApUser user = AppThreadLocalUtil.getUser();
    if(user == null){
        return ResponseResult.errorResult(AppHttpCodeEnum.NEED_LOGIN);
    }

    //æ ¹æ®ç”¨æˆ·æŸ¥è¯¢æ•°æ®ï¼ŒæŒ‰ç…§æ—¶é—´å€’åº
    List<ApUserSearch> apUserSearches = mongoTemplate.find(Query.query(Criteria.where("userId").is(user.getId())).with(Sort.by(Sort.Direction.DESC, "createdTime")), ApUserSearch.class);
    return ResponseResult.okResult(apUserSearches);
}
```

#### 7.6 åˆ é™¤æœç´¢è®°å½•

##### 7.6.1 æ€è·¯åˆ†æ

æŒ‰ç…§æœç´¢å†å²idåˆ é™¤

|          | **è¯´æ˜**            |
| -------- | ------------------- |
| æ¥å£è·¯å¾„ | /api/v1/history/del |
| è¯·æ±‚æ–¹å¼ | POST                |
| å‚æ•°     | HistorySearchDto    |
| å“åº”ç»“æœ | ResponseResult      |

HistorySearchDto

```java
@Data
public class HistorySearchDto {
    /**
    * æ¥æ”¶æœç´¢å†å²è®°å½•id
    */
    String id;
}
```

### 8. appç«¯æœç´¢-å…³é”®å­—è”æƒ³è¯

#### 8.1 éœ€æ±‚åˆ†æ

<div align="center">
    <img src="æˆªå›¾/æ–‡ç« æœç´¢/è”æƒ³è¯.png" alt="è”æƒ³è¯" />
</div>

- æ ¹æ®ç”¨æˆ·è¾“å…¥çš„å…³é”®å­—å±•ç¤ºè”æƒ³è¯

å¯¹åº”å®ä½“ç±»

```java
/**
 * <p>
 * è”æƒ³è¯è¡¨
 * </p>
 */
@Data
@Document("ap_associate_words")
public class ApAssociateWords implements Serializable {

    private static final long serialVersionUID = 1L;

    private String id;

    /**
     * è”æƒ³è¯
     */
    private String associateWords;

    /**
     * åˆ›å»ºæ—¶é—´
     */
    private Date createdTime;
}
```

#### 8.2 æœç´¢è¯-æ•°æ®æ¥æº

é€šå¸¸æ˜¯ç½‘ä¸Šæœç´¢é¢‘ç‡æ¯”è¾ƒé«˜çš„ä¸€äº›è¯ï¼Œé€šå¸¸åœ¨ä¼ä¸šä¸­æœ‰ä¸¤éƒ¨åˆ†æ¥æºï¼š

ç¬¬ä¸€ï¼šè‡ªå·±ç»´æŠ¤æœç´¢è¯

é€šè¿‡åˆ†æç”¨æˆ·æœç´¢é¢‘ç‡è¾ƒé«˜çš„è¯ï¼ŒæŒ‰ç…§æ’åä½œä¸ºæœç´¢è¯

ç¬¬äºŒï¼šç¬¬ä¸‰æ–¹è·å–

å…³é”®è¯è§„åˆ’å¸ˆï¼ˆç™¾åº¦ï¼‰ã€5118ã€çˆ±ç«™ç½‘

#### 8.3 æ ¸å¿ƒä»£ç 

```java
/**
 * @Description:
 * @Version: V1.0
 */
@Service
public class ApAssociateWordsServiceImpl implements ApAssociateWordsService {

    @Autowired
    MongoTemplate mongoTemplate;

    /**
     * è”æƒ³è¯
     * @param userSearchDto
     * @return
     */
    @Override
    public ResponseResult findAssociate(UserSearchDto userSearchDto) {
        //1 å‚æ•°æ£€æŸ¥
        if(userSearchDto == null || StringUtils.isBlank(userSearchDto.getSearchWords())){
            return ResponseResult.errorResult(AppHttpCodeEnum.PARAM_INVALID);
        }
        //åˆ†é¡µæ£€æŸ¥
        if (userSearchDto.getPageSize() > 20) {
            userSearchDto.setPageSize(20);
        }

        //3 æ‰§è¡ŒæŸ¥è¯¢ æ¨¡ç³ŠæŸ¥è¯¢
        Query query = Query.query(Criteria.where("associateWords").regex(".*?\\" + userSearchDto.getSearchWords() + ".*"));
        query.limit(userSearchDto.getPageSize());
        List<ApAssociateWords> wordsList = mongoTemplate.find(query, ApAssociateWords.class);

        return ResponseResult.okResult(wordsList);
    }
}
```

## åå››ã€xxl-Jobåˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦

### 1. éœ€æ±‚åˆ†æ

<div align="center">
    <img src="æˆªå›¾/åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦/éœ€æ±‚åˆ†æ.png" alt="éœ€æ±‚åˆ†æ" />
</div>

ç›®å‰å®ç°çš„æ€è·¯ï¼šä»æ•°æ®åº“ç›´æ¥æŒ‰ç…§å‘å¸ƒæ—¶é—´å€’åºæŸ¥è¯¢

- é—®é¢˜1ï¼š

  å¦‚ä½•è®¿é—®é‡è¾ƒå¤§ï¼Œç›´æ¥æŸ¥è¯¢æ•°æ®åº“ï¼Œå‹åŠ›è¾ƒå¤§

- é—®é¢˜2ï¼š

  æ–°å‘å¸ƒçš„æ–‡ç« ä¼šå±•ç¤ºåœ¨å‰é¢ï¼Œå¹¶ä¸æ˜¯çƒ­ç‚¹æ–‡ç« 

### 2. å®ç°æ€è·¯

æŠŠçƒ­ç‚¹æ•°æ®å­˜å…¥redisè¿›è¡Œå±•ç¤º

åˆ¤æ–­æ–‡ç« æ˜¯å¦æ˜¯çƒ­ç‚¹ï¼Œæœ‰å‡ é¡¹æ ‡å‡†ï¼š ç‚¹èµæ•°é‡ï¼Œè¯„è®ºæ•°é‡ï¼Œé˜…è¯»æ•°é‡ï¼Œæ”¶è—æ•°é‡

è®¡ç®—æ–‡ç« çƒ­åº¦ï¼Œæœ‰ä¸¤ç§æ–¹æ¡ˆï¼š

1.å®šæ—¶è®¡ç®—æ–‡ç« çƒ­åº¦

<div align="center">
    <img src="æˆªå›¾/åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦/å®šæ—¶è®¡ç®—.png" alt="å®šæ—¶è®¡ç®—" />
</div>

- æ ¹æ®æ–‡ç« çš„è¡Œä¸ºï¼ˆç‚¹èµã€è¯„è®ºã€é˜…è¯»ã€æ”¶è—ï¼‰è®¡ç®—æ–‡ç« çš„åˆ†å€¼ï¼Œåˆ©ç”¨å®šæ—¶ä»»åŠ¡æ¯å¤©å®Œæˆä¸€æ¬¡è®¡ç®—

- æŠŠåˆ†å€¼è¾ƒå¤§çš„æ–‡ç« æ•°æ®å­˜å…¥åˆ°redisä¸­

- Appç«¯ç”¨æˆ·æŸ¥è¯¢æ–‡ç« åˆ—è¡¨çš„æ—¶å€™ï¼Œä¼˜å…ˆä»redisä¸­æŸ¥è¯¢çƒ­åº¦è¾ƒé«˜çš„æ–‡ç« æ•°æ®

2.å®æ—¶è®¡ç®—æ–‡ç« çƒ­åº¦

### 3. å®šæ—¶ä»»åŠ¡æ¡†æ¶-xxljob

springä¼ ç»Ÿçš„å®šæ—¶ä»»åŠ¡@Scheduledï¼Œä½†æ˜¯è¿™æ ·å­˜åœ¨è¿™ä¸€äº›é—®é¢˜ ï¼š

- åšé›†ç¾¤ä»»åŠ¡çš„é‡å¤æ‰§è¡Œé—®é¢˜

- cronè¡¨è¾¾å¼å®šä¹‰åœ¨ä»£ç ä¹‹ä¸­ï¼Œä¿®æ”¹ä¸æ–¹ä¾¿

- å®šæ—¶ä»»åŠ¡å¤±è´¥äº†ï¼Œæ— æ³•é‡è¯•ä¹Ÿæ²¡æœ‰ç»Ÿè®¡

- å¦‚æœä»»åŠ¡é‡è¿‡å¤§ï¼Œä¸èƒ½æœ‰æ•ˆçš„åˆ†ç‰‡æ‰§è¡Œ

è§£å†³è¿™äº›é—®é¢˜çš„æ–¹æ¡ˆä¸ºï¼š

xxl-job åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦æ¡†æ¶

### 4. åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦

#### 4.1 ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦

å½“å‰è½¯ä»¶çš„æ¶æ„å·²ç»å¼€å§‹å‘åˆ†å¸ƒå¼æ¶æ„è½¬å˜ï¼Œå°†å•ä½“ç»“æ„æ‹†åˆ†ä¸ºè‹¥å¹²æœåŠ¡ï¼ŒæœåŠ¡ä¹‹é—´é€šè¿‡ç½‘ç»œäº¤äº’æ¥å®Œæˆä¸šåŠ¡å¤„ç†ã€‚åœ¨åˆ†å¸ƒå¼æ¶æ„ä¸‹ï¼Œä¸€ä¸ªæœåŠ¡å¾€å¾€ä¼šéƒ¨ç½²å¤šä¸ªå®ä¾‹æ¥è¿è¡Œæˆ‘ä»¬çš„ä¸šåŠ¡ï¼Œå¦‚æœåœ¨è¿™ç§åˆ†å¸ƒå¼ç³»ç»Ÿç¯å¢ƒä¸‹è¿è¡Œä»»åŠ¡è°ƒåº¦ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸º**åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦**ã€‚

<div align="center">
    <img src="æˆªå›¾/åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦/åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦.png" alt="åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦" />
</div>

å°†ä»»åŠ¡è°ƒåº¦ç¨‹åºåˆ†å¸ƒå¼æ„å»ºï¼Œè¿™æ ·å°±å¯ä»¥å…·æœ‰åˆ†å¸ƒå¼ç³»ç»Ÿçš„ç‰¹ç‚¹ï¼Œå¹¶ä¸”æé«˜ä»»åŠ¡çš„è°ƒåº¦å¤„ç†èƒ½åŠ›ï¼š

1ã€å¹¶è¡Œä»»åŠ¡è°ƒåº¦

å¹¶è¡Œä»»åŠ¡è°ƒåº¦å®ç°é å¤šçº¿ç¨‹ï¼Œå¦‚æœæœ‰å¤§é‡ä»»åŠ¡éœ€è¦è°ƒåº¦ï¼Œæ­¤æ—¶å…‰é å¤šçº¿ç¨‹å°±ä¼šæœ‰ç“¶é¢ˆäº†ï¼Œå› ä¸ºä¸€å°è®¡ç®—æœºCPUçš„å¤„ç†èƒ½åŠ›æ˜¯æœ‰é™çš„ã€‚

å¦‚æœå°†ä»»åŠ¡è°ƒåº¦ç¨‹åºåˆ†å¸ƒå¼éƒ¨ç½²ï¼Œæ¯ä¸ªç»“ç‚¹è¿˜å¯ä»¥éƒ¨ç½²ä¸ºé›†ç¾¤ï¼Œè¿™æ ·å°±å¯ä»¥è®©å¤šå°è®¡ç®—æœºå…±åŒå»å®Œæˆä»»åŠ¡è°ƒåº¦ï¼Œæˆ‘ä»¬å¯ä»¥å°†ä»»åŠ¡åˆ†å‰²ä¸ºè‹¥å¹²ä¸ªåˆ†ç‰‡ï¼Œç”±ä¸åŒçš„å®ä¾‹å¹¶è¡Œæ‰§è¡Œï¼Œæ¥æé«˜ä»»åŠ¡è°ƒåº¦çš„å¤„ç†æ•ˆç‡ã€‚

2ã€é«˜å¯ç”¨

è‹¥æŸä¸€ä¸ªå®ä¾‹å®•æœºï¼Œä¸å½±å“å…¶ä»–å®ä¾‹æ¥æ‰§è¡Œä»»åŠ¡ã€‚

3ã€å¼¹æ€§æ‰©å®¹

å½“é›†ç¾¤ä¸­å¢åŠ å®ä¾‹å°±å¯ä»¥æé«˜å¹¶æ‰§è¡Œä»»åŠ¡çš„å¤„ç†æ•ˆç‡ã€‚

4ã€ä»»åŠ¡ç®¡ç†ä¸ç›‘æµ‹

å¯¹ç³»ç»Ÿä¸­å­˜åœ¨çš„æ‰€æœ‰å®šæ—¶ä»»åŠ¡è¿›è¡Œç»Ÿä¸€çš„ç®¡ç†åŠç›‘æµ‹ã€‚è®©å¼€å‘äººå‘˜åŠè¿ç»´äººå‘˜èƒ½å¤Ÿæ—¶åˆ»äº†è§£ä»»åŠ¡æ‰§è¡Œæƒ…å†µï¼Œä»è€Œåšå‡ºå¿«é€Ÿçš„åº”æ€¥å¤„ç†å“åº”ã€‚

**åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦é¢ä¸´çš„é—®é¢˜ï¼š**

å½“ä»»åŠ¡è°ƒåº¦ä»¥é›†ç¾¤æ–¹å¼éƒ¨ç½²ï¼ŒåŒä¸€ä¸ªä»»åŠ¡è°ƒåº¦å¯èƒ½ä¼šæ‰§è¡Œå¤šæ¬¡ï¼Œä¾‹å¦‚ï¼šç”µå•†ç³»ç»Ÿå®šæœŸå‘æ”¾ä¼˜æƒ åˆ¸ï¼Œå°±å¯èƒ½é‡å¤å‘æ”¾ä¼˜æƒ åˆ¸ï¼Œå¯¹å…¬å¸é€ æˆæŸå¤±ï¼Œä¿¡ç”¨å¡è¿˜æ¬¾æé†’å°±ä¼šé‡å¤æ‰§è¡Œå¤šæ¬¡ï¼Œç»™ç”¨æˆ·é€ æˆçƒ¦æ¼ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æ§åˆ¶ç›¸åŒçš„ä»»åŠ¡åœ¨å¤šä¸ªè¿è¡Œå®ä¾‹ä¸Šåªæ‰§è¡Œä¸€æ¬¡ã€‚å¸¸è§è§£å†³æ–¹æ¡ˆï¼š

- åˆ†å¸ƒå¼é”ï¼Œå¤šä¸ªå®ä¾‹åœ¨ä»»åŠ¡æ‰§è¡Œå‰é¦–å…ˆéœ€è¦è·å–é”ï¼Œå¦‚æœè·å–å¤±è´¥é‚£ä¹ˆå°±è¯æ˜æœ‰å…¶ä»–æœåŠ¡å·²ç»åœ¨è¿è¡Œï¼Œå¦‚æœè·å–æˆåŠŸé‚£ä¹ˆè¯æ˜æ²¡æœ‰æœåŠ¡åœ¨è¿è¡Œå®šæ—¶ä»»åŠ¡ï¼Œé‚£ä¹ˆå°±å¯ä»¥æ‰§è¡Œã€‚
- ZooKeeperé€‰ä¸¾ï¼Œåˆ©ç”¨ZooKeeperå¯¹Leaderå®ä¾‹æ‰§è¡Œå®šæ—¶ä»»åŠ¡ï¼Œæ‰§è¡Œå®šæ—¶ä»»åŠ¡çš„æ—¶å€™åˆ¤æ–­è‡ªå·±æ˜¯å¦æ˜¯Leaderï¼Œå¦‚æœä¸æ˜¯åˆ™ä¸æ‰§è¡Œï¼Œå¦‚æœæ˜¯åˆ™æ‰§è¡Œä¸šåŠ¡é€»è¾‘ï¼Œè¿™æ ·ä¹Ÿèƒ½è¾¾åˆ°ç›®çš„ã€‚

#### 4.2 xxl-Jobç®€ä»‹

é’ˆå¯¹åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦çš„éœ€æ±‚ï¼Œå¸‚åœºä¸Šå‡ºç°äº†å¾ˆå¤šçš„äº§å“ï¼š

1ï¼‰ TBScheduleï¼šæ·˜å®æ¨å‡ºçš„ä¸€æ¬¾éå¸¸ä¼˜ç§€çš„é«˜æ€§èƒ½åˆ†å¸ƒå¼è°ƒåº¦æ¡†æ¶ï¼Œç›®å‰è¢«åº”ç”¨äºé˜¿é‡Œã€äº¬ä¸œã€æ”¯ä»˜å®ã€å›½ç¾ç­‰å¾ˆå¤šäº’è”ç½‘ä¼ä¸šçš„æµç¨‹è°ƒåº¦ç³»ç»Ÿä¸­ã€‚ä½†æ˜¯å·²ç»å¤šå¹´æœªæ›´æ–°ï¼Œæ–‡æ¡£ç¼ºå¤±ä¸¥é‡ï¼Œç¼ºå°‘ç»´æŠ¤ã€‚

2ï¼‰ XXL-Jobï¼šå¤§ä¼—ç‚¹è¯„çš„åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦å¹³å°ï¼Œæ˜¯ä¸€ä¸ªè½»é‡çº§åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦å¹³å°, å…¶æ ¸å¿ƒè®¾è®¡ç›®æ ‡æ˜¯å¼€å‘è¿…é€Ÿã€å­¦ä¹ ç®€å•ã€è½»é‡çº§ã€æ˜“æ‰©å±•ã€‚ç°å·²å¼€æ”¾æºä»£ç å¹¶æ¥å…¥å¤šå®¶å…¬å¸çº¿ä¸Šäº§å“çº¿ï¼Œå¼€ç®±å³ç”¨ã€‚

3ï¼‰Elastic-jobï¼šå½“å½“ç½‘å€Ÿé‰´TBScheduleå¹¶åŸºäºquartz äºŒæ¬¡å¼€å‘çš„å¼¹æ€§åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦ç³»ç»Ÿï¼ŒåŠŸèƒ½ä¸°å¯Œå¼ºå¤§ï¼Œé‡‡ç”¨zookeeperå®ç°åˆ†å¸ƒå¼åè°ƒï¼Œå…·æœ‰ä»»åŠ¡é«˜å¯ç”¨ä»¥åŠåˆ†ç‰‡åŠŸèƒ½ã€‚

4ï¼‰Saturnï¼š å”¯å“ä¼šå¼€æºçš„ä¸€ä¸ªåˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦å¹³å°ï¼ŒåŸºäºElastic-jobï¼Œå¯ä»¥å…¨åŸŸç»Ÿä¸€é…ç½®ï¼Œç»Ÿä¸€ç›‘
æ§ï¼Œå…·æœ‰ä»»åŠ¡é«˜å¯ç”¨ä»¥åŠåˆ†ç‰‡åŠŸèƒ½ã€‚ 

XXL-JOBæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦å¹³å°ï¼Œå…¶æ ¸å¿ƒè®¾è®¡ç›®æ ‡æ˜¯å¼€å‘è¿…é€Ÿã€å­¦ä¹ ç®€å•ã€è½»é‡çº§ã€æ˜“æ‰©å±•ã€‚ç°å·²å¼€æ”¾æºä»£ç å¹¶æ¥å…¥å¤šå®¶å…¬å¸çº¿ä¸Šäº§å“çº¿ï¼Œå¼€ç®±å³ç”¨ã€‚

æºç åœ°å€ï¼šhttps://gitee.com/xuxueli0323/xxl-job

æ–‡æ¡£åœ°å€ï¼šhttps://www.xuxueli.com/xxl-job/

**ç‰¹æ€§**

- **ç®€å•çµæ´»**
  æä¾›Webé¡µé¢å¯¹ä»»åŠ¡è¿›è¡Œç®¡ç†ï¼Œç®¡ç†ç³»ç»Ÿæ”¯æŒç”¨æˆ·ç®¡ç†ã€æƒé™æ§åˆ¶ï¼›
  æ”¯æŒå®¹å™¨éƒ¨ç½²ï¼›
  æ”¯æŒé€šè¿‡é€šç”¨HTTPæä¾›è·¨å¹³å°ä»»åŠ¡è°ƒåº¦ï¼›
- **ä¸°å¯Œçš„ä»»åŠ¡ç®¡ç†åŠŸèƒ½**
  æ”¯æŒé¡µé¢å¯¹ä»»åŠ¡CRUDæ“ä½œï¼›
  æ”¯æŒåœ¨é¡µé¢ç¼–å†™è„šæœ¬ä»»åŠ¡ã€å‘½ä»¤è¡Œä»»åŠ¡ã€Javaä»£ç ä»»åŠ¡å¹¶æ‰§è¡Œï¼›
  æ”¯æŒä»»åŠ¡çº§è”ç¼–æ’ï¼Œçˆ¶ä»»åŠ¡æ‰§è¡Œç»“æŸåè§¦å‘å­ä»»åŠ¡æ‰§è¡Œï¼›
  æ”¯æŒè®¾ç½®æŒ‡å®šä»»åŠ¡æ‰§è¡ŒèŠ‚ç‚¹è·¯ç”±ç­–ç•¥ï¼ŒåŒ…æ‹¬è½®è¯¢ã€éšæœºã€å¹¿æ’­ã€æ•…éšœè½¬ç§»ã€å¿™ç¢Œè½¬ç§»ç­‰ï¼›
  æ”¯æŒCronæ–¹å¼ã€ä»»åŠ¡ä¾èµ–ã€è°ƒåº¦ä¸­å¿ƒAPIæ¥å£æ–¹å¼è§¦å‘ä»»åŠ¡æ‰§è¡Œ
- **é«˜æ€§èƒ½**
  ä»»åŠ¡è°ƒåº¦æµç¨‹å…¨å¼‚æ­¥åŒ–è®¾è®¡å®ç°ï¼Œå¦‚å¼‚æ­¥è°ƒåº¦ã€å¼‚æ­¥è¿è¡Œã€å¼‚æ­¥å›è°ƒç­‰ï¼Œæœ‰æ•ˆå¯¹å¯†é›†è°ƒåº¦è¿›è¡Œæµé‡å‰Šå³°ï¼›
- **é«˜å¯ç”¨**
  ä»»åŠ¡è°ƒåº¦ä¸­å¿ƒã€ä»»åŠ¡æ‰§è¡ŒèŠ‚ç‚¹å‡ é›†ç¾¤éƒ¨ç½²ï¼Œæ”¯æŒåŠ¨æ€æ‰©å±•ã€æ•…éšœè½¬ç§»
  æ”¯æŒä»»åŠ¡é…ç½®è·¯ç”±æ•…éšœè½¬ç§»ç­–ç•¥ï¼Œæ‰§è¡Œå™¨èŠ‚ç‚¹ä¸å¯ç”¨æ˜¯è‡ªåŠ¨è½¬ç§»åˆ°å…¶ä»–èŠ‚ç‚¹æ‰§è¡Œ
  æ”¯æŒä»»åŠ¡è¶…æ—¶æ§åˆ¶ã€å¤±è´¥é‡è¯•é…ç½®
  æ”¯æŒä»»åŠ¡å¤„ç†é˜»å¡ç­–ç•¥ï¼šè°ƒåº¦å½“ä»»åŠ¡æ‰§è¡ŒèŠ‚ç‚¹å¿™ç¢Œæ—¶æ¥ä¸åŠæ‰§è¡Œä»»åŠ¡çš„å¤„ç†ç­–ç•¥ï¼ŒåŒ…æ‹¬ï¼šä¸²è¡Œã€æŠ›å¼ƒã€è¦†ç›–ç­–ç•¥
- **æ˜“äºç›‘æ§è¿ç»´**
  æ”¯æŒè®¾ç½®ä»»åŠ¡å¤±è´¥é‚®ä»¶å‘Šè­¦ï¼Œé¢„ç•™æ¥å£æ”¯æŒçŸ­ä¿¡ã€é’‰é’‰å‘Šè­¦ï¼›
  æ”¯æŒå®æ—¶æŸ¥çœ‹ä»»åŠ¡æ‰§è¡Œè¿è¡Œæ•°æ®ç»Ÿè®¡å›¾è¡¨ã€ä»»åŠ¡è¿›åº¦ç›‘æ§æ•°æ®ã€ä»»åŠ¡å®Œæ•´æ‰§è¡Œæ—¥å¿—ï¼›

#### 4.3 8å¼ è¡¨

```java
- xxl_job_lockï¼šä»»åŠ¡è°ƒåº¦é”è¡¨ï¼›
- xxl_job_groupï¼šæ‰§è¡Œå™¨ä¿¡æ¯è¡¨ï¼Œç»´æŠ¤ä»»åŠ¡æ‰§è¡Œå™¨ä¿¡æ¯ï¼›
- xxl_job_infoï¼šè°ƒåº¦æ‰©å±•ä¿¡æ¯è¡¨ï¼š ç”¨äºä¿å­˜XXL-JOBè°ƒåº¦ä»»åŠ¡çš„æ‰©å±•ä¿¡æ¯ï¼Œå¦‚ä»»åŠ¡åˆ†ç»„ã€ä»»åŠ¡åã€æœºå™¨åœ°å€ã€æ‰§è¡Œå™¨ã€æ‰§è¡Œå…¥å‚å’ŒæŠ¥è­¦é‚®ä»¶ç­‰ç­‰ï¼›
- xxl_job_logï¼šè°ƒåº¦æ—¥å¿—è¡¨ï¼š ç”¨äºä¿å­˜XXL-JOBä»»åŠ¡è°ƒåº¦çš„å†å²ä¿¡æ¯ï¼Œå¦‚è°ƒåº¦ç»“æœã€æ‰§è¡Œç»“æœã€è°ƒåº¦å…¥å‚ã€è°ƒåº¦æœºå™¨å’Œæ‰§è¡Œå™¨ç­‰ç­‰ï¼›
- xxl_job_logglueï¼šä»»åŠ¡GLUEæ—¥å¿—ï¼šç”¨äºä¿å­˜GLUEæ›´æ–°å†å²ï¼Œç”¨äºæ”¯æŒGLUEçš„ç‰ˆæœ¬å›æº¯åŠŸèƒ½ï¼›
- xxl_job_registryï¼šæ‰§è¡Œå™¨æ³¨å†Œè¡¨ï¼Œç»´æŠ¤åœ¨çº¿çš„æ‰§è¡Œå™¨å’Œè°ƒåº¦ä¸­å¿ƒæœºå™¨åœ°å€ä¿¡æ¯ï¼›
- xxl_job_userï¼šç³»ç»Ÿç”¨æˆ·è¡¨ï¼›
```

è°ƒåº¦ä¸­å¿ƒæ”¯æŒé›†ç¾¤éƒ¨ç½²ï¼Œé›†ç¾¤æƒ…å†µä¸‹å„èŠ‚ç‚¹åŠ¡å¿…è¿æ¥åŒä¸€ä¸ªmysqlå®ä¾‹;

å¦‚æœmysqlåšä¸»ä»,è°ƒåº¦ä¸­å¿ƒé›†ç¾¤èŠ‚ç‚¹åŠ¡å¿…å¼ºåˆ¶èµ°ä¸»åº“;

#### 4.4 é…ç½®éƒ¨ç½²è°ƒåº¦ä¸­å¿ƒ-dockerå®‰è£…

1.åˆ›å»ºmysqlå®¹å™¨ï¼Œåˆå§‹åŒ–xxl-jobçš„SQLè„šæœ¬

```shell
docker run -p 3306:3306 --name mysql57 \
-v /opt/mysql/conf:/etc/mysql \
-v /opt/mysql/logs:/var/log/mysql \
-v /opt/mysql/data:/var/lib/mysql \
-e MYSQL_ROOT_PASSWORD=root \
-d mysql:5.7
```

2.æ‹‰å–é•œåƒ

```shell
docker pull xuxueli/xxl-job-admin:2.3.0
```

3.åˆ›å»ºå®¹å™¨

```shell
docker run -e PARAMS="--spring.datasource.url=jdbc:mysql://192.168.200.130:3306/xxl_job?Unicode=true&characterEncoding=UTF-8 \
--spring.datasource.username=root \
--spring.datasource.password=root" \
-p 8888:8080 -v /tmp:/data/applogs \
--name xxl-job-admin --restart=always  -d xuxueli/xxl-job-admin:2.3.0
```

#### 4.5 é…ç½®

**åŸºç¡€é…ç½®**

- æ‰§è¡Œå™¨ï¼šæ¯ä¸ªä»»åŠ¡å¿…é¡»ç»‘å®šä¸€ä¸ªæ‰§è¡Œå™¨, æ–¹ä¾¿ç»™ä»»åŠ¡è¿›è¡Œåˆ†ç»„

- ä»»åŠ¡æè¿°ï¼šä»»åŠ¡çš„æè¿°ä¿¡æ¯ï¼Œä¾¿äºä»»åŠ¡ç®¡ç†ï¼›

- è´Ÿè´£äººï¼šä»»åŠ¡çš„è´Ÿè´£äººï¼›

- æŠ¥è­¦é‚®ä»¶ï¼šä»»åŠ¡è°ƒåº¦å¤±è´¥æ—¶é‚®ä»¶é€šçŸ¥çš„é‚®ç®±åœ°å€ï¼Œæ”¯æŒé…ç½®å¤šé‚®ç®±åœ°å€ï¼Œé…ç½®å¤šä¸ªé‚®ç®±åœ°å€æ—¶ç”¨é€—å·åˆ†éš”

**è°ƒåº¦é…ç½®**

- è°ƒåº¦ç±»å‹ï¼š
  - æ— ï¼šè¯¥ç±»å‹ä¸ä¼šä¸»åŠ¨è§¦å‘è°ƒåº¦ï¼›
  - CRONï¼šè¯¥ç±»å‹å°†ä¼šé€šè¿‡CRONï¼Œè§¦å‘ä»»åŠ¡è°ƒåº¦ï¼›
  - å›ºå®šé€Ÿåº¦ï¼šè¯¥ç±»å‹å°†ä¼šä»¥å›ºå®šé€Ÿåº¦ï¼Œè§¦å‘ä»»åŠ¡è°ƒåº¦ï¼›æŒ‰ç…§å›ºå®šçš„é—´éš”æ—¶é—´ï¼Œå‘¨æœŸæ€§è§¦å‘ï¼›

**ä»»åŠ¡é…ç½®**

- è¿è¡Œæ¨¡å¼ï¼š

â€‹    BEANæ¨¡å¼ï¼šä»»åŠ¡ä»¥JobHandleræ–¹å¼ç»´æŠ¤åœ¨æ‰§è¡Œå™¨ç«¯ï¼›éœ€è¦ç»“åˆ "JobHandler" å±æ€§åŒ¹é…æ‰§è¡Œå™¨ä¸­ä»»åŠ¡ï¼›

- JobHandlerï¼šè¿è¡Œæ¨¡å¼ä¸º "BEANæ¨¡å¼" æ—¶ç”Ÿæ•ˆï¼Œå¯¹åº”æ‰§è¡Œå™¨ä¸­æ–°å¼€å‘çš„JobHandlerç±»â€œ@JobHandlerâ€æ³¨è§£è‡ªå®šä¹‰çš„valueå€¼ï¼›

- æ‰§è¡Œå‚æ•°ï¼šä»»åŠ¡æ‰§è¡Œæ‰€éœ€çš„å‚æ•°ï¼›

**é˜»å¡å¤„ç†ç­–ç•¥**

é˜»å¡å¤„ç†ç­–ç•¥ï¼šè°ƒåº¦è¿‡äºå¯†é›†æ‰§è¡Œå™¨æ¥ä¸åŠå¤„ç†æ—¶çš„å¤„ç†ç­–ç•¥ï¼›

- å•æœºä¸²è¡Œï¼ˆé»˜è®¤ï¼‰ï¼šè°ƒåº¦è¯·æ±‚è¿›å…¥å•æœºæ‰§è¡Œå™¨åï¼Œè°ƒåº¦è¯·æ±‚è¿›å…¥FIFO(First Input First Output)é˜Ÿåˆ—å¹¶ä»¥ä¸²è¡Œæ–¹å¼è¿è¡Œï¼›

- ä¸¢å¼ƒåç»­è°ƒåº¦ï¼šè°ƒåº¦è¯·æ±‚è¿›å…¥å•æœºæ‰§è¡Œå™¨åï¼Œå‘ç°æ‰§è¡Œå™¨å­˜åœ¨è¿è¡Œçš„è°ƒåº¦ä»»åŠ¡ï¼Œæœ¬æ¬¡è¯·æ±‚å°†ä¼šè¢«ä¸¢å¼ƒå¹¶æ ‡è®°ä¸ºå¤±è´¥ï¼›

- è¦†ç›–ä¹‹å‰è°ƒåº¦ï¼šè°ƒåº¦è¯·æ±‚è¿›å…¥å•æœºæ‰§è¡Œå™¨åï¼Œå‘ç°æ‰§è¡Œå™¨å­˜åœ¨è¿è¡Œçš„è°ƒåº¦ä»»åŠ¡ï¼Œå°†ä¼šç»ˆæ­¢è¿è¡Œä¸­çš„è°ƒåº¦ä»»åŠ¡å¹¶æ¸…ç©ºé˜Ÿåˆ—ï¼Œç„¶åè¿è¡Œæœ¬åœ°è°ƒåº¦ä»»åŠ¡ï¼›

**è·¯ç”±ç­–ç•¥**

å½“æ‰§è¡Œå™¨é›†ç¾¤éƒ¨ç½²æ—¶ï¼Œæä¾›ä¸°å¯Œçš„è·¯ç”±ç­–ç•¥ï¼ŒåŒ…æ‹¬ï¼›

- FIRSTï¼ˆç¬¬ä¸€ä¸ªï¼‰ï¼šå›ºå®šé€‰æ‹©ç¬¬ä¸€ä¸ªæœºå™¨ï¼›

- LASTï¼ˆæœ€åä¸€ä¸ªï¼‰ï¼šå›ºå®šé€‰æ‹©æœ€åä¸€ä¸ªæœºå™¨ï¼›

- **ROUNDï¼ˆè½®è¯¢ï¼‰**

- RANDOMï¼ˆéšæœºï¼‰ï¼šéšæœºé€‰æ‹©åœ¨çº¿çš„æœºå™¨ï¼›

- CONSISTENT_HASHï¼ˆä¸€è‡´æ€§HASHï¼‰ï¼šæ¯ä¸ªä»»åŠ¡æŒ‰ç…§Hashç®—æ³•å›ºå®šé€‰æ‹©æŸä¸€å°æœºå™¨ï¼Œä¸”æ‰€æœ‰ä»»åŠ¡å‡åŒ€æ•£åˆ—åœ¨ä¸åŒæœºå™¨ä¸Šã€‚

- LEAST_FREQUENTLY_USEDï¼ˆæœ€ä¸ç»å¸¸ä½¿ç”¨ï¼‰ï¼šä½¿ç”¨é¢‘ç‡æœ€ä½çš„æœºå™¨ä¼˜å…ˆè¢«é€‰ä¸¾ï¼›

- LEAST_RECENTLY_USEDï¼ˆæœ€è¿‘æœ€ä¹…æœªä½¿ç”¨ï¼‰ï¼šæœ€ä¹…æœªä½¿ç”¨çš„æœºå™¨ä¼˜å…ˆè¢«é€‰ä¸¾ï¼›

- FAILOVERï¼ˆæ•…éšœè½¬ç§»ï¼‰ï¼šæŒ‰ç…§é¡ºåºä¾æ¬¡è¿›è¡Œå¿ƒè·³æ£€æµ‹ï¼Œç¬¬ä¸€ä¸ªå¿ƒè·³æ£€æµ‹æˆåŠŸçš„æœºå™¨é€‰å®šä¸ºç›®æ ‡æ‰§è¡Œå™¨å¹¶å‘èµ·è°ƒåº¦ï¼›

- BUSYOVERï¼ˆå¿™ç¢Œè½¬ç§»ï¼‰ï¼šæŒ‰ç…§é¡ºåºä¾æ¬¡è¿›è¡Œç©ºé—²æ£€æµ‹ï¼Œç¬¬ä¸€ä¸ªç©ºé—²æ£€æµ‹æˆåŠŸçš„æœºå™¨é€‰å®šä¸ºç›®æ ‡æ‰§è¡Œå™¨å¹¶å‘èµ·è°ƒåº¦ï¼›

- **SHARDING_BROADCAST(åˆ†ç‰‡å¹¿æ’­)ï¼šå¹¿æ’­è§¦å‘å¯¹åº”é›†ç¾¤ä¸­æ‰€æœ‰æœºå™¨æ‰§è¡Œä¸€æ¬¡ä»»åŠ¡ï¼ŒåŒæ—¶ç³»ç»Ÿè‡ªåŠ¨ä¼ é€’åˆ†ç‰‡å‚æ•°ï¼›å¯æ ¹æ®åˆ†ç‰‡å‚æ•°å¼€å‘åˆ†ç‰‡ä»»åŠ¡ï¼›**

#### 4.6 è·¯ç”±ç­–ç•¥(åˆ†ç‰‡å¹¿æ’­)

##### 4.6.1 åˆ†ç‰‡é€»è¾‘

æ‰§è¡Œå™¨é›†ç¾¤éƒ¨ç½²æ—¶ï¼Œä»»åŠ¡è·¯ç”±ç­–ç•¥é€‰æ‹©â€åˆ†ç‰‡å¹¿æ’­â€æƒ…å†µä¸‹ï¼Œä¸€æ¬¡ä»»åŠ¡è°ƒåº¦å°†ä¼šå¹¿æ’­è§¦å‘å¯¹åº”é›†ç¾¤ä¸­æ‰€æœ‰æ‰§è¡Œå™¨æ‰§è¡Œä¸€æ¬¡ä»»åŠ¡

<div align="center">
    <img src="æˆªå›¾/åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦/åˆ†ç‰‡å¹¿æ’­.png" alt="åˆ†ç‰‡å¹¿æ’­" />
</div>

### 5. çƒ­ç‚¹æ–‡ç« -å®šæ—¶è®¡ç®—

#### 5.1 å®ç°æ€è·¯

<div align="center">
    <img src="æˆªå›¾/åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦/å®ç°æ€è·¯.png" alt="å®ç°æ€è·¯" />
</div>

#### 5.2 å®ç°æ­¥éª¤

åˆ†å€¼è®¡ç®—ä¸æ¶‰åŠåˆ°å‰ç«¯å·¥ç¨‹ï¼Œä¹Ÿæ— éœ€æä¾›apiæ¥å£ï¼Œæ˜¯ä¸€ä¸ªçº¯åå°çš„åŠŸèƒ½çš„å¼€å‘ã€‚

#### 5.3 é¢‘é“åˆ—è¡¨è¿œç¨‹æ¥å£å‡†å¤‡

è®¡ç®—å®Œæˆæ–°çƒ­æ•°æ®åï¼Œéœ€è¦ç»™æ¯ä¸ªé¢‘é“ç¼“å­˜ä¸€ä»½æ•°æ®ï¼Œæ‰€ä»¥éœ€è¦æŸ¥è¯¢æ‰€æœ‰é¢‘é“ä¿¡æ¯

â‘  åœ¨heima-leadnews-feign-apiå®šä¹‰è¿œç¨‹æ¥å£

```java
@FeignClient("leadnews-wemedia")
public interface IWemediaClient {
    @GetMapping("/api/v1/channel/list")
    public ResponseResult getChannels();
}
```

â‘¡ heima-leadnews-wemediaç«¯æä¾›æ¥å£

```java
@RestController
public class WemediaClient implements IWemediaClient {
    @Autowired
    private WmChannelService wmChannelService;
    
    @GetMapping("/api/v1/channel/list")
    @Override
    public ResponseResult getChannels() {
        return wmChannelService.findAll();
    }
}
```

åœ¨ApArticleMapper.xmlæ–°å¢æ–¹æ³•

```xml
<select id="findArticleListByLast5days" resultMap="resultMap">
    SELECT
    aa.*
    FROM
    `ap_article` aa
    LEFT JOIN ap_article_config aac ON aa.id = aac.article_id
    <where>
        and aac.is_delete != 1
        and aac.is_down != 1
        <if test="dayParam != null">
            and aa.publish_time <![CDATA[>=]]> #{dayParam}
        </if>
    </where>
</select>
```

ä¿®æ”¹ApArticleMapperç±»

```java
@Mapper
public interface ApArticleMapper extends BaseMapper<ApArticle> {

    /**
     * åŠ è½½æ–‡ç« åˆ—è¡¨
     * @param dto
     * @param type  1  åŠ è½½æ›´å¤š   2è®°è½½æœ€æ–°
     * @return
     */
    public List<ApArticle> loadArticleList(ArticleHomeDto dto,Short type);
	//@Param: è¿™ä¸ªæ³¨è§£æ˜¯ä¸ºSQLè¯­å¥ä¸­å‚æ•°èµ‹å€¼è€ŒæœåŠ¡çš„
    public List<ApArticle> findArticleListByLast5days(@Param("dayParam") Date dayParam);
}
```

#### 5.3.4 çƒ­æ–‡ç« ä¸šåŠ¡å±‚

ä¿®æ”¹ArticleConstans

```java
public class ArticleConstants {
    public static final Short LOADTYPE_LOAD_MORE = 1;
    public static final Short LOADTYPE_LOAD_NEW = 2;
    public static final String DEFAULT_TAG = "__all__";

    public static final String ARTICLE_ES_SYNC_TOPIC = "article.es.sync.topic";

    public static final Integer HOT_ARTICLE_LIKE_WEIGHT = 3;
    public static final Integer HOT_ARTICLE_COMMENT_WEIGHT = 5;
    public static final Integer HOT_ARTICLE_COLLECTION_WEIGHT = 8;

    public static final String HOT_ARTICLE_FIRST_PAGE = "hot_article_first_page_";
}
```

åˆ›å»ºä¸€ä¸ªvoæ¥æ”¶è®¡ç®—åˆ†å€¼åçš„å¯¹è±¡

```java
@Data
public class HotArticleVo extends ApArticle {
    /**
     * æ–‡ç« åˆ†å€¼
     */
    private Integer score;
}
```

ä¸šåŠ¡å±‚å®ç°ç±»

```java
@Service
@Slf4j
@Transactional
public class HotArticleServiceImpl implements HotArticleService {

    @Autowired
    private ApArticleMapper apArticleMapper;

    /**
     * è®¡ç®—çƒ­ç‚¹æ–‡ç« 
     */
    @Override
    public void computeHotArticle() {
        //1.æŸ¥è¯¢å‰5å¤©çš„æ–‡ç« æ•°æ®
        Date dateParam = DateTime.now().minusDays(5).toDate();
        List<ApArticle> apArticleList = apArticleMapper.findArticleListByLast5days(dateParam);

        //2.è®¡ç®—æ–‡ç« çš„åˆ†å€¼
        List<HotArticleVo> hotArticleVoList = computeHotArticle(apArticleList);

        //3.ä¸ºæ¯ä¸ªé¢‘é“ç¼“å­˜30æ¡åˆ†å€¼è¾ƒé«˜çš„æ–‡ç« 
        cacheTagToRedis(hotArticleVoList);

    }

    @Autowired
    private IWemediaClient wemediaClient;

    @Autowired
    private CacheService cacheService;

    /**
     * ä¸ºæ¯ä¸ªé¢‘é“ç¼“å­˜30æ¡åˆ†å€¼è¾ƒé«˜çš„æ–‡ç« 
     * @param hotArticleVoList
     */
    private void cacheTagToRedis(List<HotArticleVo> hotArticleVoList) {
        //æ¯ä¸ªé¢‘é“ç¼“å­˜30æ¡åˆ†å€¼è¾ƒé«˜çš„æ–‡ç« 
        ResponseResult responseResult = wemediaClient.getChannels();
        if(responseResult.getCode().equals(200)){
            String channelJson = JSON.toJSONString(responseResult.getData());
            List<WmChannel> wmChannels = JSON.parseArray(channelJson, WmChannel.class);
            //æ£€ç´¢å‡ºæ¯ä¸ªé¢‘é“çš„æ–‡ç« 
            if(wmChannels != null && wmChannels.size() > 0){
                for (WmChannel wmChannel : wmChannels) {
                    List<HotArticleVo> hotArticleVos = hotArticleVoList.stream().filter(x -> x.getChannelId().equals(wmChannel.getId())).collect(Collectors.toList());
                    //ç»™æ–‡ç« è¿›è¡Œæ’åºï¼Œå–30æ¡åˆ†å€¼è¾ƒé«˜çš„æ–‡ç« å­˜å…¥redis  keyï¼šé¢‘é“id   valueï¼š30æ¡åˆ†å€¼è¾ƒé«˜çš„æ–‡ç« 
                    sortAndCache(hotArticleVos, ArticleConstants.HOT_ARTICLE_FIRST_PAGE + wmChannel.getId());
                }
            }
        }
        //è®¾ç½®æ¨èæ•°æ®
        //ç»™æ–‡ç« è¿›è¡Œæ’åºï¼Œå–30æ¡åˆ†å€¼è¾ƒé«˜çš„æ–‡ç« å­˜å…¥redis  keyï¼šé¢‘é“id   valueï¼š30æ¡åˆ†å€¼è¾ƒé«˜çš„æ–‡ç« 
        sortAndCache(hotArticleVoList, ArticleConstants.HOT_ARTICLE_FIRST_PAGE+ArticleConstants.DEFAULT_TAG);
    }

    /**
     * æ’åºå¹¶ä¸”ç¼“å­˜æ•°æ®
     * @param hotArticleVos
     * @param key
     */
    private void sortAndCache(List<HotArticleVo> hotArticleVos, String key) {
        hotArticleVos = hotArticleVos.stream().sorted(Comparator.comparing(HotArticleVo::getScore).reversed()).collect(Collectors.toList());
        if (hotArticleVos.size() > 30) {
            hotArticleVos = hotArticleVos.subList(0, 30);
        }
        cacheService.set(key, JSON.toJSONString(hotArticleVos));
    }

    /**
     * è®¡ç®—æ–‡ç« åˆ†å€¼
     * @param apArticleList
     * @return
     */
    private List<HotArticleVo> computeHotArticle(List<ApArticle> apArticleList) {

        List<HotArticleVo> hotArticleVoList = new ArrayList<>();

        if(apArticleList != null && apArticleList.size() > 0){
            for (ApArticle apArticle : apArticleList) {
                HotArticleVo hot = new HotArticleVo();
                BeanUtils.copyProperties(apArticle,hot);
                Integer score = computeScore(apArticle);
                hot.setScore(score);
                hotArticleVoList.add(hot);
            }
        }
        return hotArticleVoList;
    }

    /**
     * è®¡ç®—æ–‡ç« çš„å…·ä½“åˆ†å€¼
     * @param apArticle
     * @return
     */
    private Integer computeScore(ApArticle apArticle) {
        Integer scere = 0;
        if(apArticle.getLikes() != null){
            scere += apArticle.getLikes() * ArticleConstants.HOT_ARTICLE_LIKE_WEIGHT;
        }
        if(apArticle.getViews() != null){
            scere += apArticle.getViews();
        }
        if(apArticle.getComment() != null){
            scere += apArticle.getComment() * ArticleConstants.HOT_ARTICLE_COMMENT_WEIGHT;
        }
        if(apArticle.getCollection() != null){
            scere += apArticle.getCollection() * ArticleConstants.HOT_ARTICLE_COLLECTION_WEIGHT;
        }

        return scere;
    }
}
```

åœ¨ArticleApplicationçš„å¼•å¯¼ç±»ä¸­æ·»åŠ ä»¥ä¸‹æ³¨è§£

```java
@EnableFeignClients(basePackages = "com.heima.apis")
```

#### 3.3.5 xxl-jobå®šæ—¶è®¡ç®—-æ­¥éª¤

â‘ ï¼šåœ¨heima-leadnews-articleä¸­çš„pomæ–‡ä»¶ä¸­æ–°å¢ä¾èµ–

```xml
<!--xxl-job-->
<dependency>
    <groupId>com.xuxueli</groupId>
    <artifactId>xxl-job-core</artifactId>
    <version>2.3.0</version>
</dependency>
```

â‘¡ åœ¨xxl-job-adminä¸­æ–°å»ºæ‰§è¡Œå™¨å’Œä»»åŠ¡

æ–°å»ºæ‰§è¡Œå™¨ï¼šleadnews-hot-article-executor

<div align="center">
    <img src="æˆªå›¾/åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦/æ–°å»ºæ‰§è¡Œå™¨.png" alt="æ–°å»ºæ‰§è¡Œå™¨" />
</div>

æ–°å»ºä»»åŠ¡ï¼šè·¯ç”±ç­–ç•¥ä¸ºè½®è¯¢ï¼ŒCronè¡¨è¾¾å¼ï¼š0 0 2 * * ? 

<div align="center">
    <img src="æˆªå›¾/åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦/æ–°å»ºæ‰§è¡Œä»»åŠ¡.png" alt="æ–°å»ºæ‰§è¡Œä»»åŠ¡" />
</div>

â‘¢ leadnews-articleä¸­é›†æˆxxl-job

XxlJobConfig

```java
/**
 * xxl-job config
 *
 * @author xuxueli 2017-04-28
 */
@Configuration
public class XxlJobConfig {
    private Logger logger = LoggerFactory.getLogger(XxlJobConfig.class);

    @Value("${xxl.job.admin.addresses}")
    private String adminAddresses;

    @Value("${xxl.job.executor.appname}")
    private String appname;

    @Value("${xxl.job.executor.port}")
    private int port;
    
    @Bean
    public XxlJobSpringExecutor xxlJobExecutor() {
        logger.info(">>>>>>>>>>> xxl-job config init.");
        XxlJobSpringExecutor xxlJobSpringExecutor = new XxlJobSpringExecutor();
        xxlJobSpringExecutor.setAdminAddresses(adminAddresses);
        xxlJobSpringExecutor.setAppname(appname);
        xxlJobSpringExecutor.setPort(port);
        return xxlJobSpringExecutor;
    }
}
```

åœ¨nacosé…ç½®æ–°å¢é…ç½®

```yaml
xxl:
  job:
    admin:
      addresses: http://192.168.200.130:8888/xxl-job-admin
    executor:
      appname: leadnews-hot-article-executor
      port: 9999
```

â‘£ï¼šåœ¨articleå¾®æœåŠ¡ä¸­æ–°å»ºä»»åŠ¡ç±»

```java
@Component
@Slf4j
public class ComputeHotArticleJob {

    @Autowired
    private HotArticleService hotArticleService;

    @XxlJob("computeHotArticleJob")
    public void handle(){
        log.info("çƒ­æ–‡ç« åˆ†å€¼è®¡ç®—è°ƒåº¦ä»»åŠ¡å¼€å§‹æ‰§è¡Œ...");
        hotArticleService.computeHotArticle();
        log.info("çƒ­æ–‡ç« åˆ†å€¼è®¡ç®—è°ƒåº¦ä»»åŠ¡ç»“æŸ...");

    }
}
```

### 6. æŸ¥è¯¢æ–‡ç« æ¥å£æ”¹é€ 

#### 6.1 æ€è·¯åˆ†æ

<div align="center">
    <img src="æˆªå›¾/åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦/æŸ¥è¯¢æ–‡ç« .png" alt="æŸ¥è¯¢æ–‡ç« " />
</div>

#### 6.2 æ ¸å¿ƒä»£ç 

```java
/**
     * åŠ è½½æ–‡ç« åˆ—è¡¨
     * @param dto
     * @param type      1 åŠ è½½æ›´å¤š   2 åŠ è½½æœ€æ–°
     * @param firstPage true  æ˜¯é¦–é¡µ  flase éé¦–é¡µ
     * @return
     */
@Override
public ResponseResult load2(ArticleHomeDto dto, Short type, boolean firstPage) {
        if(firstPage){
            String jsonStr = cacheService.get(ArticleConstants.HOT_ARTICLE_FIRST_PAGE + dto.getTag());
            if(StringUtils.isNotBlank(jsonStr)){
                List<HotArticleVo> hotArticleVoList = JSON.parseArray(jsonStr, HotArticleVo.class);
                //æ²¡æ•°æ®çš„æ—¶å€™redisè¿”å›çš„æ˜¯ â€œ[]â€ï¼Œæ­¤æ—¶å­—ç¬¦ä¸²NotBlankä½†æ˜¯æ²¡æ•°æ®
                if(hotArticleVoList != null && hotArticleVoList.size() > 0){
                    ResponseResult responseResult = ResponseResult.okResult(hotArticleVoList);
                    return responseResult;
                }
            }
        }
        return load(dto, type);
    }
```

## åäº”ã€çƒ­ç‚¹æ–‡ç« -å®æ—¶è®¡ç®—

### 1. å®šæ—¶è®¡ç®—ä¸å®æ—¶è®¡ç®—

<div align="center">
    <img src="æˆªå›¾/çƒ­ç‚¹æ–‡ç« å®æ—¶è®¡ç®—/å®šæ—¶è®¡ç®—ä¸å®æ—¶è®¡ç®—.png" alt="å®šæ—¶è®¡ç®—ä¸å®æ—¶è®¡ç®—" />
</div>

å®æ—¶è®¡ç®—

- ç”¨æˆ·è¡Œä¸ºå‘é€æ¶ˆæ¯

- kafkaStreamèšåˆå¤„ç†æ¶ˆæ¯

- æ›´æ–°æ–‡ç« è¡Œä¸ºæ•°é‡

- æ›¿æ¢çƒ­ç‚¹æ–‡ç« æ•°æ®

### 2. å®æ—¶æµå¼è®¡ç®—

#### 2.1 æ¦‚å¿µ

ä¸€èˆ¬æµå¼è®¡ç®—ä¼šä¸æ‰¹é‡è®¡ç®—ç›¸æ¯”è¾ƒã€‚åœ¨æµå¼è®¡ç®—æ¨¡å‹ä¸­ï¼Œè¾“å…¥æ˜¯æŒç»­çš„ï¼Œå¯ä»¥è®¤ä¸ºåœ¨æ—¶é—´ä¸Šæ˜¯æ— ç•Œçš„ï¼Œä¹Ÿå°±æ„å‘³ç€ï¼Œæ°¸è¿œæ‹¿ä¸åˆ°å…¨é‡æ•°æ®å»åšè®¡ç®—ã€‚åŒæ—¶ï¼Œè®¡ç®—ç»“æœæ˜¯æŒç»­è¾“å‡ºçš„ï¼Œä¹Ÿå³è®¡ç®—ç»“æœåœ¨æ—¶é—´ä¸Šä¹Ÿæ˜¯æ— ç•Œçš„ã€‚

æµå¼è®¡ç®—ä¸€èˆ¬å¯¹å®æ—¶æ€§è¦æ±‚è¾ƒé«˜ï¼ŒåŒæ—¶ä¸€èˆ¬æ˜¯å…ˆå®šä¹‰ç›®æ ‡è®¡ç®—ï¼Œç„¶åæ•°æ®åˆ°æ¥ä¹‹åå°†è®¡ç®—é€»è¾‘åº”ç”¨äºæ•°æ®ã€‚åŒæ—¶ä¸ºäº†æé«˜è®¡ç®—æ•ˆç‡ï¼Œå¾€å¾€å°½å¯èƒ½é‡‡ç”¨å¢é‡è®¡ç®—ä»£æ›¿å…¨é‡è®¡ç®—ã€‚

<div align="center">
    <img src="æˆªå›¾/çƒ­ç‚¹æ–‡ç« å®æ—¶è®¡ç®—/æ¦‚å¿µ.png" alt="æ¦‚å¿µ" />
</div>

æµå¼è®¡ç®—å°±ç›¸å½“äºä¸Šå›¾çš„å³ä¾§æ‰¶æ¢¯ï¼Œæ˜¯å¯ä»¥æºæºä¸æ–­çš„äº§ç”Ÿæ•°æ®ï¼Œæºæºä¸æ–­çš„æ¥æ”¶æ•°æ®ï¼Œæ²¡æœ‰è¾¹ç•Œã€‚

#### 2.2 åº”ç”¨åœºæ™¯

- æ—¥å¿—åˆ†æ

  ç½‘ç«™çš„ç”¨æˆ·è®¿é—®æ—¥å¿—è¿›è¡Œå®æ—¶çš„åˆ†æï¼Œè®¡ç®—è®¿é—®é‡ï¼Œç”¨æˆ·ç”»åƒï¼Œç•™å­˜ç‡ç­‰ç­‰ï¼Œå®æ—¶çš„è¿›è¡Œæ•°æ®åˆ†æï¼Œå¸®åŠ©ä¼ä¸šè¿›è¡Œå†³ç­–

- å¤§å±çœ‹æ¿ç»Ÿè®¡

  å¯ä»¥å®æ—¶çš„æŸ¥çœ‹ç½‘ç«™æ³¨å†Œæ•°é‡ï¼Œè®¢å•æ•°é‡ï¼Œè´­ä¹°æ•°é‡ï¼Œé‡‘é¢ç­‰ã€‚

- å…¬äº¤å®æ—¶æ•°æ®

  å¯ä»¥éšæ—¶æ›´æ–°å…¬äº¤è½¦æ–¹ä½ï¼Œè®¡ç®—å¤šä¹…åˆ°è¾¾ç«™ç‰Œç­‰

- å®æ—¶æ–‡ç« åˆ†å€¼è®¡ç®—

- å¤´æ¡ç±»æ–‡ç« çš„åˆ†å€¼è®¡ç®—ï¼Œé€šè¿‡ç”¨æˆ·çš„è¡Œä¸ºå®æ—¶æ–‡ç« çš„åˆ†å€¼ï¼Œåˆ†å€¼è¶Šé«˜å°±è¶Šè¢«æ¨èã€‚

#### 2.3 æŠ€æœ¯æ–¹æ¡ˆé€‰å‹

- Hadoop

<div align="center">
    <img src="æˆªå›¾/çƒ­ç‚¹æ–‡ç« å®æ—¶è®¡ç®—/Hadoop.png" alt="Hadoop" />
</div>

- Apche Storm

  Storm æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼å®æ—¶å¤§æ•°æ®å¤„ç†ç³»ç»Ÿï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬æ–¹ä¾¿åœ°å¤„ç†æµ·é‡æ•°æ®ï¼Œå…·æœ‰é«˜å¯é ã€é«˜å®¹é”™ã€é«˜æ‰©å±•çš„ç‰¹ç‚¹ã€‚æ˜¯æµå¼æ¡†æ¶ï¼Œæœ‰å¾ˆé«˜çš„æ•°æ®ååèƒ½åŠ›ã€‚

- Kafka Stream 

  å¯ä»¥è½»æ¾åœ°å°†å…¶åµŒå…¥ä»»ä½•Javaåº”ç”¨ç¨‹åºä¸­ï¼Œå¹¶ä¸ç”¨æˆ·ä¸ºå…¶æµåº”ç”¨ç¨‹åºæ‰€æ‹¥æœ‰çš„ä»»ä½•ç°æœ‰æ‰“åŒ…ï¼Œéƒ¨ç½²å’Œæ“ä½œå·¥å…·é›†æˆã€‚

### 3. Kafka Stream 

#### 3.1 æ¦‚è¿°

Kafka Streamæ˜¯Apache Kafkaä»0.10ç‰ˆæœ¬å¼•å…¥çš„ä¸€ä¸ªæ–°Featureã€‚å®ƒæ˜¯æä¾›äº†å¯¹å­˜å‚¨äºKafkaå†…çš„æ•°æ®è¿›è¡Œæµå¼å¤„ç†å’Œåˆ†æçš„åŠŸèƒ½ã€‚

Kafka Streamçš„ç‰¹ç‚¹å¦‚ä¸‹ï¼š

- Kafka Streamæä¾›äº†ä¸€ä¸ªéå¸¸ç®€å•è€Œè½»é‡çš„Libraryï¼Œå®ƒå¯ä»¥éå¸¸æ–¹ä¾¿åœ°åµŒå…¥ä»»æ„Javaåº”ç”¨ä¸­ï¼Œä¹Ÿå¯ä»¥ä»»æ„æ–¹å¼æ‰“åŒ…å’Œéƒ¨ç½²
- é™¤äº†Kafkaå¤–ï¼Œæ— ä»»ä½•å¤–éƒ¨ä¾èµ–
- å……åˆ†åˆ©ç”¨Kafkaåˆ†åŒºæœºåˆ¶å®ç°æ°´å¹³æ‰©å±•å’Œé¡ºåºæ€§ä¿è¯
- é€šè¿‡å¯å®¹é”™çš„state storeå®ç°é«˜æ•ˆçš„çŠ¶æ€æ“ä½œï¼ˆå¦‚windowed joinå’Œaggregationï¼‰
- æ”¯æŒæ­£å¥½ä¸€æ¬¡å¤„ç†è¯­ä¹‰
- æä¾›è®°å½•çº§çš„å¤„ç†èƒ½åŠ›ï¼Œä»è€Œå®ç°æ¯«ç§’çº§çš„ä½å»¶è¿Ÿ
- æ”¯æŒåŸºäºäº‹ä»¶æ—¶é—´çš„çª—å£æ“ä½œï¼Œå¹¶ä¸”å¯å¤„ç†æ™šåˆ°çš„æ•°æ®ï¼ˆlate arrival of recordsï¼‰
- åŒæ—¶æä¾›åº•å±‚çš„å¤„ç†åŸè¯­Processorï¼ˆç±»ä¼¼äºStormçš„spoutå’Œboltï¼‰ï¼Œä»¥åŠé«˜å±‚æŠ½è±¡çš„DSLï¼ˆç±»ä¼¼äºSparkçš„map/group/reduceï¼‰

<div align="center">
    <img src="æˆªå›¾/çƒ­ç‚¹æ–‡ç« å®æ—¶è®¡ç®—/kafkaæ—¶é—´çª—å£.png" alt="kafkaæ—¶é—´çª—å£" />
</div>

#### 3.2 Kafka Streamsçš„å…³é”®æ¦‚å¿µ

- **æºå¤„ç†å™¨ï¼ˆSource Processorï¼‰**ï¼šæºå¤„ç†å™¨æ˜¯ä¸€ä¸ªæ²¡æœ‰ä»»ä½•ä¸Šæ¸¸å¤„ç†å™¨çš„ç‰¹æ®Šç±»å‹çš„æµå¤„ç†å™¨ã€‚å®ƒä»ä¸€ä¸ªæˆ–å¤šä¸ªkafkaä¸»é¢˜ç”Ÿæˆè¾“å…¥æµã€‚é€šè¿‡æ¶ˆè´¹è¿™äº›ä¸»é¢˜çš„æ¶ˆæ¯å¹¶å°†å®ƒä»¬è½¬å‘åˆ°ä¸‹æ¸¸å¤„ç†å™¨ã€‚
- **Sinkå¤„ç†å™¨**ï¼šsinkå¤„ç†å™¨æ˜¯ä¸€ä¸ªæ²¡æœ‰ä¸‹æ¸¸æµå¤„ç†å™¨çš„ç‰¹æ®Šç±»å‹çš„æµå¤„ç†å™¨ã€‚å®ƒæ¥æ”¶ä¸Šæ¸¸æµå¤„ç†å™¨çš„æ¶ˆæ¯å‘é€åˆ°ä¸€ä¸ªæŒ‡å®šçš„**Kafkaä¸»é¢˜**ã€‚

<div align="center">
    <img src="æˆªå›¾/çƒ­ç‚¹æ–‡ç« å®æ—¶è®¡ç®—/å…³é”®æ¦‚å¿µ.png" alt="å…³é”®æ¦‚å¿µ" />
</div>

#### 3.3 KStream

ï¼ˆ1ï¼‰æ•°æ®ç»“æ„ç±»ä¼¼äºmap,å¦‚ä¸‹å›¾ï¼Œkey-valueé”®å€¼å¯¹

<div align="center">
    <img src="æˆªå›¾/çƒ­ç‚¹æ–‡ç« å®æ—¶è®¡ç®—/KStreamæ•°æ®ç»“æ„.png" alt="KStreamæ•°æ®ç»“æ„" />
</div>

ï¼ˆ2ï¼‰KStream

<div align="center">
    <img src="æˆªå›¾/çƒ­ç‚¹æ–‡ç« å®æ—¶è®¡ç®—/KStreamæ–°å¢è®°å½•.png" alt="KStreamæ–°å¢è®°å½•" />
</div>

**KStream**æ•°æ®æµï¼ˆdata streamï¼‰ï¼Œå³æ˜¯ä¸€æ®µé¡ºåºçš„ï¼Œ**å¯ä»¥æ— é™é•¿**ï¼Œ**ä¸æ–­æ›´æ–°çš„æ•°æ®é›†**ã€‚
æ•°æ®æµä¸­æ¯”è¾ƒå¸¸è®°å½•çš„æ˜¯äº‹ä»¶ï¼Œè¿™äº›äº‹ä»¶å¯ä»¥æ˜¯**ä¸€æ¬¡é¼ æ ‡ç‚¹å‡»**ï¼ˆclickï¼‰ï¼Œ**ä¸€æ¬¡äº¤æ˜“**ï¼Œæˆ–æ˜¯**ä¼ æ„Ÿå™¨è®°å½•çš„ä½ç½®**æ•°æ®ã€‚

KStreamè´Ÿè´£æŠ½è±¡çš„ï¼Œå°±æ˜¯æ•°æ®æµã€‚ä¸Kafkaè‡ªèº«topicä¸­çš„æ•°æ®ä¸€æ ·ï¼Œ**ç±»ä¼¼æ—¥å¿—**ï¼Œæ¯ä¸€æ¬¡æ“ä½œéƒ½æ˜¯**å‘å…¶ä¸­æ’å…¥ï¼ˆinsertï¼‰æ–°æ•°æ®ã€‚**

ä¸ºäº†è¯´æ˜è¿™ä¸€ç‚¹ï¼Œè®©æˆ‘ä»¬æƒ³è±¡ä¸€ä¸‹ä»¥ä¸‹ä¸¤ä¸ªæ•°æ®è®°å½•æ­£åœ¨å‘é€åˆ°æµä¸­ï¼š

ï¼ˆâ€œ aliceâ€ï¼Œ1ï¼‰->ï¼ˆâ€œâ€ aliceâ€œï¼Œ3ï¼‰

å¦‚æœæ‚¨çš„æµå¤„ç†åº”ç”¨æ˜¯è¦æ€»ç»“æ¯ä¸ªç”¨æˆ·çš„ä»·å€¼ï¼Œå®ƒå°†è¿”å›`4`äº†`alice`ã€‚ä¸ºä»€ä¹ˆï¼Ÿå› ä¸ºç¬¬äºŒæ¡æ•°æ®è®°å½•å°†ä¸è¢«è§†ä¸ºå…ˆå‰è®°å½•çš„æ›´æ–°ã€‚è€Œæ˜¯ï¼ˆinsertï¼‰æ–°æ•°æ®

#### 3.4 Kafka Streamå…¥é—¨æ¡ˆä¾‹ç¼–å†™

##### 3.4.1 éœ€æ±‚åˆ†æï¼Œæ±‚å•è¯ä¸ªæ•°ï¼ˆword countï¼‰

<div align="center">
    <img src="æˆªå›¾/çƒ­ç‚¹æ–‡ç« å®æ—¶è®¡ç®—/æ±‚å•è¯ä¸ªæ•°.png" alt="æ±‚å•è¯ä¸ªæ•°" />
</div>

##### 3.4.2 å¼•å…¥ä¾èµ–

åœ¨ä¹‹å‰çš„kafka-demoå·¥ç¨‹çš„pomæ–‡ä»¶ä¸­å¼•å…¥

```xml
<dependency>
    <groupId>org.apache.kafka</groupId>
    <artifactId>kafka-streams</artifactId>
    <exclusions>
        <exclusion>
            <artifactId>connect-json</artifactId>
            <groupId>org.apache.kafka</groupId>
        </exclusion>
        <exclusion>
            <groupId>org.apache.kafka</groupId>
            <artifactId>kafka-clients</artifactId>
        </exclusion>
    </exclusions>
</dependency>
```

##### 3.4.3 åˆ›å»ºåŸç”Ÿçš„kafka stareamå…¥é—¨æ¡ˆä¾‹

```java
/**
 * æµå¼å¤„ç†
 */
public class KafkaStreamQuickStart {

    public static void main(String[] args) {

        //kafkaçš„é…ç½®ä¿¡å¿ƒ
        Properties prop = new Properties();
        prop.put(StreamsConfig.BOOTSTRAP_SERVERS_CONFIG,"192.168.200.130:9092");
        prop.put(StreamsConfig.DEFAULT_KEY_SERDE_CLASS_CONFIG, Serdes.String().getClass());
        prop.put(StreamsConfig.DEFAULT_VALUE_SERDE_CLASS_CONFIG, Serdes.String().getClass());
        prop.put(StreamsConfig.APPLICATION_ID_CONFIG,"streams-quickstart");

        //stream æ„å»ºå™¨
        StreamsBuilder streamsBuilder = new StreamsBuilder();

        //æµå¼è®¡ç®—
        streamProcessor(streamsBuilder);


        //åˆ›å»ºkafkaStreamå¯¹è±¡
        KafkaStreams kafkaStreams = new KafkaStreams(streamsBuilder.build(),prop);
        //å¼€å¯æµå¼è®¡ç®—
        kafkaStreams.start();
    }

    /**
     * æµå¼è®¡ç®—
     * æ¶ˆæ¯çš„å†…å®¹ï¼šhello kafka  hello itcast
     * @param streamsBuilder
     */
    private static void streamProcessor(StreamsBuilder streamsBuilder) {
        //åˆ›å»ºkstreamå¯¹è±¡ï¼ŒåŒæ—¶æŒ‡å®šä»é‚£ä¸ªtopicä¸­æ¥æ”¶æ¶ˆæ¯
        KStream<String, String> stream = streamsBuilder.stream("itcast-topic-input");
        /**
         * å¤„ç†æ¶ˆæ¯çš„value
         */
        //flatMapValues: ("a", ["x", "y", "z"])->[('a', 'x'), ('a', 'y'), ('a', 'z')]
        stream.flatMapValues(new ValueMapper<String, Iterable<String>>() {
            @Override
            public Iterable<String> apply(String value) {
                return Arrays.asList(value.split(" "));
            }
        })
                //æŒ‰ç…§valueè¿›è¡Œåˆ†ç»„
                .groupBy((key,value)->value)
                //æ—¶é—´çª—å£
                .windowedBy(TimeWindows.of(Duration.ofSeconds(10)))
                //ç»Ÿè®¡å•è¯çš„ä¸ªæ•°ï¼Œ(key,value)->(value,count(value))
                .count()
                //è½¬æ¢ä¸ºkStream
                .toStream()
                .map((key,value)->{
                    System.out.println("key:"+key+",vlaue:"+value);
                    return new KeyValue<>(key.key().toString(),value.toString());
                })
                //å‘é€æ¶ˆæ¯
                .to("itcast-topic-out");
    }
}
```

(4)æµ‹è¯•å‡†å¤‡

- ä½¿ç”¨ç”Ÿäº§è€…åœ¨topicä¸ºï¼šitcast_topic_inputä¸­å‘é€å¤šæ¡æ¶ˆæ¯

- ä½¿ç”¨æ¶ˆè´¹è€…æ¥æ”¶topicä¸ºï¼šitcast_topic_out

ç»“æœï¼š

- é€šè¿‡æµå¼è®¡ç®—ï¼Œä¼šæŠŠç”Ÿäº§è€…çš„å¤šæ¡æ¶ˆæ¯æ±‡æ€»æˆä¸€æ¡å‘é€åˆ°æ¶ˆè´¹è€…ä¸­è¾“å‡º

#### 3.5 SpringBooté›†æˆKafka Stream

##### 3.5.1 è‡ªå®šé…ç½®å‚æ•°

```java
/**
 * é€šè¿‡é‡æ–°æ³¨å†ŒKafkaStreamsConfigurationå¯¹è±¡ï¼Œè®¾ç½®è‡ªå®šé…ç½®å‚æ•°
 */
@Setter
@Getter
@Configuration
@EnableKafkaStreams  
@ConfigurationProperties(prefix="kafka")
public class KafkaStreamConfig {
    private static final int MAX_MESSAGE_SIZE = 16* 1024 * 1024;
    private String hosts;
    private String group;
    @Bean(name = KafkaStreamsDefaultConfiguration.DEFAULT_STREAMS_CONFIG_BEAN_NAME)
    public KafkaStreamsConfiguration defaultKafkaStreamsConfig() {
        Map<String, Object> props = new HashMap<>();
        props.put(StreamsConfig.BOOTSTRAP_SERVERS_CONFIG, hosts);
        props.put(StreamsConfig.APPLICATION_ID_CONFIG, this.getGroup()+"_stream_aid");
        props.put(StreamsConfig.CLIENT_ID_CONFIG, this.getGroup()+"_stream_cid");
        props.put(StreamsConfig.RETRIES_CONFIG, 10);
        props.put(StreamsConfig.DEFAULT_KEY_SERDE_CLASS_CONFIG, Serdes.String().getClass());
        props.put(StreamsConfig.DEFAULT_VALUE_SERDE_CLASS_CONFIG, Serdes.String().getClass());
        return new KafkaStreamsConfiguration(props);
    }
}
```

ä¿®æ”¹application.ymlæ–‡ä»¶ï¼Œåœ¨æœ€ä¸‹æ–¹æ·»åŠ è‡ªå®šä¹‰é…ç½®

```yaml
kafka:
  hosts: 192.168.200.130:9092
  group: ${spring.application.name}
```

(2)æ–°å¢é…ç½®ç±»ï¼Œåˆ›å»ºKStreamå¯¹è±¡ï¼Œè¿›è¡Œèšåˆ

```java
//æ ‡è®°è¿™ä¸ªç±»æ˜¯ä¸€ä¸ªSpringé…ç½®ç±»ï¼ŒSpringå®¹å™¨ä¼šåœ¨è¿™ä¸ªç±»ä¸­æŸ¥æ‰¾å¸¦æœ‰@Beanæ³¨è§£çš„æ–¹æ³•ï¼Œå¹¶å°†å®ƒä»¬æ³¨å†Œä¸ºSpringåº”ç”¨ä¸Šä¸‹æ–‡ä¸­çš„bean
@Configuration
@Slf4j
public class KafkaStreamHelloListener {

    @Bean
    public KStream<String,String> kStream(StreamsBuilder streamsBuilder){
        //åˆ›å»ºkstreamå¯¹è±¡ï¼ŒåŒæ—¶æŒ‡å®šä»é‚£ä¸ªtopicä¸­æ¥æ”¶æ¶ˆæ¯
        KStream<String, String> stream = streamsBuilder.stream("itcast-topic-input");
        stream.flatMapValues(new ValueMapper<String, Iterable<String>>() {
            @Override
            public Iterable<String> apply(String value) {
                return Arrays.asList(value.split(" "));
            }
        })
                //æ ¹æ®valueè¿›è¡Œèšåˆåˆ†ç»„
                .groupBy((key,value)->value)
                //èšåˆè®¡ç®—æ—¶é—´é—´éš”
                .windowedBy(TimeWindows.of(Duration.ofSeconds(10)))
                //æ±‚å•è¯çš„ä¸ªæ•°
                .count()
                .toStream()
                //å¤„ç†åçš„ç»“æœè½¬æ¢ä¸ºstringå­—ç¬¦ä¸²
                .map((key,value)->{
                    System.out.println("key:"+key+",value:"+value);
                    return new KeyValue<>(key.key().toString(),value.toString());
                })
                //å‘é€æ¶ˆæ¯
                .to("itcast-topic-out");
        return stream;
    }
}
```

æµ‹è¯•ï¼š

â€‹	å¯åŠ¨å¾®æœåŠ¡ï¼Œæ­£å¸¸å‘é€æ¶ˆæ¯ï¼Œå¯ä»¥æ­£å¸¸æ¥æ”¶åˆ°æ¶ˆæ¯

### 4. appç«¯çƒ­ç‚¹æ–‡ç« è®¡ç®—

#### 4.1 æ€è·¯è¯´æ˜

<div align="center">
    <img src="æˆªå›¾/çƒ­ç‚¹æ–‡ç« å®æ—¶è®¡ç®—/appç«¯çƒ­ç‚¹æ–‡ç« è®¡ç®—.png" alt="appç«¯çƒ­ç‚¹æ–‡ç« è®¡ç®—" />
</div>

#### 4.2 åŠŸèƒ½å®ç°

##### 4.2.1 ç”¨æˆ·è¡Œä¸ºï¼ˆé˜…è¯»é‡ï¼Œè¯„è®ºï¼Œç‚¹èµï¼Œæ”¶è—ï¼‰å‘é€æ¶ˆæ¯ï¼Œä»¥é˜…è¯»å’Œç‚¹èµä¸ºä¾‹

â‘ åœ¨heima-leadnews-behaviorå¾®æœåŠ¡ä¸­é›†æˆkafkaç”Ÿäº§è€…é…ç½®

ä¿®æ”¹nacosï¼Œæ–°å¢å†…å®¹

```yaml
spring:
  application:
    name: leadnews-behavior
  kafka:
    bootstrap-servers: 192.168.200.130:9092
    producer:
      retries: 10
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: org.apache.kafka.common.serialization.StringSerializer
```

â‘¡ä¿®æ”¹ApLikesBehaviorServiceImplæ–°å¢å‘é€æ¶ˆæ¯

å®šä¹‰æ¶ˆæ¯å‘é€å°è£…ç±»ï¼šUpdateArticleMess

```java
@Data
public class UpdateArticleMess {

    /**
     * ä¿®æ”¹æ–‡ç« çš„å­—æ®µç±»å‹
      */
    private UpdateArticleType type;
    /**
     * æ–‡ç« ID
     */
    private Long articleId;
    /**
     * ä¿®æ”¹æ•°æ®çš„å¢é‡ï¼Œå¯ä¸ºæ­£è´Ÿ
     */
    private Integer add;

    public enum UpdateArticleType{
        COLLECTION,COMMENT,LIKES,VIEWS;
    }
}
```

topicå¸¸é‡ç±»ï¼š

```java
public class HotArticleConstants {

    public static final String HOT_ARTICLE_SCORE_TOPIC="hot.article.score.topic";
   
}
```

å®Œæ•´ä»£ç å¦‚ä¸‹ï¼š

```java
@Service
@Transactional
@Slf4j
public class ApLikesBehaviorServiceImpl implements ApLikesBehaviorService {

    @Autowired
    private CacheService cacheService;

    @Autowired
    private KafkaTemplate<String,String> kafkaTemplate;

    @Override
    public ResponseResult like(LikesBehaviorDto dto) {

        //1.æ£€æŸ¥å‚æ•°
        if (dto == null || dto.getArticleId() == null || checkParam(dto)) {
            return ResponseResult.errorResult(AppHttpCodeEnum.PARAM_INVALID);
        }

        //2.æ˜¯å¦ç™»å½•
        ApUser user = AppThreadLocalUtil.getUser();
        if (user == null) {
            return ResponseResult.errorResult(AppHttpCodeEnum.NEED_LOGIN);
        }

        UpdateArticleMess mess = new UpdateArticleMess();
        mess.setArticleId(dto.getArticleId());
        mess.setType(UpdateArticleMess.UpdateArticleType.LIKES);

        //3.ç‚¹èµ  ä¿å­˜æ•°æ®
        if (dto.getOperation() == 0) {
            Object obj = cacheService.hGet(BehaviorConstants.LIKE_BEHAVIOR + dto.getArticleId().toString(), user.getId().toString());
            if (obj != null) {
                return ResponseResult.errorResult(AppHttpCodeEnum.PARAM_INVALID, "å·²ç‚¹èµ");
            }
            // ä¿å­˜å½“å‰key
            log.info("ä¿å­˜å½“å‰key:{} ,{}, {}", dto.getArticleId(), user.getId(), dto);
            cacheService.hPut(BehaviorConstants.LIKE_BEHAVIOR + dto.getArticleId().toString(), user.getId().toString(), JSON.toJSONString(dto));
            mess.setAdd(1);
        } else {
            // åˆ é™¤å½“å‰key
            log.info("åˆ é™¤å½“å‰key:{}, {}", dto.getArticleId(), user.getId());
            cacheService.hDelete(BehaviorConstants.LIKE_BEHAVIOR + dto.getArticleId().toString(), user.getId().toString());
            mess.setAdd(-1);
        }

        //å‘é€æ¶ˆæ¯ï¼Œæ•°æ®èšåˆ
        kafkaTemplate.send(HotArticleConstants.HOT_ARTICLE_SCORE_TOPIC,JSON.toJSONString(mess));

        return ResponseResult.okResult(AppHttpCodeEnum.SUCCESS);
    }

    /**
     * æ£€æŸ¥å‚æ•°
     * @return
     */
    private boolean checkParam(LikesBehaviorDto dto) {
        if (dto.getType() > 2 || dto.getType() < 0 || dto.getOperation() > 1 || dto.getOperation() < 0) {
            return true;
        }
        return false;
    }
}
```

â‘¢ä¿®æ”¹é˜…è¯»è¡Œä¸ºçš„ç±»ApReadBehaviorServiceImplå‘é€æ¶ˆæ¯

å®Œæ•´ä»£ç ï¼š

```java
@Service
@Transactional
@Slf4j
public class ApReadBehaviorServiceImpl implements ApReadBehaviorService {

    @Autowired
    private CacheService cacheService;

    @Autowired
    private KafkaTemplate<String,String> kafkaTemplate;

    @Override
    public ResponseResult readBehavior(ReadBehaviorDto dto) {
        //1.æ£€æŸ¥å‚æ•°
        if (dto == null || dto.getArticleId() == null) {
            return ResponseResult.errorResult(AppHttpCodeEnum.PARAM_INVALID);
        }

        //2.æ˜¯å¦ç™»å½•
        ApUser user = AppThreadLocalUtil.getUser();
        if (user == null) {
            return ResponseResult.errorResult(AppHttpCodeEnum.NEED_LOGIN);
        }
        //æ›´æ–°é˜…è¯»æ¬¡æ•°
        String readBehaviorJson = (String) cacheService.hGet(BehaviorConstants.READ_BEHAVIOR + dto.getArticleId().toString(), user.getId().toString());
        if (StringUtils.isNotBlank(readBehaviorJson)) {
            ReadBehaviorDto readBehaviorDto = JSON.parseObject(readBehaviorJson, ReadBehaviorDto.class);
            dto.setCount((short) (readBehaviorDto.getCount() + dto.getCount()));
        }
        // ä¿å­˜å½“å‰key
        log.info("ä¿å­˜å½“å‰key:{} {} {}", dto.getArticleId(), user.getId(), dto);
        cacheService.hPut(BehaviorConstants.READ_BEHAVIOR + dto.getArticleId().toString(), user.getId().toString(), JSON.toJSONString(dto));

        //å‘é€æ¶ˆæ¯ï¼Œæ•°æ®èšåˆ
        UpdateArticleMess mess = new UpdateArticleMess();
        mess.setArticleId(dto.getArticleId());
        mess.setType(UpdateArticleMess.UpdateArticleType.VIEWS);
        mess.setAdd(1);
        kafkaTemplate.send(HotArticleConstants.HOT_ARTICLE_SCORE_TOPIC,JSON.toJSONString(mess));
        
        return ResponseResult.okResult(AppHttpCodeEnum.SUCCESS);
    }
}
```

##### 4.2.2 ä½¿ç”¨kafkaStreamå®æ—¶æ¥æ”¶æ¶ˆæ¯ï¼Œèšåˆå†…å®¹

â‘ åœ¨leadnews-articleå¾®æœåŠ¡ä¸­é›†æˆkafkaStream (å‚è€ƒkafka-demo)

â‘¡å®šä¹‰å®ä½“ç±»ï¼Œç”¨äºèšåˆä¹‹åçš„åˆ†å€¼å°è£…

```java
@Data
public class ArticleVisitStreamMess {
    /**
     * æ–‡ç« id
     */
    private Long articleId;
    /**
     * é˜…è¯»
     */
    private int view;
    /**
     * æ”¶è—
     */
    private int collect;
    /**
     * è¯„è®º
     */
    private int comment;
    /**
     * ç‚¹èµ
     */
    private int like;
}
```

ä¿®æ”¹å¸¸é‡ç±»ï¼šå¢åŠ å¸¸é‡

```java
public class HotArticleConstants {

    public static final String HOT_ARTICLE_SCORE_TOPIC="hot.article.score.topic";
    public static final String HOT_ARTICLE_INCR_HANDLE_TOPIC="hot.article.incr.handle.topic";
}
```

â‘¢ å®šä¹‰stream,æ¥æ”¶æ¶ˆæ¯å¹¶èšåˆ

```java
@Configuration
@Slf4j
public class HotArticleStreamHandler {

    @Bean
    public KStream<String,String> kStream(StreamsBuilder streamsBuilder){
        //æ¥æ”¶æ¶ˆæ¯
        KStream<String,String> stream = streamsBuilder.stream(HotArticleConstants.HOT_ARTICLE_SCORE_TOPIC);
        //èšåˆæµå¼å¤„ç†
        stream.map((key,value)->{
            UpdateArticleMess mess = JSON.parseObject(value, UpdateArticleMess.class);
            //é‡ç½®æ¶ˆæ¯çš„key:1234343434   å’Œ  value: likes:1
            return new KeyValue<>(mess.getArticleId().toString(),mess.getType().name()+":"+mess.getAdd());
        })
                //æŒ‰ç…§æ–‡ç« idè¿›è¡Œåˆ†ç»„
                .groupBy((key,value)->key)
                //æ—¶é—´çª—å£
                .windowedBy(TimeWindows.of(Duration.ofSeconds(10)))
                /**
                 * è‡ªè¡Œçš„å®Œæˆèšåˆçš„è®¡ç®—
                 */
                .aggregate(new Initializer<String>() {
                    /**
                     * åˆå§‹æ–¹æ³•ï¼Œè¿”å›å€¼æ˜¯æ¶ˆæ¯çš„value
                     * è¿™ä¸ªåˆå§‹å€¼è¡¨ç¤ºäº†èšåˆæ“ä½œçš„èµ·ç‚¹ï¼Œå³åœ¨æ²¡æœ‰ä»»ä½•æ•°æ®æµå…¥æ—¶ï¼Œèšåˆç»“æœåº”è¯¥æ˜¯ä»€ä¹ˆæ ·å­çš„
                     * è¯¥æ–¹æ³•åªä¼šåœ¨ä¸€å¼€å§‹è°ƒç”¨ä¸€æ¬¡
                     * @return
                     */
                    @Override
                    public String apply() {
                        return "COLLECTION:0,COMMENT:0,LIKES:0,VIEWS:0";
                    }
                    /**
                     * çœŸæ­£çš„èšåˆæ“ä½œï¼Œè¿”å›å€¼æ˜¯æ¶ˆæ¯çš„value
                     * <String,String,String>åˆ†åˆ«è¡¨ç¤ºé”®ï¼ˆKeyï¼‰ã€å€¼ï¼ˆValueï¼‰å’Œèšåˆç»“æœï¼ˆAggregated Valueï¼‰
                     * èšåˆå™¨ä¼šæ ¹æ®è¾“å…¥çš„æ•°æ®å€¼å’Œå½“å‰çš„èšåˆç»“æœæ¥è®¡ç®—å‡ºä¸€ä¸ªæ–°çš„èšåˆç»“æœã€‚
                     * ä¹Ÿå°±æ˜¯èšåˆç»“æœåˆä½œä¸ºä¸‹ä¸€è½®çš„ç¬¬ä¸‰ä¸ªStringå‚æ•°
                     */
                }, new Aggregator<String, String, String>() {
                    @Override
                    public String apply(String key, String value, String aggValue) {
                        if(StringUtils.isBlank(value)){
                            return aggValue;
                        }
                        String[] aggAry = aggValue.split(",");
                        int col = 0,com=0,lik=0,vie=0;
                        for (String agg : aggAry) {
                            String[] split = agg.split(":");
                            /**
                             * è·å¾—ä¸Šä¸€è½®èšåˆçš„ç»“æœï¼Œä¹Ÿæ˜¯æ—¶é—´çª—å£å†…è®¡ç®—ä¹‹åçš„å€¼
                             */
                            switch (UpdateArticleMess.UpdateArticleType.valueOf(split[0])){
                                case COLLECTION:
                                    col = Integer.parseInt(split[1]);
                                    break;
                                case COMMENT:
                                    com = Integer.parseInt(split[1]);
                                    break;
                                case LIKES:
                                    lik = Integer.parseInt(split[1]);
                                    break;
                                case VIEWS:
                                    vie = Integer.parseInt(split[1]);
                                    break;
                            }
                        }
                        /**
                         * ç´¯åŠ æ“ä½œ
                         */
                        String[] valAry = value.split(":");
                        switch (UpdateArticleMess.UpdateArticleType.valueOf(valAry[0])){
                            case COLLECTION:
                                col += Integer.parseInt(valAry[1]);
                                break;
                            case COMMENT:
                                com += Integer.parseInt(valAry[1]);
                                break;
                            case LIKES:
                                lik += Integer.parseInt(valAry[1]);
                                break;
                            case VIEWS:
                                vie += Integer.parseInt(valAry[1]);
                                break;
                        }

                        String formatStr = String.format("COLLECTION:%d,COMMENT:%d,LIKES:%d,VIEWS:%d", col, com, lik, vie);
                        System.out.println("æ–‡ç« çš„id:"+key);
                        System.out.println("å½“å‰æ—¶é—´çª—å£å†…çš„æ¶ˆæ¯å¤„ç†ç»“æœï¼š"+formatStr);
                        return formatStr;
                    }
                }, Materialized.as("hot-atricle-stream-count-001"))//å°†æµå¤„ç†çš„ç»“æœç‰©åŒ–ï¼ˆå³ä¿å­˜ä¸ºçŠ¶æ€ï¼Œå¯ä»¥æŒä¹…åŒ–ä¹Ÿå¯ä»¥ä»…åœ¨å†…å­˜ä¸­ï¼‰
                .toStream()
                .map((key,value)->{
                    return new KeyValue<>(key.key().toString(),formatObj(key.key().toString(),value));
                })
                //å‘é€æ¶ˆæ¯
                .to(HotArticleConstants.HOT_ARTICLE_INCR_HANDLE_TOPIC);

        return stream;
    }

    /**
     * æ ¼å¼åŒ–æ¶ˆæ¯çš„valueæ•°æ®
     * @param articleId
     * @param value
     * @return
     */
    public String formatObj(String articleId,String value){
        ArticleVisitStreamMess mess = new ArticleVisitStreamMess();
        mess.setArticleId(Long.valueOf(articleId));
        //COLLECTION:0,COMMENT:0,LIKES:0,VIEWS:0
        String[] valAry = value.split(",");
        for (String val : valAry) {
            String[] split = val.split(":");
            switch (UpdateArticleMess.UpdateArticleType.valueOf(split[0])){
                case COLLECTION:
                    mess.setCollect(Integer.parseInt(split[1]));
                    break;
                case COMMENT:
                    mess.setComment(Integer.parseInt(split[1]));
                    break;
                case LIKES:
                    mess.setLike(Integer.parseInt(split[1]));
                    break;
                case VIEWS:
                    mess.setView(Integer.parseInt(split[1]));
                    break;
            }
        }
        log.info("èšåˆæ¶ˆæ¯å¤„ç†ä¹‹åçš„ç»“æœä¸º:{}",JSON.toJSONString(mess));
        return JSON.toJSONString(mess);
    }
}
```

##### 4.2.3 é‡æ–°è®¡ç®—æ–‡ç« çš„åˆ†å€¼ï¼Œæ›´æ–°åˆ°æ•°æ®åº“å’Œç¼“å­˜ä¸­

â‘ åœ¨ApArticleServiceæ·»åŠ æ–¹æ³•ï¼Œç”¨äºæ›´æ–°æ•°æ®åº“ä¸­çš„æ–‡ç« åˆ†å€¼

```java
/**
     * æ›´æ–°æ–‡ç« çš„åˆ†å€¼  åŒæ—¶æ›´æ–°ç¼“å­˜ä¸­çš„çƒ­ç‚¹æ–‡ç« æ•°æ®
     * @param mess
     */
public void updateScore(ArticleVisitStreamMess mess);
```

å®ç°ç±»æ–¹æ³•

```java
/**
     * æ›´æ–°æ–‡ç« çš„åˆ†å€¼  åŒæ—¶æ›´æ–°ç¼“å­˜ä¸­çš„çƒ­ç‚¹æ–‡ç« æ•°æ®
     * @param mess
     */
@Override
public void updateScore(ArticleVisitStreamMess mess) {
    //1.æ›´æ–°æ–‡ç« çš„é˜…è¯»ã€ç‚¹èµã€æ”¶è—ã€è¯„è®ºçš„æ•°é‡
    ApArticle apArticle = updateArticle(mess);
    //2.è®¡ç®—æ–‡ç« çš„åˆ†å€¼
    Integer score = computeScore(apArticle);
    score = score * 3;

    //3.æ›¿æ¢å½“å‰æ–‡ç« å¯¹åº”é¢‘é“çš„çƒ­ç‚¹æ•°æ®
    replaceDataToRedis(apArticle, score, ArticleConstants.HOT_ARTICLE_FIRST_PAGE + apArticle.getChannelId());

    //4.æ›¿æ¢æ¨èå¯¹åº”çš„çƒ­ç‚¹æ•°æ®
    replaceDataToRedis(apArticle, score, ArticleConstants.HOT_ARTICLE_FIRST_PAGE + ArticleConstants.DEFAULT_TAG);

}

/**
     * æ›¿æ¢æ•°æ®å¹¶ä¸”å­˜å…¥åˆ°redis
     * @param apArticle
     * @param score
     * @param s
     */
private void replaceDataToRedis(ApArticle apArticle, Integer score, String s) {
    String articleListStr = cacheService.get(s);
    if (StringUtils.isNotBlank(articleListStr)) {
        List<HotArticleVo> hotArticleVoList = JSON.parseArray(articleListStr, HotArticleVo.class);

        boolean flag = true;

        //å¦‚æœç¼“å­˜ä¸­å­˜åœ¨è¯¥æ–‡ç« ï¼Œåªæ›´æ–°åˆ†å€¼
        for (HotArticleVo hotArticleVo : hotArticleVoList) {
            if (hotArticleVo.getId().equals(apArticle.getId())) {
                hotArticleVo.setScore(score);
                flag = false;
                break;
            }
        }

        //å¦‚æœç¼“å­˜ä¸­ä¸å­˜åœ¨ï¼ŒæŸ¥è¯¢ç¼“å­˜ä¸­åˆ†å€¼æœ€å°çš„ä¸€æ¡æ•°æ®ï¼Œè¿›è¡Œåˆ†å€¼çš„æ¯”è¾ƒï¼Œå¦‚æœå½“å‰æ–‡ç« çš„åˆ†å€¼å¤§äºç¼“å­˜ä¸­çš„æ•°æ®ï¼Œå°±æ›¿æ¢
        if (flag) {
            if (hotArticleVoList.size() >= 30) {
                hotArticleVoList = hotArticleVoList.stream().sorted(Comparator.comparing(HotArticleVo::getScore).reversed()).collect(Collectors.toList());
                HotArticleVo lastHot = hotArticleVoList.get(hotArticleVoList.size() - 1);
                if (lastHot.getScore() < score) {
                    hotArticleVoList.remove(lastHot);
                    HotArticleVo hot = new HotArticleVo();
                    BeanUtils.copyProperties(apArticle, hot);
                    hot.setScore(score);
                    hotArticleVoList.add(hot);
                }


            } else {
                HotArticleVo hot = new HotArticleVo();
                BeanUtils.copyProperties(apArticle, hot);
                hot.setScore(score);
                hotArticleVoList.add(hot);
            }
        }
        //ç¼“å­˜åˆ°redis
        hotArticleVoList = hotArticleVoList.stream().sorted(Comparator.comparing(HotArticleVo::getScore).reversed()).collect(Collectors.toList());
        cacheService.set(s, JSON.toJSONString(hotArticleVoList));
    }
}

/**
     * æ›´æ–°æ–‡ç« è¡Œä¸ºæ•°é‡
     * @param mess
     */
private ApArticle updateArticle(ArticleVisitStreamMess mess) {
    ApArticle apArticle = getById(mess.getArticleId());
    //è¿™é‡Œæ˜¯get apArticleçš„ï¼Œä¹Ÿå°±æ˜¯getæ•°æ®åº“çš„ï¼Œå¦‚æœæ•°æ®åº“ä¸ºnullï¼Œå½“ç„¶è¦è®¾ç½®ä¸º0
    apArticle.setCollection(apArticle.getCollection()==null?0:apArticle.getCollection()+mess.getCollect());
    apArticle.setComment(apArticle.getComment()==null?0:apArticle.getComment()+mess.getComment());
    apArticle.setLikes(apArticle.getLikes()==null?0:apArticle.getLikes()+mess.getLike());
    apArticle.setViews(apArticle.getViews()==null?0:apArticle.getViews()+mess.getView());
    updateById(apArticle);
    return apArticle;
}

/**
     * è®¡ç®—æ–‡ç« çš„å…·ä½“åˆ†å€¼
     * @param apArticle
     * @return
     */
private Integer computeScore(ApArticle apArticle) {
    Integer score = 0;
    if(apArticle.getLikes() != null){
        score += apArticle.getLikes() * ArticleConstants.HOT_ARTICLE_LIKE_WEIGHT;
    }
    if(apArticle.getViews() != null){
        score += apArticle.getViews();
    }
    if(apArticle.getComment() != null){
        score += apArticle.getComment() * ArticleConstants.HOT_ARTICLE_COMMENT_WEIGHT;
    }
    if(apArticle.getCollection() != null){
        score += apArticle.getCollection() * ArticleConstants.HOT_ARTICLE_COLLECTION_WEIGHT;
    }

    return score;
}
```

â‘¡å®šä¹‰ç›‘å¬ï¼Œæ¥æ”¶èšåˆä¹‹åçš„æ•°æ®ï¼Œæ–‡ç« çš„åˆ†å€¼é‡æ–°è¿›è¡Œè®¡ç®—

```java
@Component
@Slf4j
public class ArticleIncrHandleListener {

    @Autowired
    private ApArticleService apArticleService;

    @KafkaListener(topics = HotArticleConstants.HOT_ARTICLE_INCR_HANDLE_TOPIC)
    public void onMessage(String mess){
        if(StringUtils.isNotBlank(mess)){
            ArticleVisitStreamMess articleVisitStreamMess = JSON.parseObject(mess, ArticleVisitStreamMess.class);
            apArticleService.updateScore(articleVisitStreamMess);
        }
    }
}
```

## åå…­ã€é¡¹ç›®éƒ¨ç½²_æŒç»­é›†æˆ

### 1.æ¦‚å¿µ

#### 1.1 ä»€ä¹ˆæ˜¯æŒç»­é›†æˆ

æŒç»­é›†æˆï¼ˆ Continuous integration ï¼Œ ç®€ç§° CI ï¼‰æŒ‡çš„æ˜¯ï¼Œé¢‘ç¹åœ°ï¼ˆä¸€å¤©å¤šæ¬¡ï¼‰å°†ä»£ç é›†æˆåˆ°ä¸»å¹²

<div align="center">
    <img src="æˆªå›¾/é¡¹ç›®éƒ¨ç½²_æŒç»­é›†æˆ/æ¦‚å¿µ.png" alt="æ¦‚å¿µ" />
</div>

**æŒç»­é›†æˆçš„ç»„æˆè¦ç´ **

ä¸€ä¸ªè‡ªåŠ¨æ„å»ºè¿‡ç¨‹ï¼Œ ä»æ£€å‡ºä»£ç ã€ ç¼–è¯‘æ„å»ºã€ è¿è¡Œæµ‹è¯•ã€ ç»“æœè®°å½•ã€ æµ‹è¯•ç»Ÿè®¡ç­‰éƒ½æ˜¯è‡ªåŠ¨å®Œæˆçš„ï¼Œ æ— éœ€äººå·¥å¹²é¢„ã€‚

ä¸€ä¸ªä»£ç å­˜å‚¨åº“ï¼Œå³éœ€è¦ç‰ˆæœ¬æ§åˆ¶è½¯ä»¶æ¥ä¿éšœä»£ç çš„å¯ç»´æŠ¤æ€§ï¼ŒåŒæ—¶ä½œä¸ºæ„å»ºè¿‡ç¨‹çš„ç´ æåº“ï¼Œä¸€èˆ¬ä½¿ç”¨SVNæˆ–Gitã€‚

ä¸€ä¸ªæŒç»­é›†æˆæœåŠ¡å™¨ï¼Œ Jenkins å°±æ˜¯ä¸€ä¸ªé…ç½®ç®€å•å’Œä½¿ç”¨æ–¹ä¾¿çš„æŒç»­é›†æˆæœåŠ¡å™¨ã€‚

#### 1.2 æŒç»­é›†æˆçš„å¥½å¤„

1ã€é™ä½é£é™©ï¼Œç”±äºæŒç»­é›†æˆä¸æ–­å»æ„å»ºï¼Œç¼–è¯‘å’Œæµ‹è¯•ï¼Œå¯ä»¥å¾ˆæ—©æœŸå‘ç°é—®é¢˜ï¼Œæ‰€ä»¥ä¿®å¤çš„ä»£ä»·å°±å°‘ï¼›
2ã€å¯¹ç³»ç»Ÿå¥åº·æŒç»­æ£€æŸ¥ï¼Œå‡å°‘å‘å¸ƒé£é™©å¸¦æ¥çš„é—®é¢˜ï¼›
3ã€å‡å°‘é‡å¤æ€§å·¥ä½œï¼›
4ã€æŒç»­éƒ¨ç½²ï¼Œæä¾›å¯éƒ¨ç½²å•å…ƒåŒ…ï¼›
5ã€æŒç»­äº¤ä»˜å¯ä¾›ä½¿ç”¨çš„ç‰ˆæœ¬ï¼›
6ã€å¢å¼ºå›¢é˜Ÿä¿¡å¿ƒï¼›

### 2. è½¯ä»¶å¼€å‘æ¨¡å¼

<div align="center">
    <img src="æˆªå›¾/é¡¹ç›®éƒ¨ç½²_æŒç»­é›†æˆ/è½¯ä»¶å¼€å‘æ¨¡å¼.png" alt="è½¯ä»¶å¼€å‘æ¨¡å¼" />
</div>

#### 2.1 è½¯ä»¶å¼€å‘ç”Ÿå‘½å‘¨æœŸ

è½¯ä»¶å¼€å‘ç”Ÿå‘½å‘¨æœŸåˆå«åšSDLCï¼ˆSoftware Development Life Cycleï¼‰ï¼Œå®ƒæ˜¯é›†åˆäº†è®¡åˆ’ã€å¼€å‘ã€æµ‹è¯•å’Œéƒ¨ç½²è¿‡ç¨‹çš„é›†åˆã€‚å¦‚ä¸‹å›¾æ‰€ç¤º ï¼š

<div align="center">
    <img src="æˆªå›¾/é¡¹ç›®éƒ¨ç½²_æŒç»­é›†æˆ/è½¯ä»¶å¼€å‘ç”Ÿå‘½å‘¨æœŸ.png" alt="è½¯ä»¶å¼€å‘ç”Ÿå‘½å‘¨æœŸ" />
</div>

- éœ€æ±‚åˆ†æ

  è¿™æ˜¯ç”Ÿå‘½å‘¨æœŸçš„ç¬¬ä¸€é˜¶æ®µï¼Œæ ¹æ®é¡¹ç›®éœ€æ±‚ï¼Œå›¢é˜Ÿæ‰§è¡Œä¸€ä¸ªå¯è¡Œæ€§è®¡åˆ’çš„åˆ†æã€‚é¡¹ç›®éœ€æ±‚å¯èƒ½æ˜¯å…¬å¸å†…éƒ¨æˆ–è€…å®¢æˆ·æå‡ºçš„ã€‚è¿™é˜¶æ®µä¸»è¦æ˜¯å¯¹ä¿¡æ¯çš„æ”¶é›†ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯å¯¹ç°æœ‰é¡¹ç›®çš„æ”¹å–„å’Œé‡æ–°åšä¸€ä¸ªæ–°çš„é¡¹ç›®ã€‚è¿˜è¦åˆ†æé¡¹ç›®çš„é¢„ç®—å¤šé•¿ï¼Œå¯ä»¥ä»å“ªæ–¹é¢å—ç›ŠåŠå¸ƒå±€ï¼Œè¿™ä¹Ÿæ˜¯é¡¹ç›®åˆ›å»ºçš„ç›®æ ‡ã€‚

- è®¾è®¡

  ç¬¬äºŒé˜¶æ®µå°±æ˜¯è®¾è®¡é˜¶æ®µï¼Œç³»ç»Ÿæ¶æ„å’Œæ»¡æ„çŠ¶æ€ï¼ˆå°±æ˜¯è¦åšæˆä»€ä¹ˆæ ·å­ï¼Œæœ‰ä»€ä¹ˆåŠŸèƒ½ï¼‰ï¼Œå’Œåˆ›å»ºä¸€ä¸ªé¡¹ç›®è®¡åˆ’ã€‚è®¡åˆ’å¯ä»¥ä½¿ç”¨å›¾è¡¨ï¼Œå¸ƒå±€è®¾è®¡æˆ–è€…æ–‡å­—çš„æ–¹å¼å‘ˆç°ã€‚

- å®ç°

  ç¬¬ä¸‰é˜¶æ®µå°±æ˜¯å®ç°é˜¶æ®µï¼Œé¡¹ç›®ç»ç†åˆ›å»ºå’Œåˆ†é…å·¥ä½œç»™å¼€è€…ï¼Œå¼€å‘è€…æ ¹æ®ä»»åŠ¡å’Œåœ¨è®¾è®¡é˜¶æ®µå®šä¹‰çš„ç›®æ ‡è¿›è¡Œå¼€å‘ä»£ç ã€‚ä¾æ®é¡¹ç›®çš„å¤§å°å’Œå¤æ‚ç¨‹åº¦ï¼Œå¯ä»¥éœ€è¦æ•°æœˆæˆ–æ›´é•¿æ—¶é—´æ‰èƒ½å®Œæˆã€‚

- æµ‹è¯•

  æµ‹è¯•äººå‘˜è¿›è¡Œä»£ç æµ‹è¯• ï¼ŒåŒ…æ‹¬åŠŸèƒ½æµ‹è¯•ã€ä»£ç æµ‹è¯•ã€å‹åŠ›æµ‹è¯•ç­‰ã€‚

- è¿›åŒ–

  æœ€åé˜¶æ®µå°±æ˜¯å¯¹äº§å“ä¸æ–­çš„è¿›åŒ–æ”¹è¿›å’Œç»´æŠ¤é˜¶æ®µï¼Œæ ¹æ®ç”¨æˆ·çš„ä½¿ç”¨æƒ…å†µï¼Œå¯èƒ½éœ€è¦å¯¹æŸåŠŸèƒ½è¿›è¡Œä¿®æ”¹ï¼Œbugä¿®å¤ï¼ŒåŠŸèƒ½å¢åŠ ç­‰ã€‚

#### 2.2 è½¯ä»¶å¼€å‘ç€‘å¸ƒæ¨¡å‹

ç€‘å¸ƒæ¨¡å‹æ˜¯æœ€è‘—åå’Œæœ€å¸¸ä½¿ç”¨çš„è½¯ä»¶å¼€å‘æ¨¡å‹ã€‚ç€‘å¸ƒæ¨¡å‹å°±æ˜¯ä¸€ç³»åˆ—çš„è½¯ä»¶å¼€å‘è¿‡ç¨‹ã€‚å®ƒæ˜¯ç”±åˆ¶é€ ä¸šç¹è¡å‡ºæ¥çš„ã€‚ä¸€ä¸ªé«˜åº¦åŒ–çš„ç»“æ„æµç¨‹åœ¨ä¸€ä¸ªæ–¹å‘ä¸ŠæµåŠ¨ï¼Œæœ‰ç‚¹åƒç”Ÿäº§çº¿ä¸€æ ·ã€‚åœ¨ç€‘å¸ƒæ¨¡å‹åˆ›å»ºä¹‹åˆï¼Œæ²¡æœ‰å…¶å®ƒå¼€å‘çš„æ¨¡å‹ï¼Œæœ‰å¾ˆå¤šä¸œè¥¿å…¨é å¼€å‘äººå‘˜å»çŒœæµ‹ï¼Œå»å¼€å‘ã€‚è¿™æ ·çš„æ¨¡å‹ä»…é€‚ç”¨äºé‚£äº›ç®€å•çš„è½¯ä»¶å¼€å‘ï¼Œ ä½†æ˜¯å·²ç»ä¸é€‚åˆç°åœ¨çš„å¼€å‘äº†ã€‚

ä¸‹å›¾å¯¹è½¯ä»¶å¼€å‘æ¨¡å‹çš„ä¸€ä¸ªé˜è¿°ã€‚

<div align="center">
    <img src="æˆªå›¾/é¡¹ç›®éƒ¨ç½²_æŒç»­é›†æˆ/ç€‘å¸ƒæ¨¡å‹.png" alt="ç€‘å¸ƒæ¨¡å‹" />
</div>



| ä¼˜åŠ¿                                       | åŠ£åŠ¿                                                         |
| ------------------------------------------ | ------------------------------------------------------------ |
| ç®€å•æ˜“ç”¨å’Œç†è§£                             | å„ä¸ªé˜¶æ®µçš„åˆ’åˆ†å®Œå…¨å›ºå®šï¼Œé˜¶æ®µä¹‹é—´äº§ç”Ÿå¤§é‡çš„æ–‡æ¡£ï¼Œæå¤§åœ°å¢åŠ äº†å·¥ä½œé‡ã€‚ |
| å½“å‰ä¸€é˜¶æ®µå®Œæˆåï¼Œæ‚¨åªéœ€è¦å»å…³æ³¨åç»­é˜¶æ®µã€‚ | ç”±äºå¼€å‘æ¨¡å‹æ˜¯çº¿æ€§çš„ï¼Œç”¨æˆ·åªæœ‰ç­‰åˆ°æ•´ä¸ªè¿‡ç¨‹çš„æœ«æœŸæ‰èƒ½è§åˆ°å¼€å‘æˆæœï¼Œä»è€Œå¢åŠ äº†å¼€å‘é£é™©ã€‚ |
| ä¸ºé¡¹ç›®æä¾›äº†æŒ‰é˜¶æ®µåˆ’åˆ†çš„æ£€æŸ¥èŠ‚ç‚¹           | ç€‘å¸ƒæ¨¡å‹çš„çªå‡ºç¼ºç‚¹æ˜¯ä¸é€‚åº”ç”¨æˆ·éœ€æ±‚çš„å˜åŒ–ã€‚                   |

#### 2.3 è½¯ä»¶çš„æ•æ·å¼€å‘

- ä»€ä¹ˆæ˜¯æ•æ·å¼€å‘ï¼Ÿ

  æ•æ·å¼€å‘ï¼ˆAgile Developmentï¼‰ çš„æ ¸å¿ƒæ˜¯è¿­ä»£å¼€å‘ï¼ˆIterative Developmentï¼‰ ä¸ å¢é‡å¼€å‘ï¼ˆIncremental Developmentï¼‰ã€‚

- ä½•ä¸ºè¿­ä»£å¼€å‘ï¼Ÿ

  å¯¹äºå¤§å‹è½¯ä»¶é¡¹ç›®ï¼Œä¼ ç»Ÿçš„å¼€å‘æ–¹å¼æ˜¯é‡‡ç”¨ä¸€ä¸ªå¤§å‘¨æœŸï¼ˆæ¯”å¦‚ä¸€å¹´ï¼‰è¿›è¡Œå¼€å‘ï¼Œæ•´ä¸ªè¿‡ç¨‹å°±æ˜¯ä¸€æ¬¡"å¤§å¼€å‘"ï¼›è¿­ä»£å¼€å‘çš„æ–¹å¼åˆ™ä¸ä¸€æ ·ï¼Œå®ƒå°†å¼€å‘è¿‡ç¨‹æ‹†åˆ†æˆå¤šä¸ªå°å‘¨æœŸï¼Œå³ä¸€æ¬¡"å¤§å¼€å‘"å˜æˆå¤šæ¬¡"å°å¼€å‘"ï¼Œæ¯æ¬¡å°å¼€å‘éƒ½æ˜¯åŒæ ·çš„æµç¨‹ï¼Œæ‰€ä»¥çœ‹ä¸Šå»å°±å¥½åƒé‡å¤åœ¨åšåŒæ ·çš„æ­¥éª¤ã€‚

  ä¸¾ä¾‹æ¥è¯´ï¼ŒSpaceX å…¬å¸æƒ³é€ ä¸€ä¸ªå¤§æ¨åŠ›ç«ç®­ï¼Œå°†äººç±»é€åˆ°ç«æ˜Ÿã€‚ä½†æ˜¯ï¼Œå®ƒä¸æ˜¯ä¸€å¼€å§‹å°±é€ å¤§ç«ç®­ï¼Œè€Œæ˜¯å…ˆé€ ä¸€ä¸ªæœ€ç®€é™‹çš„å°ç«ç®­ Falcon 1ã€‚ç»“æœï¼Œç¬¬ä¸€æ¬¡å‘å°„å°±çˆ†ç‚¸äº†ï¼Œç›´åˆ°ç¬¬å››æ¬¡å‘å°„ï¼Œæ‰æˆåŠŸè¿›å…¥è½¨é“ã€‚ç„¶åï¼Œå¼€å‘äº†ä¸­å‹ç«ç®­ Falcon 9ï¼Œä¹å¹´ä¸­å‘å°„äº†70æ¬¡ã€‚æœ€åï¼Œæ‰å¼€å‘ Falcon é‡å‹ç«ç®­ã€‚å¦‚æœSpaceX ä¸é‡‡ç”¨è¿­ä»£å¼€å‘ï¼Œå®ƒå¯èƒ½ç›´åˆ°ç°åœ¨è¿˜æ— æ³•ä¸Šå¤©ã€‚

- ä½•ä¸ºå¢é‡å¼€å‘ï¼Ÿ

  è½¯ä»¶çš„æ¯ä¸ªç‰ˆæœ¬ï¼Œéƒ½ä¼šæ–°å¢ä¸€ä¸ªç”¨æˆ·å¯ä»¥æ„ŸçŸ¥çš„å®Œæ•´åŠŸèƒ½ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒæŒ‰ç…§æ–°å¢åŠŸèƒ½æ¥åˆ’åˆ†è¿­ä»£ã€‚

  ä¸¾ä¾‹æ¥è¯´ï¼Œæˆ¿äº§å…¬å¸å¼€å‘ä¸€ä¸ª10æ ‹æ¥¼çš„å°åŒºã€‚å¦‚æœé‡‡ç”¨å¢é‡å¼€å‘çš„æ¨¡å¼ï¼Œè¯¥å…¬å¸ç¬¬ä¸€ä¸ªè¿­ä»£å°±æ˜¯äº¤ä»˜ä¸€å·æ¥¼ï¼Œç¬¬äºŒä¸ªè¿­ä»£äº¤ä»˜äºŒå·æ¥¼......æ¯ä¸ªè¿­ä»£éƒ½æ˜¯å®Œæˆä¸€æ ‹å®Œæ•´çš„æ¥¼ã€‚è€Œä¸æ˜¯ç¬¬ä¸€ä¸ªè¿­ä»£æŒ–å¥½10æ ‹æ¥¼çš„åœ°åŸºï¼Œç¬¬äºŒä¸ªè¿­ä»£å»ºå¥½æ¯æ ‹æ¥¼çš„éª¨æ¶ï¼Œç¬¬ä¸‰ä¸ªè¿­ä»£æ¶è®¾å±‹é¡¶......

- æ•æ·å¼€å‘å¦‚ä½•è¿­ä»£ï¼Ÿ

  è™½ç„¶æ•æ·å¼€å‘å°†è½¯ä»¶å¼€å‘åˆ†æˆå¤šä¸ªè¿­ä»£ï¼Œä½†æ˜¯ä¹Ÿè¦æ±‚ï¼Œæ¯æ¬¡è¿­ä»£éƒ½æ˜¯ä¸€ä¸ªå®Œæ•´çš„è½¯ä»¶å¼€å‘å‘¨æœŸï¼Œå¿…é¡»æŒ‰ç…§è½¯ä»¶å·¥ç¨‹çš„æ–¹æ³•è®ºï¼Œè¿›è¡Œæ­£è§„çš„æµç¨‹ç®¡ç†ã€‚

<div align="center">
    <img src="æˆªå›¾/é¡¹ç›®éƒ¨ç½²_æŒç»­é›†æˆ/æ•æ·å¼€å‘.png" alt="æ•æ·å¼€å‘" />
</div>

æ•æ·å¼€å‘æœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿ

- æ—©æœŸäº¤ä»˜

  æ•æ·å¼€å‘çš„ç¬¬ä¸€ä¸ªå¥½å¤„ï¼Œå°±æ˜¯æ—©æœŸäº¤ä»˜ï¼Œä»è€Œå¤§å¤§é™ä½æˆæœ¬ã€‚ è¿˜æ˜¯ä»¥æˆ¿äº§å…¬å¸ä¸ºä¾‹ï¼Œå¦‚æœæŒ‰ç…§ä¼ ç»Ÿçš„"ç€‘å¸ƒå¼€å‘æ¨¡å¼"ï¼Œå…ˆæŒ–10æ ‹æ¥¼çš„åœ°åŸºã€å†ç›–éª¨æ¶ã€ç„¶åæ¶è®¾å±‹é¡¶ï¼Œæ¯ä¸ªé˜¶æ®µéƒ½ç­‰åˆ°å‰ä¸€ä¸ªé˜¶æ®µå®Œæˆåå¼€å§‹ï¼Œå¯èƒ½éœ€è¦ä¸¤å¹´æ‰èƒ½ä¸€æ¬¡æ€§äº¤ä»˜10æ ‹æ¥¼ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœä¸è€ƒè™‘é¢„å”®ï¼Œè¯¥é¡¹ç›®å¿…é¡»ç­‰åˆ°ä¸¤å¹´åæ‰èƒ½å›æ¬¾ã€‚ æ•æ·å¼€å‘æ˜¯å…­ä¸ªæœˆåäº¤ä»˜ä¸€å·æ¥¼ï¼Œåé¢æ¯ä¸¤ä¸ªæœˆäº¤ä»˜ä¸€æ ‹æ¥¼ã€‚å› æ­¤ï¼ŒåŠå¹´å°±èƒ½å›æ¬¾10%ï¼Œåé¢æ¯ä¸ªæœˆéƒ½ä¼šæœ‰ç°é‡‘æµï¼Œèµ„é‡‘å‹åŠ›å°±å¤§å¤§å‡è½»äº†ã€‚

- é™ä½é£é™©

  æ•æ·å¼€å‘çš„ç¬¬äºŒä¸ªå¥½å¤„æ˜¯ï¼ŒåŠæ—¶äº†è§£å¸‚åœºéœ€æ±‚ï¼Œé™ä½äº§å“ä¸é€‚ç”¨çš„é£é™©ã€‚ è¯·æƒ³ä¸€æƒ³ï¼Œå“ªä¸€ç§æƒ…å†µæŸå¤±æ¯”è¾ƒå°ï¼š10æ ‹æ¥¼éƒ½é€ å¥½ä»¥åï¼Œæ‰å‘ç°å–ä¸å‡ºå»ï¼Œè¿˜æ˜¯é€ å¥½ç¬¬ä¸€æ ‹æ¥¼ï¼Œå°±å‘ç°å–ä¸å‡ºå»ï¼Œä»è€Œæ”¹è¿›æˆ–åœå»ºåé¢9æ ‹æ¥¼ï¼Ÿ

### 3. Jenkinså®‰è£…é…ç½®

#### 3.1 Jenkinsä»‹ç»

<div align="center">
    <img src="æˆªå›¾/é¡¹ç›®éƒ¨ç½²_æŒç»­é›†æˆ/Jenkins.png" alt="Jenkins" />
</div>

Jenkins  æ˜¯ä¸€æ¬¾æµè¡Œçš„å¼€æºæŒç»­é›†æˆï¼ˆContinuous Integrationï¼‰å·¥å…·ï¼Œå¹¿æ³›ç”¨äºé¡¹ç›®å¼€å‘ï¼Œå…·æœ‰è‡ªåŠ¨åŒ–æ„å»ºã€æµ‹è¯•å’Œéƒ¨ç½²ç­‰åŠŸèƒ½ã€‚å®˜ç½‘ï¼š  http://jenkins-ci.org/ã€‚

Jenkinsçš„ç‰¹å¾ï¼š

- å¼€æºçš„ Javaè¯­è¨€å¼€å‘æŒç»­é›†æˆå·¥å…·ï¼Œæ”¯æŒæŒç»­é›†æˆï¼ŒæŒç»­éƒ¨ç½²ã€‚
- æ˜“äºå®‰è£…éƒ¨ç½²é…ç½®ï¼šå¯é€šè¿‡ yumå®‰è£…,æˆ–ä¸‹è½½waråŒ…ä»¥åŠé€šè¿‡dockerå®¹å™¨ç­‰å¿«é€Ÿå®ç°å®‰è£…éƒ¨ç½²ï¼Œå¯æ–¹ä¾¿webç•Œé¢é…ç½®ç®¡ç†ã€‚
- æ¶ˆæ¯é€šçŸ¥åŠæµ‹è¯•æŠ¥å‘Šï¼šé›†æˆ RSS/E-mailé€šè¿‡RSSå‘å¸ƒæ„å»ºç»“æœæˆ–å½“æ„å»ºå®Œæˆæ—¶é€šè¿‡e-mailé€šçŸ¥ï¼Œç”ŸæˆJUnit/TestNGæµ‹è¯•æŠ¥å‘Šã€‚
- åˆ†å¸ƒå¼æ„å»ºï¼šæ”¯æŒ Jenkinsèƒ½å¤Ÿè®©å¤šå°è®¡ç®—æœºä¸€èµ·æ„å»º/æµ‹è¯•ã€‚
- æ–‡ä»¶è¯†åˆ«ï¼š Jenkinsèƒ½å¤Ÿè·Ÿè¸ªå“ªæ¬¡æ„å»ºç”Ÿæˆå“ªäº›jarï¼Œå“ªæ¬¡æ„å»ºä½¿ç”¨å“ªä¸ªç‰ˆæœ¬çš„jarç­‰ã€‚
- ä¸°å¯Œçš„æ’ä»¶æ”¯æŒï¼šæ”¯æŒæ‰©å±•æ’ä»¶ï¼Œä½ å¯ä»¥å¼€å‘é€‚åˆè‡ªå·±å›¢é˜Ÿä½¿ç”¨çš„å·¥å…·ï¼Œå¦‚ gitï¼Œsvnï¼Œmavenï¼Œdockerç­‰ã€‚



Jenkinså®‰è£…å’ŒæŒç»­é›†æˆç¯å¢ƒé…ç½®

<div align="center">
    <img src="æˆªå›¾/é¡¹ç›®éƒ¨ç½²_æŒç»­é›†æˆ/æµç¨‹.png" alt="æµç¨‹" />
</div>

1 ï¼‰é¦–å…ˆï¼Œå¼€å‘äººå‘˜æ¯å¤©è¿›è¡Œä»£ç æäº¤ï¼Œæäº¤åˆ°Gitä»“åº“

2ï¼‰ç„¶åï¼ŒJenkinsä½œä¸ºæŒç»­é›†æˆå·¥å…·ï¼Œä½¿ç”¨Gitå·¥å…·åˆ°Gitä»“åº“æ‹‰å–ä»£ç åˆ°é›†æˆæœåŠ¡å™¨ï¼Œå†é…åˆJDKï¼ŒMavenç­‰è½¯ä»¶å®Œæˆä»£ç ç¼–è¯‘ï¼Œä»£ç æµ‹è¯•ä¸å®¡æŸ¥ï¼Œæµ‹è¯•ï¼Œæ‰“åŒ…ç­‰å·¥ä½œï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­æ¯ä¸€æ­¥å‡ºé”™ï¼Œéƒ½é‡æ–°å†æ‰§è¡Œä¸€æ¬¡æ•´ä¸ªæµç¨‹ã€‚

3ï¼‰æœ€åï¼ŒJenkinsæŠŠç”Ÿæˆçš„jaræˆ–waråŒ…åˆ†å‘åˆ°æµ‹è¯•æœåŠ¡å™¨æˆ–è€…ç”Ÿäº§æœåŠ¡å™¨ï¼Œæµ‹è¯•äººå‘˜æˆ–ç”¨æˆ·å°±å¯ä»¥è®¿é—®åº”ç”¨ã€‚

#### 3.2 Jenkinsç¯å¢ƒæ­å»º

##### 3.2.1  Jenkinså®‰è£…é…ç½®

å¦‚æœå¯åŠ¨å¤±è´¥ï¼Œ å‡ºç°é”™è¯¯ä¿¡æ¯ï¼š

```
Starting Jenkins bash: /usr/bin/java: No such file or directory
```

åˆ›å»ºJAVAç¯å¢ƒçš„è½¯é“¾æ¥ï¼š

```
ln -s /usr/local/jdk/bin/java /usr/bin/java
```

è½¯è¿æ¥çš„åº”ç”¨åœºæ™¯ï¼šä¸‹è½½çš„ä¸œè¥¿ï¼ˆJavaï¼‰åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œè€ŒæŸä¸ªï¼ˆJenkinsï¼‰è¦çš„è¿™ä¸ªä¸œè¥¿ï¼ˆJavaï¼‰å¿…é¡»åœ¨æŒ‡å®šçš„å¦ä¸€ä¸ªæ–‡ä»¶ï¼Œæ­¤æ—¶å°±å¯ä»¥é€šè¿‡è½¯è¿æ¥çš„æ–¹å¼ã€‚

##### 3.2.2  Jenkinsæ’ä»¶å®‰è£…

åœ¨å®ç°æŒç»­é›†æˆä¹‹å‰ï¼Œ éœ€è¦ç¡®ä¿ä»¥ä¸‹æ’ä»¶å®‰è£…æˆåŠŸã€‚

- Maven Integration pluginï¼š Maven é›†æˆç®¡ç†æ’ä»¶ã€‚
- Docker pluginï¼š Dockeré›†æˆæ’ä»¶ã€‚
- GitLab Pluginï¼š GitLabé›†æˆæ’ä»¶ã€‚
- Publish Over SSHï¼šè¿œç¨‹æ–‡ä»¶å‘å¸ƒæ’ä»¶ã€‚
- SSH: è¿œç¨‹è„šæœ¬æ‰§è¡Œæ’ä»¶ã€‚

å‹¾é€‰æ’ä»¶ï¼Œ ç‚¹å‡»ç›´æ¥å®‰è£…å³å¯ã€‚

>æ³¨æ„ï¼Œå¦‚æœæ²¡æœ‰å®‰è£…æŒ‰é’®ï¼Œéœ€è¦æ›´æ”¹é…ç½®
>
>åœ¨å®‰è£…æ’ä»¶çš„é«˜çº§é…ç½®ä¸­ï¼Œä¿®æ”¹å‡çº§ç«™ç‚¹çš„è¿æ¥ä¸ºï¼šhttp://updates.jenkins.io/update-center.json   ä¿å­˜

Docker

è®¾ç½®å¼€æœºå¯åŠ¨ï¼š

```sh
systemctl enable docker
```

å¯åŠ¨docker

```sh
systemctl start docker
```

### 4. åç«¯é¡¹ç›®éƒ¨ç½²

#### 4.1 å¤šç¯å¢ƒåˆ‡æ¢-å¾®æœåŠ¡ä¸­å¤šç¯å¢ƒé…ç½®

åœ¨é¡¹ç›®å¼€å‘éƒ¨ç½²çš„è¿‡ç¨‹ä¸­ï¼Œä¸€èˆ¬éƒ½ä¼šæœ‰ä¸‰å¥—é¡¹ç›®ç¯å¢ƒ

- Development ï¼šå¼€å‘ç¯å¢ƒ

- Production ï¼šç”Ÿäº§ç¯å¢ƒ

- Test ï¼šæµ‹è¯•ç¯å¢ƒ

ä¾‹å¦‚ï¼šå¼€å‘ç¯å¢ƒçš„mysqlè¿æ¥çš„æ˜¯æœ¬åœ°ï¼Œç”Ÿäº§ç¯å¢ƒéœ€è¦è¿æ¥çº¿ä¸Šçš„mysqlç¯å¢ƒ

åœ¨nacosçš„é…ç½®ä¸­å¿ƒä¸­æ–°å¢å„ä¸ªç¯å¢ƒçš„é…ç½®æ–‡ä»¶ï¼Œä¾‹å¦‚userå¾®æœåŠ¡ä¸­æ–°å¢

ä¿®æ”¹bootstrap.yml æ·»åŠ å†…å®¹

```properties
spring:
  profiles:
    active: dev
```

åˆ›å»ºå¯¹åº”çš„nacosçš„å¤šç¯å¢ƒé…ç½®ï¼š

æ³¨æ„äº‹é¡¹ï¼š

<div align="center">
    <img src="æˆªå›¾/é¡¹ç›®éƒ¨ç½²_æŒç»­é›†æˆ/å¤šç¯å¢ƒé…ç½®.png" alt="å¤šç¯å¢ƒé…ç½®" />
</div>

å…¶ä¸­DataIDå±æ€§å‘½åæœ‰è§„èŒƒï¼š

- prefixï¼Œé»˜è®¤ä½¿ç”¨${spring.application.name}ï¼Œä¹Ÿå¯ä»¥é€šè¿‡spring.cloud.nacos.config.prefixæ¥é…ç½®ã€‚
- spring.profile.activeï¼Œå³ä¸ºå½“å‰ç¯å¢ƒå¯¹åº”çš„ profileï¼Œè¯¦æƒ…å¯ä»¥å‚è€ƒ Spring Bootæ–‡æ¡£ã€‚ æ³¨æ„ï¼šå½“ spring.profile.active ä¸ºç©ºæ—¶ï¼Œå¯¹åº”çš„è¿æ¥ç¬¦ - ä¹Ÿå°†ä¸å­˜åœ¨ï¼ŒdataId çš„æ‹¼æ¥æ ¼å¼å˜æˆ ${prefix}.${file-extension}
- file-exetensionï¼Œä¸ºé…ç½®å†…å®¹çš„æ•°æ®æ ¼å¼ï¼Œå¯ä»¥é€šè¿‡é…ç½®é¡¹ spring.cloud.nacos.config.file-extension æ¥é…ç½®ã€‚ç›®å‰åªæ”¯æŒ properties å’Œ yaml ç±»å‹ã€‚

#### 4.2 æ•´ä½“æ€è·¯

ç›®æ ‡ï¼šæŠŠé»‘é©¬å¤´æ¡çš„appç«¯ç›¸å…³çš„å¾®æœåŠ¡éƒ¨ç½²åˆ°192.168.200.100è¿™å°æœåŠ¡å™¨ä¸Š

<div align="center">
    <img src="æˆªå›¾/é¡¹ç›®éƒ¨ç½²_æŒç»­é›†æˆ/æ•´ä½“æ€è·¯.png" alt="æ•´ä½“æ€è·¯" />
</div>

<div align="center">
    <img src="æˆªå›¾/é¡¹ç›®éƒ¨ç½²_æŒç»­é›†æˆ/æ³¨æ„äº‹é¡¹.png" alt="æ³¨æ„äº‹é¡¹" />
</div>

#### 4.3 æœåŠ¡é›†æˆDockeré…ç½®

ç›®æ ‡ï¼šéƒ¨ç½²çš„æ¯ä¸€ä¸ªå¾®æœåŠ¡éƒ½æ˜¯å…ˆåˆ›å»ºdockeré•œåƒååˆ›å»ºå¯¹åº”å®¹å™¨å¯åŠ¨

æ–¹å¼ä¸€ï¼šæœ¬åœ°å¾®æœåŠ¡æ‰“åŒ…ä»¥åä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼Œç¼–å†™Dockerfileæ–‡ä»¶å®Œæˆã€‚

æ–¹å¼äºŒï¼šä½¿ç”¨dockerfile-maven-pluginæ’ä»¶ï¼Œå¯ä»¥ç›´æ¥æŠŠå¾®æœåŠ¡åˆ›å»ºä¸ºé•œåƒä½¿ç”¨ï¼ˆæ›´çœäº‹ï¼‰

**æœåŠ¡é›†æˆDockeré…ç½®**

<div align="center">
    <img src="æˆªå›¾/é¡¹ç›®éƒ¨ç½²_æŒç»­é›†æˆ/æœåŠ¡é›†æˆDockeré…ç½®.png" alt="æœåŠ¡é›†æˆDockeré…ç½®" />
</div>

æ¯ä¸ªå¾®æœåŠ¡éƒ½å¼•å…¥è¯¥ä¾èµ–,ä»¥heima-leadnews-userå¾®æœåŠ¡ä¸ºä¾‹

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <artifactId>heima-leadnews-service</artifactId>
        <groupId>com.heima</groupId>
        <version>1.0-SNAPSHOT</version>
    </parent>
    <modelVersion>4.0.0</modelVersion>

    <artifactId>heima-leadnews-user</artifactId>

    <properties>
        <maven.compiler.source>8</maven.compiler.source>
        <maven.compiler.target>8</maven.compiler.target>
        <docker.image>docker_storage</docker.image>
    </properties>

    <build>
        <finalName>heima-leadnews-user</finalName>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
                <executions>
                    <execution>
                        <goals>
                            <goal>repackage</goal>
                        </goals>
                    </execution>
                </executions>
            </plugin>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-compiler-plugin</artifactId>
                <version>3.7.0</version>
                <configuration>
                    <source>${java.version}</source>
                    <target>${java.version}</target>
                </configuration>
            </plugin>
            <plugin>
                <groupId>com.spotify</groupId>
                <artifactId>dockerfile-maven-plugin</artifactId>
                <version>1.3.6</version>
                <configuration>
                    <repository>${docker.image}/${project.artifactId}</repository>
                    <buildArgs>
                        <JAR_FILE>target/${project.build.finalName}.jar</JAR_FILE>
                    </buildArgs>
                </configuration>
            </plugin>
        </plugins>
    </build>

</project>
```

**æœåŠ¡é›†æˆDockerfileæ–‡ä»¶**

```dockerfile
# è®¾ç½®JAVAç‰ˆæœ¬
FROM java:8
# æŒ‡å®šå­˜å‚¨å·, ä»»ä½•å‘/tmpå†™å…¥çš„ä¿¡æ¯éƒ½ä¸ä¼šè®°å½•åˆ°å®¹å™¨å­˜å‚¨å±‚
VOLUME /tmp
# æ‹·è´è¿è¡ŒJARåŒ…
ARG JAR_FILE
COPY ${JAR_FILE} app.jar
# è®¾ç½®JVMè¿è¡Œå‚æ•°ï¼Œ è¿™é‡Œé™å®šä¸‹å†…å­˜å¤§å°ï¼Œå‡å°‘å¼€é”€
ENV JAVA_OPTS="\
-server \
-Xms256m \
-Xmx512m \
-XX:MetaspaceSize=256m \
-XX:MaxMetaspaceSize=512m"
#ç©ºå‚æ•°ï¼Œæ–¹ä¾¿åˆ›å»ºå®¹å™¨æ—¶ä¼ å‚
ENV PARAMS=""
# å…¥å£ç‚¹ï¼Œ æ‰§è¡ŒJAVAè¿è¡Œå‘½ä»¤
ENTRYPOINT ["sh","-c","java -jar $JAVA_OPTS /app.jar $PARAMS"]
```

#### 4.4 jenkinså¾®æœåŠ¡æ‰“åŒ…é…ç½®

æ‰€æœ‰å¾®æœåŠ¡æ‰“åŒ…çš„æ–¹å¼ç±»ä¼¼ï¼Œä»¥heima-leadnews-userå¾®æœåŠ¡ä¸ºä¾‹

1. æ–°å»ºä»»åŠ¡

<div align="center">
    <img src="æˆªå›¾/é¡¹ç›®éƒ¨ç½²_æŒç»­é›†æˆ/æ–°å»ºä»»åŠ¡.png" alt="æ–°å»ºä»»åŠ¡" />
</div>

2. æ‰¾åˆ°è‡ªå·±æŒ‡å®šçš„gitä»“åº“ï¼Œè®¾ç½®ç”¨æˆ·åå’Œå¯†ç 

<div align="center">
    <img src="æˆªå›¾/é¡¹ç›®éƒ¨ç½²_æŒç»­é›†æˆ/Git.png" alt="Git" />
</div>

3. æ‰§è¡Œmavenå‘½ä»¤

<div align="center">
    <img src="æˆªå›¾/é¡¹ç›®éƒ¨ç½²_æŒç»­é›†æˆ/Maven.png" alt="Maven" />
</div>



```java
clean install -Dmaven.test.skip=true  dockerfile:build -f heima-leadnews/heima-leadnews-service/heima-leadnews-user/pom.xml
```

<font color='red'>æ³¨æ„ï¼šæ ¹æ®è‡ªå·±çš„å®é™…ä»£ç è·¯å¾„é…ç½®</font>

-Dmaven.test.skip=true  è·³è¿‡æµ‹è¯•

dockerfile:build å¯åŠ¨dockerfileæ’ä»¶æ„å»ºå®¹å™¨

-f heima-leadnews-user/pom.xml æŒ‡å®šéœ€è¦æ„å»ºçš„æ–‡ä»¶ï¼ˆå¿…é¡»æ˜¯pomï¼‰

4. å¹¶æ‰§è¡Œshellè„šæœ¬

<div align="center">
    <img src="æˆªå›¾/é¡¹ç›®éƒ¨ç½²_æŒç»­é›†æˆ/shell.png" alt="shell" />
</div>

```java
if [ -n  "$(docker ps -a -f  name=$JOB_NAME  --format '{{.ID}}' )" ]
 then
 #åˆ é™¤ä¹‹å‰çš„å®¹å™¨
 docker rm -f $(docker ps -a -f  name=$JOB_NAME  --format '{{.ID}}' )
fi
 # æ¸…ç†é•œåƒ
docker image prune -f 
 # å¯åŠ¨dockeræœåŠ¡
docker run -d --net=host -e PARAMS="--spring.profiles.active=prod"  --name $JOB_NAME docker_storage/$JOB_NAME
```

5. æ‰§è¡Œæ—¥å¿—

æ‹‰å–ä»£ç  -> ç¼–è¯‘æ‰“åŒ… -> æ„å»ºé•œåƒ -> æ¸…ç†å®¹å™¨ï¼Œåˆ›å»ºæ–°çš„å®¹å™¨

#### 4.4 éƒ¨ç½²æœåŠ¡åˆ°è¿œç¨‹æœåŠ¡å™¨ä¸Š

<div align="center">
    <img src="æˆªå›¾/é¡¹ç›®éƒ¨ç½²_æŒç»­é›†æˆ/è¿œç¨‹éƒ¨ç½².png" alt="è¿œç¨‹éƒ¨ç½²" />
</div>

##### 4.4.1 å®‰è£…é…ç½®ç§æœ‰ä»“åº“

å¯¹äºæŒç»­é›†æˆç¯å¢ƒçš„é…ç½®ï¼ŒJenkinsä¼šå‘å¸ƒå¤§é‡çš„å¾®æœåŠ¡ï¼Œ è¦ä¸å¤šå°æœºå™¨è¿›è¡Œäº¤äº’ï¼Œ å¯ä»¥é‡‡ç”¨dockeré•œåƒçš„ä¿å­˜ä¸å¯¼å‡ºåŠŸèƒ½ç»“åˆSSHå®ç°ï¼Œ ä½†è¿™æ ·äº¤äº’ç¹çï¼Œç¨³å®šæ€§å·®ï¼Œ è€Œä¸”ä¸ä¾¿ç®¡ç†ï¼Œ è¿™é‡Œæˆ‘ä»¬é€šè¿‡æ­å»ºDockerçš„ç§æœ‰ä»“åº“æ¥å®ç°ï¼Œ è¿™ä¸ªæœ‰ç‚¹ç±»ä¼¼GITä»“åº“ï¼Œ é›†ä¸­ç»Ÿä¸€ç®¡ç†èµ„æºï¼Œ ç”±å®¢æˆ·ç«¯æ‹‰å–æˆ–æ›´æ–°ã€‚

1. ä¸‹è½½æœ€æ–°Registryé•œåƒ

   ```sh
   docker pull registry:latest
   ```

2. å¯åŠ¨Registryé•œåƒæœåŠ¡

   ```sh
   docker run -d -p 5000:5000 --name registry -v /usr/local/docker/registry:/var/lib/registry registry:latest
   ```

   æ˜ å°„5000ç«¯å£ï¼› -væ˜¯å°†Registryå†…çš„é•œåƒæ•°æ®å·ä¸æœ¬åœ°æ–‡ä»¶å…³è”ï¼Œ ä¾¿äºç®¡ç†å’Œç»´æŠ¤Registryå†…çš„æ•°æ®ã€‚

3. æŸ¥çœ‹ä»“åº“èµ„æº

   è®¿é—®åœ°å€ï¼šhttp://192.168.200.100:5000/v2/_catalog

   å¯åŠ¨æ­£å¸¸ï¼Œ å¯ä»¥çœ‹åˆ°è¿”å›ï¼š

   ```json
   {"repositories":[]}
   ```

   ç›®å‰å¹¶æ²¡æœ‰ä¸Šä¼ é•œåƒï¼Œ æ˜¾ç¤ºç©ºæ•°æ®ã€‚

4. é…ç½®Dockerå®¢æˆ·ç«¯

   æ­£å¸¸ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ï¼Œ è¦é…ç½®HTTPSæœåŠ¡ï¼Œ ç¡®ä¿å®‰å…¨ï¼Œå†…éƒ¨å¼€å‘æˆ–æµ‹è¯•é›†æˆçš„å±€åŸŸç½‘ç¯å¢ƒï¼Œå¯ä»¥é‡‡ç”¨ç®€ä¾¿çš„æ–¹å¼ï¼Œ ä¸åšå®‰å…¨æ§åˆ¶ã€‚

   å…ˆç¡®ä¿æŒç»­é›†æˆç¯å¢ƒçš„æœºå™¨å·²å®‰è£…å¥½Dockerå®¢æˆ·ç«¯ï¼Œ ç„¶ååšä»¥ä¸‹ä¿®æ”¹ï¼š

   ```sh
   vi /lib/systemd/system/docker.service
   ```

   ä¿®æ”¹å†…å®¹ï¼š

   ```sh
   ExecStart=/usr/bin/dockerd --insecure-registry 192.168.200.100:5000
   ```

   æŒ‡å‘å®‰è£…Registryçš„æœåŠ¡IPä¸ç«¯å£ã€‚

   é‡å¯ç”Ÿæ•ˆï¼š

   ```sh
   systemctl daemon-reolad
   systemctl restart docker.service
   ```

##### 4.4.2 jenkinsä¸­å®‰è£…æ’ä»¶

ä½ç½®ï¼šManage Jenkins-->Configure System

<div align="center">
    <img src="æˆªå›¾/é¡¹ç›®éƒ¨ç½²_æŒç»­é›†æˆ/Jenkinsä¸­å®‰è£…æ’ä»¶.png" alt="Jenkinsä¸­å®‰è£…æ’ä»¶" />
</div>

##### 4.4.3 jenkinsç³»ç»Ÿé…ç½®è¿œç¨‹æœåŠ¡å™¨é“¾æ¥

ä½ç½®ï¼šManage Jenkins-->Configure System

<div align="center">
    <img src="æˆªå›¾/é¡¹ç›®éƒ¨ç½²_æŒç»­é›†æˆ/Jenkinsé…ç½®è¿œç¨‹æœåŠ¡å™¨é“¾æ¥.png" alt="Jenkinsé…ç½®è¿œç¨‹æœåŠ¡å™¨é“¾æ¥" />
</div>
mavenå‘½ä»¤

```java
clean install -Dmaven.test.skip=true dockerfile:build -f heima-leadnews/heima-leadnews-service/heima-leadnews-article/pom.xml
```

shellè„šæœ¬

```shell
image_tag=$docker_registry/docker_storage/$JOB_NAME
echo '================dockeré•œåƒæ¸…ç†================'
if [ -n  "$(docker ps -a -f  name=$JOB_NAME  --format '{{.ID}}' )" ]
 then
 #åˆ é™¤ä¹‹å‰çš„å®¹å™¨
 docker rm -f $(docker ps -a -f  name=$JOB_NAME  --format '{{.ID}}' )
fi
 # æ¸…ç†é•œåƒ
docker image prune -f 

# åˆ›å»ºTAG
docker tag docker_storage/$JOB_NAME $image_tag
echo '================dockeré•œåƒæ¨é€================'
# æ¨é€é•œåƒ
docker push $image_tag
# åˆ é™¤TAG
docker rmi $image_tag
echo '================docker tag æ¸…ç† ================'
```

##### 4.4.4 åœ¨è¿œç¨‹æœåŠ¡å™¨ä¸Šæ‰§è¡Œè„šæœ¬

è¿œç¨‹æœåŠ¡å™¨æ‰§è¡Œçš„shellè„šæœ¬

```shell
echo '================æ‹‰å–æœ€æ–°é•œåƒ================'
docker pull $docker_registry/docker_storage/$JOB_NAME

echo '================åˆ é™¤æ¸…ç†å®¹å™¨é•œåƒ================'
if [ -n  "$(docker ps -a -f  name=$JOB_NAME  --format '{{.ID}}' )" ]
 then
 #åˆ é™¤ä¹‹å‰çš„å®¹å™¨
 docker rm -f $(docker ps -a -f  name=$JOB_NAME  --format '{{.ID}}' )
fi
 # æ¸…ç†é•œåƒ
docker image prune -f 

echo '===============å¯åŠ¨å®¹å™¨================'
docker run -d   --net=host -e PARAMS="--spring.profiles.active=prod" --name $JOB_NAME $docker_registry/docker_storage/$JOB_NAME
```

##### 4.4.5 æ„å»ºå®Œæˆä»¥åï¼Œå¯ä»¥ç™»å½•130æœåŠ¡å™¨ï¼ŒæŸ¥çœ‹æ˜¯å¦æœ‰ç›¸å…³çš„é•œåƒå’Œå®¹å™¨

#### 4.5 è”è°ƒæµ‹è¯•

1.å‚è€ƒjenkinsä¸­heima-leadnews-userå¾®æœåŠ¡æŠŠappç«¯ç½‘å…³éƒ¨ç½²èµ·æ¥

2.ä¿®æ”¹æœ¬åœ°nginxä¸­çš„é…ç½®åå‘ä»£ç†åœ°å€ä¸º100è¿™å°æœåŠ¡å™¨ï¼šheima-leadnews-app.conf

```html
upstream  heima-app-gateway{
	server 192.168.200.100:51601;
}
```

3.å¯åŠ¨nginxï¼Œæ‰“å¼€é¡µé¢è¿›è¡Œæµ‹è¯•

### 5. jenkinsè§¦å‘å™¨é…ç½®

#### 5.1 URLè§¦å‘è¿œç¨‹æ„å»º

è§¦å‘è¿œç¨‹æ„å»ºï¼Œä¿®æ”¹jenkinsçš„é…ç½®ï¼Œå¦‚ä¸‹

<div align="center">
    <img src="æˆªå›¾/é¡¹ç›®éƒ¨ç½²_æŒç»­é›†æˆ/URLè§¦å‘.png" alt="URLè§¦å‘" />
</div>

è§¦å‘æ„å»ºurlï¼š http://192.168.200.100:16060/job/leadnews-admin/build?token=88888888

#### 5.2 å…¶ä»–å·¥ç¨‹æ„å»ºåè§¦å‘

é…ç½®éœ€è¦è§¦å‘çš„å·¥ç¨‹

<div align="center">
    <img src="æˆªå›¾/é¡¹ç›®éƒ¨ç½²_æŒç»­é›†æˆ/å…¶ä»–å·¥ç¨‹æ„å»ºè§¦å‘.png" alt="å…¶ä»–å·¥ç¨‹æ„å»ºè§¦å‘" />
</div>

#### 5.3 å®šæ—¶æ„å»º

å®šæ—¶æ„å»ºï¼ˆ Build periodicallyï¼‰

<div align="center">
    <img src="æˆªå›¾/é¡¹ç›®éƒ¨ç½²_æŒç»­é›†æˆ/å®šæ—¶è§¦å‘.png" alt="å®šæ—¶è§¦å‘" />
</div>

å®šæ—¶å­—ç¬¦ä¸²ä»å·¦å¾€å³åˆ†åˆ«ä¸ºï¼š åˆ† æ—¶ æ—¥ æœˆ å‘¨

**å®šæ—¶æ„å»º-å®šæ—¶è¡¨è¾¾å¼**

å®šæ—¶å­—ç¬¦ä¸²ä»å·¦å¾€å³åˆ†åˆ«ä¸ºï¼š åˆ† æ—¶ æ—¥ æœˆ å‘¨

| ç»„æˆéƒ¨åˆ† | å«ä¹‰        | å–å€¼èŒƒå›´                   |
| -------- | ----------- | -------------------------- |
| ç¬¬ä¸€éƒ¨åˆ† | minute (åˆ†) | 0~59                       |
| ç¬¬äºŒéƒ¨åˆ† | hour(å°æ—¶)  | 0~23                       |
| ç¬¬ä¸‰éƒ¨åˆ† | day(å¤©)     | 1~31                       |
| ç¬¬å››éƒ¨åˆ† | month(æœˆ)   | 1~12                       |
| ç¬¬äº”éƒ¨åˆ† | week(å‘¨)    | 0~7ï¼Œ0 å’Œ 7 éƒ½æ˜¯è¡¨ç¤ºæ˜ŸæœŸå¤© |

- ç¬¦å·H è¡¨ç¤ºä¸€ä¸ªéšæœºæ•°

- ç¬¦å·*  å–å€¼èŒƒå›´çš„ä»»æ„å€¼

æ¡ˆä¾‹ï¼š

- æ¯30åˆ†é’Ÿæ„å»ºä¸€æ¬¡ï¼šH/30 * * * * 10:02 10:32

- æ¯2ä¸ªå°æ—¶æ„å»ºä¸€æ¬¡: H H/2 * * *

- æ¯å¤©çš„8ç‚¹ï¼Œ12ç‚¹ï¼Œ22ç‚¹ï¼Œä¸€å¤©æ„å»º3æ¬¡ï¼š (å¤šä¸ªæ—¶é—´ç‚¹ä¸­é—´ç”¨é€—å·éš”å¼€) 0 8,12,22 * * *

- æ¯å¤©ä¸­åˆ12ç‚¹å®šæ—¶æ„å»ºä¸€æ¬¡ H 12 * * *

- æ¯å¤©ä¸‹åˆ18ç‚¹å®šæ—¶æ„å»ºä¸€æ¬¡ H 18 * * *

#### 5.4 è½®è¯¢

è½®è¯¢ SCMï¼ˆPoll SCMï¼‰

è½®è¯¢SCMï¼Œæ˜¯æŒ‡å®šæ—¶æ‰«ææœ¬åœ°ä»£ç ä»“åº“çš„ä»£ç æ˜¯å¦æœ‰å˜æ›´ï¼Œå¦‚æœä»£ç æœ‰å˜æ›´å°±è§¦å‘é¡¹ç›®æ„å»ºã€‚

<div align="center">
    <img src="æˆªå›¾/é¡¹ç›®éƒ¨ç½²_æŒç»­é›†æˆ/è½®è¯¢.png" alt="è½®è¯¢" />
</div>

Jenkinsä¼šå®šæ—¶æ‰«ææœ¬åœ°æ•´ä¸ªé¡¹ç›®çš„ä»£ç ï¼Œå¢å¤§ç³»ç»Ÿçš„å¼€é”€ï¼Œä¸å»ºè®®ä½¿ç”¨ã€‚
