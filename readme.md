- [åŸºäºå¾®æœåŠ¡çš„å¤´æ¡ç±»é¡¹ç›®](#åŸºäºå¾®æœåŠ¡çš„å¤´æ¡ç±»é¡¹ç›®)
  - [ä¸€ã€é¡¹ç›®èƒŒæ™¯ä»‹ç»](#ä¸€é¡¹ç›®èƒŒæ™¯ä»‹ç»)
    - [1. é¡¹ç›®æ¦‚è¿°](#1-é¡¹ç›®æ¦‚è¿°)
    - [2. åŠŸèƒ½æ¶æ„å›¾](#2-åŠŸèƒ½æ¶æ„å›¾)
    - [3. æŠ€æœ¯æ ˆè¯´æ˜](#3-æŠ€æœ¯æ ˆè¯´æ˜)
      - [3.1 åŸºç¡€å±‚](#31-åŸºç¡€å±‚)
      - [3.2 æœåŠ¡å±‚](#32-æœåŠ¡å±‚)
    - [4. é¡¹ç›®ä¸»ä½“ç»“æ„](#4-é¡¹ç›®ä¸»ä½“ç»“æ„)
  - [äºŒã€ç™»å½•åŠŸèƒ½å®ç°](#äºŒç™»å½•åŠŸèƒ½å®ç°)
    - [1. éœ€æ±‚è®¾è®¡](#1-éœ€æ±‚è®¾è®¡)
    - [2. è¡¨ç»“æ„åˆ†æ](#2-è¡¨ç»“æ„åˆ†æ)
    - [3. ap\_userè¡¨ç»“æ„å¦‚ä¸‹ï¼š](#3-ap_userè¡¨ç»“æ„å¦‚ä¸‹)
      - [3.1 ä½¿ç”¨mybais-plusé€†å‘ç”Ÿæˆå¯¹åº”çš„å®ä½“ç±»](#31-ä½¿ç”¨mybais-plusé€†å‘ç”Ÿæˆå¯¹åº”çš„å®ä½“ç±»)
    - [4. æ‰‹åŠ¨åŠ å¯†ï¼ˆmd5+éšæœºå­—ç¬¦ä¸²ï¼‰](#4-æ‰‹åŠ¨åŠ å¯†md5éšæœºå­—ç¬¦ä¸²)
    - [5. æ€è·¯åˆ†æ](#5-æ€è·¯åˆ†æ)
      - [5.1 æ ¸å¿ƒä»£ç ](#51-æ ¸å¿ƒä»£ç )
    - [6.  å…¨å±€è¿‡æ»¤å™¨å®ç°jwtæ ¡éªŒ](#6--å…¨å±€è¿‡æ»¤å™¨å®ç°jwtæ ¡éªŒ)
  - [ä¸‰ã€æ¥å£æµ‹è¯•å·¥å…·postmanã€swaggerã€knife4j](#ä¸‰æ¥å£æµ‹è¯•å·¥å…·postmanswaggerknife4j)
    - [1. postman](#1-postman)
    - [2.swagger](#2swagger)
      - [2.1 Swaggerå¸¸ç”¨æ³¨è§£](#21-swaggerå¸¸ç”¨æ³¨è§£)
      - [2.2 è®¿é—®æ¥å£æ–‡æ¡£](#22-è®¿é—®æ¥å£æ–‡æ¡£)
    - [3. knife4j](#3-knife4j)
      - [3.1 æ ¸å¿ƒåŠŸèƒ½](#31-æ ¸å¿ƒåŠŸèƒ½)
      - [3.2 è®¿é—®æ¥å£æ–‡æ¡£](#32-è®¿é—®æ¥å£æ–‡æ¡£)
  - [å››ã€Nginx](#å››nginx)
  - [äº”ã€æ–‡ç« åˆ—è¡¨åŠ è½½](#äº”æ–‡ç« åˆ—è¡¨åŠ è½½)
    - [1. éœ€æ±‚åˆ†æ](#1-éœ€æ±‚åˆ†æ)
    - [2. è¡¨ç»“æ„åˆ†æ](#2-è¡¨ç»“æ„åˆ†æ-1)
      - [2.1 è¡¨çš„æ‹†åˆ†-å‚ç›´åˆ†è¡¨](#21-è¡¨çš„æ‹†åˆ†-å‚ç›´åˆ†è¡¨)
    - [3. å®ç°æ€è·¯](#3-å®ç°æ€è·¯)
    - [4. æ•°æ®åº“æŸ¥è¯¢](#4-æ•°æ®åº“æŸ¥è¯¢)
    - [5. æ ¸å¿ƒä»£ç ](#5-æ ¸å¿ƒä»£ç )
  - [å…­ã€freemarker](#å…­freemarker)
    - [1. åŸºç¡€è¯­æ³•ç§ç±»](#1-åŸºç¡€è¯­æ³•ç§ç±»)
    - [2. é›†åˆæŒ‡ä»¤ï¼ˆListå’ŒMapï¼‰](#2-é›†åˆæŒ‡ä»¤listå’Œmap)
    - [3. ifæŒ‡ä»¤](#3-ifæŒ‡ä»¤)
    - [4. è¿ç®—ç¬¦](#4-è¿ç®—ç¬¦)
      - [4.1. ç®—æ•°è¿ç®—ç¬¦](#41-ç®—æ•°è¿ç®—ç¬¦)
      - [4.2. æ¯”è¾ƒè¿ç®—ç¬¦](#42-æ¯”è¾ƒè¿ç®—ç¬¦)
      - [4.3. é€»è¾‘è¿ç®—ç¬¦](#43-é€»è¾‘è¿ç®—ç¬¦)
    - [5. ç©ºå€¼å¤„ç†](#5-ç©ºå€¼å¤„ç†)
    - [6. å†…å»ºå‡½æ•°](#6-å†…å»ºå‡½æ•°)
    - [7. é™æ€åŒ–æµ‹è¯•](#7-é™æ€åŒ–æµ‹è¯•)
  - [ä¸ƒã€å¯¹è±¡å­˜å‚¨æœåŠ¡MinIO](#ä¸ƒå¯¹è±¡å­˜å‚¨æœåŠ¡minio)
    - [1. MinIOç®€ä»‹](#1-minioç®€ä»‹)
    - [2. MinIOç‰¹ç‚¹](#2-minioç‰¹ç‚¹)
    - [3. ä½¿ç”¨dockerè¿›è¡Œç¯å¢ƒéƒ¨ç½²å’Œå¯åŠ¨](#3-ä½¿ç”¨dockerè¿›è¡Œç¯å¢ƒéƒ¨ç½²å’Œå¯åŠ¨)
    - [4. æ ¸å¿ƒä»£ç ](#4-æ ¸å¿ƒä»£ç )
  - [å…«ã€æ–‡ç« è¯¦æƒ…](#å…«æ–‡ç« è¯¦æƒ…)
    - [1. éœ€æ±‚åˆ†æ](#1-éœ€æ±‚åˆ†æ-1)
    - [2. å®ç°æ–¹æ¡ˆ](#2-å®ç°æ–¹æ¡ˆ)
    - [3. æ ¸å¿ƒä»£ç ](#3-æ ¸å¿ƒä»£ç )
  - [ä¹ã€è‡ªåª’ä½“æ–‡ç« å‘å¸ƒ](#ä¹è‡ªåª’ä½“æ–‡ç« å‘å¸ƒ)
    - [1. åå°æ­å»º](#1-åå°æ­å»º)
    - [2. å‰å°æ­å»º](#2-å‰å°æ­å»º)
    - [3. è‡ªåª’ä½“ç´ æç®¡ç†](#3-è‡ªåª’ä½“ç´ æç®¡ç†)
      - [3.1 ç´ æä¸Šä¼ ](#31-ç´ æä¸Šä¼ )
        - [3.1.1 éœ€æ±‚åˆ†æ](#311-éœ€æ±‚åˆ†æ)
        - [3.1.2 è¡¨ç»“æ„](#312-è¡¨ç»“æ„)
        - [3.1.3 å®ç°æ€è·¯](#313-å®ç°æ€è·¯)
        - [3.1.4 æ¥å£å®šä¹‰](#314-æ¥å£å®šä¹‰)
        - [3.1.5 æ ¸å¿ƒä»£ç ](#315-æ ¸å¿ƒä»£ç )
      - [3.2 ç´ æåˆ—è¡¨æŸ¥è¯¢](#32-ç´ æåˆ—è¡¨æŸ¥è¯¢)
        - [3.2.1 æ ¸å¿ƒä»£ç ](#321-æ ¸å¿ƒä»£ç )
    - [4. è‡ªåª’ä½“æ–‡ç« ç®¡ç†](#4-è‡ªåª’ä½“æ–‡ç« ç®¡ç†)
      - [4.1 æŸ¥è¯¢æ‰€æœ‰é¢‘é“](#41-æŸ¥è¯¢æ‰€æœ‰é¢‘é“)
        - [4.1.1 éœ€æ±‚åˆ†æ](#411-éœ€æ±‚åˆ†æ)
        - [4.1.2 è¡¨ç»“æ„](#412-è¡¨ç»“æ„)
        - [4.1.3 æ¥å£å®šä¹‰](#413-æ¥å£å®šä¹‰)
        - [4.1.4 æ ¸å¿ƒä»£ç ](#414-æ ¸å¿ƒä»£ç )
      - [4.2 æŸ¥è¯¢è‡ªåª’ä½“æ–‡ç« ](#42-æŸ¥è¯¢è‡ªåª’ä½“æ–‡ç« )
        - [4.2.1 éœ€æ±‚è¯´æ˜](#421-éœ€æ±‚è¯´æ˜)
        - [4.2.2 è¡¨ç»“æ„åˆ†æ](#422-è¡¨ç»“æ„åˆ†æ)
        - [4.2.3 æšä¸¾ç±»](#423-æšä¸¾ç±»)
        - [4.2.4 æ¥å£å®šä¹‰](#424-æ¥å£å®šä¹‰)
        - [4.2.5 æ ¸å¿ƒä»£ç ](#425-æ ¸å¿ƒä»£ç )
      - [4.3 æ–‡ç« å‘å¸ƒ](#43-æ–‡ç« å‘å¸ƒ)
        - [4.3.1 éœ€æ±‚åˆ†æ](#431-éœ€æ±‚åˆ†æ)
        - [4.3.2 è¡¨ç»“æ„åˆ†æ](#432-è¡¨ç»“æ„åˆ†æ)
        - [4.3.3 å®ç°æ€è·¯](#433-å®ç°æ€è·¯)
        - [4.3.4 æ¥å£å®šä¹‰](#434-æ¥å£å®šä¹‰)
        - [4.3.5 æ ¸å¿ƒä»£ç ](#435-æ ¸å¿ƒä»£ç )


# åŸºäºå¾®æœåŠ¡çš„å¤´æ¡ç±»é¡¹ç›®

## ä¸€ã€é¡¹ç›®èƒŒæ™¯ä»‹ç»

### 1. é¡¹ç›®æ¦‚è¿°

&emsp;ç±»ä¼¼äºä»Šæ—¥å¤´æ¡/è…¾è®¯æ–°é—»ï¼Œæ˜¯ä¸€ä¸ªæ–°é—»èµ„è®¯ç±»é¡¹ç›®ã€‚éšç€æ™ºèƒ½æ‰‹æœºçš„æ™®åŠï¼Œäººä»¬æ›´åŠ ä¹ æƒ¯äºé€šè¿‡æ‰‹æœºæ¥çœ‹æ–°é—»ã€‚ç”±äºç”Ÿæ´»èŠ‚å¥çš„åŠ å¿«ï¼Œå¾ˆå¤šäººåªèƒ½åˆ©ç”¨ç¢ç‰‡æ—¶é—´æ¥è·å–ä¿¡æ¯ï¼Œå› æ­¤ï¼Œå¯¹äºç§»åŠ¨èµ„è®¯å®¢æˆ·ç«¯çš„éœ€æ±‚ä¹Ÿè¶Šæ¥è¶Šé«˜ã€‚å¤´æ¡é¡¹ç›®é‡‡ç”¨å½“ä¸‹ç«çƒ­çš„å¾®æœåŠ¡+å¤§æ•°æ®æŠ€æœ¯æ¶æ„å®ç°ã€‚æœ¬é¡¹ç›®ä¸»è¦ç€æ‰‹äºè·å–æœ€æ–°æœ€çƒ­æ–°é—»èµ„è®¯ï¼Œé€šè¿‡å¤§æ•°æ®åˆ†æç”¨æˆ·å–œå¥½ç²¾ç¡®æ¨é€å’¨è¯¢æ–°é—»

### 2. åŠŸèƒ½æ¶æ„å›¾

<div align="center">
    <img src="æˆªå›¾/é¡¹ç›®èƒŒæ™¯ä»‹ç»/åŠŸèƒ½æ¶æ„å›¾.png" alt="åŠŸèƒ½æ¶æ„å›¾" />
</div>

### 3. æŠ€æœ¯æ ˆè¯´æ˜

#### 3.1 åŸºç¡€å±‚

<div align="center">
    <img src="æˆªå›¾/é¡¹ç›®èƒŒæ™¯ä»‹ç»/åŸºç¡€å±‚.png" alt="åŸºç¡€å±‚" />
</div>

#### 3.2 æœåŠ¡å±‚

<div align="center">
    <img src="æˆªå›¾/é¡¹ç›®èƒŒæ™¯ä»‹ç»/æœåŠ¡å±‚.png" alt="æœåŠ¡å±‚" />
</div>

- Spring-Cloud-Gateway : å¾®æœåŠ¡ä¹‹å‰æ¶è®¾çš„ç½‘å…³æœåŠ¡ï¼Œå®ç°æœåŠ¡æ³¨å†Œä¸­çš„APIè¯·æ±‚è·¯ç”±ï¼Œä»¥åŠæ§åˆ¶æµé€Ÿæ§åˆ¶å’Œç†”æ–­å¤„ç†éƒ½æ˜¯å¸¸ç”¨çš„æ¶æ„æ‰‹æ®µï¼Œè€Œè¿™äº›åŠŸèƒ½Gatewayå¤©ç„¶æ”¯æŒ
- è¿ç”¨Spring Bootå¿«é€Ÿå¼€å‘æ¡†æ¶ï¼Œæ„å»ºé¡¹ç›®å·¥ç¨‹ï¼›å¹¶ç»“åˆSpring Cloudå…¨å®¶æ¡¶æŠ€æœ¯ï¼Œå®ç°åç«¯ä¸ªäººä¸­å¿ƒã€è‡ªåª’ä½“ã€ç®¡ç†ä¸­å¿ƒç­‰å¾®æœåŠ¡ã€‚
- è¿ç”¨Spring Cloud Alibaba Nacosä½œä¸ºé¡¹ç›®ä¸­çš„æ³¨å†Œä¸­å¿ƒå’Œé…ç½®ä¸­å¿ƒ
- è¿ç”¨mybatis-plusä½œä¸ºæŒä¹…å±‚æå‡å¼€å‘æ•ˆç‡
- è¿ç”¨Kafkaå®Œæˆå†…éƒ¨ç³»ç»Ÿæ¶ˆæ¯é€šçŸ¥ï¼›ä¸å®¢æˆ·ç«¯ç³»ç»Ÿæ¶ˆæ¯é€šçŸ¥ï¼›ä»¥åŠå®æ—¶æ•°æ®è®¡ç®—
- è¿ç”¨Redisç¼“å­˜æŠ€æœ¯ï¼Œå®ç°çƒ­æ•°æ®çš„è®¡ç®—ï¼Œæå‡ç³»ç»Ÿæ€§èƒ½æŒ‡æ ‡
- ä½¿ç”¨Mysqlå­˜å‚¨ç”¨æˆ·æ•°æ®ï¼Œä»¥ä¿è¯ä¸Šå±‚æ•°æ®æŸ¥è¯¢çš„é«˜æ€§èƒ½
- ä½¿ç”¨Mongoå­˜å‚¨ç”¨æˆ·çƒ­æ•°æ®ï¼Œä»¥ä¿è¯ç”¨æˆ·çƒ­æ•°æ®é«˜æ‰©å±•å’Œé«˜æ€§èƒ½æŒ‡æ ‡
- ä½¿ç”¨FastDFSä½œä¸ºé™æ€èµ„æºå­˜å‚¨å™¨ï¼Œåœ¨å…¶ä¸Šå®ç°çƒ­é™æ€èµ„æºç¼“å­˜ã€æ·˜æ±°ç­‰åŠŸèƒ½
- è¿ç”¨HbaseæŠ€æœ¯ï¼Œå­˜å‚¨ç³»ç»Ÿä¸­çš„å†·æ•°æ®ï¼Œä¿è¯ç³»ç»Ÿæ•°æ®çš„å¯é æ€§
- è¿ç”¨ESæœç´¢æŠ€æœ¯ï¼Œå¯¹å†·æ•°æ®ã€æ–‡ç« æ•°æ®å»ºç«‹ç´¢å¼•ï¼Œä»¥ä¿è¯å†·æ•°æ®ã€æ–‡ç« æŸ¥è¯¢æ€§èƒ½
- è¿ç”¨AIæŠ€æœ¯ï¼Œæ¥å®Œæˆç³»ç»Ÿè‡ªåŠ¨åŒ–åŠŸèƒ½ï¼Œä»¥æå‡æ•ˆç‡åŠèŠ‚çœæˆæœ¬ã€‚æ¯”å¦‚å®åè®¤è¯è‡ªåŠ¨åŒ–
- PMD&P3C : é™æ€ä»£ç æ‰«æå·¥å…·ï¼Œåœ¨é¡¹ç›®ä¸­æ‰«æé¡¹ç›®ä»£ç ï¼Œæ£€æŸ¥å¼‚å¸¸ç‚¹ã€ä¼˜åŒ–ç‚¹ã€ä»£ç è§„èŒƒç­‰ï¼Œä¸ºå¼€å‘å›¢é˜Ÿæä¾›è§„èŒƒç»Ÿä¸€ï¼Œæå‡é¡¹ç›®ä»£ç è´¨é‡

### 4. é¡¹ç›®ä¸»ä½“ç»“æ„

<div align="center">
    <img src="æˆªå›¾/é¡¹ç›®èƒŒæ™¯ä»‹ç»/å·¥ç¨‹ä¸»ä½“ç»“æ„.png" alt="å·¥ç¨‹ä¸»ä½“ç»“æ„" />
</div>



## äºŒã€ç™»å½•åŠŸèƒ½å®ç°

### 1. éœ€æ±‚è®¾è®¡

- ç”¨æˆ·ç‚¹å‡»**å¼€å§‹ä½¿ç”¨**

  ç™»å½•åçš„ç”¨æˆ·æƒé™è¾ƒå¤§ï¼Œå¯ä»¥æŸ¥çœ‹ï¼Œä¹Ÿå¯ä»¥æ“ä½œï¼ˆç‚¹èµï¼Œå…³æ³¨ï¼Œè¯„è®ºï¼‰

- ç”¨æˆ·ç‚¹å‡»**ä¸ç™»å½•ï¼Œå…ˆçœ‹çœ‹**

â€‹       æ¸¸å®¢åªæœ‰æŸ¥çœ‹çš„æƒé™

### 2. è¡¨ç»“æ„åˆ†æ

&emsp;å…³äºappç«¯ç”¨æˆ·ç›¸å…³çš„å†…å®¹è¾ƒå¤šï¼Œå¯ä»¥å•ç‹¬è®¾ç½®ä¸€ä¸ªåº“leadnews_user

| **è¡¨åç§°**       | **è¯´æ˜**          |
| ---------------- | :---------------- |
| ap_user          | APPç”¨æˆ·ä¿¡æ¯è¡¨     |
| ap_user_fan      | APPç”¨æˆ·ç²‰ä¸ä¿¡æ¯è¡¨ |
| ap_user_follow   | APPç”¨æˆ·å…³æ³¨ä¿¡æ¯è¡¨ |
| ap_user_realname | APPå®åè®¤è¯ä¿¡æ¯è¡¨ |

### 3. ap_userè¡¨ç»“æ„å¦‚ä¸‹ï¼š

```mysql
-- auto-generated definition
create table ap_user
(
    id                         int unsigned auto_increment comment 'ä¸»é”®'
        primary key,
    salt                       varchar(32)      null comment 'å¯†ç ã€é€šä¿¡ç­‰åŠ å¯†ç›',
    name                       varchar(20)      null comment 'ç”¨æˆ·å',
    password                   varchar(32)      null comment 'å¯†ç ,md5åŠ å¯†',
    phone                      varchar(11)      null comment 'æ‰‹æœºå·',
    image                      varchar(255)     null comment 'å¤´åƒ',
    sex                        tinyint unsigned null comment '0 ç”·
            1 å¥³
            2 æœªçŸ¥',
    is_certification           tinyint unsigned null comment '0 æœª
            1 æ˜¯',
    is_identity_authentication tinyint(1)       null comment 'æ˜¯å¦èº«ä»½è®¤è¯',
    status                     tinyint unsigned null comment '0æ­£å¸¸
            1é”å®š',
    flag                       tinyint unsigned null comment '0 æ™®é€šç”¨æˆ·
            1 è‡ªåª’ä½“äºº
            2 å¤§V',
    created_time               datetime         null comment 'æ³¨å†Œæ—¶é—´'
)
    comment 'APPç”¨æˆ·ä¿¡æ¯è¡¨' row_format = DYNAMIC;
```

<div align="center">
    <img src="æˆªå›¾/ç™»å½•åŠŸèƒ½å®ç°/tinyint.png" alt="tinyint" />
</div>


#### 3.1 ä½¿ç”¨mybais-plusé€†å‘ç”Ÿæˆå¯¹åº”çš„å®ä½“ç±»

&emsp;é¡¹ç›®ä¸­çš„æŒä¹…å±‚ä½¿ç”¨çš„mybatis-plusï¼Œä¸€èˆ¬éƒ½ä½¿ç”¨mybais-plusé€†å‘ç”Ÿæˆå¯¹åº”çš„å®ä½“ç±»

app_userè¡¨å¯¹åº”çš„å®ä½“ç±»å¦‚ä¸‹ï¼š

```java
package com.heima.model.user.pojos;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableField;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;

import java.io.Serializable;
import java.util.Date;

/**
 * <p>
 * APPç”¨æˆ·ä¿¡æ¯è¡¨
 * </p>
 *
 * @author itheima
 */
@Data
@TableName("ap_user")
public class ApUser implements Serializable {

    private static final long serialVersionUID = 1L;

    /**
     * ä¸»é”®
     */
    @TableId(value = "id", type = IdType.AUTO)
    private Integer id;

    /**
     * å¯†ç ã€é€šä¿¡ç­‰åŠ å¯†ç›
     */
    @TableField("salt")
    private String salt;

    /**
     * ç”¨æˆ·å
     */
    @TableField("name")
    private String name;

    /**
     * å¯†ç ,md5åŠ å¯†
     */
    @TableField("password")
    private String password;

    /**
     * æ‰‹æœºå·
     */
    @TableField("phone")
    private String phone;

    /**
     * å¤´åƒ
     */
    @TableField("image")
    private String image;

    /**
     * 0 ç”·
            1 å¥³
            2 æœªçŸ¥
     */
    @TableField("sex")
    private Boolean sex;

    /**
     * 0 æœª
            1 æ˜¯
     */
    @TableField("is_certification")
    private Boolean certification;

    /**
     * æ˜¯å¦èº«ä»½è®¤è¯
     */
    @TableField("is_identity_authentication")
    private Boolean identityAuthentication;

    /**
     * 0æ­£å¸¸
            1é”å®š
     */
    @TableField("status")
    private Boolean status;

    /**
     * 0 æ™®é€šç”¨æˆ·
            1 è‡ªåª’ä½“äºº
            2 å¤§V
     */
    @TableField("flag")
    private Short flag;

    /**
     * æ³¨å†Œæ—¶é—´
     */
    @TableField("created_time")
    private Date createdTime;

}
```

### 4. æ‰‹åŠ¨åŠ å¯†ï¼ˆmd5+éšæœºå­—ç¬¦ä¸²ï¼‰

&emsp;md5æ˜¯ä¸å¯é€†åŠ å¯†ï¼Œmd5ç›¸åŒçš„å¯†ç æ¯æ¬¡åŠ å¯†éƒ½ä¸€æ ·ï¼Œä¸å¤ªå®‰å…¨ã€‚åœ¨md5çš„åŸºç¡€ä¸Šæ‰‹åŠ¨åŠ ç›ï¼ˆsaltï¼‰å¤„ç†

æ³¨å†Œ->ç”Ÿæˆç›

<div align="center">
    <img src="æˆªå›¾/ç™»å½•åŠŸèƒ½å®ç°/æ³¨å†Œ.png" alt="æ³¨å†Œ" />
</div>


ç™»å½•->ä½¿ç”¨ç›æ¥é…åˆéªŒè¯

<div align="center">
    <img src="æˆªå›¾/ç™»å½•åŠŸèƒ½å®ç°/ç™»å½•.png" alt="ç™»å½•" />
</div>


### 5. æ€è·¯åˆ†æ

<div align="center">
    <img src="æˆªå›¾/ç™»å½•åŠŸèƒ½å®ç°/æ€è·¯åˆ†æ.png" alt="æ€è·¯åˆ†æ" />
</div>


1. ç”¨æˆ·è¾“å…¥äº†ç”¨æˆ·åå’Œå¯†ç è¿›è¡Œç™»å½•ï¼Œæ ¡éªŒæˆåŠŸåè¿”å›jwt**(åŸºäºå½“å‰ç”¨æˆ·çš„idç”Ÿæˆï¼Œæ•°æ®åº“idå¿…å¤§äº0)**

2. ç”¨æˆ·æ¸¸å®¢ç™»å½•ï¼Œç”Ÿæˆjwtè¿”å›**(åŸºäºé»˜è®¤å€¼0ç”Ÿæˆ)**

#### 5.1 æ ¸å¿ƒä»£ç 

```java
package com.heima.user.service.impl;

import com.baomidou.mybatisplus.core.toolkit.Wrappers;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.heima.model.common.dtos.ResponseResult;
import com.heima.model.common.enums.AppHttpCodeEnum;
import com.heima.model.user.dtos.LoginDto;
import com.heima.model.user.pojos.ApUser;
import com.heima.user.mapper.ApUserMapper;
import com.heima.user.service.ApUserService;
import com.heima.utils.common.AppJwtUtil;
import org.apache.commons.lang3.StringUtils;
import org.springframework.stereotype.Service;
import org.springframework.util.DigestUtils;

import java.util.HashMap;
import java.util.Map;


@Service
public class ApUserServiceImpl extends ServiceImpl<ApUserMapper, ApUser> implements ApUserService {

    @Override
    public ResponseResult login(LoginDto dto) {

        //1.æ­£å¸¸ç™»å½•ï¼ˆæ‰‹æœºå·+å¯†ç ç™»å½•ï¼‰
        if (!StringUtils.isBlank(dto.getPhone()) && !StringUtils.isBlank(dto.getPassword())) {
            //1.1æŸ¥è¯¢ç”¨æˆ·
            ApUser apUser = getOne(Wrappers.<ApUser>lambdaQuery().eq(ApUser::getPhone, dto.getPhone()));
            if (apUser == null) {
                return ResponseResult.errorResult(AppHttpCodeEnum.DATA_NOT_EXIST,"ç”¨æˆ·ä¸å­˜åœ¨");
            }

            //1.2 æ¯”å¯¹å¯†ç 
            String salt = apUser.getSalt();
            String pswd = dto.getPassword();
            pswd = DigestUtils.md5DigestAsHex((pswd + salt).getBytes());
            if (!pswd.equals(apUser.getPassword())) {
                return ResponseResult.errorResult(AppHttpCodeEnum.LOGIN_PASSWORD_ERROR);
            }
            //1.3 è¿”å›æ•°æ®  jwt
            Map<String, Object> map = new HashMap<>();
            map.put("token", AppJwtUtil.getToken(apUser.getId().longValue()));
            apUser.setSalt("");
            apUser.setPassword("");
            map.put("user", apUser);
            return ResponseResult.okResult(map);
        } else {
            //2.æ¸¸å®¢  åŒæ ·è¿”å›token  id = 0
            Map<String, Object> map = new HashMap<>();
            map.put("token", AppJwtUtil.getToken(0l));
            return ResponseResult.okResult(map);
        }
    }
}
```

### 6.  å…¨å±€è¿‡æ»¤å™¨å®ç°jwtæ ¡éªŒ

<div align="center">
    <img src="æˆªå›¾/ç™»å½•åŠŸèƒ½å®ç°/å…¨å±€è¿‡æ»¤å™¨å®ç°jwtæ ¡éªŒ.png" alt="å…¨å±€è¿‡æ»¤å™¨å®ç°jwtæ ¡éªŒ" />
</div>

æ€è·¯åˆ†æï¼š

1. ç”¨æˆ·è¿›å…¥ç½‘å…³å¼€å§‹ç™»é™†ï¼Œç½‘å…³è¿‡æ»¤å™¨è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœæ˜¯ç™»å½•ï¼Œåˆ™è·¯ç”±åˆ°åå°ç®¡ç†å¾®æœåŠ¡è¿›è¡Œç™»å½•
2. ç”¨æˆ·ç™»å½•æˆåŠŸï¼Œåå°ç®¡ç†å¾®æœåŠ¡ç­¾å‘JWT TOKENä¿¡æ¯è¿”å›ç»™ç”¨æˆ·
3. ç”¨æˆ·å†æ¬¡è¿›å…¥ç½‘å…³å¼€å§‹è®¿é—®ï¼Œç½‘å…³è¿‡æ»¤å™¨æ¥æ”¶ç”¨æˆ·æºå¸¦çš„TOKEN 
4. ç½‘å…³è¿‡æ»¤å™¨è§£æTOKEN ï¼Œåˆ¤æ–­æ˜¯å¦æœ‰æƒé™ï¼Œå¦‚æœæœ‰ï¼Œåˆ™æ”¾è¡Œï¼Œå¦‚æœæ²¡æœ‰åˆ™è¿”å›æœªè®¤è¯é”™è¯¯

å…·ä½“å®ç°ï¼š

1. åœ¨è®¤è¯è¿‡æ»¤å™¨ä¸­éœ€è¦ç”¨åˆ°jwtçš„è§£æï¼Œæ‰€ä»¥éœ€è¦æŠŠå·¥å…·ç±»æ‹·è´ä¸€ä»½åˆ°ç½‘å…³å¾®æœåŠ¡

2. åœ¨ç½‘å…³å¾®æœåŠ¡ä¸­æ–°å»ºå…¨å±€è¿‡æ»¤å™¨ï¼š

```java
package com.heima.app.gateway.filter;


import com.heima.app.gateway.util.AppJwtUtil;
import io.jsonwebtoken.Claims;
import lombok.extern.slf4j.Slf4j;
import org.apache.commons.lang.StringUtils;
import org.springframework.cloud.gateway.filter.GatewayFilterChain;
import org.springframework.cloud.gateway.filter.GlobalFilter;
import org.springframework.core.Ordered;
import org.springframework.http.HttpStatus;
import org.springframework.http.server.reactive.ServerHttpRequest;
import org.springframework.http.server.reactive.ServerHttpResponse;
import org.springframework.stereotype.Component;
import org.springframework.web.server.ServerWebExchange;
import reactor.core.publisher.Mono;

@Component
@Slf4j
public class AuthorizeFilter implements Ordered, GlobalFilter {
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        //1.è·å–requestå’Œresponseå¯¹è±¡
        ServerHttpRequest request = exchange.getRequest();
        ServerHttpResponse response = exchange.getResponse();

        //2.åˆ¤æ–­æ˜¯å¦æ˜¯ç™»å½•
        if(request.getURI().getPath().contains("/login")){
            //æ”¾è¡Œ
            return chain.filter(exchange);
        }


        //3.è·å–token
        String token = request.getHeaders().getFirst("token");

        //4.åˆ¤æ–­tokenæ˜¯å¦å­˜åœ¨
        if(StringUtils.isBlank(token)){
            response.setStatusCode(HttpStatus.UNAUTHORIZED);
            return response.setComplete();
        }

        //5.åˆ¤æ–­tokenæ˜¯å¦æœ‰æ•ˆ
        try {
            Claims claimsBody = AppJwtUtil.getClaimsBody(token);
            //æ˜¯å¦æ˜¯è¿‡æœŸ
            int result = AppJwtUtil.verifyToken(claimsBody);
            if(result == 1 || result  == 2){
                response.setStatusCode(HttpStatus.UNAUTHORIZED);
                return response.setComplete();
            }
        }catch (Exception e){
            e.printStackTrace();
            response.setStatusCode(HttpStatus.UNAUTHORIZED);
            return response.setComplete();
        }

        //6.æ”¾è¡Œ
        return chain.filter(exchange);
    }

    /**
     * ä¼˜å…ˆçº§è®¾ç½®  å€¼è¶Šå°  ä¼˜å…ˆçº§è¶Šé«˜
     * @return
     */
    @Override
    public int getOrder() {
        return 0;
    }
}
```



## ä¸‰ã€æ¥å£æµ‹è¯•å·¥å…·postmanã€swaggerã€knife4j

### 1. postman

&emsp;Postmanæ˜¯ä¸€æ¬¾åŠŸèƒ½å¼ºå¤§çš„ç½‘é¡µè°ƒè¯•ä¸å‘é€ç½‘é¡µHTTPè¯·æ±‚çš„Chromeæ’ä»¶ã€‚postmanè¢«500ä¸‡å¼€å‘è€…å’Œè¶…100,000å®¶å…¬å¸ç”¨äºæ¯æœˆè®¿é—®1.3äº¿ä¸ªAPIã€‚å®˜æ–¹ç½‘å€ï¼šhttps://www.postman.com/

### 2.swagger

&emsp;Swagger æ˜¯ä¸€ä¸ªè§„èŒƒå’Œå®Œæ•´çš„æ¡†æ¶ï¼Œç”¨äºç”Ÿæˆã€æè¿°ã€è°ƒç”¨å’Œå¯è§†åŒ– RESTful é£æ ¼çš„ Web æœåŠ¡(<https://swagger.io/>)ã€‚ å®ƒçš„ä¸»è¦ä½œç”¨æ˜¯ï¼š

1. ä½¿å¾—å‰åç«¯åˆ†ç¦»å¼€å‘æ›´åŠ æ–¹ä¾¿ï¼Œæœ‰åˆ©äºå›¢é˜Ÿåä½œ

2. æ¥å£çš„æ–‡æ¡£åœ¨çº¿è‡ªåŠ¨ç”Ÿæˆï¼Œé™ä½åç«¯å¼€å‘äººå‘˜ç¼–å†™æ¥å£æ–‡æ¡£çš„è´Ÿæ‹…

3. åŠŸèƒ½æµ‹è¯•ï¼šSpringå·²ç»å°†Swaggerçº³å…¥è‡ªèº«çš„æ ‡å‡†ï¼Œå»ºç«‹äº†Spring-swaggeré¡¹ç›®ï¼Œç°åœ¨å«Springfoxã€‚é€šè¿‡åœ¨é¡¹ç›®ä¸­å¼•å…¥Springfox ï¼Œå³å¯éå¸¸ç®€å•å¿«æ·çš„ä½¿ç”¨Swaggerã€‚


#### 2.1 Swaggerå¸¸ç”¨æ³¨è§£

åœ¨Javaç±»ä¸­æ·»åŠ Swaggerçš„æ³¨è§£å³å¯ç”ŸæˆSwaggeræ¥å£æ–‡æ¡£ï¼Œå¸¸ç”¨Swaggeræ³¨è§£å¦‚ä¸‹ï¼š

@Apiï¼šä¿®é¥°æ•´ä¸ªç±»ï¼Œæè¿°Controllerçš„ä½œç”¨  

@ApiOperationï¼šæè¿°ä¸€ä¸ªç±»çš„ä¸€ä¸ªæ–¹æ³•ï¼Œæˆ–è€…è¯´ä¸€ä¸ªæ¥å£  

@ApiParamï¼šå•ä¸ªå‚æ•°çš„æè¿°ä¿¡æ¯  

@ApiModelï¼šç”¨å¯¹è±¡æ¥æ¥æ”¶å‚æ•°  

@ApiModelPropertyï¼šç”¨å¯¹è±¡æ¥æ”¶å‚æ•°æ—¶ï¼Œæè¿°å¯¹è±¡çš„ä¸€ä¸ªå­—æ®µ  

@ApiResponseï¼šHTTPå“åº”å…¶ä¸­1ä¸ªæè¿°  

@ApiResponsesï¼šHTTPå“åº”æ•´ä½“æè¿°  

@ApiIgnoreï¼šä½¿ç”¨è¯¥æ³¨è§£å¿½ç•¥è¿™ä¸ªAPI  

@ApiError ï¼šå‘ç”Ÿé”™è¯¯è¿”å›çš„ä¿¡æ¯  

@ApiImplicitParamï¼šä¸€ä¸ªè¯·æ±‚å‚æ•°  

@ApiImplicitParamsï¼šå¤šä¸ªè¯·æ±‚å‚æ•°çš„æè¿°ä¿¡æ¯

#### 2.2 è®¿é—®æ¥å£æ–‡æ¡£

&emsp;å¯åŠ¨userå¾®æœåŠ¡ï¼Œè®¿é—®åœ°å€ï¼šhttp://localhost:port/swagger-ui.html

### 3. knife4j

&emsp;knife4jæ˜¯ä¸ºJava MVCæ¡†æ¶é›†æˆSwaggerç”ŸæˆApiæ–‡æ¡£çš„å¢å¼ºè§£å†³æ–¹æ¡ˆ,å‰èº«æ˜¯swagger-bootstrap-ui,å–åkni4jæ˜¯å¸Œæœ›å®ƒèƒ½åƒä¸€æŠŠåŒ•é¦–ä¸€æ ·å°å·§,è½»é‡,å¹¶ä¸”åŠŸèƒ½å¼ºæ‚!

giteeåœ°å€ï¼šhttps://gitee.com/xiaoym/knife4j

å®˜æ–¹æ–‡æ¡£ï¼šhttps://doc.xiaominfo.com/

æ•ˆæœæ¼”ç¤ºï¼šhttp://knife4j.xiaominfo.com/doc.html

#### 3.1 æ ¸å¿ƒåŠŸèƒ½

è¯¥UIå¢å¼ºåŒ…ä¸»è¦åŒ…æ‹¬ä¸¤å¤§æ ¸å¿ƒåŠŸèƒ½ï¼šæ–‡æ¡£è¯´æ˜ å’Œ åœ¨çº¿è°ƒè¯•

- æ–‡æ¡£è¯´æ˜ï¼šæ ¹æ®Swaggerçš„è§„èŒƒè¯´æ˜ï¼Œè¯¦ç»†åˆ—å‡ºæ¥å£æ–‡æ¡£çš„è¯´æ˜ï¼ŒåŒ…æ‹¬æ¥å£åœ°å€ã€ç±»å‹ã€è¯·æ±‚ç¤ºä¾‹ã€è¯·æ±‚å‚æ•°ã€å“åº”ç¤ºä¾‹ã€å“åº”å‚æ•°ã€å“åº”ç ç­‰ä¿¡æ¯ï¼Œä½¿ç”¨swagger-bootstrap-uièƒ½æ ¹æ®è¯¥æ–‡æ¡£è¯´æ˜ï¼Œå¯¹è¯¥æ¥å£çš„ä½¿ç”¨æƒ…å†µä¸€ç›®äº†ç„¶ã€‚
- åœ¨çº¿è°ƒè¯•ï¼šæä¾›åœ¨çº¿æ¥å£è”è°ƒçš„å¼ºå¤§åŠŸèƒ½ï¼Œè‡ªåŠ¨è§£æå½“å‰æ¥å£å‚æ•°,åŒæ—¶åŒ…å«è¡¨å•éªŒè¯ï¼Œè°ƒç”¨å‚æ•°å¯è¿”å›æ¥å£å“åº”å†…å®¹ã€headersã€Curlè¯·æ±‚å‘½ä»¤å®ä¾‹ã€å“åº”æ—¶é—´ã€å“åº”çŠ¶æ€ç ç­‰ä¿¡æ¯ï¼Œå¸®åŠ©å¼€å‘è€…åœ¨çº¿è°ƒè¯•ï¼Œè€Œä¸å¿…é€šè¿‡å…¶ä»–æµ‹è¯•å·¥å…·æµ‹è¯•æ¥å£æ˜¯å¦æ­£ç¡®ï¼Œç®€æ´ã€å¼ºå¤§ã€‚
- ä¸ªæ€§åŒ–é…ç½®ï¼šé€šè¿‡ä¸ªæ€§åŒ–uié…ç½®é¡¹ï¼Œå¯è‡ªå®šä¹‰UIçš„ç›¸å…³æ˜¾ç¤ºä¿¡æ¯
- ç¦»çº¿æ–‡æ¡£ï¼šæ ¹æ®æ ‡å‡†è§„èŒƒï¼Œç”Ÿæˆçš„åœ¨çº¿markdownç¦»çº¿æ–‡æ¡£ï¼Œå¼€å‘è€…å¯ä»¥è¿›è¡Œæ‹·è´ç”Ÿæˆmarkdownæ¥å£æ–‡æ¡£ï¼Œé€šè¿‡å…¶ä»–ç¬¬ä¸‰æ–¹markdownè½¬æ¢å·¥å…·è½¬æ¢æˆhtmlæˆ–pdfï¼Œè¿™æ ·ä¹Ÿå¯ä»¥æ”¾å¼ƒswagger2markdownç»„ä»¶
- æ¥å£æ’åºï¼šè‡ª1.8.5åï¼Œuiæ”¯æŒäº†æ¥å£æ’åºåŠŸèƒ½ï¼Œä¾‹å¦‚ä¸€ä¸ªæ³¨å†ŒåŠŸèƒ½ä¸»è¦åŒ…å«äº†å¤šä¸ªæ­¥éª¤,å¯ä»¥æ ¹æ®swagger-bootstrap-uiæä¾›çš„æ¥å£æ’åºè§„åˆ™å®ç°æ¥å£çš„æ’åºï¼ŒstepåŒ–æ¥å£æ“ä½œï¼Œæ–¹ä¾¿å…¶ä»–å¼€å‘è€…è¿›è¡Œæ¥å£å¯¹æ¥

#### 3.2 è®¿é—®æ¥å£æ–‡æ¡£

&emsp;åœ¨æµè§ˆå™¨è¾“å…¥åœ°å€ï¼š`http://host:port/doc.html`

## å››ã€Nginx

<div align="center">
    <img src="æˆªå›¾/ç™»å½•åŠŸèƒ½å®ç°/nginx.png" alt="nginx" />
</div>

é€šè¿‡nginxæ¥è¿›è¡Œé…ç½®ï¼ŒåŠŸèƒ½å¦‚ä¸‹

- é€šè¿‡nginxçš„**åå‘ä»£ç†**åŠŸèƒ½è®¿é—®åå°çš„ç½‘å…³èµ„æº
- é€šè¿‡nginxçš„**é™æ€æœåŠ¡å™¨**åŠŸèƒ½è®¿é—®å‰ç«¯é™æ€é¡µé¢

## äº”ã€æ–‡ç« åˆ—è¡¨åŠ è½½

### 1. éœ€æ±‚åˆ†æ

æ–‡ç« å¸ƒå±€å±•ç¤º

<div align="center">
    <img src="æˆªå›¾/æ–‡ç« åˆ—è¡¨åŠ è½½/æ–‡ç« å¸ƒå±€å±•ç¤º.png" alt="æ–‡ç« å¸ƒå±€å±•ç¤º" />
</div>

### 2. è¡¨ç»“æ„åˆ†æ

ap_article  æ–‡ç« åŸºæœ¬ä¿¡æ¯è¡¨

```mysql
-- auto-generated definition
create table ap_article
(
    id           bigint unsigned auto_increment
        primary key,
    title        varchar(50)                  null comment 'æ ‡é¢˜',
    author_id    int unsigned                 null comment 'æ–‡ç« ä½œè€…çš„ID',
    author_name  varchar(20)                  null comment 'ä½œè€…æ˜µç§°',
    channel_id   int unsigned                 null comment 'æ–‡ç« æ‰€å±é¢‘é“ID',
    channel_name varchar(10)                  null comment 'é¢‘é“åç§°',
    layout       tinyint unsigned             null comment 'æ–‡ç« å¸ƒå±€
            0 æ— å›¾æ–‡ç« 
            1 å•å›¾æ–‡ç« 
            2 å¤šå›¾æ–‡ç« ',
    flag         tinyint unsigned             null comment 'æ–‡ç« æ ‡è®°
            0 æ™®é€šæ–‡ç« 
            1 çƒ­ç‚¹æ–‡ç« 
            2 ç½®é¡¶æ–‡ç« 
            3 ç²¾å“æ–‡ç« 
            4 å¤§V æ–‡ç« ',
    images       varchar(1000)                null comment 'æ–‡ç« å›¾ç‰‡
            å¤šå¼ é€—å·åˆ†éš”',
    labels       varchar(500)                 null comment 'æ–‡ç« æ ‡ç­¾æœ€å¤š3ä¸ª é€—å·åˆ†éš”',
    likes        int unsigned                 null comment 'ç‚¹èµæ•°é‡',
    collection   int unsigned                 null comment 'æ”¶è—æ•°é‡',
    comment      int unsigned                 null comment 'è¯„è®ºæ•°é‡',
    views        int unsigned                 null comment 'é˜…è¯»æ•°é‡',
    province_id  int unsigned                 null comment 'çœå¸‚',
    city_id      int unsigned                 null comment 'å¸‚åŒº',
    county_id    int unsigned                 null comment 'åŒºå¿',
    created_time datetime                     null comment 'åˆ›å»ºæ—¶é—´',
    publish_time datetime                     null comment 'å‘å¸ƒæ—¶é—´',
    sync_status  tinyint(1)       default 0   null comment 'åŒæ­¥çŠ¶æ€',
    origin       tinyint unsigned default '0' null comment 'æ¥æº',
    static_url   varchar(150)                 null
)
    comment 'æ–‡ç« ä¿¡æ¯è¡¨ï¼Œå­˜å‚¨å·²å‘å¸ƒçš„æ–‡ç« ' row_format = DYNAMIC;
```

ap_article_config  æ–‡ç« é…ç½®è¡¨

```mysql
-- auto-generated definition
create table ap_article_config
(
    id         bigint unsigned auto_increment comment 'ä¸»é”®'
        primary key,
    article_id bigint unsigned  null comment 'æ–‡ç« ID',
    is_comment tinyint unsigned null comment 'æ˜¯å¦å¯è¯„è®º',
    is_forward tinyint unsigned null comment 'æ˜¯å¦è½¬å‘',
    is_down    tinyint unsigned null comment 'æ˜¯å¦ä¸‹æ¶',
    is_delete  tinyint unsigned null comment 'æ˜¯å¦å·²åˆ é™¤'
)
    comment 'APPå·²å‘å¸ƒæ–‡ç« é…ç½®è¡¨' row_format = DYNAMIC;

create index idx_article_id
    on ap_article_config (article_id);
```

ap_article_content æ–‡ç« å†…å®¹è¡¨

```mysql
-- auto-generated definition
create table ap_article_content
(
    id         bigint unsigned auto_increment comment 'ä¸»é”®'
        primary key,
    article_id bigint unsigned null comment 'æ–‡ç« ID',
    content    longtext        null comment 'æ–‡ç« å†…å®¹'
)
    comment 'APPå·²å‘å¸ƒæ–‡ç« å†…å®¹è¡¨' row_format = DYNAMIC;

create index idx_article_id
    on ap_article_content (article_id);
```

ä¸‰å¼ è¡¨å…³ç³»åˆ†æ

<div align="center">
    <img src="æˆªå›¾/æ–‡ç« åˆ—è¡¨åŠ è½½/ä¸‰è¡¨å…³ç³».png" alt="ä¸‰è¡¨å…³ç³»" />
</div>
#### 2.1 è¡¨çš„æ‹†åˆ†-å‚ç›´åˆ†è¡¨

&emsp;å‚ç›´åˆ†è¡¨ï¼šå°†ä¸€ä¸ªè¡¨çš„å­—æ®µåˆ†æ•£åˆ°å¤šä¸ªè¡¨ä¸­ï¼Œæ¯ä¸ªè¡¨å­˜å‚¨å…¶ä¸­ä¸€éƒ¨åˆ†å­—æ®µã€‚

ä¼˜åŠ¿ï¼š

1. å‡å°‘IOäº‰æŠ¢ï¼Œå‡å°‘é”è¡¨çš„å‡ ç‡ï¼ŒæŸ¥çœ‹æ–‡ç« æ¦‚è¿°ä¸æ–‡ç« è¯¦æƒ…äº’ä¸å½±å“
2. å……åˆ†å‘æŒ¥é«˜é¢‘æ•°æ®çš„æ“ä½œæ•ˆç‡ï¼Œå¯¹æ–‡ç« æ¦‚è¿°æ•°æ®æ“ä½œçš„é«˜æ•ˆç‡ä¸ä¼šè¢«æ“ä½œæ–‡ç« è¯¦æƒ…æ•°æ®çš„ä½æ•ˆç‡æ‰€æ‹–ç´¯

æ‹†åˆ†åŸåˆ™ï¼š

1. æŠŠä¸å¸¸ç”¨çš„å­—æ®µå•ç‹¬æ”¾åœ¨ä¸€å¼ è¡¨
2. æŠŠtextï¼Œblobç­‰å¤§å­—æ®µæ‹†åˆ†å‡ºæ¥å•ç‹¬æ”¾åœ¨ä¸€å¼ è¡¨
3. ç»å¸¸ç»„åˆæŸ¥è¯¢çš„å­—æ®µå•ç‹¬æ”¾åœ¨ä¸€å¼ è¡¨ä¸­

### 3. å®ç°æ€è·¯

<div align="center">
    <img src="æˆªå›¾/æ–‡ç« åˆ—è¡¨åŠ è½½/å®ç°æ€è·¯.png" alt="å®ç°æ€è·¯" />
</div>

1. åœ¨é»˜è®¤é¢‘é“å±•ç¤º10æ¡æ–‡ç« ä¿¡æ¯

2. å¯ä»¥åˆ‡æ¢é¢‘é“æŸ¥çœ‹ä¸åŒç§ç±»æ–‡ç« 

3. å½“ç”¨æˆ·ä¸‹æ‹‰å¯ä»¥åŠ è½½æœ€æ–°çš„æ–‡ç« ï¼ˆåˆ†é¡µï¼‰æœ¬é¡µæ–‡ç« åˆ—è¡¨ä¸­å‘å¸ƒæ—¶é—´ä¸ºæœ€å¤§çš„æ—¶é—´ä¸ºä¾æ®

4. å½“ç”¨æˆ·ä¸Šæ‹‰å¯ä»¥åŠ è½½æ›´å¤šçš„æ–‡ç« ä¿¡æ¯ï¼ˆæŒ‰ç…§å‘å¸ƒæ—¶é—´ï¼‰æœ¬é¡µæ–‡ç« åˆ—è¡¨ä¸­å‘å¸ƒæ—¶é—´æœ€å°çš„æ—¶é—´ä¸ºä¾æ®

5. å¦‚æœæ˜¯å½“å‰é¢‘é“çš„é¦–é¡µï¼Œå‰ç«¯ä¼ é€’é»˜è®¤å‚æ•°ï¼š

- maxBehotTimeï¼š0ï¼ˆæ¯«ç§’ï¼‰

- minBehotTimeï¼š20000000000000ï¼ˆæ¯«ç§’ï¼‰--->2063å¹´

### 4. æ•°æ®åº“æŸ¥è¯¢

Mapperæ¥å£å¯¹åº”çš„æ˜ å°„æ–‡ä»¶

åœ¨resourcesä¸­æ–°å»ºmapper/ApArticleMapper.xml     å¦‚ä¸‹é…ç½®ï¼š

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.heima.article.mapper.ApArticleMapper">

    <resultMap id="resultMap" type="com.heima.model.article.pojos.ApArticle">
        <id column="id" property="id"/>
        <result column="title" property="title"/>
        <result column="author_id" property="authorId"/>
        <result column="author_name" property="authorName"/>
        <result column="channel_id" property="channelId"/>
        <result column="channel_name" property="channelName"/>
        <result column="layout" property="layout"/>
        <result column="flag" property="flag"/>
        <result column="images" property="images"/>
        <result column="labels" property="labels"/>
        <result column="likes" property="likes"/>
        <result column="collection" property="collection"/>
        <result column="comment" property="comment"/>
        <result column="views" property="views"/>
        <result column="province_id" property="provinceId"/>
        <result column="city_id" property="cityId"/>
        <result column="county_id" property="countyId"/>
        <result column="created_time" property="createdTime"/>
        <result column="publish_time" property="publishTime"/>
        <result column="sync_status" property="syncStatus"/>
        <result column="static_url" property="staticUrl"/>
    </resultMap>
    <select id="loadArticleList" resultMap="resultMap">
        SELECT
        aa.*
        FROM
        `ap_article` aa
        LEFT JOIN ap_article_config aac ON aa.id = aac.article_id
        <where>
            and aac.is_delete != 1
            and aac.is_down != 1
            <!-- loadmore -->
            <if test="type != null and type == 1">
                and aa.publish_time <![CDATA[<]]> #{dto.minBehotTime}
            </if>
            <!-- loadnew -->
            <if test="type != null and type == 2">
                and aa.publish_time <![CDATA[>]]> #{dto.maxBehotTime}
            </if>
            <if test="dto.tag != '__all__'">
                and aa.channel_id = #{dto.tag}
            </if>
        </where>
        order by aa.publish_time desc
        limit #{dto.size}
    </select>

</mapper>
```

### 5. æ ¸å¿ƒä»£ç 

```java
package com.heima.article.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.heima.article.mapper.ApArticleMapper;
import com.heima.article.service.ApArticleService;
import com.heima.common.constants.ArticleConstants;
import com.heima.model.article.dtos.ArticleHomeDto;

import com.heima.model.article.pojos.ApArticle;
import com.heima.model.common.dtos.ResponseResult;
import lombok.extern.slf4j.Slf4j;
import org.apache.commons.lang3.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.Date;
import java.util.List;


@Service
@Transactional
@Slf4j
public class ApArticleServiceImpl  extends ServiceImpl<ApArticleMapper, ApArticle> implements ApArticleService {

    // å•é¡µæœ€å¤§åŠ è½½çš„æ•°å­—
    private final static short MAX_PAGE_SIZE = 50;

    @Autowired
    private ApArticleMapper apArticleMapper;

    /**
     * æ ¹æ®å‚æ•°åŠ è½½æ–‡ç« åˆ—è¡¨
     * @param loadtype 1ä¸ºåŠ è½½æ›´å¤š  2ä¸ºåŠ è½½æœ€æ–°
     * @param dto
     * @return
     */
    @Override
    public ResponseResult load(Short loadtype, ArticleHomeDto dto) {
        //1.æ ¡éªŒå‚æ•°
        Integer size = dto.getSize();
        if(size == null || size == 0){
            size = 10;
        }
        size = Math.min(size,MAX_PAGE_SIZE);
        dto.setSize(size);

        //ç±»å‹å‚æ•°æ£€éªŒ
        if(!loadtype.equals(ArticleConstants.LOADTYPE_LOAD_MORE)&&!loadtype.equals(ArticleConstants.LOADTYPE_LOAD_NEW)){
            loadtype = ArticleConstants.LOADTYPE_LOAD_MORE;
        }
        //æ–‡ç« é¢‘é“æ ¡éªŒ
        if(StringUtils.isEmpty(dto.getTag())){
            dto.setTag(ArticleConstants.DEFAULT_TAG);
        }

        //æ—¶é—´æ ¡éªŒ
        if(dto.getMaxBehotTime() == null) dto.setMaxBehotTime(new Date());
        if(dto.getMinBehotTime() == null) dto.setMinBehotTime(new Date());
        //2.æŸ¥è¯¢æ•°æ®
        List<ApArticle> apArticles = apArticleMapper.loadArticleList(dto, loadtype);

        //3.ç»“æœå°è£…
        ResponseResult responseResult = ResponseResult.okResult(apArticles);
        return responseResult;
    }
    
}
```

å®šä¹‰å¸¸é‡ç±»

```java
package com.heima.common.constants;

public class ArticleConstants {
    public static final Short LOADTYPE_LOAD_MORE = 1;
    public static final Short LOADTYPE_LOAD_NEW = 2;
    public static final String DEFAULT_TAG = "__all__";

}
```

## å…­ã€freemarker

&emsp;FreeMarker æ˜¯ä¸€æ¬¾**æ¨¡æ¿å¼•æ“**ï¼š å³ä¸€ç§åŸºäºæ¨¡æ¿å’Œè¦æ”¹å˜çš„æ•°æ®ï¼Œ å¹¶ç”¨æ¥ç”Ÿæˆè¾“å‡ºæ–‡æœ¬(HTMLç½‘é¡µï¼Œç”µå­é‚®ä»¶ï¼Œé…ç½®æ–‡ä»¶ï¼Œæºä»£ç ç­‰)çš„é€šç”¨å·¥å…·ã€‚ å®ƒä¸æ˜¯é¢å‘æœ€ç»ˆç”¨æˆ·çš„ï¼Œè€Œæ˜¯ä¸€ä¸ªJavaç±»åº“ï¼Œæ˜¯ä¸€æ¬¾ç¨‹åºå‘˜å¯ä»¥åµŒå…¥ä»–ä»¬æ‰€å¼€å‘äº§å“çš„ç»„ä»¶ã€‚

&emsp;æ¨¡æ¿ç¼–å†™ä¸ºFreeMarker Template Language (FTL)ã€‚å®ƒæ˜¯ç®€å•çš„ï¼Œä¸“ç”¨çš„è¯­è¨€ï¼Œ *ä¸æ˜¯* åƒPHPé‚£æ ·æˆç†Ÿçš„ç¼–ç¨‹è¯­è¨€ã€‚ é‚£å°±æ„å‘³ç€è¦å‡†å¤‡æ•°æ®åœ¨çœŸå®ç¼–ç¨‹è¯­è¨€ä¸­æ¥æ˜¾ç¤ºï¼Œæ¯”å¦‚æ•°æ®åº“æŸ¥è¯¢å’Œä¸šåŠ¡è¿ç®—ï¼Œ ä¹‹åæ¨¡æ¿æ˜¾ç¤ºå·²ç»å‡†å¤‡å¥½çš„æ•°æ®ã€‚åœ¨æ¨¡æ¿ä¸­ï¼Œä½ å¯ä»¥ä¸“æ³¨äºå¦‚ä½•å±•ç°æ•°æ®ï¼Œ è€Œåœ¨æ¨¡æ¿ä¹‹å¤–å¯ä»¥ä¸“æ³¨äºè¦å±•ç¤ºä»€ä¹ˆæ•°æ®ã€‚ 

<div align="center">
    <img src="æˆªå›¾/æ–‡ç« åˆ—è¡¨åŠ è½½/freemarker.png" alt="freemarker" />
</div>

å¸¸ç”¨çš„javaæ¨¡æ¿å¼•æ“è¿˜æœ‰å“ªäº›ï¼Ÿ

Jspã€Freemarkerã€Thymeleaf ã€Velocity ç­‰ã€‚

1. Jsp ä¸º Servlet ä¸“ç”¨ï¼Œä¸èƒ½å•ç‹¬è¿›è¡Œä½¿ç”¨ã€‚

2. Thymeleaf ä¸ºæ–°æŠ€æœ¯ï¼ŒåŠŸèƒ½è¾ƒä¸ºå¼ºå¤§ï¼Œä½†æ˜¯æ‰§è¡Œçš„æ•ˆç‡æ¯”è¾ƒä½ã€‚

3. Velocityä»2010å¹´æ›´æ–°å®Œ 2.0 ç‰ˆæœ¬åï¼Œä¾¿æ²¡æœ‰åœ¨æ›´æ–°ã€‚Spring Boot å®˜æ–¹åœ¨ 1.4 ç‰ˆæœ¬åå¯¹æ­¤ä¹Ÿä¸åœ¨æ”¯æŒï¼Œè™½ç„¶ Velocity åœ¨ 2017 å¹´ç‰ˆæœ¬å¾—åˆ°è¿­ä»£ï¼Œä½†ä¸ºæ—¶å·²æ™šã€‚ 

### 1. åŸºç¡€è¯­æ³•ç§ç±»

  1ã€æ³¨é‡Šï¼Œå³<#--  -->ï¼Œä»‹äºå…¶ä¹‹é—´çš„å†…å®¹ä¼šè¢«freemarkerå¿½ç•¥

```velocity
<#--æˆ‘æ˜¯ä¸€ä¸ªfreemarkeræ³¨é‡Š-->
```

  2ã€æ’å€¼ï¼ˆInterpolationï¼‰ï¼šå³ **`${..}`** éƒ¨åˆ†,freemarkerä¼šç”¨çœŸå®çš„å€¼ä»£æ›¿**`${..}`**

```velocity
Hello ${name}
```

  3ã€FTLæŒ‡ä»¤ï¼šå’ŒHTMLæ ‡è®°ç±»ä¼¼ï¼Œåå­—å‰åŠ #äºˆä»¥åŒºåˆ†ï¼ŒFreemarkerä¼šè§£ææ ‡ç­¾ä¸­çš„è¡¨è¾¾å¼æˆ–é€»è¾‘ã€‚

```velocity
<# >FTLæŒ‡ä»¤</#> 
```

  4ã€æ–‡æœ¬ï¼Œä»…æ–‡æœ¬ä¿¡æ¯ï¼Œè¿™äº›ä¸æ˜¯freemarkerçš„æ³¨é‡Šã€æ’å€¼ã€FTLæŒ‡ä»¤çš„å†…å®¹ä¼šè¢«freemarkerå¿½ç•¥è§£æï¼Œç›´æ¥è¾“å‡ºå†…å®¹ã€‚

```velocity
æˆ‘æ˜¯ä¸€ä¸ªæ™®é€šçš„æ–‡æœ¬
```

### 2. é›†åˆæŒ‡ä»¤ï¼ˆListå’ŒMapï¼‰

å®ä¾‹ä»£ç 

```velocity
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Hello World!</title>
</head>
<body>
    
<#-- list æ•°æ®çš„å±•ç¤º -->
<b>å±•ç¤ºlistä¸­çš„stuæ•°æ®:</b>
<br>
<br>
<table>
    <tr>
        <td>åºå·</td>
        <td>å§“å</td>
        <td>å¹´é¾„</td>
        <td>é’±åŒ…</td>
    </tr>
    <#list stus as stu>
        <tr>
            <td>${stu_index+1}</td>
            <td>${stu.name}</td>
            <td>${stu.age}</td>
            <td>${stu.money}</td>
        </tr>
    </#list>

</table>
<hr>
    
<#-- Map æ•°æ®çš„å±•ç¤º -->
<b>mapæ•°æ®çš„å±•ç¤ºï¼š</b>
<br/><br/>
<a href="###">æ–¹å¼ä¸€ï¼šé€šè¿‡map['keyname'].property</a><br/>
è¾“å‡ºstu1çš„å­¦ç”Ÿä¿¡æ¯ï¼š<br/>
å§“åï¼š${stuMap['stu1'].name}<br/>
å¹´é¾„ï¼š${stuMap['stu1'].age}<br/>
<br/>
<a href="###">æ–¹å¼äºŒï¼šé€šè¿‡map.keyname.property</a><br/>
è¾“å‡ºstu2çš„å­¦ç”Ÿä¿¡æ¯ï¼š<br/>
å§“åï¼š${stuMap.stu2.name}<br/>
å¹´é¾„ï¼š${stuMap.stu2.age}<br/>

<br/>
<a href="###">éå†mapä¸­ä¸¤ä¸ªå­¦ç”Ÿä¿¡æ¯ï¼š</a><br/>
<table>
    <tr>
        <td>åºå·</td>
        <td>å§“å</td>
        <td>å¹´é¾„</td>
        <td>é’±åŒ…</td>
    </tr>
    <#list stuMap?keys as key >
        <tr>
            <td>${key_index}</td>
            <td>${stuMap[key].name}</td>
            <td>${stuMap[key].age}</td>
            <td>${stuMap[key].money}</td>
        </tr>
    </#list>
</table>
<hr>
 
</body>
</html>
```

ğŸ‘†ä¸Šé¢ä»£ç è§£é‡Šï¼š

${k_index}ï¼š
	indexï¼šå¾—åˆ°å¾ªç¯çš„ä¸‹æ ‡ï¼Œä½¿ç”¨æ–¹æ³•æ˜¯åœ¨stuåè¾¹åŠ "_index"ï¼Œå®ƒçš„å€¼æ˜¯ä»0å¼€å§‹

### 3. ifæŒ‡ä»¤

â€‹	 if æŒ‡ä»¤å³åˆ¤æ–­æŒ‡ä»¤ï¼Œæ˜¯å¸¸ç”¨çš„FTLæŒ‡ä»¤ï¼Œfreemarkeråœ¨è§£ææ—¶é‡åˆ°ifä¼šè¿›è¡Œåˆ¤æ–­ï¼Œæ¡ä»¶ä¸ºçœŸåˆ™è¾“å‡ºifä¸­é—´çš„å†…å®¹ï¼Œå¦åˆ™è·³è¿‡å†…å®¹ä¸å†è¾“å‡ºã€‚

- æŒ‡ä»¤æ ¼å¼

```html
<#if ></if>
```

### 4. è¿ç®—ç¬¦

#### 4.1. ç®—æ•°è¿ç®—ç¬¦

FreeMarkerè¡¨è¾¾å¼ä¸­å®Œå…¨æ”¯æŒç®—æœ¯è¿ç®—,FreeMarkeræ”¯æŒçš„ç®—æœ¯è¿ç®—ç¬¦åŒ…æ‹¬:

- åŠ æ³•ï¼š `+`
- å‡æ³•ï¼š `-`
- ä¹˜æ³•ï¼š `*`
- é™¤æ³•ï¼š `/`
- æ±‚æ¨¡ (æ±‚ä½™)ï¼š `%`

#### 4.2. æ¯”è¾ƒè¿ç®—ç¬¦

- **`=`**æˆ–è€…**`==`**:åˆ¤æ–­ä¸¤ä¸ªå€¼æ˜¯å¦ç›¸ç­‰. 
- **`!=`**:åˆ¤æ–­ä¸¤ä¸ªå€¼æ˜¯å¦ä¸ç­‰. 
- **`>`**æˆ–è€…**`gt`**:åˆ¤æ–­å·¦è¾¹å€¼æ˜¯å¦å¤§äºå³è¾¹å€¼ 
- **`>=`**æˆ–è€…**`gte`**:åˆ¤æ–­å·¦è¾¹å€¼æ˜¯å¦å¤§äºç­‰äºå³è¾¹å€¼ 
- **`<`**æˆ–è€…**`lt`**:åˆ¤æ–­å·¦è¾¹å€¼æ˜¯å¦å°äºå³è¾¹å€¼ 
- **`<=`**æˆ–è€…**`lte`**:åˆ¤æ–­å·¦è¾¹å€¼æ˜¯å¦å°äºç­‰äºå³è¾¹å€¼ 

**æ¯”è¾ƒè¿ç®—ç¬¦æ³¨æ„**

- **`=`**å’Œ**`!=`**å¯ä»¥ç”¨äºå­—ç¬¦ä¸²ã€æ•°å€¼å’Œæ—¥æœŸæ¥æ¯”è¾ƒæ˜¯å¦ç›¸ç­‰
- **`=`**å’Œ**`!=`**ä¸¤è¾¹å¿…é¡»æ˜¯ç›¸åŒç±»å‹çš„å€¼,å¦åˆ™ä¼šäº§ç”Ÿé”™è¯¯
- å­—ç¬¦ä¸² **`"x"`** ã€**`"x "`** ã€**`"X"`**æ¯”è¾ƒæ˜¯ä¸ç­‰çš„.å› ä¸ºFreeMarkeræ˜¯ç²¾ç¡®æ¯”è¾ƒ
- å…¶å®ƒçš„è¿è¡Œç¬¦å¯ä»¥ä½œç”¨äºæ•°å­—å’Œæ—¥æœŸ,ä½†ä¸èƒ½ä½œç”¨äºå­—ç¬¦ä¸²
- ä½¿ç”¨**`gt`**ç­‰å­—æ¯è¿ç®—ç¬¦ä»£æ›¿**`>`**ä¼šæœ‰æ›´å¥½çš„æ•ˆæœ,å› ä¸º FreeMarkerä¼šæŠŠ**`>`**è§£é‡ŠæˆFTLæ ‡ç­¾çš„ç»“æŸå­—ç¬¦
- å¯ä»¥ä½¿ç”¨æ‹¬å·æ¥é¿å…è¿™ç§æƒ…å†µ,å¦‚:**`<#if (x>y)>`**

#### 4.3. é€»è¾‘è¿ç®—ç¬¦

- é€»è¾‘ä¸:&& 
- é€»è¾‘æˆ–:|| 
- é€»è¾‘é:! 

é€»è¾‘è¿ç®—ç¬¦åªèƒ½ä½œç”¨äºå¸ƒå°”å€¼,å¦åˆ™å°†äº§ç”Ÿé”™è¯¯ ã€‚

### 5. ç©ºå€¼å¤„ç†

**1ã€åˆ¤æ–­æŸå˜é‡æ˜¯å¦å­˜åœ¨ä½¿ç”¨ â€œ??â€**

ç”¨æ³•ä¸º:variable??,å¦‚æœè¯¥å˜é‡å­˜åœ¨,è¿”å›true,å¦åˆ™è¿”å›false 

ä¾‹ï¼šä¸ºé˜²æ­¢stusä¸ºç©ºæŠ¥é”™å¯ä»¥åŠ ä¸Šåˆ¤æ–­å¦‚ä¸‹ï¼š

**2ã€ç¼ºå¤±å˜é‡é»˜è®¤å€¼ä½¿ç”¨ â€œ!â€**

- ä½¿ç”¨!è¦ä»¥æŒ‡å®šä¸€ä¸ªé»˜è®¤å€¼ï¼Œå½“å˜é‡ä¸ºç©ºæ—¶æ˜¾ç¤ºé»˜è®¤å€¼

  ä¾‹ï¼š  ${name!''}è¡¨ç¤ºå¦‚æœnameä¸ºç©ºæ˜¾ç¤ºç©ºå­—ç¬¦ä¸²ã€‚

- å¦‚æœæ˜¯åµŒå¥—å¯¹è±¡åˆ™å»ºè®®ä½¿ç”¨ï¼ˆï¼‰æ‹¬èµ·æ¥

  ä¾‹ï¼š ${(stu.bestFriend.name)!''}è¡¨ç¤ºï¼Œå¦‚æœstuæˆ–bestFriendæˆ–nameä¸ºç©ºé»˜è®¤æ˜¾ç¤ºç©ºå­—ç¬¦ä¸²ã€‚

### 6. å†…å»ºå‡½æ•°

å†…å»ºå‡½æ•°è¯­æ³•æ ¼å¼ï¼š **`å˜é‡+?+å‡½æ•°åç§°`**  

**1ã€å’Œåˆ°æŸä¸ªé›†åˆçš„å¤§å°**

**`${é›†åˆå?size}`**

**2ã€æ—¥æœŸæ ¼å¼åŒ–**

æ˜¾ç¤ºå¹´æœˆæ—¥: **`${today?date}`** 
æ˜¾ç¤ºæ—¶åˆ†ç§’ï¼š**`${today?time}`**   
æ˜¾ç¤ºæ—¥æœŸ+æ—¶é—´ï¼š**`${today?datetime}`**   
è‡ªå®šä¹‰æ ¼å¼åŒ–ï¼š  **`${today?string("yyyyå¹´MMæœˆ")}`**

**3ã€å†…å»ºå‡½æ•°`c`**

model.addAttribute("point", 102920122);

pointæ˜¯æ•°å­—å‹ï¼Œä½¿ç”¨${point}ä¼šæ˜¾ç¤ºè¿™ä¸ªæ•°å­—çš„å€¼ï¼Œæ¯ä¸‰ä½ä½¿ç”¨é€—å·åˆ†éš”ã€‚

å¦‚æœä¸æƒ³æ˜¾ç¤ºä¸ºæ¯ä¸‰ä½åˆ†éš”çš„æ•°å­—ï¼Œå¯ä»¥ä½¿ç”¨cå‡½æ•°å°†æ•°å­—å‹è½¬æˆå­—ç¬¦ä¸²è¾“å‡º

**`${point?c}`**

**4ã€å°†jsonå­—ç¬¦ä¸²è½¬æˆå¯¹è±¡**

ä¸€ä¸ªä¾‹å­ï¼š

å…¶ä¸­ç”¨åˆ°äº† assignæ ‡ç­¾ï¼Œassignçš„ä½œç”¨æ˜¯å®šä¹‰ä¸€ä¸ªå˜é‡ã€‚

```velocity
<#assign text="{'bank':'å·¥å•†é“¶è¡Œ','account':'10101920201920212'}" />
<#assign data=text?eval />
å¼€æˆ·è¡Œï¼š${data.bank}  è´¦å·ï¼š${data.account}
```

### 7. é™æ€åŒ–æµ‹è¯•

&emsp;ä¹‹å‰çš„æµ‹è¯•éƒ½æ˜¯SpringMVCå°†Freemarkerä½œä¸ºè§†å›¾è§£æå™¨ï¼ˆViewReporterï¼‰æ¥é›†æˆåˆ°é¡¹ç›®ä¸­ï¼Œå·¥ä½œä¸­ï¼Œæœ‰çš„æ—¶å€™éœ€è¦ä½¿ç”¨FreemarkeråŸç”ŸApiæ¥ç”Ÿæˆé™æ€å†…å®¹ï¼Œä¸‹é¢ä¸€èµ·æ¥å­¦ä¹ ä¸‹åŸç”ŸApiç”Ÿæˆæ–‡æœ¬æ–‡ä»¶ã€‚

ä½¿ç”¨freemarkeråŸç”ŸApiå°†é¡µé¢ç”Ÿæˆhtmlæ–‡ä»¶ï¼Œæœ¬èŠ‚æµ‹è¯•htmlæ–‡ä»¶ç”Ÿæˆçš„æ–¹æ³•ï¼š

<div align="center">
    <img src="æˆªå›¾/æ–‡ç« åˆ—è¡¨åŠ è½½/é™æ€åŒ–æµ‹è¯•.png" alt="é™æ€åŒ–æµ‹è¯•" />
</div>

```java
package com.heima.freemarker.test;


import com.heima.freemarker.FreemarkerDemoApplication;
import com.heima.freemarker.entity.Student;
import freemarker.template.Configuration;
import freemarker.template.Template;
import freemarker.template.TemplateException;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.test.context.junit4.SpringRunner;

import java.io.FileWriter;
import java.io.IOException;
import java.util.*;

@SpringBootTest(classes = FreemarkerDemoApplication.class)
@RunWith(SpringRunner.class)
public class FreemarkerTest {

    @Autowired
    private Configuration configuration;

    @Test
    public void test() throws IOException, TemplateException {
        //freemarkerçš„æ¨¡æ¿å¯¹è±¡ï¼Œè·å–æ¨¡æ¿
        Template template = configuration.getTemplate("02-list.ftl");
        Map params = getData();
        //åˆæˆ
        //ç¬¬ä¸€ä¸ªå‚æ•° æ•°æ®æ¨¡å‹
        //ç¬¬äºŒä¸ªå‚æ•°  è¾“å‡ºæµ
        template.process(params, new FileWriter("d:/list.html"));
    }

    private Map getData() {
        Map<String, Object> map = new HashMap<>();

        //å°å¼ºå¯¹è±¡æ¨¡å‹æ•°æ®
        Student stu1 = new Student();
        stu1.setName("å°å¼º");
        stu1.setAge(18);
        stu1.setMoney(1000.86f);
        stu1.setBirthday(new Date());

        //å°çº¢å¯¹è±¡æ¨¡å‹æ•°æ®
        Student stu2 = new Student();
        stu2.setName("å°çº¢");
        stu2.setMoney(200.1f);
        stu2.setAge(19);

        //å°†ä¸¤ä¸ªå¯¹è±¡æ¨¡å‹æ•°æ®å­˜æ”¾åˆ°Listé›†åˆä¸­
        List<Student> stus = new ArrayList<>();
        stus.add(stu1);
        stus.add(stu2);

        //å‘mapä¸­å­˜æ”¾Listé›†åˆæ•°æ®
        map.put("stus", stus);


        //åˆ›å»ºMapæ•°æ®
        HashMap<String, Student> stuMap = new HashMap<>();
        stuMap.put("stu1", stu1);
        stuMap.put("stu2", stu2);
        //å‘mapä¸­å­˜æ”¾Mapæ•°æ®
        map.put("stuMap", stuMap);

        //è¿”å›Map
        return map;
    }
}
```

## ä¸ƒã€å¯¹è±¡å­˜å‚¨æœåŠ¡MinIO 

### 1. MinIOç®€ä»‹   

&emsp;MinIOåŸºäºApache License v2.0å¼€æºåè®®çš„å¯¹è±¡å­˜å‚¨æœåŠ¡ï¼Œå¯ä»¥åšä¸ºäº‘å­˜å‚¨çš„è§£å†³æ–¹æ¡ˆç”¨æ¥ä¿å­˜æµ·é‡çš„å›¾ç‰‡ï¼Œè§†é¢‘ï¼Œæ–‡æ¡£ã€‚ç”±äºé‡‡ç”¨Golangå®ç°ï¼ŒæœåŠ¡ç«¯å¯ä»¥å·¥ä½œåœ¨Windows,Linux, OS Xå’ŒFreeBSDä¸Šã€‚é…ç½®ç®€å•ï¼ŒåŸºæœ¬æ˜¯å¤åˆ¶å¯æ‰§è¡Œç¨‹åºï¼Œå•è¡Œå‘½ä»¤å¯ä»¥è¿è¡Œèµ·æ¥ã€‚

&emsp;MinIOå…¼å®¹äºšé©¬é€ŠS3äº‘å­˜å‚¨æœåŠ¡æ¥å£ï¼Œéå¸¸é€‚åˆäºå­˜å‚¨å¤§å®¹é‡éç»“æ„åŒ–çš„æ•°æ®ï¼Œä¾‹å¦‚å›¾ç‰‡ã€è§†é¢‘ã€æ—¥å¿—æ–‡ä»¶ã€å¤‡ä»½æ•°æ®å’Œå®¹å™¨/è™šæ‹Ÿæœºé•œåƒç­‰ï¼Œè€Œä¸€ä¸ªå¯¹è±¡æ–‡ä»¶å¯ä»¥æ˜¯ä»»æ„å¤§å°ï¼Œä»å‡ kbåˆ°æœ€å¤§5Tä¸ç­‰ã€‚

**S3 ï¼ˆ Simple Storage Serviceç®€å•å­˜å‚¨æœåŠ¡ï¼‰**

åŸºæœ¬æ¦‚å¿µ

- bucket â€“ ç±»æ¯”äºæ–‡ä»¶ç³»ç»Ÿçš„ç›®å½•
- Object â€“ ç±»æ¯”æ–‡ä»¶ç³»ç»Ÿçš„æ–‡ä»¶
- Keys â€“ ç±»æ¯”æ–‡ä»¶å

å®˜ç½‘æ–‡æ¡£ï¼šhttp://docs.minio.org.cn/docs/

### 2. MinIOç‰¹ç‚¹ 

- æ•°æ®ä¿æŠ¤

  Minioä½¿ç”¨Minio Erasure Codeï¼ˆçº åˆ ç ï¼‰æ¥é˜²æ­¢ç¡¬ä»¶æ•…éšœã€‚å³ä¾¿æŸåä¸€åŠä»¥ä¸Šçš„driverï¼Œä½†æ˜¯ä»ç„¶å¯ä»¥ä»ä¸­æ¢å¤ã€‚

- é«˜æ€§èƒ½

  ä½œä¸ºé«˜æ€§èƒ½å¯¹è±¡å­˜å‚¨ï¼Œåœ¨æ ‡å‡†ç¡¬ä»¶æ¡ä»¶ä¸‹å®ƒèƒ½è¾¾åˆ°55GB/sçš„è¯»ã€35GB/sçš„å†™é€Ÿç‡

- å¯æ‰©å®¹

  ä¸åŒMinIOé›†ç¾¤å¯ä»¥ç»„æˆè”é‚¦ï¼Œå¹¶å½¢æˆä¸€ä¸ªå…¨å±€çš„å‘½åç©ºé—´ï¼Œå¹¶è·¨è¶Šå¤šä¸ªæ•°æ®ä¸­å¿ƒ

- SDKæ”¯æŒ

  åŸºäºMinioè½»é‡çš„ç‰¹ç‚¹ï¼Œå®ƒå¾—åˆ°ç±»ä¼¼Javaã€Pythonæˆ–Goç­‰è¯­è¨€çš„sdkæ”¯æŒ

- æœ‰æ“ä½œé¡µé¢

  é¢å‘ç”¨æˆ·å‹å¥½çš„ç®€å•æ“ä½œç•Œé¢ï¼Œéå¸¸æ–¹ä¾¿çš„ç®¡ç†BucketåŠé‡Œé¢çš„æ–‡ä»¶èµ„æº

- åŠŸèƒ½ç®€å•

  è¿™ä¸€è®¾è®¡åŸåˆ™è®©MinIOä¸å®¹æ˜“å‡ºé”™ã€æ›´å¿«å¯åŠ¨

- ä¸°å¯Œçš„API

  æ”¯æŒæ–‡ä»¶èµ„æºçš„åˆ†äº«è¿æ¥åŠåˆ†äº«é“¾æ¥çš„è¿‡æœŸç­–ç•¥ã€å­˜å‚¨æ¡¶æ“ä½œã€æ–‡ä»¶åˆ—è¡¨è®¿é—®åŠæ–‡ä»¶ä¸Šä¼ ä¸‹è½½çš„åŸºæœ¬åŠŸèƒ½ç­‰ã€‚

- æ–‡ä»¶å˜åŒ–ä¸»åŠ¨é€šçŸ¥

  å­˜å‚¨æ¡¶ï¼ˆBucketï¼‰å¦‚æœå‘ç”Ÿæ”¹å˜,æ¯”å¦‚ä¸Šä¼ å¯¹è±¡å’Œåˆ é™¤å¯¹è±¡ï¼Œå¯ä»¥ä½¿ç”¨å­˜å‚¨æ¡¶äº‹ä»¶é€šçŸ¥æœºåˆ¶è¿›è¡Œç›‘æ§ï¼Œå¹¶é€šè¿‡ä»¥ä¸‹æ–¹å¼å‘å¸ƒå‡ºå»:AMQPã€MQTTã€Elasticsearchã€Redisã€NATSã€MySQLã€Kafkaã€Webhooksç­‰ã€‚

### 3. ä½¿ç”¨dockerè¿›è¡Œç¯å¢ƒéƒ¨ç½²å’Œå¯åŠ¨

```bash
docker run -p 9000:9000 --name minio -d --restart=always -e "MINIO_ACCESS_KEY=minio" -e "MINIO_SECRET_KEY=minio123" -v /home/data:/data -v /home/config:/root/.minio minio/minio server /data
```

### 4. æ ¸å¿ƒä»£ç 

```java
package com.heima.file.service.impl;


import com.heima.file.config.MinIOConfig;
import com.heima.file.config.MinIOConfigProperties;
import com.heima.file.service.FileStorageService;
import io.minio.GetObjectArgs;
import io.minio.MinioClient;
import io.minio.PutObjectArgs;
import io.minio.RemoveObjectArgs;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.context.properties.EnableConfigurationProperties;
import org.springframework.context.annotation.Import;
import org.springframework.util.StringUtils;

import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.text.SimpleDateFormat;
import java.util.Date;

@Slf4j
@EnableConfigurationProperties(MinIOConfigProperties.class)
@Import(MinIOConfig.class)
public class MinIOFileStorageService implements FileStorageService {

    @Autowired
    private MinioClient minioClient;

    @Autowired
    private MinIOConfigProperties minIOConfigProperties;

    private final static String separator = "/";

    /**
     * @param dirPath
     * @param filename  yyyy/mm/dd/file.jpg
     * @return
     */
    public String builderFilePath(String dirPath,String filename) {
        StringBuilder stringBuilder = new StringBuilder(50);
        if(!StringUtils.isEmpty(dirPath)){
            stringBuilder.append(dirPath).append(separator);
        }
        SimpleDateFormat sdf = new SimpleDateFormat("yyyy/MM/dd");
        String todayStr = sdf.format(new Date());
        stringBuilder.append(todayStr).append(separator);
        stringBuilder.append(filename);
        return stringBuilder.toString();
    }

    /**
     *  ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶
     * @param prefix  æ–‡ä»¶å‰ç¼€
     * @param filename  æ–‡ä»¶å
     * @param inputStream æ–‡ä»¶æµ
     * @return  æ–‡ä»¶å…¨è·¯å¾„
     */
    @Override
    public String uploadImgFile(String prefix, String filename,InputStream inputStream) {
        String filePath = builderFilePath(prefix, filename);
        try {
            PutObjectArgs putObjectArgs = PutObjectArgs.builder()
                    .object(filePath)
                    .contentType("image/jpg")
                    .bucket(minIOConfigProperties.getBucket()).stream(inputStream,inputStream.available(),-1)
                    .build();
            minioClient.putObject(putObjectArgs);
            StringBuilder urlPath = new StringBuilder(minIOConfigProperties.getReadPath());
            urlPath.append(separator+minIOConfigProperties.getBucket());
            urlPath.append(separator);
            urlPath.append(filePath);
            return urlPath.toString();
        }catch (Exception ex){
            log.error("minio put file error.",ex);
            throw new RuntimeException("ä¸Šä¼ æ–‡ä»¶å¤±è´¥");
        }
    }

    /**
     *  ä¸Šä¼ htmlæ–‡ä»¶
     * @param prefix  æ–‡ä»¶å‰ç¼€
     * @param filename   æ–‡ä»¶å
     * @param inputStream  æ–‡ä»¶æµ
     * @return  æ–‡ä»¶å…¨è·¯å¾„
     */
    @Override
    public String uploadHtmlFile(String prefix, String filename,InputStream inputStream) {
        String filePath = builderFilePath(prefix, filename);
        try {
            PutObjectArgs putObjectArgs = PutObjectArgs.builder()
                    .object(filePath)
                    .contentType("text/html")
                    .bucket(minIOConfigProperties.getBucket()).stream(inputStream,inputStream.available(),-1)
                    .build();
            minioClient.putObject(putObjectArgs);
            StringBuilder urlPath = new StringBuilder(minIOConfigProperties.getReadPath());
            urlPath.append(separator+minIOConfigProperties.getBucket());
            urlPath.append(separator);
            urlPath.append(filePath);
            return urlPath.toString();
        }catch (Exception ex){
            log.error("minio put file error.",ex);
            ex.printStackTrace();
            throw new RuntimeException("ä¸Šä¼ æ–‡ä»¶å¤±è´¥");
        }
    }

    /**
     * åˆ é™¤æ–‡ä»¶
     * @param pathUrl  æ–‡ä»¶å…¨è·¯å¾„
     */
    @Override
    public void delete(String pathUrl) {
        String key = pathUrl.replace(minIOConfigProperties.getEndpoint()+"/","");
        int index = key.indexOf(separator);
        String bucket = key.substring(0,index);
        String filePath = key.substring(index+1);
        // åˆ é™¤Objects
        RemoveObjectArgs removeObjectArgs = RemoveObjectArgs.builder().bucket(bucket).object(filePath).build();
        try {
            minioClient.removeObject(removeObjectArgs);
        } catch (Exception e) {
            log.error("minio remove file error.  pathUrl:{}",pathUrl);
            e.printStackTrace();
        }
    }


    /**
     * ä¸‹è½½æ–‡ä»¶
     * @param pathUrl  æ–‡ä»¶å…¨è·¯å¾„
     * @return  æ–‡ä»¶æµ
     *
     */
    @Override
    public byte[] downLoadFile(String pathUrl)  {
        String key = pathUrl.replace(minIOConfigProperties.getEndpoint()+"/","");
        int index = key.indexOf(separator);
        String bucket = key.substring(0,index);
        String filePath = key.substring(index+1);
        InputStream inputStream = null;
        try {
            inputStream = minioClient.getObject(GetObjectArgs.builder().bucket(minIOConfigProperties.getBucket()).object(filePath).build());
        } catch (Exception e) {
            log.error("minio down file error.  pathUrl:{}",pathUrl);
            e.printStackTrace();
        }

        ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream();
        byte[] buff = new byte[100];
        int rc = 0;
        while (true) {
            try {
                if (!((rc = inputStream.read(buff, 0, 100)) > 0)) break;
            } catch (IOException e) {
                e.printStackTrace();
            }
            byteArrayOutputStream.write(buff, 0, rc);
        }
        return byteArrayOutputStream.toByteArray();
    }
}
```

## å…«ã€æ–‡ç« è¯¦æƒ…

### 1. éœ€æ±‚åˆ†æ

<div align="center">
    <img src="æˆªå›¾/æ–‡ç« åˆ—è¡¨åŠ è½½/æ–‡ç« è¯¦æƒ….png" alt="æ–‡ç« è¯¦æƒ…" />
</div>

### 2. å®ç°æ–¹æ¡ˆ

æ–¹æ¡ˆä¸€

ç”¨æˆ·æŸä¸€æ¡æ–‡ç« ï¼Œæ ¹æ®æ–‡ç« çš„idå»æŸ¥è¯¢æ–‡ç« å†…å®¹è¡¨ï¼Œè¿”å›æ¸²æŸ“é¡µé¢

<div align="center">
    <img src="æˆªå›¾/æ–‡ç« åˆ—è¡¨åŠ è½½/idæŸ¥æ–‡ç« .png" alt="idæŸ¥æ–‡ç« " />
</div>

æ–¹æ¡ˆäºŒ

<div align="center">
    <img src="æˆªå›¾/æ–‡ç« åˆ—è¡¨åŠ è½½/æ–¹æ¡ˆ2.png" alt="æ–¹æ¡ˆ2" />
</div>

### 3. æ ¸å¿ƒä»£ç 

```java
package com.heima.article.test;


import com.alibaba.fastjson.JSONArray;
import com.baomidou.mybatisplus.core.toolkit.Wrappers;
import com.heima.article.ArticleApplication;
import com.heima.article.mapper.ApArticleContentMapper;
import com.heima.article.mapper.ApArticleMapper;
import com.heima.file.service.FileStorageService;
import com.heima.model.article.pojos.ApArticle;
import com.heima.model.article.pojos.ApArticleContent;
import freemarker.template.Configuration;
import freemarker.template.Template;
import org.apache.commons.lang3.StringUtils;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.test.context.junit4.SpringRunner;

import java.io.ByteArrayInputStream;
import java.io.InputStream;
import java.io.StringWriter;
import java.util.HashMap;
import java.util.Map;

@SpringBootTest(classes = ArticleApplication.class)
@RunWith(SpringRunner.class)
public class ArticleFreemarkerTest {

    @Autowired
    private Configuration configuration;

    @Autowired
    private FileStorageService fileStorageService;


    @Autowired
    private ApArticleMapper apArticleMapper;

    @Autowired
    private ApArticleContentMapper apArticleContentMapper;

    @Test
    public void createStaticUrlTest() throws Exception {
        //1.è·å–æ–‡ç« å†…å®¹
        ApArticleContent apArticleContent = apArticleContentMapper.selectOne(Wrappers.<ApArticleContent>lambdaQuery().eq(ApArticleContent::getArticleId, 1390536764510310401L));
        if(apArticleContent != null && StringUtils.isNotBlank(apArticleContent.getContent())){
            //2.æ–‡ç« å†…å®¹é€šè¿‡freemarkerç”Ÿæˆhtmlæ–‡ä»¶
            StringWriter out = new StringWriter();
            Template template = configuration.getTemplate("article.ftl");

            Map<String, Object> params = new HashMap<>();
            params.put("content", JSONArray.parseArray(apArticleContent.getContent()));

            template.process(params, out);
            InputStream is = new ByteArrayInputStream(out.toString().getBytes());

            //3.æŠŠhtmlæ–‡ä»¶ä¸Šä¼ åˆ°minioä¸­
            String path = fileStorageService.uploadHtmlFile("", apArticleContent.getArticleId() + ".html", is);

            //4.ä¿®æ”¹ap_articleè¡¨ï¼Œä¿å­˜static_urlå­—æ®µ
            ApArticle article = new ApArticle();
            article.setId(apArticleContent.getArticleId());
            article.setStaticUrl(path);
            apArticleMapper.updateById(article);

        }
    }
}
```

## ä¹ã€è‡ªåª’ä½“æ–‡ç« å‘å¸ƒ

### 1. åå°æ­å»º

<div align="center">
    <img src="æˆªå›¾/è‡ªåª’ä½“æ–‡ç« å‘å¸ƒ/åå°æ­å»º.png" alt="åå°æ­å»º" />
</div>

### 2. å‰å°æ­å»º

<div align="center">
    <img src="æˆªå›¾/è‡ªåª’ä½“æ–‡ç« å‘å¸ƒ/å‰å°æ­å»º.png" alt="å‰å°æ­å»º" />
</div>

### 3. è‡ªåª’ä½“ç´ æç®¡ç†

#### 3.1 ç´ æä¸Šä¼ 

##### 3.1.1 éœ€æ±‚åˆ†æ

<div align="center">
    <img src="æˆªå›¾/è‡ªåª’ä½“æ–‡ç« å‘å¸ƒ/ç´ æä¸Šä¼ -éœ€æ±‚åˆ†æ.png" alt="ç´ æä¸Šä¼ -éœ€æ±‚åˆ†æ" />
</div>

å›¾ç‰‡ä¸Šä¼ çš„é¡µé¢ï¼Œé¦–å…ˆæ˜¯å±•ç¤ºç´ æä¿¡æ¯ï¼Œå¯ä»¥ç‚¹å‡»å›¾ç‰‡ä¸Šä¼ ï¼Œå¼¹çª—åå¯ä»¥ä¸Šä¼ å›¾ç‰‡

##### 3.1.2 è¡¨ç»“æ„

```mysql
-- auto-generated definition
create table wm_material
(
    id            int unsigned auto_increment comment 'ä¸»é”®'
        primary key,
    user_id       int unsigned     null comment 'è‡ªåª’ä½“ç”¨æˆ·ID',
    url           varchar(255)     null comment 'å›¾ç‰‡åœ°å€',
    type          tinyint unsigned null comment 'ç´ æç±»å‹
            0 å›¾ç‰‡
            1 è§†é¢‘',
    is_collection tinyint(1)       null comment 'æ˜¯å¦æ”¶è—',
    created_time  datetime         null comment 'åˆ›å»ºæ—¶é—´'
)
    comment 'è‡ªåª’ä½“å›¾æ–‡ç´ æä¿¡æ¯è¡¨' collate = utf8mb4_unicode_ci
                                   row_format = DYNAMIC;
```

##### 3.1.3 å®ç°æ€è·¯

<div align="center">
    <img src="æˆªå›¾/è‡ªåª’ä½“æ–‡ç« å‘å¸ƒ/ç´ æä¸Šä¼ -å®ç°æ€è·¯.png" alt="ç´ æä¸Šä¼ -å®ç°æ€è·¯" />
</div>

â‘ ï¼šå‰ç«¯å‘é€ä¸Šä¼ å›¾ç‰‡è¯·æ±‚ï¼Œç±»å‹ä¸ºMultipartFile

â‘¡ï¼šç½‘å…³è¿›è¡Œtokenè§£æåï¼ŒæŠŠè§£æåçš„ç”¨æˆ·ä¿¡æ¯å­˜å‚¨åˆ°headerä¸­

```java
//è·å¾—tokenè§£æåä¸­çš„ç”¨æˆ·ä¿¡æ¯
Object userId = claimsBody.get("id");
//åœ¨headerä¸­æ·»åŠ æ–°çš„ä¿¡æ¯
ServerHttpRequest serverHttpRequest = request.mutate().headers(httpHeaders -> {
    httpHeaders.add("userId", userId + "");
}).build();
//é‡ç½®header
exchange.mutate().request(serverHttpRequest).build();
```

â‘¢ï¼šè‡ªåª’ä½“å¾®æœåŠ¡ä½¿ç”¨æ‹¦æˆªå™¨è·å–åˆ°headerä¸­çš„çš„ç”¨æˆ·ä¿¡æ¯ï¼Œå¹¶æ”¾å…¥åˆ°threadlocalä¸­

åœ¨heima-leadnews-utilsä¸­æ–°å¢å·¥å…·ç±»

```java
package com.heima.utils.thread;

import com.heima.model.wemedia.pojos.WmUser;

public class WmThreadLocalUtil {

    private final static ThreadLocal<WmUser> WM_USER_THREAD_LOCAL = new ThreadLocal<>();

    /**
     * æ·»åŠ ç”¨æˆ·
     * @param wmUser
     */
    public static void  setUser(WmUser wmUser){
        WM_USER_THREAD_LOCAL.set(wmUser);
    }

    /**
     * è·å–ç”¨æˆ·
     */
    public static WmUser getUser(){
        return WM_USER_THREAD_LOCAL.get();
    }

    /**
     * æ¸…ç†ç”¨æˆ·
     */
    public static void clear(){
        WM_USER_THREAD_LOCAL.remove();
    }
}
```

æ–°å¢æ‹¦æˆªå™¨

```java
package com.heima.wemedia.interceptor;

import com.heima.model.wemedia.pojos.WmUser;
import com.heima.utils.thread.WmThreadLocalUtils;
import lombok.extern.slf4j.Slf4j;
import org.springframework.web.servlet.HandlerInterceptor;
import org.springframework.web.servlet.ModelAndView;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.util.Optional;

@Slf4j
public class WmTokenInterceptor implements HandlerInterceptor {
    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {
        //å¾—åˆ°headerä¸­çš„ä¿¡æ¯
        String userId = request.getHeader("userId");
        Optional<String> optional = Optional.ofNullable(userId);
        if(optional.isPresent()){
            //æŠŠç”¨æˆ·idå­˜å…¥threadloaclä¸­
            WmUser wmUser = new WmUser();
            wmUser.setId(Integer.valueOf(userId));
            WmThreadLocalUtils.setUser(wmUser);
            log.info("wmTokenFilterè®¾ç½®ç”¨æˆ·ä¿¡æ¯åˆ°threadlocalä¸­...");
        }

        return true;
    }

    @Override
    public void postHandle(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView) throws Exception {
        log.info("æ¸…ç†threadlocal...");
        WmThreadLocalUtils.clear();
    }
}
```

é…ç½®ä½¿æ‹¦æˆªå™¨ç”Ÿæ•ˆï¼Œæ‹¦æˆªæ‰€æœ‰çš„è¯·æ±‚

```java
package com.heima.wemedia.config;

import com.heima.wemedia.interceptor.WmTokenInterceptor;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.InterceptorRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

@Configuration
public class WebMvcConfig implements WebMvcConfigurer {

    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(new WmTokenInterceptor()).addPathPatterns("/**");
    }
}
```

â‘£ï¼šå…ˆæŠŠå›¾ç‰‡ä¸Šä¼ åˆ°minIOä¸­ï¼Œè·å–åˆ°å›¾ç‰‡è¯·æ±‚çš„è·¯å¾„

â‘¤ï¼šæŠŠç”¨æˆ·idå’Œå›¾ç‰‡ä¸Šçš„è·¯å¾„ä¿å­˜åˆ°ç´ æè¡¨ä¸­

##### 3.1.4 æ¥å£å®šä¹‰

|          | **è¯´æ˜**                        |
| -------- | ------------------------------- |
| æ¥å£è·¯å¾„ | /api/v1/material/upload_picture |
| è¯·æ±‚æ–¹å¼ | POST                            |
| å‚æ•°     | MultipartFile                   |
| å“åº”ç»“æœ | ResponseResult                  |

MultipartFile  ï¼šSpringmvcæŒ‡å®šçš„æ–‡ä»¶æ¥æ”¶ç±»å‹

ResponseResult  ï¼šæˆåŠŸéœ€è¦**å›æ˜¾å›¾ç‰‡**ï¼Œè¿”å›ç´ æå¯¹è±¡

```json
{
  "host":null,
  "code":200,
  "errorMessage":"æ“ä½œæˆåŠŸ",
  "data":{
    "id":52,
    "userId":1102,
    "url":"http://192.168.200.130:9000/leadnews/2021/04/26/a73f5b60c0d84c32bfe175055aaaac40.jpg",
    "type":0,
    "isCollection":0,
    "createdTime":"2021-01-20T16:49:48.443+0000"
  }
}
```

å¤±è´¥ï¼š

- å‚æ•°å¤±æ•ˆ
- æ–‡ç« ä¸Šä¼ å¤±è´¥

##### 3.1.5 æ ¸å¿ƒä»£ç 

```java
package com.heima.wemedia.service.impl;


import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.heima.file.service.FileStorageService;
import com.heima.model.common.dtos.ResponseResult;
import com.heima.model.common.enums.AppHttpCodeEnum;
import com.heima.model.wemedia.pojos.WmMaterial;
import com.heima.utils.thread.WmThreadLocalUtil;
import com.heima.wemedia.mapper.WmMaterialMapper;
import com.heima.wemedia.service.WmMaterialService;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.web.multipart.MultipartFile;

import java.io.IOException;
import java.util.Date;
import java.util.UUID;

@Slf4j
@Service
@Transactional
public class WmMaterialServiceImpl extends ServiceImpl<WmMaterialMapper, WmMaterial> implements WmMaterialService {

    @Autowired
    private FileStorageService fileStorageService;


    /**
     * å›¾ç‰‡ä¸Šä¼ 
     * @param multipartFile
     * @return
     */
    @Override
    public ResponseResult uploadPicture(MultipartFile multipartFile) {

        //1.æ£€æŸ¥å‚æ•°
        if(multipartFile == null || multipartFile.getSize() == 0){
            return ResponseResult.errorResult(AppHttpCodeEnum.PARAM_INVALID);
        }

        //2.ä¸Šä¼ å›¾ç‰‡åˆ°minIOä¸­
        String fileName = UUID.randomUUID().toString().replace("-", "");
        //aa.jpg
        String originalFilename = multipartFile.getOriginalFilename();
        String postfix = originalFilename.substring(originalFilename.lastIndexOf("."));
        String fileId = null;
        try {
            fileId = fileStorageService.uploadImgFile("", fileName + postfix, multipartFile.getInputStream());
            log.info("ä¸Šä¼ å›¾ç‰‡åˆ°MinIOä¸­ï¼ŒfileId:{}",fileId);
        } catch (IOException e) {
            e.printStackTrace();
            log.error("WmMaterialServiceImpl-ä¸Šä¼ æ–‡ä»¶å¤±è´¥");
        }

        //3.ä¿å­˜åˆ°æ•°æ®åº“ä¸­
        WmMaterial wmMaterial = new WmMaterial();
        wmMaterial.setUserId(WmThreadLocalUtil.getUser().getId());
        wmMaterial.setUrl(fileId);
        wmMaterial.setIsCollection((short)0);
        wmMaterial.setType((short)0);
        wmMaterial.setCreatedTime(new Date());
        save(wmMaterial);

        //4.è¿”å›ç»“æœ

        return ResponseResult.okResult(wmMaterial);
    }

}
```

#### 3.2 ç´ æåˆ—è¡¨æŸ¥è¯¢

##### 3.2.1 æ ¸å¿ƒä»£ç 

```java
/**
     * ç´ æåˆ—è¡¨æŸ¥è¯¢
     * @param dto
     * @return
     */
@Override
public ResponseResult findList(WmMaterialDto dto) {

    //1.æ£€æŸ¥å‚æ•°
    dto.checkParam();

    //2.åˆ†é¡µæŸ¥è¯¢
    IPage page = new Page(dto.getPage(),dto.getSize());
    LambdaQueryWrapper<WmMaterial> lambdaQueryWrapper = new LambdaQueryWrapper<>();
    //æ˜¯å¦æ”¶è—
    if(dto.getIsCollection() != null && dto.getIsCollection() == 1){
        lambdaQueryWrapper.eq(WmMaterial::getIsCollection,dto.getIsCollection());
    }

    //æŒ‰ç…§ç”¨æˆ·æŸ¥è¯¢
    lambdaQueryWrapper.eq(WmMaterial::getUserId,WmThreadLocalUtil.getUser().getId());

    //æŒ‰ç…§æ—¶é—´å€’åº
    lambdaQueryWrapper.orderByDesc(WmMaterial::getCreatedTime);


    page = page(page,lambdaQueryWrapper);

    //3.ç»“æœè¿”å›
    ResponseResult responseResult = new PageResponseResult(dto.getPage(),dto.getSize(),(int)page.getTotal());
    responseResult.setData(page.getRecords());
    return responseResult;
}
```

### 4. è‡ªåª’ä½“æ–‡ç« ç®¡ç†

#### 4.1 æŸ¥è¯¢æ‰€æœ‰é¢‘é“

##### 4.1.1 éœ€æ±‚åˆ†æ

<div align="center">
    <img src="æˆªå›¾/è‡ªåª’ä½“æ–‡ç« å‘å¸ƒ/è‡ªåª’ä½“æ–‡ç« ç®¡ç†-éœ€æ±‚åˆ†æ.png" alt="è‡ªåª’ä½“æ–‡ç« ç®¡ç†-éœ€æ±‚åˆ†æ" />
</div>

##### 4.1.2 è¡¨ç»“æ„

wm_channel é¢‘é“ä¿¡æ¯è¡¨

```mysql
-- auto-generated definition
create table wm_channel
(
    id           int unsigned auto_increment
        primary key,
    name         varchar(10)      null comment 'é¢‘é“åç§°',
    description  varchar(255)     null comment 'é¢‘é“æè¿°',
    is_default   tinyint unsigned null comment 'æ˜¯å¦é»˜è®¤é¢‘é“',
    status       tinyint unsigned null,
    ord          tinyint unsigned null comment 'é»˜è®¤æ’åº',
    created_time datetime         null comment 'åˆ›å»ºæ—¶é—´'
)
    comment 'é¢‘é“ä¿¡æ¯è¡¨' collate = utf8mb4_unicode_ci
                         row_format = DYNAMIC;
```

##### 4.1.3 æ¥å£å®šä¹‰

|          | **è¯´æ˜**                 |
| -------- | ------------------------ |
| æ¥å£è·¯å¾„ | /api/v1/channel/channels |
| è¯·æ±‚æ–¹å¼ | POST                     |
| å‚æ•°     | æ—                        |
| å“åº”ç»“æœ | ResponseResult           |

ResponseResult  ï¼š

```json
{
  "host": "null",
  "code": 0,
  "errorMessage": "æ“ä½œæˆåŠŸ",
  "data": [
    {
      "id": 4,
      "name": "java",
      "description": "java",
      "isDefault": true,
      "status": false,
      "ord": 3,
      "createdTime": "2019-08-16T10:55:41.000+0000"
    },
    Object {  ... },
    Object {  ... }
  ]
}
```

##### 4.1.4 æ ¸å¿ƒä»£ç 

```java
package com.heima.wemedia.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.heima.model.common.dtos.ResponseResult;
import com.heima.model.wemedia.pojos.WmChannel;
import com.heima.wemedia.mapper.WmChannelMapper;
import com.heima.wemedia.service.WmChannelService;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

@Service
@Transactional
@Slf4j
public class WmChannelServiceImpl extends ServiceImpl<WmChannelMapper, WmChannel> implements WmChannelService {

    /**
     * æŸ¥è¯¢æ‰€æœ‰é¢‘é“
     * @return
     */
    @Override
    public ResponseResult findAll() {
        return ResponseResult.okResult(list());
    }
}
```

#### 4.2 æŸ¥è¯¢è‡ªåª’ä½“æ–‡ç« 

##### 4.2.1 éœ€æ±‚è¯´æ˜

<div align="center">
    <img src="æˆªå›¾/è‡ªåª’ä½“æ–‡ç« å‘å¸ƒ/æŸ¥è¯¢è‡ªåª’ä½“æ–‡ç« -éœ€æ±‚è¯´æ˜.png" alt="æŸ¥è¯¢è‡ªåª’ä½“æ–‡ç« -éœ€æ±‚è¯´æ˜" />
</div>

##### 4.2.2 è¡¨ç»“æ„åˆ†æ

wm_news è‡ªåª’ä½“æ–‡ç« è¡¨

```mysql
-- auto-generated definition
create table wm_news
(
    id            int auto_increment comment 'ä¸»é”®'
        primary key,
    user_id       int unsigned                 null comment 'è‡ªåª’ä½“ç”¨æˆ·ID',
    title         varchar(36)                  null comment 'æ ‡é¢˜',
    content       longtext                     null comment 'å›¾æ–‡å†…å®¹',
    type          tinyint unsigned             null comment 'æ–‡ç« å¸ƒå±€
            0 æ— å›¾æ–‡ç« 
            1 å•å›¾æ–‡ç« 
            3 å¤šå›¾æ–‡ç« ',
    channel_id    int unsigned                 null comment 'å›¾æ–‡é¢‘é“ID',
    labels        varchar(20)                  null,
    created_time  datetime                     null comment 'åˆ›å»ºæ—¶é—´',
    submited_time datetime                     null comment 'æäº¤æ—¶é—´',
    status        tinyint unsigned             null comment 'å½“å‰çŠ¶æ€
            0 è‰ç¨¿
            1 æäº¤ï¼ˆå¾…å®¡æ ¸ï¼‰
            2 å®¡æ ¸å¤±è´¥
            3 äººå·¥å®¡æ ¸
            4 äººå·¥å®¡æ ¸é€šè¿‡
            8 å®¡æ ¸é€šè¿‡ï¼ˆå¾…å‘å¸ƒï¼‰
            9 å·²å‘å¸ƒ',
    publish_time  datetime                     null comment 'å®šæ—¶å‘å¸ƒæ—¶é—´ï¼Œä¸å®šæ—¶åˆ™ä¸ºç©º',
    reason        varchar(50)                  null comment 'æ‹’ç»ç†ç”±',
    article_id    bigint unsigned              null comment 'å‘å¸ƒåº“æ–‡ç« ID',
    images        longtext                     null comment '//å›¾ç‰‡ç”¨é€—å·åˆ†éš”',
    enable        tinyint unsigned default '1' null
)
    comment 'è‡ªåª’ä½“å›¾æ–‡å†…å®¹ä¿¡æ¯è¡¨' collate = utf8mb4_unicode_ci
                                   row_format = DYNAMIC;
```

##### 4.2.3 æšä¸¾ç±»

```java
//çŠ¶æ€æšä¸¾ç±»
    @Alias("WmNewsStatus")
    public enum Status{
        NORMAL((short)0),SUBMIT((short)1),FAIL((short)2),ADMIN_AUTH((short)3),ADMIN_SUCCESS((short)4),SUCCESS((short)8),PUBLISHED((short)9);
        short code;
        Status(short code){
            this.code = code;
        }
        public short getCode(){
            return this.code;
        }
    }
```

##### 4.2.4 æ¥å£å®šä¹‰

|          | **è¯´æ˜**          |
| -------- | ----------------- |
| æ¥å£è·¯å¾„ | /api/v1/news/list |
| è¯·æ±‚æ–¹å¼ | POST              |
| å‚æ•°     | WmNewsPageReqDto  |
| å“åº”ç»“æœ | ResponseResult    |

WmNewsPageReqDto  :

```java
package com.heima.model.wemedia.dtos;

import com.heima.model.common.dtos.PageRequestDto;
import lombok.Data;

import java.util.Date;

@Data
public class WmNewsPageReqDto extends PageRequestDto {

    /**
     * çŠ¶æ€
     */
    private Short status;
    /**
     * å¼€å§‹æ—¶é—´
     */
    private Date beginPubDate;
    /**
     * ç»“æŸæ—¶é—´
     */
    private Date endPubDate;
    /**
     * æ‰€å±é¢‘é“ID
     */
    private Integer channelId;
    /**
     * å…³é”®å­—
     */
    private String keyword;
}
```

ResponseResult  :

```json
{
  "host": "null",
  "code": 0,
  "errorMessage": "æ“ä½œæˆåŠŸ",
  "data": [
    Object { ... },
    Object { ... },
    Object { ... }
    
  ],
  "currentPage":1,
  "size":10,
  "total":21
}
```

##### 4.2.5 æ ¸å¿ƒä»£ç 

```java
package com.heima.wemedia.service.impl;

import com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.heima.model.common.dtos.PageResponseResult;
import com.heima.model.common.dtos.ResponseResult;
import com.heima.model.common.enums.AppHttpCodeEnum;
import com.heima.model.wemedia.dtos.WmNewsPageReqDto;
import com.heima.model.wemedia.pojos.WmNews;
import com.heima.model.wemedia.pojos.WmUser;
import com.heima.utils.thread.WmThreadLocalUtil;
import com.heima.wemedia.mapper.WmNewsMapper;
import com.heima.wemedia.service.WmNewsService;
import lombok.extern.slf4j.Slf4j;
import org.apache.commons.lang3.StringUtils;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

@Service
@Slf4j
@Transactional
public class WmNewsServiceImpl  extends ServiceImpl<WmNewsMapper, WmNews> implements WmNewsService {

    /**
     * æŸ¥è¯¢æ–‡ç« 
     * @param dto
     * @return
     */
    @Override
    public ResponseResult findAll(WmNewsPageReqDto dto) {

        //1.æ£€æŸ¥å‚æ•°
        if(dto == null){
            return ResponseResult.errorResult(AppHttpCodeEnum.PARAM_INVALID);
        }
        //åˆ†é¡µå‚æ•°æ£€æŸ¥
        dto.checkParam();
        //è·å–å½“å‰ç™»å½•äººçš„ä¿¡æ¯
        WmUser user = WmThreadLocalUtil.getUser();
        if(user == null){
            return ResponseResult.errorResult(AppHttpCodeEnum.NEED_LOGIN);
        }

        //2.åˆ†é¡µæ¡ä»¶æŸ¥è¯¢
        IPage page = new Page(dto.getPage(),dto.getSize());
        LambdaQueryWrapper<WmNews> lambdaQueryWrapper = new LambdaQueryWrapper<>();
        //çŠ¶æ€ç²¾ç¡®æŸ¥è¯¢
        if(dto.getStatus() != null){
            lambdaQueryWrapper.eq(WmNews::getStatus,dto.getStatus());
        }

        //é¢‘é“ç²¾ç¡®æŸ¥è¯¢
        if(dto.getChannelId() != null){
            lambdaQueryWrapper.eq(WmNews::getChannelId,dto.getChannelId());
        }

        //æ—¶é—´èŒƒå›´æŸ¥è¯¢
        if(dto.getBeginPubDate()!=null && dto.getEndPubDate()!=null){
            lambdaQueryWrapper.between(WmNews::getPublishTime,dto.getBeginPubDate(),dto.getEndPubDate());
        }

        //å…³é”®å­—æ¨¡ç³ŠæŸ¥è¯¢
        if(StringUtils.isNotBlank(dto.getKeyword())){
            lambdaQueryWrapper.like(WmNews::getTitle,dto.getKeyword());
        }

        //æŸ¥è¯¢å½“å‰ç™»å½•ç”¨æˆ·çš„æ–‡ç« 
        lambdaQueryWrapper.eq(WmNews::getUserId,user.getId());

        //å‘å¸ƒæ—¶é—´å€’åºæŸ¥è¯¢
        lambdaQueryWrapper.orderByDesc(WmNews::getCreatedTime);

        page = page(page,lambdaQueryWrapper);

        //3.ç»“æœè¿”å›
        ResponseResult responseResult = new PageResponseResult(dto.getPage(),dto.getSize(),(int)page.getTotal());
        responseResult.setData(page.getRecords());

        return responseResult;
    }
   
}
```

#### 4.3 æ–‡ç« å‘å¸ƒ

##### 4.3.1 éœ€æ±‚åˆ†æ

<div align="center">
    <img src="æˆªå›¾/è‡ªåª’ä½“æ–‡ç« å‘å¸ƒ/æ–‡ç« å‘å¸ƒ-éœ€æ±‚åˆ†æ.png" alt="æ–‡ç« å‘å¸ƒ-éœ€æ±‚åˆ†æ" />
</div>


##### 4.3.2 è¡¨ç»“æ„åˆ†æ

ä¿å­˜æ–‡ç« ï¼Œé™¤äº†éœ€è¦wm_newsè¡¨ä»¥å¤–ï¼Œè¿˜éœ€è¦å¦å¤–ä¸¤å¼ è¡¨

wm_material ç´ æè¡¨

```mysql
-- auto-generated definition
create table wm_material
(
    id            int unsigned auto_increment comment 'ä¸»é”®'
        primary key,
    user_id       int unsigned     null comment 'è‡ªåª’ä½“ç”¨æˆ·ID',
    url           varchar(255)     null comment 'å›¾ç‰‡åœ°å€',
    type          tinyint unsigned null comment 'ç´ æç±»å‹
            0 å›¾ç‰‡
            1 è§†é¢‘',
    is_collection tinyint(1)       null comment 'æ˜¯å¦æ”¶è—',
    created_time  datetime         null comment 'åˆ›å»ºæ—¶é—´'
)
    comment 'è‡ªåª’ä½“å›¾æ–‡ç´ æä¿¡æ¯è¡¨' collate = utf8mb4_unicode_ci
                                   row_format = DYNAMIC;
```

wm_news_material æ–‡ç« ç´ æå…³ç³»è¡¨

```mysql
-- auto-generated definition
create table wm_news_material
(
    id          int unsigned auto_increment comment 'ä¸»é”®'
        primary key,
    material_id int unsigned     null comment 'ç´ æID',
    news_id     int unsigned     null comment 'å›¾æ–‡ID',
    type        tinyint unsigned null comment 'å¼•ç”¨ç±»å‹
            0 å†…å®¹å¼•ç”¨
            1 ä¸»å›¾å¼•ç”¨',
    ord         tinyint unsigned null comment 'å¼•ç”¨æ’åº'
)
    comment 'è‡ªåª’ä½“å›¾æ–‡å¼•ç”¨ç´ æä¿¡æ¯è¡¨' collate = utf8mb4_unicode_ci
                                       row_format = DYNAMIC;
```

å› ä¸ºä¸€ç¯‡æ–‡ç« å¯ä»¥å¼•ç”¨å¤šå¼ ç´ æï¼Œä¸€å¼ ç´ æä¹Ÿå¯ä»¥è¢«å¤šç¯‡æ–‡ç« å¼•ç”¨ï¼Œå³wm_newsè¡¨ä¸wm_materialè¡¨æ˜¯**å¤šå¯¹å¤š**çš„å…³ç³»ï¼Œéœ€è¦wm_news_material ä¸­é—´è¡¨æ¥ç»´æŠ¤ä¸¤è€…å…³ç³»

<div align="center">
    <img src="æˆªå›¾/è‡ªåª’ä½“æ–‡ç« å‘å¸ƒ/ä¸‰è¡¨å…³ç³».png" alt="ä¸‰è¡¨å…³ç³»" />
</div>

##### 4.3.3 å®ç°æ€è·¯

<div align="center">
    <img src="æˆªå›¾/è‡ªåª’ä½“æ–‡ç« å‘å¸ƒ/æ–‡ç« å‘å¸ƒ-å®ç°æ€è·¯.png" alt="æ–‡ç« å‘å¸ƒ-å®ç°æ€è·¯" />
</div>
1.å‰ç«¯æäº¤å‘å¸ƒæˆ–ä¿å­˜ä¸ºè‰ç¨¿

2.åå°åˆ¤æ–­è¯·æ±‚ä¸­æ˜¯å¦åŒ…å«äº†æ–‡ç« id

3.å¦‚æœä¸åŒ…å«id,åˆ™ä¸ºæ–°å¢

â€‹	3.1 æ‰§è¡Œæ–°å¢æ–‡ç« çš„æ“ä½œ

â€‹	3.2 å…³è”æ–‡ç« å†…å®¹å›¾ç‰‡ä¸ç´ æçš„å…³ç³»

â€‹	3.3 å…³è”æ–‡ç« å°é¢å›¾ç‰‡ä¸ç´ æçš„å…³ç³»

4.å¦‚æœåŒ…å«äº†idï¼Œåˆ™ä¸ºä¿®æ”¹è¯·æ±‚

â€‹	4.1 åˆ é™¤è¯¥æ–‡ç« ä¸ç´ æçš„æ‰€æœ‰å…³ç³»

â€‹	4.2 æ‰§è¡Œä¿®æ”¹æ“ä½œ

â€‹	4.3 å…³è”æ–‡ç« å†…å®¹å›¾ç‰‡ä¸ç´ æçš„å…³ç³»

â€‹	4.4 å…³è”æ–‡ç« å°é¢å›¾ç‰‡ä¸ç´ æçš„å…³ç³»

##### 4.3.4 æ¥å£å®šä¹‰

|          | **è¯´æ˜**               |
| -------- | ---------------------- |
| æ¥å£è·¯å¾„ | /api/v1/channel/submit |
| è¯·æ±‚æ–¹å¼ | POST                   |
| å‚æ•°     | WmNewsDto              |
| å“åº”ç»“æœ | ResponseResult         |

WmNewsDto  

```java
package com.heima.model.wemedia.dtos;

import lombok.Data;

import java.util.Date;
import java.util.List;

@Data
public class WmNewsDto {
    
    private Integer id;
     /**
     * æ ‡é¢˜
     */
    private String title;
     /**
     * é¢‘é“id
     */
    private Integer channelId;
     /**
     * æ ‡ç­¾
     */
    private String labels;
     /**
     * å‘å¸ƒæ—¶é—´
     */
    private Date publishTime;
     /**
     * æ–‡ç« å†…å®¹
     */
    private String content;
     /**
     * æ–‡ç« å°é¢ç±»å‹  0 æ— å›¾ 1 å•å›¾ 3 å¤šå›¾ -1 è‡ªåŠ¨
     */
    private Short type;
     /**
     * æäº¤æ—¶é—´
     */
    private Date submitedTime; 
     /**
     * çŠ¶æ€ æäº¤ä¸º1  è‰ç¨¿ä¸º0
     */
    private Short status;
     
     /**
     * å°é¢å›¾ç‰‡åˆ—è¡¨ å¤šå¼ å›¾ä»¥é€—å·éš”å¼€
     */
    private List<String> images;
}
```

å‰ç«¯ç»™ä¼ é€’è¿‡æ¥çš„jsonæ•°æ®æ ¼å¼ä¸ºï¼š

```json
{
    "title":"é»‘é©¬å¤´æ¡é¡¹ç›®èƒŒæ™¯",
    "type":"1",//è¿™ä¸ª 0 æ˜¯æ— å›¾  1 æ˜¯å•å›¾  3 æ˜¯å¤šå›¾  -1 æ˜¯è‡ªåŠ¨
    "labels":"é»‘é©¬å¤´æ¡",
    "publishTime":"2020-03-14T11:35:49.000Z",
    "channelId":1,
    "images":[
        "http://192.168.200.130/group1/M00/00/00/wKjIgl5swbGATaSAAAEPfZfx6Iw790.png"
    ],
    "status":1,
    "content":"[
    {
        "type":"text",
        "value":"éšç€æ™ºèƒ½æ‰‹æœºçš„æ™®åŠï¼Œäººä»¬æ›´åŠ ä¹ æƒ¯äºé€šè¿‡æ‰‹æœºæ¥çœ‹æ–°é—»ã€‚ç”±äºç”Ÿæ´»èŠ‚å¥çš„åŠ å¿«ï¼Œå¾ˆå¤šäººåªèƒ½åˆ©ç”¨ç¢ç‰‡æ—¶é—´æ¥è·å–ä¿¡æ¯ï¼Œå› æ­¤ï¼Œå¯¹äºç§»åŠ¨èµ„è®¯å®¢æˆ·ç«¯çš„éœ€æ±‚ä¹Ÿè¶Šæ¥è¶Šé«˜ã€‚é»‘é©¬å¤´æ¡é¡¹ç›®æ­£æ˜¯åœ¨è¿™æ ·èƒŒæ™¯ä¸‹å¼€å‘å‡ºæ¥ã€‚é»‘é©¬å¤´æ¡é¡¹ç›®é‡‡ç”¨å½“ä¸‹ç«çƒ­çš„å¾®æœåŠ¡+å¤§æ•°æ®æŠ€æœ¯æ¶æ„å®ç°ã€‚æœ¬é¡¹ç›®ä¸»è¦ç€æ‰‹äºè·å–æœ€æ–°æœ€çƒ­æ–°é—»èµ„è®¯ï¼Œé€šè¿‡å¤§æ•°æ®åˆ†æç”¨æˆ·å–œå¥½ç²¾ç¡®æ¨é€å’¨è¯¢æ–°é—»"
    },
    {
        "type":"image",
        "value":"http://192.168.200.130/group1/M00/00/00/wKjIgl5swbGATaSAAAEPfZfx6Iw790.png"
    }
]"
}
```

ResponseResult:

```json
{
    â€œcodeâ€:501,
    â€œerrorMessageâ€:â€œå‚æ•°å¤±æ•ˆ"
}

{
    â€œcodeâ€:200,
    â€œerrorMessageâ€:â€œæ“ä½œæˆåŠŸ"
}

{
    â€œcodeâ€:501,
    â€œerrorMessageâ€:â€œç´ æå¼•ç”¨å¤±æ•ˆ"
}
```

##### 4.3.5 æ ¸å¿ƒä»£ç 

æ–°å¢WmNewsMaterialMapperç±»ï¼Œæ–‡ç« ä¸ç´ æçš„å…³è”å…³ç³»éœ€è¦æ‰¹é‡ä¿å­˜ï¼Œç´¢å¼•éœ€è¦å®šä¹‰mapperæ–‡ä»¶å’Œå¯¹åº”çš„æ˜ å°„æ–‡ä»¶

```java
package com.heima.wemedia.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.heima.model.wemedia.pojos.WmNewsMaterial;
import org.apache.ibatis.annotations.Mapper;
import org.apache.ibatis.annotations.Param;

import java.util.List;

@Mapper
public interface WmNewsMaterialMapper extends BaseMapper<WmNewsMaterial> {

     void saveRelations(@Param("materialIds") List<Integer> materialIds,@Param("newsId") Integer newsId, @Param("type")Short type);
}
```

WmNewsMaterialMapper.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.heima.wemedia.mapper.WmNewsMaterialMapper">

    <insert id="saveRelations">
        insert into wm_news_material (material_id,news_id,type,ord)
        values
        <foreach collection="materialIds" index="ord" item="mid" separator=",">
            (#{mid},#{newsId},#{type},#{ord})
        </foreach>
    </insert>

</mapper>
```

å®ç°æ–¹æ³•ï¼š

```java
/**
     * å‘å¸ƒä¿®æ”¹æ–‡ç« æˆ–ä¿å­˜ä¸ºè‰ç¨¿
     * @param dto
     * @return
     */
@Override
public ResponseResult submitNews(WmNewsDto dto) {

    //0.æ¡ä»¶åˆ¤æ–­
    if(dto == null || dto.getContent() == null){
        return ResponseResult.errorResult(AppHttpCodeEnum.PARAM_INVALID);
    }

    //1.ä¿å­˜æˆ–ä¿®æ”¹æ–‡ç« 

    WmNews wmNews = new WmNews();
    //å±æ€§æ‹·è´ å±æ€§åè¯å’Œç±»å‹ç›¸åŒæ‰èƒ½æ‹·è´
    BeanUtils.copyProperties(dto,wmNews);
    //å°é¢å›¾ç‰‡  list---> string
    if(dto.getImages() != null && dto.getImages().size() > 0){
        //[1dddfsd.jpg,sdlfjldk.jpg]-->   1dddfsd.jpg,sdlfjldk.jpg
        String imageStr = StringUtils.join(dto.getImages(), ",");
        wmNews.setImages(imageStr);
    }
    //å¦‚æœå½“å‰å°é¢ç±»å‹ä¸ºè‡ªåŠ¨ -1
    if(dto.getType().equals(WemediaConstants.WM_NEWS_TYPE_AUTO)){
        wmNews.setType(null);
    }

    saveOrUpdateWmNews(wmNews);

    //2.åˆ¤æ–­æ˜¯å¦ä¸ºè‰ç¨¿  å¦‚æœä¸ºè‰ç¨¿ç»“æŸå½“å‰æ–¹æ³•
    if(dto.getStatus().equals(WmNews.Status.NORMAL.getCode())){
        return ResponseResult.okResult(AppHttpCodeEnum.SUCCESS);
    }

    //3.ä¸æ˜¯è‰ç¨¿ï¼Œä¿å­˜æ–‡ç« å†…å®¹å›¾ç‰‡ä¸ç´ æçš„å…³ç³»
    //è·å–åˆ°æ–‡ç« å†…å®¹ä¸­çš„å›¾ç‰‡ä¿¡æ¯
    List<String> materials =  ectractUrlInfo(dto.getContent());
    saveRelativeInfoForContent(materials,wmNews.getId());

    //4.ä¸æ˜¯è‰ç¨¿ï¼Œä¿å­˜æ–‡ç« å°é¢å›¾ç‰‡ä¸ç´ æçš„å…³ç³»ï¼Œå¦‚æœå½“å‰å¸ƒå±€æ˜¯è‡ªåŠ¨ï¼Œéœ€è¦åŒ¹é…å°é¢å›¾ç‰‡
    saveRelativeInfoForCover(dto,wmNews,materials);

    return ResponseResult.okResult(AppHttpCodeEnum.SUCCESS);

}

/**
     * ç¬¬ä¸€ä¸ªåŠŸèƒ½ï¼šå¦‚æœå½“å‰å°é¢ç±»å‹ä¸ºè‡ªåŠ¨ï¼Œåˆ™è®¾ç½®å°é¢ç±»å‹çš„æ•°æ®
     * åŒ¹é…è§„åˆ™ï¼š
     * 1ï¼Œå¦‚æœå†…å®¹å›¾ç‰‡å¤§äºç­‰äº1ï¼Œå°äº3  å•å›¾  type 1
     * 2ï¼Œå¦‚æœå†…å®¹å›¾ç‰‡å¤§äºç­‰äº3  å¤šå›¾  type 3
     * 3ï¼Œå¦‚æœå†…å®¹æ²¡æœ‰å›¾ç‰‡ï¼Œæ— å›¾  type 0
     *
     * ç¬¬äºŒä¸ªåŠŸèƒ½ï¼šä¿å­˜å°é¢å›¾ç‰‡ä¸ç´ æçš„å…³ç³»
     * @param dto
     * @param wmNews
     * @param materials
     */
private void saveRelativeInfoForCover(WmNewsDto dto, WmNews wmNews, List<String> materials) {

    List<String> images = dto.getImages();

    //å¦‚æœå½“å‰å°é¢ç±»å‹ä¸ºè‡ªåŠ¨ï¼Œåˆ™è®¾ç½®å°é¢ç±»å‹çš„æ•°æ®
    if(dto.getType().equals(WemediaConstants.WM_NEWS_TYPE_AUTO)){
        //å¤šå›¾
        if(materials.size() >= 3){
            wmNews.setType(WemediaConstants.WM_NEWS_MANY_IMAGE);
            images = materials.stream().limit(3).collect(Collectors.toList());
        }else if(materials.size() >= 1 && materials.size() < 3){
            //å•å›¾
            wmNews.setType(WemediaConstants.WM_NEWS_SINGLE_IMAGE);
            images = materials.stream().limit(1).collect(Collectors.toList());
        }else {
            //æ— å›¾
            wmNews.setType(WemediaConstants.WM_NEWS_NONE_IMAGE);
        }

        //ä¿®æ”¹æ–‡ç« 
        if(images != null && images.size() > 0){
            wmNews.setImages(StringUtils.join(images,","));
        }
        updateById(wmNews);
    }
    if(images != null && images.size() > 0){
        saveRelativeInfo(images,wmNews.getId(),WemediaConstants.WM_COVER_REFERENCE);
    }

}


/**
     * å¤„ç†æ–‡ç« å†…å®¹å›¾ç‰‡ä¸ç´ æçš„å…³ç³»
     * @param materials
     * @param newsId
     */
private void saveRelativeInfoForContent(List<String> materials, Integer newsId) {
    saveRelativeInfo(materials,newsId,WemediaConstants.WM_CONTENT_REFERENCE);
}

@Autowired
private WmMaterialMapper wmMaterialMapper;

/**
     * ä¿å­˜æ–‡ç« å›¾ç‰‡ä¸ç´ æçš„å…³ç³»åˆ°æ•°æ®åº“ä¸­
     * @param materials
     * @param newsId
     * @param type
     */
private void saveRelativeInfo(List<String> materials, Integer newsId, Short type) {
    if(materials!=null && !materials.isEmpty()){
        //é€šè¿‡å›¾ç‰‡çš„urlæŸ¥è¯¢ç´ æçš„id
        List<WmMaterial> dbMaterials = wmMaterialMapper.selectList(Wrappers.<WmMaterial>lambdaQuery().in(WmMaterial::getUrl, materials));

        //åˆ¤æ–­ç´ ææ˜¯å¦æœ‰æ•ˆ
        if(dbMaterials==null || dbMaterials.size() == 0){
            //æ‰‹åŠ¨æŠ›å‡ºå¼‚å¸¸   ç¬¬ä¸€ä¸ªåŠŸèƒ½ï¼šèƒ½å¤Ÿæç¤ºè°ƒç”¨è€…ç´ æå¤±æ•ˆäº†ï¼Œç¬¬äºŒä¸ªåŠŸèƒ½ï¼Œè¿›è¡Œæ•°æ®çš„å›æ»š
            throw new CustomException(AppHttpCodeEnum.MATERIASL_REFERENCE_FAIL);
        }

        if(materials.size() != dbMaterials.size()){
            throw new CustomException(AppHttpCodeEnum.MATERIASL_REFERENCE_FAIL);
        }

        List<Integer> idList = dbMaterials.stream().map(WmMaterial::getId).collect(Collectors.toList());

        //æ‰¹é‡ä¿å­˜
        wmNewsMaterialMapper.saveRelations(idList,newsId,type);
    }

}


/**
     * æå–æ–‡ç« å†…å®¹ä¸­çš„å›¾ç‰‡ä¿¡æ¯
     * @param content
     * @return
     */
private List<String> ectractUrlInfo(String content) {
    List<String> materials = new ArrayList<>();

    List<Map> maps = JSON.parseArray(content, Map.class);
    for (Map map : maps) {
        if(map.get("type").equals("image")){
            String imgUrl = (String) map.get("value");
            materials.add(imgUrl);
        }
    }

    return materials;
}

@Autowired
private WmNewsMaterialMapper wmNewsMaterialMapper;

/**
     * ä¿å­˜æˆ–ä¿®æ”¹æ–‡ç« 
     * @param wmNews
     */
private void saveOrUpdateWmNews(WmNews wmNews) {
    //è¡¥å…¨å±æ€§
    wmNews.setUserId(WmThreadLocalUtil.getUser().getId());
    wmNews.setCreatedTime(new Date());
    wmNews.setSubmitedTime(new Date());
    wmNews.setEnable((short)1);//é»˜è®¤ä¸Šæ¶

    if(wmNews.getId() == null){
        //ä¿å­˜
        save(wmNews);
    }else {
        //ä¿®æ”¹
        //åˆ é™¤æ–‡ç« å›¾ç‰‡ä¸ç´ æçš„å…³ç³»
        wmNewsMaterialMapper.delete(Wrappers.<WmNewsMaterial>lambdaQuery().eq(WmNewsMaterial::getNewsId,wmNews.getId()));
        updateById(wmNews);
    }

}
```

## åã€è‡ªåª’ä½“æ–‡ç« -è‡ªåŠ¨å®¡æ ¸

### 1. è‡ªåª’ä½“æ–‡ç« è‡ªåŠ¨å®¡æ ¸æµç¨‹

<div align="center">
    <img src="æˆªå›¾/è‡ªåŠ¨å®¡æ ¸/è‡ªåŠ¨å®¡æ ¸æµç¨‹.png" alt="åå°æ­å»º" />
</div>

1. è‡ªåª’ä½“ç«¯å‘å¸ƒæ–‡ç« åï¼Œå¼€å§‹å®¡æ ¸æ–‡ç« 

2. å®¡æ ¸çš„ä¸»è¦æ˜¯å®¡æ ¸æ–‡ç« çš„å†…å®¹ï¼ˆæ–‡æœ¬å†…å®¹å’Œå›¾ç‰‡ï¼‰

3. å€ŸåŠ©ç¬¬ä¸‰æ–¹æä¾›çš„æ¥å£å®¡æ ¸æ–‡æœ¬

4. å€ŸåŠ©ç¬¬ä¸‰æ–¹æä¾›çš„æ¥å£å®¡æ ¸å›¾ç‰‡ï¼Œç”±äºå›¾ç‰‡å­˜å‚¨åˆ°minIOä¸­ï¼Œéœ€è¦å…ˆä¸‹è½½æ‰èƒ½å®¡æ ¸

5. å¦‚æœå®¡æ ¸å¤±è´¥ï¼Œåˆ™éœ€è¦ä¿®æ”¹è‡ªåª’ä½“æ–‡ç« çš„çŠ¶æ€ï¼Œstatus:2  å®¡æ ¸å¤±è´¥    status:3  è½¬åˆ°äººå·¥å®¡æ ¸

6. å¦‚æœå®¡æ ¸æˆåŠŸï¼Œåˆ™éœ€è¦åœ¨æ–‡ç« å¾®æœåŠ¡ä¸­åˆ›å»ºappç«¯éœ€è¦çš„æ–‡ç« 

### 2. å†…å®¹å®‰å…¨ç¬¬ä¸‰æ–¹æ¥å£

&emsp;å†…å®¹å®‰å…¨æ˜¯è¯†åˆ«æœåŠ¡ï¼Œæ”¯æŒå¯¹å›¾ç‰‡ã€è§†é¢‘ã€æ–‡æœ¬ã€è¯­éŸ³ç­‰å¯¹è±¡è¿›è¡Œå¤šæ ·åŒ–åœºæ™¯æ£€æµ‹ï¼Œæœ‰æ•ˆé™ä½å†…å®¹è¿è§„é£é™©ã€‚ç›®å‰å¾ˆå¤šå¹³å°éƒ½æ”¯æŒå†…å®¹æ£€æµ‹ï¼Œå¦‚é˜¿é‡Œäº‘ã€è…¾è®¯äº‘ã€ç™¾åº¦AIã€ç½‘æ˜“äº‘ç­‰å›½å†…å¤§å‹äº’è”ç½‘å…¬å¸éƒ½å¯¹å¤–æä¾›äº†APIã€‚

- æ–‡æœ¬åƒåœ¾å†…å®¹æ£€æµ‹ï¼šhttps://help.aliyun.com/document_detail/70439.html?spm=a2c4g.11186623.6.659.35ac3db3l0wV5k 
- æ–‡æœ¬åƒåœ¾å†…å®¹Java SDK: https://help.aliyun.com/document_detail/53427.html?spm=a2c4g.11186623.6.717.466d7544QbU8Lr 
- å›¾ç‰‡åƒåœ¾å†…å®¹æ£€æµ‹ï¼šhttps://help.aliyun.com/document_detail/70292.html?spm=a2c4g.11186623.6.616.5d7d1e7f9vDRz4 
- å›¾ç‰‡åƒåœ¾å†…å®¹Java SDK: https://help.aliyun.com/document_detail/53424.html?spm=a2c4g.11186623.6.715.c8f69b12ey35j4 

### 3. appç«¯æ–‡ç« ä¿å­˜æ¥å£

#### 3.1 è¡¨ç»“æ„è¯´æ˜

ap_article  æ–‡ç« åŸºæœ¬ä¿¡æ¯è¡¨

```mysql
-- auto-generated definition
create table ap_article
(
    id           bigint unsigned auto_increment
        primary key,
    title        varchar(50)                  null comment 'æ ‡é¢˜',
    author_id    int unsigned                 null comment 'æ–‡ç« ä½œè€…çš„ID',
    author_name  varchar(20)                  null comment 'ä½œè€…æ˜µç§°',
    channel_id   int unsigned                 null comment 'æ–‡ç« æ‰€å±é¢‘é“ID',
    channel_name varchar(10)                  null comment 'é¢‘é“åç§°',
    layout       tinyint unsigned             null comment 'æ–‡ç« å¸ƒå±€
            0 æ— å›¾æ–‡ç« 
            1 å•å›¾æ–‡ç« 
            2 å¤šå›¾æ–‡ç« ',
    flag         tinyint unsigned             null comment 'æ–‡ç« æ ‡è®°
            0 æ™®é€šæ–‡ç« 
            1 çƒ­ç‚¹æ–‡ç« 
            2 ç½®é¡¶æ–‡ç« 
            3 ç²¾å“æ–‡ç« 
            4 å¤§V æ–‡ç« ',
    images       varchar(1000)                null comment 'æ–‡ç« å›¾ç‰‡
            å¤šå¼ é€—å·åˆ†éš”',
    labels       varchar(500)                 null comment 'æ–‡ç« æ ‡ç­¾æœ€å¤š3ä¸ª é€—å·åˆ†éš”',
    likes        int unsigned                 null comment 'ç‚¹èµæ•°é‡',
    collection   int unsigned                 null comment 'æ”¶è—æ•°é‡',
    comment      int unsigned                 null comment 'è¯„è®ºæ•°é‡',
    views        int unsigned                 null comment 'é˜…è¯»æ•°é‡',
    province_id  int unsigned                 null comment 'çœå¸‚',
    city_id      int unsigned                 null comment 'å¸‚åŒº',
    county_id    int unsigned                 null comment 'åŒºå¿',
    created_time datetime                     null comment 'åˆ›å»ºæ—¶é—´',
    publish_time datetime                     null comment 'å‘å¸ƒæ—¶é—´',
    sync_status  tinyint(1)       default 0   null comment 'åŒæ­¥çŠ¶æ€',
    origin       tinyint unsigned default '0' null comment 'æ¥æº',
    static_url   varchar(150)                 null
)
    comment 'æ–‡ç« ä¿¡æ¯è¡¨ï¼Œå­˜å‚¨å·²å‘å¸ƒçš„æ–‡ç« ' row_format = DYNAMIC;
```

ap_article_config  æ–‡ç« é…ç½®è¡¨

```mysql
-- auto-generated definition
create table ap_article_config
(
    id         bigint unsigned auto_increment comment 'ä¸»é”®'
        primary key,
    article_id bigint unsigned  null comment 'æ–‡ç« ID',
    is_comment tinyint unsigned null comment 'æ˜¯å¦å¯è¯„è®º',
    is_forward tinyint unsigned null comment 'æ˜¯å¦è½¬å‘',
    is_down    tinyint unsigned null comment 'æ˜¯å¦ä¸‹æ¶',
    is_delete  tinyint unsigned null comment 'æ˜¯å¦å·²åˆ é™¤'
)
    comment 'APPå·²å‘å¸ƒæ–‡ç« é…ç½®è¡¨' row_format = DYNAMIC;

create index idx_article_id
    on ap_article_config (article_id);
```

ap_article_content æ–‡ç« å†…å®¹è¡¨

```mysql
-- auto-generated definition
create table ap_article_content
(
    id         bigint unsigned auto_increment comment 'ä¸»é”®'
        primary key,
    article_id bigint unsigned null comment 'æ–‡ç« ID',
    content    longtext        null comment 'æ–‡ç« å†…å®¹'
)
    comment 'APPå·²å‘å¸ƒæ–‡ç« å†…å®¹è¡¨' row_format = DYNAMIC;

create index idx_article_id
    on ap_article_content (article_id);
```

ä¸‰å¼ è¡¨å…³ç³»åˆ†æ

<div align="center">
    <img src="æˆªå›¾/æ–‡ç« åˆ—è¡¨åŠ è½½/ä¸‰è¡¨å…³ç³».png" alt="ä¸‰è¡¨å…³ç³»" />
</div>

#### 3.2 åˆ†å¸ƒå¼id

&emsp;éšç€ä¸šåŠ¡çš„å¢é•¿ï¼Œæ–‡ç« è¡¨å¯èƒ½è¦å ç”¨å¾ˆå¤§çš„ç‰©ç†å­˜å‚¨ç©ºé—´ï¼Œä¸ºäº†è§£å†³è¯¥é—®é¢˜ï¼ŒåæœŸä½¿ç”¨æ•°æ®åº“åˆ†ç‰‡æŠ€æœ¯ã€‚å°†ä¸€ä¸ªæ•°æ®åº“è¿›è¡Œæ‹†åˆ†ï¼Œé€šè¿‡æ•°æ®åº“ä¸­é—´ä»¶è¿æ¥ã€‚å¦‚æœæ•°æ®åº“ä¸­è¯¥è¡¨é€‰ç”¨IDè‡ªå¢ç­–ç•¥ï¼Œåˆ™å¯èƒ½äº§ç”Ÿé‡å¤çš„IDï¼Œæ­¤æ—¶åº”è¯¥ä½¿ç”¨åˆ†å¸ƒå¼IDç”Ÿæˆç­–ç•¥æ¥ç”ŸæˆIDã€‚

<div align="center">
    <img src="æˆªå›¾/è‡ªåŠ¨å®¡æ ¸/åˆ†å¸ƒå¼id.png" alt="åå°æ­å»º" />
</div>

&emsp;snowflakeæ˜¯Twitterå¼€æºçš„åˆ†å¸ƒå¼IDç”Ÿæˆç®—æ³•ï¼Œç»“æœæ˜¯ä¸€ä¸ªlongå‹çš„IDã€‚å…¶æ ¸å¿ƒæ€æƒ³æ˜¯ï¼šä½¿ç”¨41bitä½œä¸ºæ¯«ç§’æ•°ï¼Œ10bitä½œä¸ºæœºå™¨çš„IDï¼ˆ5ä¸ªbitæ˜¯æ•°æ®ä¸­å¿ƒï¼Œ5ä¸ªbitçš„æœºå™¨IDï¼‰ï¼Œ12bitä½œä¸ºæ¯«ç§’å†…çš„æµæ°´å·ï¼ˆæ„å‘³ç€æ¯ä¸ªèŠ‚ç‚¹åœ¨æ¯æ¯«ç§’å¯ä»¥äº§ç”Ÿ 4096 ä¸ª IDï¼‰ï¼Œæœ€åè¿˜æœ‰ä¸€ä¸ªç¬¦å·ä½ï¼Œæ°¸è¿œæ˜¯0

<div align="center">
    <img src="æˆªå›¾/è‡ªåŠ¨å®¡æ ¸/é›ªèŠ±ç®—æ³•.png" alt="åå°æ­å»º" />
</div>

æ–‡ç« ç«¯ç›¸å…³çš„è¡¨éƒ½ä½¿ç”¨é›ªèŠ±ç®—æ³•ç”Ÿæˆid,åŒ…æ‹¬ap_articleã€ ap_article_configã€ ap_article_content

#### 3.3 æ€è·¯åˆ†æ

åœ¨æ–‡ç« å®¡æ ¸æˆåŠŸä»¥åéœ€è¦åœ¨appçš„articleåº“ä¸­æ–°å¢æ–‡ç« æ•°æ®

1.ä¿å­˜æ–‡ç« ä¿¡æ¯ ap_article

2.ä¿å­˜æ–‡ç« é…ç½®ä¿¡æ¯ ap_article_config

3.ä¿å­˜æ–‡ç« å†…å®¹ ap_article_content

å®ç°æ€è·¯ï¼š

<div align="center">
    <img src="æˆªå›¾/è‡ªåŠ¨å®¡æ ¸/æ–‡ç« ä¿å­˜æ¥å£.png" alt="åå°æ­å»º" />
</div>

#### 3.4 feignæ¥å£

|          | **è¯´æ˜**             |
| -------- | -------------------- |
| æ¥å£è·¯å¾„ | /api/v1/article/save |
| è¯·æ±‚æ–¹å¼ | POST                 |
| å‚æ•°     | ArticleDto           |
| å“åº”ç»“æœ | ResponseResult       |

ArticleDto

```java
package com.heima.model.article.dtos;

import com.heima.model.article.pojos.ApArticle;
import lombok.Data;

@Data
public class ArticleDto  extends ApArticle {
    /**
     * æ–‡ç« å†…å®¹
     */
    private String content;
}
```

æˆåŠŸï¼š

```json
{
  "code": 200,
  "errorMessage" : "æ“ä½œæˆåŠŸ",
  "data":"1302864436297442242"
 }
```

å¤±è´¥ï¼š

```json
{
  "code":501,
  "errorMessage":"å‚æ•°å¤±æ•ˆ",
 }
```

```json
{
  "code":501,
  "errorMessage":"æ–‡ç« æ²¡æœ‰æ‰¾åˆ°",
 }
```

#### 3.5 æ ¸å¿ƒä»£ç 

```java
@Autowired
private ApArticleConfigMapper apArticleConfigMapper;

@Autowired
private ApArticleContentMapper apArticleContentMapper;

/**
     * ä¿å­˜appç«¯ç›¸å…³æ–‡ç« 
     * @param dto
     * @return
     */
@Override
public ResponseResult saveArticle(ArticleDto dto) {
    //1.æ£€æŸ¥å‚æ•°
    if(dto == null){
        return ResponseResult.errorResult(AppHttpCodeEnum.PARAM_INVALID);
    }

    ApArticle apArticle = new ApArticle();
    BeanUtils.copyProperties(dto,apArticle);

    //2.åˆ¤æ–­æ˜¯å¦å­˜åœ¨id
    if(dto.getId() == null){
        //2.1 ä¸å­˜åœ¨id  ä¿å­˜  æ–‡ç«   æ–‡ç« é…ç½®  æ–‡ç« å†…å®¹

        //ä¿å­˜æ–‡ç« 
        save(apArticle);

        //ä¿å­˜é…ç½®
        ApArticleConfig apArticleConfig = new ApArticleConfig(apArticle.getId());
        apArticleConfigMapper.insert(apArticleConfig);

        //ä¿å­˜ æ–‡ç« å†…å®¹
        ApArticleContent apArticleContent = new ApArticleContent();
        apArticleContent.setArticleId(apArticle.getId());
        apArticleContent.setContent(dto.getContent());
        apArticleContentMapper.insert(apArticleContent);

    }else {
        //2.2 å­˜åœ¨id   ä¿®æ”¹  æ–‡ç«   æ–‡ç« å†…å®¹

        //ä¿®æ”¹  æ–‡ç« 
        updateById(apArticle);

        //ä¿®æ”¹æ–‡ç« å†…å®¹
        ApArticleContent apArticleContent = apArticleContentMapper.selectOne(Wrappers.<ApArticleContent>lambdaQuery().eq(ApArticleContent::getArticleId, dto.getId()));
        apArticleContent.setContent(dto.getContent());
        apArticleContentMapper.updateById(apArticleContent);
    }


    //3.ç»“æœè¿”å›  æ–‡ç« çš„id
    return ResponseResult.okResult(apArticle.getId());
}
```

